[TOC]

# ç¼“å­˜åŸºç¡€å¸¸è§é¢è¯•é¢˜æ€»ç»“(ä»˜è´¹)

æš‚æ— 

# Rediså¸¸è§é¢è¯•é¢˜æ€»ç»“(ä¸Š)(å¿…çœ‹ğŸ‘)

## Redis åŸºç¡€

### ä»€ä¹ˆæ˜¯ Redisï¼Ÿ

==redisé»˜è®¤ç«¯å£ï¼š6379==

[Redis](https://redis.io/) ï¼ˆ**RE**mote **DI**ctionary **S**erverï¼‰æ˜¯ä¸€ä¸ªåŸºäº C è¯­è¨€å¼€å‘çš„å¼€æº **NoSQL æ•°æ®åº“**ï¼ˆBSD è®¸å¯ï¼‰ã€‚ä¸ä¼ ç»Ÿæ•°æ®åº“ä¸åŒçš„æ˜¯ï¼ŒRedis çš„æ•°æ®æ˜¯ä¿å­˜åœ¨==**å†…å­˜**==ä¸­çš„ï¼ˆå†…å­˜æ•°æ®åº“ï¼Œæ”¯æŒæŒä¹…åŒ–ï¼‰ï¼Œå› æ­¤è¯»å†™é€Ÿåº¦éå¸¸å¿«ï¼Œè¢«å¹¿æ³›åº”ç”¨äº**åˆ†å¸ƒå¼ç¼“å­˜æ–¹å‘**ã€‚å¹¶ä¸”ï¼ŒRedis å­˜å‚¨çš„æ˜¯ ==**KV é”®å€¼å¯¹æ•°æ®**==ã€‚

ä¸ºäº†æ»¡è¶³ä¸åŒçš„ä¸šåŠ¡åœºæ™¯ï¼ŒRedis å†…ç½®äº†å¤šç§æ•°æ®ç±»å‹å®ç°ï¼ˆæ¯”å¦‚ Stringã€Hashã€Sorted Setã€Bitmapã€HyperLogLogã€GEOï¼‰ã€‚å¹¶ä¸”ï¼ŒRedis è¿˜æ”¯æŒäº‹åŠ¡ã€æŒä¹…åŒ–ã€Lua è„šæœ¬ã€å‘å¸ƒè®¢é˜…æ¨¡å‹ã€å¤šç§å¼€ç®±å³ç”¨çš„é›†ç¾¤æ–¹æ¡ˆï¼ˆRedis Sentinelã€Redis Clusterï¼‰ã€‚

![](images\redis-overview-of-data-types-2023-09-28.jpg)

Redis æ²¡æœ‰å¤–éƒ¨ä¾èµ–ï¼ŒLinux å’Œ OS X æ˜¯ Redis å¼€å‘å’Œæµ‹è¯•æœ€å¤šçš„ä¸¤ä¸ªæ“ä½œç³»ç»Ÿï¼Œå®˜æ–¹æ¨èç”Ÿäº§ç¯å¢ƒä½¿ç”¨ **Linux** éƒ¨ç½² Redisã€‚

ä¸ªäººå­¦ä¹ çš„è¯ï¼Œä½ å¯ä»¥è‡ªå·±æœ¬æœºå®‰è£… Redis æˆ–è€…é€šè¿‡ Redis å®˜ç½‘æä¾›çš„[åœ¨çº¿ Redis ç¯å¢ƒ](https://try.redis.io/)ï¼ˆå°‘éƒ¨åˆ†å‘½ä»¤æ— æ³•ä½¿ç”¨ï¼‰æ¥å®é™…ä½“éªŒ Redisã€‚

![](images\try.redis.io.png)

å…¨ä¸–ç•Œæœ‰éå¸¸å¤šçš„ç½‘ç«™ä½¿ç”¨åˆ°äº† Redis ï¼Œ[techstacks.io](https://techstacks.io/) ä¸“é—¨ç»´æŠ¤äº†ä¸€ä¸ª[ä½¿ç”¨ Redis çš„çƒ­é—¨ç«™ç‚¹åˆ—è¡¨](https://techstacks.io/tech/redis) ï¼Œæ„Ÿå…´è¶£çš„è¯å¯ä»¥çœ‹çœ‹ã€‚

### Redis ä¸ºä»€ä¹ˆè¿™ä¹ˆå¿«ï¼Ÿâœ…

Redis å†…éƒ¨åšäº†éå¸¸å¤šçš„æ€§èƒ½ä¼˜åŒ–ï¼Œæ¯”è¾ƒé‡è¦çš„æœ‰ä¸‹é¢ 3 ç‚¹ï¼š

1. Redis åŸºäº**å†…å­˜**ï¼Œå†…å­˜çš„è®¿é—®é€Ÿåº¦æ¯”ç£ç›˜å¿«å¾ˆå¤šï¼›
2. Redis åŸºäº Reactor æ¨¡å¼è®¾è®¡å¼€å‘äº†ä¸€å¥—é«˜æ•ˆçš„äº‹ä»¶å¤„ç†æ¨¡å‹ï¼Œä¸»è¦æ˜¯**å•çº¿ç¨‹äº‹ä»¶å¾ªç¯**å’Œ **IO å¤šè·¯å¤ç”¨**ï¼ˆRedis çº¿ç¨‹æ¨¡å¼åé¢ä¼šè¯¦ç»†ä»‹ç»åˆ°ï¼‰ï¼›
3. Redis å†…ç½®äº†å¤šç§ä¼˜åŒ–è¿‡åçš„**æ•°æ®ç±»å‹/ç»“æ„**å®ç°ï¼Œæ€§èƒ½éå¸¸é«˜ã€‚
4. Redis **é€šä¿¡åè®®**å®ç°ç®€å•ä¸”è§£æé«˜æ•ˆã€‚

> ä¸‹é¢è¿™å¼ å›¾ç‰‡æ€»ç»“çš„æŒºä¸é”™çš„ï¼Œåˆ†äº«ä¸€ä¸‹ï¼Œå‡ºè‡ª [Why is Redis so fast?](https://twitter.com/alexxubyte/status/1498703822528544770) ã€‚

![](images\why-redis-so-fast-TbWX24ja.png)

é‚£æ—¢ç„¶éƒ½è¿™ä¹ˆå¿«äº†ï¼Œ**ä¸ºä»€ä¹ˆä¸ç›´æ¥ç”¨ Redis å½“ä¸»æ•°æ®åº“å‘¢ï¼Ÿä¸»è¦æ˜¯å› ä¸ºå†…å­˜æˆæœ¬å¤ªé«˜ä¸” Redis æä¾›çš„æ•°æ®æŒä¹…åŒ–ä»ç„¶æœ‰æ•°æ®ä¸¢å¤±çš„é£é™©**ã€‚

### åˆ†å¸ƒå¼ç¼“å­˜å¸¸è§çš„æŠ€æœ¯é€‰å‹æ–¹æ¡ˆæœ‰å“ªäº›ï¼Ÿ

åˆ†å¸ƒå¼ç¼“å­˜çš„è¯ï¼Œæ¯”è¾ƒè€ç‰ŒåŒæ—¶ä¹Ÿæ˜¯ä½¿ç”¨çš„æ¯”è¾ƒå¤šçš„è¿˜æ˜¯ **Memcached** å’Œ **Redis**ã€‚ä¸è¿‡ï¼Œç°åœ¨åŸºæœ¬æ²¡æœ‰çœ‹è¿‡è¿˜æœ‰é¡¹ç›®ä½¿ç”¨ **Memcached** æ¥åšç¼“å­˜ï¼Œéƒ½æ˜¯ç›´æ¥ç”¨ **Redis**ã€‚

Memcached æ˜¯åˆ†å¸ƒå¼ç¼“å­˜æœ€å¼€å§‹å…´èµ·çš„é‚£ä¼šï¼Œæ¯”è¾ƒå¸¸ç”¨çš„ã€‚åæ¥ï¼Œéšç€ Redis çš„å‘å±•ï¼Œå¤§å®¶æ…¢æ…¢éƒ½è½¬è€Œä½¿ç”¨æ›´åŠ å¼ºå¤§çš„ Redis äº†ã€‚

æœ‰ä¸€äº›å¤§å‚ä¹Ÿå¼€æºäº†ç±»ä¼¼äº Redis çš„åˆ†å¸ƒå¼é«˜æ€§èƒ½ KV å­˜å‚¨æ•°æ®åº“ï¼Œä¾‹å¦‚ï¼Œè…¾è®¯å¼€æºçš„ [Tendis](https://github.com/Tencent/Tendis) ã€‚Tendis åŸºäºçŸ¥åå¼€æºé¡¹ç›® [RocksDB](https://github.com/facebook/rocksdb) ä½œä¸ºå­˜å‚¨å¼•æ“ ï¼Œ100% å…¼å®¹ Redis åè®®å’Œ Redis4.0 æ‰€æœ‰æ•°æ®æ¨¡å‹ã€‚å…³äº Redis å’Œ Tendis çš„å¯¹æ¯”ï¼Œè…¾è®¯å®˜æ–¹æ›¾ç»å‘è¿‡ä¸€ç¯‡æ–‡ç« ï¼š[Redis vs Tendisï¼šå†·çƒ­æ··åˆå­˜å‚¨ç‰ˆæ¶æ„æ­ç§˜](https://mp.weixin.qq.com/s/MeYkfOIdnU6LYlsGb24KjQ) ï¼Œå¯ä»¥ç®€å•å‚è€ƒä¸€ä¸‹ã€‚

ä¸è¿‡ï¼Œä» Tendis è¿™ä¸ªé¡¹ç›®çš„ Github æäº¤è®°å½•å¯ä»¥çœ‹å‡ºï¼ŒTendis å¼€æºç‰ˆå‡ ä¹å·²ç»æ²¡æœ‰è¢«ç»´æŠ¤æ›´æ–°äº†ï¼ŒåŠ ä¸Šå…¶å…³æ³¨åº¦å¹¶ä¸é«˜ï¼Œä½¿ç”¨çš„å…¬å¸ä¹Ÿæ¯”è¾ƒå°‘ã€‚å› æ­¤ï¼Œä¸å»ºè®®ä½ ä½¿ç”¨ Tendis æ¥å®ç°åˆ†å¸ƒå¼ç¼“å­˜ã€‚

ç›®å‰ï¼Œæ¯”è¾ƒä¸šç•Œè®¤å¯çš„ Redis æ›¿ä»£å“è¿˜æ˜¯ä¸‹é¢è¿™ä¸¤ä¸ªå¼€æºåˆ†å¸ƒå¼ç¼“å­˜ï¼ˆéƒ½æ˜¯é€šè¿‡ç¢°ç“· Redis ç«çš„ï¼‰ï¼š

- [Dragonfly](https://github.com/dragonflydb/dragonfly)ï¼šä¸€ç§é’ˆå¯¹ç°ä»£åº”ç”¨ç¨‹åºè´Ÿè·éœ€æ±‚è€Œæ„å»ºçš„å†…å­˜æ•°æ®åº“ï¼Œå®Œå…¨å…¼å®¹ Redis å’Œ Memcached çš„ APIï¼Œè¿ç§»æ—¶æ— éœ€ä¿®æ”¹ä»»ä½•ä»£ç ï¼Œå·ç§°å…¨ä¸–ç•Œæœ€å¿«çš„å†…å­˜æ•°æ®åº“ã€‚
- [KeyDB](https://github.com/Snapchat/KeyDB)ï¼š Redis çš„ä¸€ä¸ªé«˜æ€§èƒ½åˆ†æ”¯ï¼Œä¸“æ³¨äºå¤šçº¿ç¨‹ã€å†…å­˜æ•ˆç‡å’Œé«˜ååé‡ã€‚

ä¸è¿‡ï¼Œä¸ªäººè¿˜æ˜¯å»ºè®®åˆ†å¸ƒå¼ç¼“å­˜é¦–é€‰ Redis ï¼Œæ¯•ç«Ÿç»è¿‡è¿™ä¹ˆå¤šå¹´çš„ç”Ÿè€ƒéªŒï¼Œç”Ÿæ€ä¹Ÿè¿™ä¹ˆä¼˜ç§€ï¼Œèµ„æ–™ä¹Ÿå¾ˆå…¨é¢ã€‚

### è¯´ä¸€ä¸‹ Redis å’Œ Memcached çš„åŒºåˆ«å’Œå…±åŒç‚¹

ç°åœ¨å…¬å¸ä¸€èˆ¬éƒ½æ˜¯ç”¨ Redis æ¥å®ç°ç¼“å­˜ï¼Œè€Œä¸” Redis è‡ªèº«ä¹Ÿè¶Šæ¥è¶Šå¼ºå¤§äº†ï¼ä¸è¿‡ï¼Œäº†è§£ Redis å’Œ Memcached çš„åŒºåˆ«å’Œå…±åŒç‚¹ï¼Œæœ‰åŠ©äºæˆ‘ä»¬åœ¨åšç›¸åº”çš„æŠ€æœ¯é€‰å‹çš„æ—¶å€™ï¼Œèƒ½å¤Ÿåšåˆ°æœ‰ç†æœ‰æ®ï¼

**å…±åŒç‚¹**ï¼š

1. éƒ½æ˜¯**åŸºäºå†…å­˜**çš„æ•°æ®åº“ï¼Œä¸€èˆ¬éƒ½ç”¨æ¥**å½“åšç¼“å­˜ä½¿ç”¨**ã€‚
2. éƒ½æœ‰**è¿‡æœŸç­–ç•¥**ã€‚
3. ä¸¤è€…çš„æ€§èƒ½éƒ½éå¸¸é«˜ã€‚

**åŒºåˆ«**ï¼š

1. **æ•°æ®ç±»å‹**ï¼šRedis æ”¯æŒæ›´ä¸°å¯Œçš„æ•°æ®ç±»å‹ï¼ˆæ”¯æŒæ›´å¤æ‚çš„åº”ç”¨åœºæ™¯ï¼‰ã€‚Redis ä¸ä»…ä»…æ”¯æŒç®€å•çš„ k/v ç±»å‹çš„æ•°æ®ï¼ŒåŒæ—¶è¿˜æä¾› listï¼Œsetï¼Œzsetï¼Œhash ç­‰æ•°æ®ç»“æ„çš„å­˜å‚¨ã€‚Memcached åªæ”¯æŒæœ€ç®€å•çš„ k/v æ•°æ®ç±»å‹ã€‚
2. **æ•°æ®æŒä¹…åŒ–**ï¼šRedis æ”¯æŒæ•°æ®çš„æŒä¹…åŒ–ï¼Œå¯ä»¥å°†å†…å­˜ä¸­çš„æ•°æ®ä¿æŒåœ¨ç£ç›˜ä¸­ï¼Œé‡å¯çš„æ—¶å€™å¯ä»¥å†æ¬¡åŠ è½½è¿›è¡Œä½¿ç”¨ï¼Œè€Œ Memcached æŠŠæ•°æ®å…¨éƒ¨å­˜åœ¨å†…å­˜ä¹‹ä¸­ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œ**Redis æœ‰ç¾éš¾æ¢å¤æœºåˆ¶**è€Œ Memcached æ²¡æœ‰ã€‚
3. **é›†ç¾¤æ¨¡å¼æ”¯æŒ**ï¼šMemcached æ²¡æœ‰åŸç”Ÿçš„é›†ç¾¤æ¨¡å¼ï¼Œéœ€è¦ä¾é å®¢æˆ·ç«¯æ¥å®ç°å¾€é›†ç¾¤ä¸­åˆ†ç‰‡å†™å…¥æ•°æ®ï¼›ä½†æ˜¯ Redis è‡ª 3.0 ç‰ˆæœ¬èµ·æ˜¯åŸç”Ÿæ”¯æŒé›†ç¾¤æ¨¡å¼çš„ã€‚
4. **çº¿ç¨‹æ¨¡å‹**ï¼šMemcached æ˜¯**å¤šçº¿ç¨‹ï¼Œéé˜»å¡ IO å¤ç”¨**çš„ç½‘ç»œæ¨¡å‹ï¼›Redis ä½¿ç”¨**å•çº¿ç¨‹çš„å¤šè·¯ IO å¤ç”¨æ¨¡å‹**ã€‚ ï¼ˆRedis 6.0 é’ˆå¯¹ç½‘ç»œæ•°æ®çš„è¯»å†™å¼•å…¥äº†å¤šçº¿ç¨‹ï¼‰
5. **ç‰¹æ€§æ”¯æŒ**ï¼šRedis æ”¯æŒå‘å¸ƒè®¢é˜…æ¨¡å‹ã€Lua è„šæœ¬ã€äº‹åŠ¡ç­‰åŠŸèƒ½ï¼Œè€Œ Memcached ä¸æ”¯æŒã€‚å¹¶ä¸”ï¼ŒRedis æ”¯æŒæ›´å¤šçš„ç¼–ç¨‹è¯­è¨€ã€‚
6. **è¿‡æœŸæ•°æ®åˆ é™¤**ï¼šMemcached è¿‡æœŸæ•°æ®çš„åˆ é™¤ç­–ç•¥åªç”¨äº†æƒ°æ€§åˆ é™¤ï¼Œè€Œ Redis åŒæ—¶ä½¿ç”¨äº†**æƒ°æ€§åˆ é™¤**ä¸**å®šæœŸåˆ é™¤**ã€‚

ç›¸ä¿¡çœ‹äº†ä¸Šé¢çš„å¯¹æ¯”ä¹‹åï¼Œæˆ‘ä»¬å·²ç»æ²¡æœ‰ä»€ä¹ˆç†ç”±å¯ä»¥é€‰æ‹©ä½¿ç”¨ Memcached æ¥ä½œä¸ºè‡ªå·±é¡¹ç›®çš„åˆ†å¸ƒå¼ç¼“å­˜äº†ã€‚

### ä¸ºä»€ä¹ˆè¦ç”¨ Redisï¼Ÿ

**1ã€è®¿é—®é€Ÿåº¦æ›´å¿«**

ä¼ ç»Ÿæ•°æ®åº“æ•°æ®ä¿å­˜åœ¨ç£ç›˜ï¼Œè€Œ Redis **åŸºäºå†…å­˜**ï¼Œå†…å­˜çš„è®¿é—®é€Ÿåº¦æ¯”ç£ç›˜å¿«å¾ˆå¤šã€‚å¼•å…¥ Redis ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥æŠŠä¸€äº›é«˜é¢‘è®¿é—®çš„æ•°æ®æ”¾åˆ° Redis ä¸­ï¼Œè¿™æ ·ä¸‹æ¬¡å°±å¯ä»¥ç›´æ¥ä»å†…å­˜ä¸­è¯»å–ï¼Œé€Ÿåº¦å¯ä»¥æå‡å‡ åå€ç”šè‡³ä¸Šç™¾å€ã€‚

**2ã€é«˜å¹¶å‘**

ä¸€èˆ¬åƒ MySQL è¿™ç±»çš„æ•°æ®åº“çš„ QPS å¤§æ¦‚éƒ½åœ¨ 4k å·¦å³ï¼ˆ4 æ ¸ 8gï¼‰ ï¼Œä½†æ˜¯ä½¿ç”¨ Redis ç¼“å­˜ä¹‹åå¾ˆå®¹æ˜“è¾¾åˆ° 5w+ï¼Œç”šè‡³èƒ½è¾¾åˆ° 10w+ï¼ˆå°±å•æœº Redis çš„æƒ…å†µï¼ŒRedis é›†ç¾¤çš„è¯ä¼šæ›´é«˜ï¼‰ã€‚

> QPSï¼ˆQuery Per Secondï¼‰ï¼šæœåŠ¡å™¨æ¯ç§’å¯ä»¥æ‰§è¡Œçš„æŸ¥è¯¢æ¬¡æ•°ï¼›

ç”±æ­¤å¯è§ï¼Œç›´æ¥æ“ä½œç¼“å­˜èƒ½å¤Ÿæ‰¿å—çš„æ•°æ®åº“è¯·æ±‚æ•°é‡æ˜¯è¿œè¿œå¤§äºç›´æ¥è®¿é—®æ•°æ®åº“çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥è€ƒè™‘æŠŠæ•°æ®åº“ä¸­çš„éƒ¨åˆ†æ•°æ®è½¬ç§»åˆ°ç¼“å­˜ä¸­å»ï¼Œè¿™æ ·ç”¨æˆ·çš„ä¸€éƒ¨åˆ†è¯·æ±‚ä¼šç›´æ¥åˆ°ç¼“å­˜è¿™é‡Œè€Œä¸ç”¨ç»è¿‡æ•°æ®åº“ã€‚è¿›è€Œï¼Œæˆ‘ä»¬ä¹Ÿå°±æé«˜äº†ç³»ç»Ÿæ•´ä½“çš„å¹¶å‘ã€‚

**3ã€åŠŸèƒ½å…¨é¢**

Redis é™¤äº†å¯ä»¥ç”¨ä½œç¼“å­˜ä¹‹å¤–ï¼Œè¿˜å¯ä»¥ç”¨äºåˆ†å¸ƒå¼é”ã€é™æµã€æ¶ˆæ¯é˜Ÿåˆ—ã€å»¶æ—¶é˜Ÿåˆ—ç­‰åœºæ™¯ï¼ŒåŠŸèƒ½å¼ºå¤§ï¼

### å¸¸è§çš„ç¼“å­˜è¯»å†™ç­–ç•¥æœ‰å“ªäº›ï¼Ÿ

å…³äºå¸¸è§çš„ç¼“å­˜è¯»å†™ç­–ç•¥çš„è¯¦ç»†ä»‹ç»ï¼Œå¯ä»¥çœ‹æˆ‘å†™çš„è¿™ç¯‡æ–‡ç« ï¼š[3 ç§å¸¸ç”¨çš„ç¼“å­˜è¯»å†™ç­–ç•¥è¯¦è§£](https://javaguide.cn/database/redis/3-commonly-used-cache-read-and-write-strategies.html) ã€‚ å‚è€ƒç¬”è®° [3ç§å¸¸ç”¨çš„ç¼“å­˜è¯»å†™ç­–ç•¥è¯¦è§£ï¼ˆæ›´æ–°ä¸­ï¼‰](# 3ç§å¸¸ç”¨çš„ç¼“å­˜è¯»å†™ç­–ç•¥è¯¦è§£ï¼ˆæ›´æ–°ä¸­ï¼‰) 

### ä»€ä¹ˆæ˜¯ Redis Moduleï¼Ÿæœ‰ä»€ä¹ˆç”¨ï¼Ÿ

Redis ä» 4.0 ç‰ˆæœ¬å¼€å§‹ï¼Œæ”¯æŒé€šè¿‡ Module æ¥æ‰©å±•å…¶åŠŸèƒ½ä»¥æ»¡è¶³ç‰¹æ®Šçš„éœ€æ±‚ã€‚è¿™äº› Module ä»¥**åŠ¨æ€é“¾æ¥åº“ï¼ˆso æ–‡ä»¶ï¼‰**çš„å½¢å¼è¢«åŠ è½½åˆ° Redis ä¸­ï¼Œè¿™æ˜¯ä¸€ç§éå¸¸çµæ´»çš„**åŠ¨æ€æ‰©å±•åŠŸèƒ½**çš„å®ç°æ–¹å¼ï¼Œå€¼å¾—å€Ÿé‰´å­¦ä¹ ï¼

æˆ‘ä»¬æ¯ä¸ªäººéƒ½å¯ä»¥åŸºäº Redis å»å®šåˆ¶åŒ–å¼€å‘è‡ªå·±çš„ Moduleï¼Œæ¯”å¦‚å®ç°æœç´¢å¼•æ“åŠŸèƒ½ã€è‡ªå®šä¹‰åˆ†å¸ƒå¼é”å’Œåˆ†å¸ƒå¼é™æµã€‚

ç›®å‰ï¼Œè¢« Redis å®˜æ–¹æ¨èçš„ Module æœ‰ï¼š

- [RediSearch](https://github.com/RediSearch/RediSearch)ï¼šç”¨äºå®ç°æœç´¢å¼•æ“çš„æ¨¡å—ã€‚
- [RedisJSON](https://github.com/RedisJSON/RedisJSON)ï¼šç”¨äºå¤„ç† JSON æ•°æ®çš„æ¨¡å—ã€‚
- [RedisGraph](https://github.com/RedisGraph/RedisGraph)ï¼šç”¨äºå®ç°å›¾å½¢æ•°æ®åº“çš„æ¨¡å—ã€‚
- [RedisTimeSeries](https://github.com/RedisTimeSeries/RedisTimeSeries)ï¼šç”¨äºå¤„ç†æ—¶é—´åºåˆ—æ•°æ®çš„æ¨¡å—ã€‚
- [RedisBloom](https://github.com/RedisBloom/RedisBloom)ï¼šç”¨äºå®ç°å¸ƒéš†è¿‡æ»¤å™¨çš„æ¨¡å—ã€‚
- [RedisAI](https://github.com/RedisAI/RedisAI)ï¼šç”¨äºæ‰§è¡Œæ·±åº¦å­¦ä¹ /æœºå™¨å­¦ä¹ æ¨¡å‹å¹¶ç®¡ç†å…¶æ•°æ®çš„æ¨¡å—ã€‚
- [RedisCell](https://github.com/brandur/redis-cell)ï¼šç”¨äºå®ç°åˆ†å¸ƒå¼é™æµçš„æ¨¡å—ã€‚
- â€¦â€¦

å…³äº Redis æ¨¡å—çš„è¯¦ç»†ä»‹ç»ï¼Œå¯ä»¥æŸ¥çœ‹å®˜æ–¹æ–‡æ¡£ï¼š[https://redis.io/modules](https://redis.io/modules)ã€‚

## Redis åº”ç”¨

### Redis é™¤äº†åšç¼“å­˜ï¼Œè¿˜èƒ½åšä»€ä¹ˆï¼Ÿ

- **åˆ†å¸ƒå¼é”**ï¼šé€šè¿‡ Redis æ¥åšåˆ†å¸ƒå¼é”æ˜¯ä¸€ç§æ¯”è¾ƒå¸¸è§çš„æ–¹å¼ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éƒ½æ˜¯åŸºäº Redisson æ¥å®ç°åˆ†å¸ƒå¼é”ã€‚å…³äº Redis å®ç°åˆ†å¸ƒå¼é”çš„è¯¦ç»†ä»‹ç»ï¼Œå¯ä»¥çœ‹æˆ‘å†™çš„è¿™ç¯‡æ–‡ç« ï¼š[åˆ†å¸ƒå¼é”è¯¦è§£](https://javaguide.cn/distributed-system/distributed-lock.html) ã€‚
- **é™æµ**ï¼šä¸€èˆ¬æ˜¯é€šè¿‡ Redis + Lua è„šæœ¬çš„æ–¹å¼æ¥å®ç°é™æµã€‚å¦‚æœä¸æƒ³è‡ªå·±å†™ Lua è„šæœ¬çš„è¯ï¼Œä¹Ÿå¯ä»¥ç›´æ¥åˆ©ç”¨ Redisson ä¸­çš„ `RRateLimiter` æ¥å®ç°åˆ†å¸ƒå¼é™æµï¼Œå…¶åº•å±‚å®ç°å°±æ˜¯åŸºäº Lua ä»£ç +ä»¤ç‰Œæ¡¶ç®—æ³•ã€‚
- **æ¶ˆæ¯é˜Ÿåˆ—**ï¼šRedis è‡ªå¸¦çš„ **List æ•°æ®ç»“æ„**å¯ä»¥ä½œä¸ºä¸€ä¸ªç®€å•çš„é˜Ÿåˆ—ä½¿ç”¨ã€‚Redis 5.0 ä¸­å¢åŠ çš„ Stream ç±»å‹çš„æ•°æ®ç»“æ„æ›´åŠ é€‚åˆç”¨æ¥åšæ¶ˆæ¯é˜Ÿåˆ—ã€‚å®ƒæ¯”è¾ƒç±»ä¼¼äº Kafkaï¼Œæœ‰ä¸»é¢˜å’Œæ¶ˆè´¹ç»„çš„æ¦‚å¿µï¼Œæ”¯æŒæ¶ˆæ¯æŒä¹…åŒ–ä»¥åŠ ACK æœºåˆ¶ã€‚
- **å»¶æ—¶é˜Ÿåˆ—**ï¼šRedisson å†…ç½®äº†å»¶æ—¶é˜Ÿåˆ—ï¼ˆåŸºäº Sorted Set å®ç°çš„ï¼‰ã€‚
- **åˆ†å¸ƒå¼ Session** ï¼šåˆ©ç”¨ String æˆ–è€… Hash æ•°æ®ç±»å‹ä¿å­˜ Session æ•°æ®ï¼Œæ‰€æœ‰çš„æœåŠ¡å™¨éƒ½å¯ä»¥è®¿é—®ã€‚
- **å¤æ‚ä¸šåŠ¡åœºæ™¯**ï¼šé€šè¿‡ Redis ä»¥åŠ Redis æ‰©å±•ï¼ˆæ¯”å¦‚ Redissonï¼‰æä¾›çš„æ•°æ®ç»“æ„ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆæ–¹ä¾¿åœ°å®Œæˆå¾ˆå¤šå¤æ‚çš„ä¸šåŠ¡åœºæ™¯æ¯”å¦‚é€šè¿‡ Bitmap ç»Ÿè®¡æ´»è·ƒç”¨æˆ·ã€é€šè¿‡ Sorted Set ç»´æŠ¤æ’è¡Œæ¦œã€‚
- â€¦â€¦

### å¦‚ä½•åŸºäº Redis å®ç°åˆ†å¸ƒå¼é”ï¼Ÿ

å…³äº Redis å®ç°åˆ†å¸ƒå¼é”çš„è¯¦ç»†ä»‹ç»ï¼Œå¯ä»¥çœ‹æˆ‘å†™çš„è¿™ç¯‡æ–‡ç« ï¼š[åˆ†å¸ƒå¼é”è¯¦è§£](https://javaguide.cn/distributed-system/distributed-lock-implementations.html) ã€‚

### Redis å¯ä»¥åšæ¶ˆæ¯é˜Ÿåˆ—ä¹ˆï¼Ÿ

> å®é™…é¡¹ç›®ä¸­ä½¿ç”¨ Redis æ¥åšæ¶ˆæ¯é˜Ÿåˆ—çš„éå¸¸å°‘ï¼Œæ¯•ç«Ÿæœ‰æ›´æˆç†Ÿçš„æ¶ˆæ¯é˜Ÿåˆ—ä¸­é—´ä»¶å¯ä»¥ç”¨ã€‚

å…ˆè¯´ç»“è®ºï¼š**å¯ä»¥æ˜¯å¯ä»¥ï¼Œä½†ä¸å»ºè®®ä½¿ç”¨ Redis æ¥åšæ¶ˆæ¯é˜Ÿåˆ—ã€‚å’Œä¸“ä¸šçš„æ¶ˆæ¯é˜Ÿåˆ—ç›¸æ¯”ï¼Œè¿˜æ˜¯æœ‰å¾ˆå¤šæ¬ ç¼ºçš„åœ°æ–¹ã€‚**

**Redis 2.0 ä¹‹å‰ï¼Œå¦‚æœæƒ³è¦ä½¿ç”¨ Redis æ¥åšæ¶ˆæ¯é˜Ÿåˆ—çš„è¯ï¼Œåªèƒ½é€šè¿‡ List æ¥å®ç°ã€‚**

é€šè¿‡ `RPUSH/LPOP` æˆ–è€… `LPUSH/RPOP`å³å¯å®ç°ç®€æ˜“ç‰ˆæ¶ˆæ¯é˜Ÿåˆ—ï¼š

```bash
# ç”Ÿäº§è€…ç”Ÿäº§æ¶ˆæ¯
> RPUSH myList msg1 msg2
(integer) 2
> RPUSH myList msg3
(integer) 3
# æ¶ˆè´¹è€…æ¶ˆè´¹æ¶ˆæ¯
> LPOP myList
"msg1"
```

ä¸è¿‡ï¼Œé€šè¿‡ `RPUSH/LPOP` æˆ–è€… `LPUSH/RPOP`è¿™æ ·çš„æ–¹å¼å­˜åœ¨æ€§èƒ½é—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦ä¸æ–­è½®è¯¢å»è°ƒç”¨ `RPOP` æˆ– `LPOP` æ¥æ¶ˆè´¹æ¶ˆæ¯ã€‚å½“ List ä¸ºç©ºæ—¶ï¼Œå¤§éƒ¨åˆ†çš„è½®è¯¢çš„è¯·æ±‚éƒ½æ˜¯æ— æ•ˆè¯·æ±‚ï¼Œè¿™ç§æ–¹å¼å¤§é‡æµªè´¹äº†ç³»ç»Ÿèµ„æºã€‚

å› æ­¤ï¼ŒRedis è¿˜æä¾›äº† `BLPOP`ã€`BRPOP` è¿™ç§é˜»å¡å¼è¯»å–çš„å‘½ä»¤ï¼ˆå¸¦ B-Blocking çš„éƒ½æ˜¯é˜»å¡å¼ï¼‰ï¼Œå¹¶ä¸”è¿˜æ”¯æŒä¸€ä¸ªè¶…æ—¶å‚æ•°ã€‚å¦‚æœ List ä¸ºç©ºï¼ŒRedis æœåŠ¡ç«¯ä¸ä¼šç«‹åˆ»è¿”å›ç»“æœï¼Œå®ƒä¼šç­‰å¾… List ä¸­æœ‰æ–°æ•°æ®åå†è¿”å›æˆ–è€…æ˜¯ç­‰å¾…æœ€å¤šä¸€ä¸ªè¶…æ—¶æ—¶é—´åè¿”å›ç©ºã€‚å¦‚æœå°†è¶…æ—¶æ—¶é—´è®¾ç½®ä¸º 0 æ—¶ï¼Œå³å¯æ— é™ç­‰å¾…ï¼Œç›´åˆ°å¼¹å‡ºæ¶ˆæ¯

```bash
# è¶…æ—¶æ—¶é—´ä¸º 10s
# å¦‚æœæœ‰æ•°æ®ç«‹åˆ»è¿”å›ï¼Œå¦åˆ™æœ€å¤šç­‰å¾…10ç§’
> BRPOP myList 10
null
```

**List å®ç°æ¶ˆæ¯é˜Ÿåˆ—åŠŸèƒ½å¤ªç®€å•ï¼Œåƒæ¶ˆæ¯ç¡®è®¤æœºåˆ¶ç­‰åŠŸèƒ½è¿˜éœ€è¦æˆ‘ä»¬è‡ªå·±å®ç°ï¼Œæœ€è¦å‘½çš„æ˜¯æ²¡æœ‰å¹¿æ’­æœºåˆ¶ï¼Œæ¶ˆæ¯ä¹Ÿåªèƒ½è¢«æ¶ˆè´¹ä¸€æ¬¡ã€‚**

**Redis 2.0 å¼•å…¥äº†==å‘å¸ƒè®¢é˜… (pub/sub) åŠŸèƒ½==ï¼Œè§£å†³äº† List å®ç°æ¶ˆæ¯é˜Ÿåˆ—æ²¡æœ‰å¹¿æ’­æœºåˆ¶çš„é—®é¢˜ã€‚**

![](images\redis-pub-sub.png)

pub/sub ä¸­å¼•så…¥äº†ä¸€ä¸ªæ¦‚å¿µå« ==**channelï¼ˆé¢‘é“ï¼‰**==ï¼Œå‘å¸ƒè®¢é˜…æœºåˆ¶çš„å®ç°å°±æ˜¯åŸºäºè¿™ä¸ª channel æ¥åšçš„ã€‚

pub/sub æ¶‰åŠå‘å¸ƒè€…ï¼ˆPublisherï¼‰å’Œè®¢é˜…è€…ï¼ˆSubscriberï¼Œä¹Ÿå«æ¶ˆè´¹è€…ï¼‰ä¸¤ä¸ªè§’è‰²ï¼š

- å‘å¸ƒè€…é€šè¿‡ `PUBLISH` æŠ•é€’æ¶ˆæ¯ç»™æŒ‡å®š channelã€‚
- è®¢é˜…è€…é€šè¿‡`SUBSCRIBE`è®¢é˜…å®ƒå…³å¿ƒçš„ channelã€‚å¹¶ä¸”ï¼Œè®¢é˜…è€…å¯ä»¥è®¢é˜…ä¸€ä¸ªæˆ–è€…å¤šä¸ª channelã€‚

æˆ‘ä»¬è¿™é‡Œå¯åŠ¨ 3 ä¸ª Redis å®¢æˆ·ç«¯æ¥ç®€å•æ¼”ç¤ºä¸€ä¸‹ï¼š

![](images\redis-pubsub-message-queue.png)

pub/sub æ—¢èƒ½å•æ’­åˆèƒ½å¹¿æ’­ï¼Œè¿˜æ”¯æŒ channel çš„ç®€å•æ­£åˆ™åŒ¹é…ã€‚ä¸è¿‡ï¼Œæ¶ˆæ¯ä¸¢å¤±ï¼ˆå®¢æˆ·ç«¯æ–­å¼€è¿æ¥æˆ–è€… Redis å®•æœºéƒ½ä¼šå¯¼è‡´æ¶ˆæ¯ä¸¢å¤±ï¼‰ã€æ¶ˆæ¯å †ç§¯ï¼ˆå‘å¸ƒè€…å‘å¸ƒæ¶ˆæ¯çš„æ—¶å€™ä¸ä¼šç®¡æ¶ˆè´¹è€…çš„å…·ä½“æ¶ˆè´¹èƒ½åŠ›å¦‚ä½•ï¼‰ç­‰é—®é¢˜ä¾ç„¶æ²¡æœ‰ä¸€ä¸ªæ¯”è¾ƒå¥½çš„è§£å†³åŠæ³•ã€‚

ä¸ºæ­¤ï¼ŒRedis 5.0 æ–°å¢åŠ çš„ä¸€ä¸ª**æ•°æ®ç»“æ„ `Stream`** æ¥åšæ¶ˆæ¯é˜Ÿåˆ—ã€‚`Stream` æ”¯æŒï¼š

- å‘å¸ƒ / è®¢é˜…æ¨¡å¼
- æŒ‰ç…§æ¶ˆè´¹è€…ç»„è¿›è¡Œæ¶ˆè´¹ï¼ˆå€Ÿé‰´äº† Kafka æ¶ˆè´¹è€…ç»„çš„æ¦‚å¿µï¼‰
- æ¶ˆæ¯æŒä¹…åŒ–ï¼ˆ RDB å’Œ AOFï¼‰
- ACK æœºåˆ¶ï¼ˆé€šè¿‡ç¡®è®¤æœºåˆ¶æ¥å‘ŠçŸ¥å·²ç»æˆåŠŸå¤„ç†äº†æ¶ˆæ¯ï¼‰
- é˜»å¡å¼è·å–æ¶ˆæ¯

`Stream` çš„ç»“æ„å¦‚ä¸‹ï¼š

![](images\redis-stream-structure.png)

è¿™æ˜¯ä¸€ä¸ª**æœ‰åºçš„æ¶ˆæ¯é“¾è¡¨**ï¼Œæ¯ä¸ªæ¶ˆæ¯éƒ½æœ‰ä¸€ä¸ª**å”¯ä¸€çš„ ID** å’Œ**å¯¹åº”çš„å†…å®¹**ã€‚ID æ˜¯ä¸€ä¸ªæ—¶é—´æˆ³å’Œåºåˆ—å·çš„ç»„åˆï¼Œç”¨æ¥ä¿è¯æ¶ˆæ¯çš„å”¯ä¸€æ€§å’Œé€’å¢æ€§ã€‚å†…å®¹æ˜¯ä¸€ä¸ªæˆ–å¤šä¸ªé”®å€¼å¯¹ï¼ˆç±»ä¼¼ Hash åŸºæœ¬æ•°æ®ç±»å‹ï¼‰ï¼Œç”¨æ¥å­˜å‚¨æ¶ˆæ¯çš„æ•°æ®ã€‚

è¿™é‡Œå†å¯¹å›¾ä¸­æ¶‰åŠåˆ°çš„ä¸€äº›æ¦‚å¿µï¼Œè¿›è¡Œç®€å•è§£é‡Šï¼š

- **`Consumer Group`**ï¼š**æ¶ˆè´¹è€…ç»„**ç”¨äºç»„ç»‡å’Œç®¡ç†å¤šä¸ªæ¶ˆè´¹è€…ã€‚æ¶ˆè´¹è€…ç»„æœ¬èº«ä¸å¤„ç†æ¶ˆæ¯ï¼Œè€Œæ˜¯å†å°†æ¶ˆæ¯åˆ†å‘ç»™æ¶ˆè´¹è€…ï¼Œç”±æ¶ˆè´¹è€…è¿›è¡ŒçœŸæ­£çš„æ¶ˆè´¹ã€‚
- **`last_delivered_id`**ï¼šæ ‡è¯†æ¶ˆè´¹è€…ç»„å½“å‰æ¶ˆè´¹ä½ç½®çš„æ¸¸æ ‡ï¼Œæ¶ˆè´¹è€…ç»„ä¸­ä»»æ„ä¸€ä¸ªæ¶ˆè´¹è€…è¯»å–äº†æ¶ˆæ¯éƒ½ä¼šä½¿ last_delivered_id å¾€å‰ç§»åŠ¨ã€‚
- **`pending_ids`**ï¼šè®°å½•å·²ç»è¢«å®¢æˆ·ç«¯æ¶ˆè´¹ä½†æ²¡æœ‰ ack çš„æ¶ˆæ¯çš„ IDã€‚

ä¸‹é¢æ˜¯`Stream` ç”¨ä½œæ¶ˆæ¯é˜Ÿåˆ—æ—¶å¸¸ç”¨çš„å‘½ä»¤ï¼š

- `XADD`ï¼šå‘æµä¸­æ·»åŠ æ–°çš„æ¶ˆæ¯ã€‚
- `XREAD`ï¼šä»æµä¸­è¯»å–æ¶ˆæ¯ã€‚
- `XREADGROUP`ï¼šä»æ¶ˆè´¹ç»„ä¸­è¯»å–æ¶ˆæ¯ã€‚
- `XRANGE`ï¼šæ ¹æ®æ¶ˆæ¯ ID èŒƒå›´è¯»å–æµä¸­çš„æ¶ˆæ¯ã€‚
- `XREVRANGE`ï¼šä¸ `XRANGE` ç±»ä¼¼ï¼Œä½†ä»¥ç›¸åé¡ºåºè¿”å›ç»“æœã€‚
- `XDEL`ï¼šä»æµä¸­åˆ é™¤æ¶ˆæ¯ã€‚
- `XTRIM`ï¼šä¿®å‰ªæµçš„é•¿åº¦ï¼Œå¯ä»¥æŒ‡å®šä¿®å»ºç­–ç•¥ï¼ˆ`MAXLEN`/`MINID`ï¼‰ã€‚
- `XLEN`ï¼šè·å–æµçš„é•¿åº¦ã€‚
- `XGROUP CREATE`ï¼šåˆ›å»ºæ¶ˆè´¹è€…ç»„ã€‚
- `XGROUP DESTROY` ï¼š åˆ é™¤æ¶ˆè´¹è€…ç»„
- `XGROUP DELCONSUMER`ï¼šä»æ¶ˆè´¹è€…ç»„ä¸­åˆ é™¤ä¸€ä¸ªæ¶ˆè´¹è€…ã€‚
- `XGROUP SETID`ï¼šä¸ºæ¶ˆè´¹è€…ç»„è®¾ç½®æ–°çš„æœ€åé€’é€æ¶ˆæ¯ ID
- `XACK`ï¼šç¡®è®¤æ¶ˆè´¹ç»„ä¸­çš„æ¶ˆæ¯å·²è¢«å¤„ç†ã€‚
- `XPENDING`ï¼šæŸ¥è¯¢æ¶ˆè´¹ç»„ä¸­æŒ‚èµ·ï¼ˆæœªç¡®è®¤ï¼‰çš„æ¶ˆæ¯ã€‚
- `XCLAIM`ï¼šå°†æŒ‚èµ·çš„æ¶ˆæ¯ä»ä¸€ä¸ªæ¶ˆè´¹è€…è½¬ç§»åˆ°å¦ä¸€ä¸ªæ¶ˆè´¹è€…ã€‚
- `XINFO`ï¼šè·å–æµ(`XINFO STREAM`)ã€æ¶ˆè´¹ç»„(`XINFO GROUPS`)æˆ–æ¶ˆè´¹è€…(`XINFO CONSUMERS`)çš„è¯¦ç»†ä¿¡æ¯ã€‚

`Stream` ä½¿ç”¨èµ·æ¥ç›¸å¯¹è¦éº»çƒ¦ä¸€äº›ï¼Œè¿™é‡Œå°±ä¸æ¼”ç¤ºäº†ã€‚

æ€»çš„æ¥è¯´ï¼Œ`Stream` å·²ç»å¯ä»¥æ»¡è¶³ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—çš„åŸºæœ¬è¦æ±‚äº†ã€‚ä¸è¿‡ï¼Œ`Stream` åœ¨å®é™…ä½¿ç”¨ä¸­ä¾ç„¶ä¼šæœ‰ä¸€äº›å°é—®é¢˜ä¸å¤ªå¥½è§£å†³æ¯”å¦‚åœ¨ Redis å‘ç”Ÿæ•…éšœæ¢å¤åä¸èƒ½ä¿è¯æ¶ˆæ¯è‡³å°‘è¢«æ¶ˆè´¹ä¸€æ¬¡ã€‚

ç»¼ä¸Šï¼Œå’Œä¸“ä¸šçš„æ¶ˆæ¯é˜Ÿåˆ—ç›¸æ¯”ï¼Œä½¿ç”¨ Redis æ¥å®ç°æ¶ˆæ¯é˜Ÿåˆ—è¿˜æ˜¯æœ‰å¾ˆå¤šæ¬ ç¼ºçš„åœ°æ–¹æ¯”å¦‚**æ¶ˆæ¯ä¸¢å¤±å’Œå †ç§¯é—®é¢˜**ä¸å¥½è§£å†³ã€‚å› æ­¤ï¼Œæˆ‘ä»¬é€šå¸¸å»ºè®®ä¸è¦ä½¿ç”¨ Redis æ¥åšæ¶ˆæ¯é˜Ÿåˆ—ï¼Œä½ å®Œå…¨å¯ä»¥é€‰æ‹©å¸‚é¢ä¸Šæ¯”è¾ƒæˆç†Ÿçš„ä¸€äº›æ¶ˆæ¯é˜Ÿåˆ—æ¯”å¦‚ RocketMQã€Kafkaã€‚ä¸è¿‡ï¼Œå¦‚æœä½ å°±æ˜¯æƒ³è¦ç”¨ Redis æ¥åšæ¶ˆæ¯é˜Ÿåˆ—çš„è¯ï¼Œé‚£æˆ‘å»ºè®®ä½ ä¼˜å…ˆè€ƒè™‘ `Stream`ï¼Œè¿™æ˜¯ç›®å‰ç›¸å¯¹æœ€ä¼˜çš„ Redis æ¶ˆæ¯é˜Ÿåˆ—å®ç°ã€‚

ç›¸å…³é˜…è¯»ï¼š[Redis æ¶ˆæ¯é˜Ÿåˆ—å‘å±•å†ç¨‹ - é˜¿é‡Œå¼€å‘è€… - 2022](https://mp.weixin.qq.com/s/gCUT5TcCQRAxYkTJfTRjJw)ã€‚

### Redis å¯ä»¥åšæœç´¢å¼•æ“ä¹ˆï¼Ÿ

Redis æ˜¯å¯ä»¥å®ç°å…¨æ–‡æœç´¢å¼•æ“åŠŸèƒ½çš„ï¼Œéœ€è¦å€ŸåŠ© **RediSearch** ï¼Œè¿™æ˜¯ä¸€ä¸ªåŸºäº Redis çš„**æœç´¢å¼•æ“æ¨¡å—**ã€‚

RediSearch æ”¯æŒä¸­æ–‡åˆ†è¯ã€èšåˆç»Ÿè®¡ã€åœç”¨è¯ã€åŒä¹‰è¯ã€æ‹¼å†™æ£€æŸ¥ã€æ ‡ç­¾æŸ¥è¯¢ã€å‘é‡ç›¸ä¼¼åº¦æŸ¥è¯¢ã€å¤šå…³é”®è¯æœç´¢ã€åˆ†é¡µæœç´¢ç­‰åŠŸèƒ½ï¼Œç®—æ˜¯ä¸€ä¸ªåŠŸèƒ½æ¯”è¾ƒå®Œå–„çš„å…¨æ–‡æœç´¢å¼•æ“äº†ã€‚

ç›¸æ¯”è¾ƒäº Elasticsearch æ¥è¯´ï¼ŒRediSearch ä¸»è¦åœ¨ä¸‹é¢ä¸¤ç‚¹ä¸Šè¡¨ç°æ›´ä¼˜å¼‚ä¸€äº›ï¼š

1. æ€§èƒ½æ›´ä¼˜ç§€ï¼šä¾èµ– Redis è‡ªèº«çš„é«˜æ€§èƒ½ï¼ŒåŸºäºå†…å­˜æ“ä½œï¼ˆElasticsearch åŸºäºç£ç›˜ï¼‰ã€‚
2. è¾ƒä½å†…å­˜å ç”¨å®ç°å¿«é€Ÿç´¢å¼•ï¼šRediSearch å†…éƒ¨ä½¿ç”¨å‹ç¼©çš„å€’æ’ç´¢å¼•ï¼Œæ‰€ä»¥å¯ä»¥ç”¨è¾ƒä½çš„å†…å­˜å ç”¨æ¥å®ç°ç´¢å¼•çš„å¿«é€Ÿæ„å»ºã€‚

å¯¹äºå°å‹é¡¹ç›®çš„ç®€å•æœç´¢åœºæ™¯æ¥è¯´ï¼Œä½¿ç”¨ RediSearch æ¥ä½œä¸ºæœç´¢å¼•æ“è¿˜æ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼ˆæ­é… RedisJSON ä½¿ç”¨ï¼‰ã€‚

å¯¹äºæ¯”è¾ƒå¤æ‚æˆ–è€…æ•°æ®è§„æ¨¡è¾ƒå¤§çš„æœç´¢åœºæ™¯è¿˜æ˜¯ä¸å¤ªå»ºè®®ä½¿ç”¨ RediSearch æ¥ä½œä¸ºæœç´¢å¼•æ“ï¼Œä¸»è¦æ˜¯å› ä¸ºä¸‹é¢è¿™äº›é™åˆ¶å’Œé—®é¢˜ï¼š

1. **æ•°æ®é‡é™åˆ¶**ï¼šElasticsearch å¯ä»¥æ”¯æŒ PB çº§åˆ«çš„æ•°æ®é‡ï¼Œå¯ä»¥è½»æ¾æ‰©å±•åˆ°å¤šä¸ªèŠ‚ç‚¹ï¼Œåˆ©ç”¨åˆ†ç‰‡æœºåˆ¶æé«˜å¯ç”¨æ€§å’Œæ€§èƒ½ã€‚RedisSearch æ˜¯åŸºäº Redis å®ç°çš„ï¼Œå…¶èƒ½å­˜å‚¨çš„æ•°æ®é‡å—é™äº Redis çš„å†…å­˜å®¹é‡ï¼Œä¸å¤ªé€‚åˆå­˜å‚¨å¤§è§„æ¨¡çš„æ•°æ®ï¼ˆå†…å­˜æ˜‚è´µï¼Œæ‰©å±•èƒ½åŠ›è¾ƒå·®ï¼‰ã€‚
2. **åˆ†å¸ƒå¼èƒ½åŠ›è¾ƒå·®**ï¼šElasticsearch æ˜¯ä¸ºåˆ†å¸ƒå¼ç¯å¢ƒè®¾è®¡çš„ï¼Œå¯ä»¥è½»æ¾æ‰©å±•åˆ°å¤šä¸ªèŠ‚ç‚¹ã€‚è™½ç„¶ RedisSearch æ”¯æŒåˆ†å¸ƒå¼éƒ¨ç½²ï¼Œä½†åœ¨å®é™…åº”ç”¨ä¸­å¯èƒ½ä¼šé¢ä¸´ä¸€äº›æŒ‘æˆ˜ï¼Œå¦‚æ•°æ®åˆ†ç‰‡ã€èŠ‚ç‚¹é—´é€šä¿¡ã€æ•°æ®ä¸€è‡´æ€§ç­‰é—®é¢˜ã€‚
3. **èšåˆåŠŸèƒ½è¾ƒå¼±**ï¼šElasticsearch æä¾›äº†ä¸°å¯Œçš„èšåˆåŠŸèƒ½ï¼Œè€Œ RediSearch çš„èšåˆåŠŸèƒ½ç›¸å¯¹è¾ƒå¼±ï¼Œåªæ”¯æŒç®€å•çš„èšåˆæ“ä½œã€‚
4. **ç”Ÿæ€è¾ƒå·®**ï¼šElasticsearch å¯ä»¥è½»æ¾å’Œå¸¸è§çš„ä¸€äº›ç³»ç»Ÿ/è½¯ä»¶é›†æˆæ¯”å¦‚ Hadoopã€Sparkã€Kibanaï¼Œè€Œ RedisSearch åˆ™ä¸å…·å¤‡è¯¥ä¼˜åŠ¿ã€‚

Elasticsearch é€‚ç”¨äºå…¨æ–‡æœç´¢ã€å¤æ‚æŸ¥è¯¢ã€å®æ—¶æ•°æ®åˆ†æå’Œèšåˆçš„åœºæ™¯ï¼Œè€Œ RediSearch é€‚ç”¨äºå¿«é€Ÿæ•°æ®å­˜å‚¨ã€ç¼“å­˜å’Œç®€å•æŸ¥è¯¢çš„åœºæ™¯ã€‚

### å¦‚ä½•åŸºäº Redis å®ç°å»¶æ—¶ä»»åŠ¡ï¼Ÿ

> ç±»ä¼¼çš„é—®é¢˜ï¼š
>
> - è®¢å•åœ¨ 10 åˆ†é’Ÿåæœªæ”¯ä»˜å°±å¤±æ•ˆï¼Œå¦‚ä½•ç”¨ Redis å®ç°ï¼Ÿ
> - çº¢åŒ… 24 å°æ—¶æœªè¢«æŸ¥æ”¶è‡ªåŠ¨é€€è¿˜ï¼Œå¦‚ä½•ç”¨ Redis å®ç°ï¼Ÿ

åŸºäº Redis å®ç°å»¶æ—¶ä»»åŠ¡çš„åŠŸèƒ½æ— éå°±ä¸‹é¢ä¸¤ç§æ–¹æ¡ˆï¼š

1. Redis è¿‡æœŸäº‹ä»¶ç›‘å¬
2. Redisson å†…ç½®çš„å»¶æ—¶é˜Ÿåˆ—

Redis è¿‡æœŸäº‹ä»¶ç›‘å¬çš„å­˜åœ¨æ—¶æ•ˆæ€§è¾ƒå·®ã€ä¸¢æ¶ˆæ¯ã€å¤šæœåŠ¡å®ä¾‹ä¸‹æ¶ˆæ¯é‡å¤æ¶ˆè´¹ç­‰é—®é¢˜ï¼Œä¸è¢«æ¨èä½¿ç”¨ã€‚

Redisson å†…ç½®çš„å»¶æ—¶é˜Ÿåˆ—å…·å¤‡ä¸‹é¢è¿™äº›ä¼˜åŠ¿ï¼š

1. **å‡å°‘äº†ä¸¢æ¶ˆæ¯çš„å¯èƒ½**ï¼šDelayedQueue ä¸­çš„æ¶ˆæ¯ä¼šè¢«æŒä¹…åŒ–ï¼Œå³ä½¿ Redis å®•æœºäº†ï¼Œæ ¹æ®æŒä¹…åŒ–æœºåˆ¶ï¼Œä¹Ÿåªå¯èƒ½ä¸¢å¤±ä¸€ç‚¹æ¶ˆæ¯ï¼Œå½±å“ä¸å¤§ã€‚å½“ç„¶äº†ï¼Œä½ ä¹Ÿå¯ä»¥ä½¿ç”¨æ‰«ææ•°æ®åº“çš„æ–¹æ³•ä½œä¸ºè¡¥å¿æœºåˆ¶ã€‚
2. **æ¶ˆæ¯ä¸å­˜åœ¨é‡å¤æ¶ˆè´¹é—®é¢˜**ï¼šæ¯ä¸ªå®¢æˆ·ç«¯éƒ½æ˜¯ä»åŒä¸€ä¸ªç›®æ ‡é˜Ÿåˆ—ä¸­è·å–ä»»åŠ¡çš„ï¼Œä¸å­˜åœ¨é‡å¤æ¶ˆè´¹çš„é—®é¢˜ã€‚

å…³äº Redis å®ç°å»¶æ—¶ä»»åŠ¡çš„è¯¦ç»†ä»‹ç»ï¼Œå¯ä»¥çœ‹æˆ‘å†™çš„è¿™ç¯‡æ–‡ç« ï¼š[å¦‚ä½•åŸºäº Redis å®ç°å»¶æ—¶ä»»åŠ¡ï¼Ÿ]()ã€‚  å‚è€ƒç¬”è®° [å¦‚ä½•åŸºäºRediså®ç°å»¶æ—¶ä»»åŠ¡ï¼ˆæ›´æ–°ä¸­ï¼‰](# å¦‚ä½•åŸºäºRediså®ç°å»¶æ—¶ä»»åŠ¡ï¼ˆæ›´æ–°ä¸­ï¼‰) 

## Redis æ•°æ®ç±»å‹

å…³äº Redis 5 ç§åŸºç¡€æ•°æ®ç±»å‹å’Œ 3 ç§ç‰¹æ®Šæ•°æ®ç±»å‹çš„è¯¦ç»†ä»‹ç»è¯·çœ‹ä¸‹é¢è¿™ä¸¤ç¯‡æ–‡ç« ä»¥åŠ [Redis å®˜æ–¹æ–‡æ¡£](https://redis.io/docs/data-types/) ï¼š

- [ Redis 5 ç§åŸºæœ¬æ•°æ®ç±»å‹è¯¦è§£](https://javaguide.cn/database/redis/redis-data-structures-01.html)  å‚è€ƒç¬”è®° [Redis 5 ç§åŸºæœ¬æ•°æ®ç±»å‹è¯¦è§£ï¼ˆæ›´æ–°ä¸­ï¼‰ ](# Redis 5 ç§åŸºæœ¬æ•°æ®ç±»å‹è¯¦è§£ï¼ˆæ›´æ–°ä¸­ï¼‰) 
- [Redis 3 ç§ç‰¹æ®Šæ•°æ®ç±»å‹è¯¦è§£ ](https://javaguide.cn/database/redis/redis-data-structures-02.html)  å‚è€ƒç¬”è®° [Redis 3 ç§ç‰¹æ®Šæ•°æ®ç±»å‹è¯¦è§£ï¼ˆæ›´æ–°ä¸­ï¼‰](# Redis 3 ç§ç‰¹æ®Šæ•°æ®ç±»å‹è¯¦è§£ï¼ˆæ›´æ–°ä¸­ï¼‰) 

### Redis å¸¸ç”¨çš„æ•°æ®ç±»å‹æœ‰å“ªäº›ï¼Ÿ

Redis ä¸­æ¯”è¾ƒå¸¸è§çš„æ•°æ®ç±»å‹æœ‰ä¸‹é¢è¿™äº›ï¼š

- **5 ç§åŸºç¡€æ•°æ®ç±»å‹**ï¼šStringï¼ˆå­—ç¬¦ä¸²ï¼‰ã€Listï¼ˆåˆ—è¡¨ï¼‰ã€Setï¼ˆé›†åˆï¼‰ã€Hashï¼ˆæ•£åˆ—ï¼‰ã€Zsetï¼ˆæœ‰åºé›†åˆï¼‰ã€‚
- **3 ç§ç‰¹æ®Šæ•°æ®ç±»å‹**ï¼šHyperLogLogï¼ˆåŸºæ•°ç»Ÿè®¡ï¼‰ã€Bitmap ï¼ˆä½å›¾ï¼‰ã€Geospatial (åœ°ç†ä½ç½®)ã€‚

é™¤äº†ä¸Šé¢æåˆ°çš„ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€äº›å…¶ä»–çš„æ¯”å¦‚ [Bloom filterï¼ˆå¸ƒéš†è¿‡æ»¤å™¨ï¼‰](https://javaguide.cn/cs-basics/data-structure/bloom-filter.html)ã€Bitfieldï¼ˆä½åŸŸï¼‰ã€‚

### String çš„åº”ç”¨åœºæ™¯æœ‰å“ªäº›ï¼Ÿ

String æ˜¯ Redis ä¸­æœ€ç®€å•åŒæ—¶ä¹Ÿæ˜¯æœ€å¸¸ç”¨çš„ä¸€ä¸ªæ•°æ®ç±»å‹ã€‚å®ƒæ˜¯ä¸€ç§äºŒè¿›åˆ¶å®‰å…¨çš„æ•°æ®ç±»å‹ï¼Œå¯ä»¥ç”¨æ¥å­˜å‚¨ä»»ä½•ç±»å‹çš„æ•°æ®æ¯”å¦‚å­—ç¬¦ä¸²ã€æ•´æ•°ã€æµ®ç‚¹æ•°ã€å›¾ç‰‡ï¼ˆå›¾ç‰‡çš„ base64 ç¼–ç æˆ–è€…è§£ç æˆ–è€…å›¾ç‰‡çš„è·¯å¾„ï¼‰ã€åºåˆ—åŒ–åçš„å¯¹è±¡ã€‚

String çš„å¸¸è§åº”ç”¨åœºæ™¯å¦‚ä¸‹ï¼š

- å¸¸è§„æ•°æ®ï¼ˆæ¯”å¦‚ Sessionã€Tokenã€åºåˆ—åŒ–åçš„å¯¹è±¡ã€å›¾ç‰‡çš„è·¯å¾„ï¼‰çš„ç¼“å­˜ï¼›
- è®¡æ•°æ¯”å¦‚ç”¨æˆ·å•ä½æ—¶é—´çš„è¯·æ±‚æ•°ï¼ˆç®€å•é™æµå¯ä»¥ç”¨åˆ°ï¼‰ã€é¡µé¢å•ä½æ—¶é—´çš„è®¿é—®æ•°ï¼›
- åˆ†å¸ƒå¼é”(åˆ©ç”¨ `SETNX key value` å‘½ä»¤å¯ä»¥å®ç°ä¸€ä¸ªæœ€ç®€æ˜“çš„åˆ†å¸ƒå¼é”)ï¼›
- â€¦â€¦

å…³äº String çš„è¯¦ç»†ä»‹ç»è¯·çœ‹è¿™ç¯‡æ–‡ç« ï¼š[Redis 5 ç§åŸºæœ¬æ•°æ®ç±»å‹è¯¦è§£](https://javaguide.cn/database/redis/redis-data-structures-01.html)  å‚è€ƒç¬”è®° [Redis 5 ç§åŸºæœ¬æ•°æ®ç±»å‹è¯¦è§£ï¼ˆæ›´æ–°ä¸­ï¼‰ ](# Redis 5 ç§åŸºæœ¬æ•°æ®ç±»å‹è¯¦è§£ï¼ˆæ›´æ–°ä¸­ï¼‰)  ã€‚

### String è¿˜æ˜¯ Hash å­˜å‚¨å¯¹è±¡æ•°æ®æ›´å¥½å‘¢ï¼Ÿ

- String å­˜å‚¨çš„æ˜¯åºåˆ—åŒ–åçš„å¯¹è±¡æ•°æ®ï¼Œ**å­˜æ”¾çš„æ˜¯æ•´ä¸ªå¯¹è±¡**ã€‚Hash æ˜¯å¯¹**å¯¹è±¡çš„æ¯ä¸ªå­—æ®µå•ç‹¬å­˜å‚¨**ï¼Œå¯ä»¥è·å–éƒ¨åˆ†å­—æ®µçš„ä¿¡æ¯ï¼Œä¹Ÿå¯ä»¥ä¿®æ”¹æˆ–è€…æ·»åŠ éƒ¨åˆ†å­—æ®µï¼ŒèŠ‚çœç½‘ç»œæµé‡ã€‚å¦‚æœå¯¹è±¡ä¸­æŸäº›å­—æ®µéœ€è¦ç»å¸¸å˜åŠ¨æˆ–è€…ç»å¸¸éœ€è¦å•ç‹¬æŸ¥è¯¢å¯¹è±¡ä¸­çš„ä¸ªåˆ«å­—æ®µä¿¡æ¯ï¼ŒHash å°±éå¸¸é€‚åˆã€‚
- String å­˜å‚¨ç›¸å¯¹æ¥è¯´æ›´åŠ èŠ‚çœå†…å­˜ï¼Œç¼“å­˜ç›¸åŒæ•°é‡çš„å¯¹è±¡æ•°æ®ï¼Œ**String æ¶ˆè€—çš„å†…å­˜çº¦æ˜¯ Hash çš„ä¸€åŠ**ã€‚å¹¶ä¸”ï¼Œå­˜å‚¨å…·æœ‰å¤šå±‚åµŒå¥—çš„å¯¹è±¡æ—¶ä¹Ÿæ–¹ä¾¿å¾ˆå¤šã€‚å¦‚æœç³»ç»Ÿå¯¹æ€§èƒ½å’Œèµ„æºæ¶ˆè€—éå¸¸æ•æ„Ÿçš„è¯ï¼ŒString å°±éå¸¸é€‚åˆã€‚

åœ¨ç»å¤§éƒ¨åˆ†æƒ…å†µï¼Œæˆ‘ä»¬å»ºè®®ä½¿ç”¨ String æ¥å­˜å‚¨å¯¹è±¡æ•°æ®å³å¯ï¼

### String çš„åº•å±‚å®ç°æ˜¯ä»€ä¹ˆï¼Ÿ

Redis æ˜¯**åŸºäº C è¯­è¨€ç¼–å†™**çš„ï¼Œä½† Redis çš„ String ç±»å‹çš„åº•å±‚å®ç°å¹¶ä¸æ˜¯ C è¯­è¨€ä¸­çš„å­—ç¬¦ä¸²ï¼ˆå³ä»¥ç©ºå­—ç¬¦ `\0` ç»“å°¾çš„å­—ç¬¦æ•°ç»„ï¼‰ï¼Œè€Œæ˜¯è‡ªå·±ç¼–å†™äº† **[SDS](https://github.com/antirez/sds)ï¼ˆSimple Dynamic Stringï¼Œç®€å•åŠ¨æ€å­—ç¬¦ä¸²ï¼‰** æ¥ä½œä¸ºåº•å±‚å®ç°ã€‚

SDS æœ€æ—©æ˜¯ Redis ä½œè€…ä¸ºæ—¥å¸¸ C è¯­è¨€å¼€å‘è€Œè®¾è®¡çš„ C å­—ç¬¦ä¸²ï¼Œåæ¥è¢«åº”ç”¨åˆ°äº† Redis ä¸Šï¼Œå¹¶ç»è¿‡äº†å¤§é‡çš„ä¿®æ”¹å®Œå–„ä»¥é€‚åˆé«˜æ€§èƒ½æ“ä½œã€‚

Redis7.0 çš„ SDS çš„éƒ¨åˆ†æºç å¦‚ä¸‹ï¼ˆ[https://github.com/redis/redis/blob/7.0/src/sds.h](https://github.com/redis/redis/blob/7.0/src/sds.h)ï¼‰:

```c
/* Note: sdshdr5 is never used, we just access the flags byte directly.
 * However is here to document the layout of type 5 SDS strings. */
struct __attribute__ ((__packed__)) sdshdr5 {
    unsigned char flags; /* 3 lsb of type, and 5 msb of string length */
    char buf[];
};
struct __attribute__ ((__packed__)) sdshdr8 {
    uint8_t len; /* used */
    uint8_t alloc; /* excluding the header and null terminator */
    unsigned char flags; /* 3 lsb of type, 5 unused bits */
    char buf[];
};
struct __attribute__ ((__packed__)) sdshdr16 {
    uint16_t len; /* used */
    uint16_t alloc; /* excluding the header and null terminator */
    unsigned char flags; /* 3 lsb of type, 5 unused bits */
    char buf[];
};
struct __attribute__ ((__packed__)) sdshdr32 {
    uint32_t len; /* used */
    uint32_t alloc; /* excluding the header and null terminator */
    unsigned char flags; /* 3 lsb of type, 5 unused bits */
    char buf[];
};
struct __attribute__ ((__packed__)) sdshdr64 {
    uint64_t len; /* used */
    uint64_t alloc; /* excluding the header and null terminator */
    unsigned char flags; /* 3 lsb of type, 5 unused bits */
    char buf[];
};
```

é€šè¿‡æºç å¯ä»¥çœ‹å‡ºï¼ŒSDS å…±æœ‰**äº”ç§å®ç°æ–¹å¼** ï¼šSDS_TYPE_5ï¼ˆå¹¶æœªç”¨åˆ°ï¼‰ã€SDS_TYPE_8ã€SDS_TYPE_16ã€SDS_TYPE_32ã€SDS_TYPE_64ï¼Œå…¶ä¸­åªæœ‰åå››ç§å®é™…ç”¨åˆ°ã€‚Redis ä¼šæ ¹æ®åˆå§‹åŒ–çš„é•¿åº¦å†³å®šä½¿ç”¨å“ªç§ç±»å‹ï¼Œä»è€Œå‡å°‘å†…å­˜çš„ä½¿ç”¨ã€‚

| ç±»å‹     | å­—èŠ‚ | ä½   |
| -------- | ---- | ---- |
| sdshdr5  | < 1  | <8   |
| sdshdr8  | 1    | 8    |
| sdshdr16 | 2    | 16   |
| sdshdr32 | 4    | 32   |
| sdshdr64 | 8    | 64   |

å¯¹äºåå››ç§å®ç°éƒ½åŒ…å«äº†ä¸‹é¢è¿™ **4 ä¸ªå±æ€§**ï¼š

- `len`ï¼šå­—ç¬¦ä¸²çš„é•¿åº¦ä¹Ÿå°±æ˜¯å·²ç»ä½¿ç”¨çš„å­—èŠ‚æ•°
- `alloc`ï¼šæ€»å…±å¯ç”¨çš„å­—ç¬¦ç©ºé—´å¤§å°ï¼Œalloc-len å°±æ˜¯ SDS å‰©ä½™çš„ç©ºé—´å¤§å°
- `buf[]`ï¼šå®é™…å­˜å‚¨å­—ç¬¦ä¸²çš„æ•°ç»„
- `flags`ï¼šä½ä¸‰ä½ä¿å­˜ç±»å‹æ ‡å¿—

SDS ç›¸æ¯”äº C è¯­è¨€ä¸­çš„å­—ç¬¦ä¸²æœ‰å¦‚ä¸‹æå‡ï¼š

1. **å¯ä»¥é¿å…ç¼“å†²åŒºæº¢å‡º**ï¼šC è¯­è¨€ä¸­çš„å­—ç¬¦ä¸²è¢«ä¿®æ”¹ï¼ˆæ¯”å¦‚æ‹¼æ¥ï¼‰æ—¶ï¼Œä¸€æ—¦æ²¡æœ‰åˆ†é…è¶³å¤Ÿé•¿åº¦çš„å†…å­˜ç©ºé—´ï¼Œå°±ä¼šé€ æˆç¼“å†²åŒºæº¢å‡ºã€‚SDS è¢«ä¿®æ”¹æ—¶ï¼Œä¼šå…ˆæ ¹æ® len å±æ€§æ£€æŸ¥ç©ºé—´å¤§å°æ˜¯å¦æ»¡è¶³è¦æ±‚ï¼Œå¦‚æœä¸æ»¡è¶³ï¼Œåˆ™å…ˆæ‰©å±•è‡³æ‰€éœ€å¤§å°å†è¿›è¡Œä¿®æ”¹æ“ä½œã€‚
2. **è·å–å­—ç¬¦ä¸²é•¿åº¦çš„å¤æ‚åº¦è¾ƒä½**ï¼šC è¯­è¨€ä¸­çš„å­—ç¬¦ä¸²çš„é•¿åº¦é€šå¸¸æ˜¯ç»è¿‡éå†è®¡æ•°æ¥å®ç°çš„ï¼Œæ—¶é—´å¤æ‚åº¦ä¸º O(n)ã€‚SDS çš„é•¿åº¦è·å–ç›´æ¥è¯»å– len å±æ€§å³å¯ï¼Œæ—¶é—´å¤æ‚åº¦ä¸º O(1)ã€‚
3. **å‡å°‘å†…å­˜åˆ†é…æ¬¡æ•°**ï¼šä¸ºäº†é¿å…ä¿®æ”¹ï¼ˆå¢åŠ /å‡å°‘ï¼‰å­—ç¬¦ä¸²æ—¶ï¼Œæ¯æ¬¡éƒ½éœ€è¦é‡æ–°åˆ†é…å†…å­˜ï¼ˆC è¯­è¨€çš„å­—ç¬¦ä¸²æ˜¯è¿™æ ·çš„ï¼‰ï¼ŒSDS å®ç°äº†**ç©ºé—´é¢„åˆ†é…**å’Œ**æƒ°æ€§ç©ºé—´é‡Šæ”¾**ä¸¤ç§ä¼˜åŒ–ç­–ç•¥ã€‚å½“ SDS éœ€è¦å¢åŠ å­—ç¬¦ä¸²æ—¶ï¼ŒRedis ä¼šä¸º SDS åˆ†é…å¥½å†…å­˜ï¼Œå¹¶ä¸”æ ¹æ®ç‰¹å®šçš„ç®—æ³•åˆ†é…å¤šä½™çš„å†…å­˜ï¼Œè¿™æ ·å¯ä»¥å‡å°‘è¿ç»­æ‰§è¡Œå­—ç¬¦ä¸²å¢é•¿æ“ä½œæ‰€éœ€çš„å†…å­˜é‡åˆ†é…æ¬¡æ•°ã€‚å½“ SDS éœ€è¦å‡å°‘å­—ç¬¦ä¸²æ—¶ï¼Œè¿™éƒ¨åˆ†å†…å­˜ä¸ä¼šç«‹å³è¢«å›æ”¶ï¼Œä¼šè¢«è®°å½•ä¸‹æ¥ï¼Œç­‰å¾…åç»­ä½¿ç”¨ï¼ˆæ”¯æŒæ‰‹åŠ¨é‡Šæ”¾ï¼Œæœ‰å¯¹åº”çš„ APIï¼‰ã€‚
4. **äºŒè¿›åˆ¶å®‰å…¨**ï¼šC è¯­è¨€ä¸­çš„å­—ç¬¦ä¸²ä»¥ç©ºå­—ç¬¦ `\0` ä½œä¸ºå­—ç¬¦ä¸²ç»“æŸçš„æ ‡è¯†ï¼Œè¿™å­˜åœ¨ä¸€äº›é—®é¢˜ï¼Œåƒä¸€äº›äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆæ¯”å¦‚å›¾ç‰‡ã€è§†é¢‘ã€éŸ³é¢‘ï¼‰å°±å¯èƒ½åŒ…æ‹¬ç©ºå­—ç¬¦ï¼ŒC å­—ç¬¦ä¸²æ— æ³•æ­£ç¡®ä¿å­˜ã€‚SDS ä½¿ç”¨ len å±æ€§åˆ¤æ–­å­—ç¬¦ä¸²æ˜¯å¦ç»“æŸï¼Œä¸å­˜åœ¨è¿™ä¸ªé—®é¢˜ã€‚

ğŸ¤ å¤šæä¸€å˜´ï¼Œå¾ˆå¤šæ–‡ç« é‡Œ SDS çš„å®šä¹‰æ˜¯ä¸‹é¢è¿™æ ·çš„ï¼š

```c
struct sdshdr {
    unsigned int len;
    unsigned int free;
    char buf[];
};
```

è¿™ä¸ªä¹Ÿæ²¡é”™ï¼ŒRedis 3.2 ä¹‹å‰å°±æ˜¯è¿™æ ·å®šä¹‰çš„ã€‚åæ¥ï¼Œç”±äºè¿™ç§æ–¹å¼çš„å®šä¹‰å­˜åœ¨é—®é¢˜ï¼Œ`len` å’Œ `free` çš„å®šä¹‰ç”¨äº† 4 ä¸ªå­—èŠ‚ï¼Œé€ æˆäº†æµªè´¹ã€‚Redis 3.2 ä¹‹åï¼ŒRedis æ”¹è¿›äº† SDS çš„å®šä¹‰ï¼Œå°†å…¶åˆ’åˆ†ä¸ºäº†ç°åœ¨çš„ 5 ç§ç±»å‹ã€‚

### è´­ç‰©è½¦ä¿¡æ¯ç”¨ String è¿˜æ˜¯ Hash å­˜å‚¨æ›´å¥½å‘¢?

ç”±äºè´­ç‰©è½¦ä¸­çš„å•†å“é¢‘ç¹ä¿®æ”¹å’Œå˜åŠ¨ï¼Œè´­ç‰©è½¦ä¿¡æ¯å»ºè®®ä½¿ç”¨ Hash å­˜å‚¨ï¼š

- ç”¨æˆ· id ä¸º key
- å•†å“ id ä¸º fieldï¼Œå•†å“æ•°é‡ä¸º value

![](images\hash-shopping-cart.png)

é‚£ç”¨æˆ·è´­ç‰©è½¦ä¿¡æ¯çš„ç»´æŠ¤å…·ä½“åº”è¯¥æ€ä¹ˆæ“ä½œå‘¢ï¼Ÿ

- ç”¨æˆ·æ·»åŠ å•†å“å°±æ˜¯å¾€ Hash é‡Œé¢å¢åŠ æ–°çš„ field ä¸ valueï¼›
- æŸ¥è¯¢è´­ç‰©è½¦ä¿¡æ¯å°±æ˜¯éå†å¯¹åº”çš„ Hashï¼›
- æ›´æ”¹å•†å“æ•°é‡ç›´æ¥ä¿®æ”¹å¯¹åº”çš„ value å€¼ï¼ˆç›´æ¥ set æˆ–è€…åšè¿ç®—çš†å¯ï¼‰ï¼›
- åˆ é™¤å•†å“å°±æ˜¯åˆ é™¤ Hash ä¸­å¯¹åº”çš„ fieldï¼›
- æ¸…ç©ºè´­ç‰©è½¦ç›´æ¥åˆ é™¤å¯¹åº”çš„ key å³å¯ã€‚

è¿™é‡Œåªæ˜¯ä»¥ä¸šåŠ¡æ¯”è¾ƒç®€å•çš„è´­ç‰©è½¦åœºæ™¯ä¸¾ä¾‹ï¼Œå®é™…ç”µå•†åœºæ™¯ä¸‹ï¼Œfield åªä¿å­˜ä¸€ä¸ªå•†å“ id æ˜¯æ²¡åŠæ³•æ»¡è¶³éœ€æ±‚çš„ã€‚

### ä½¿ç”¨ Redis å®ç°ä¸€ä¸ªæ’è¡Œæ¦œæ€ä¹ˆåšï¼Ÿ

Redis ä¸­æœ‰ä¸€ä¸ªå«åš **`Sorted Set` ï¼ˆæœ‰åºé›†åˆï¼‰**çš„æ•°æ®ç±»å‹ç»å¸¸è¢«ç”¨åœ¨å„ç§æ’è¡Œæ¦œçš„åœºæ™¯ï¼Œæ¯”å¦‚ç›´æ’­é—´é€ç¤¼ç‰©çš„æ’è¡Œæ¦œã€æœ‹å‹åœˆçš„å¾®ä¿¡æ­¥æ•°æ’è¡Œæ¦œã€ç‹è€…è£è€€ä¸­çš„æ®µä½æ’è¡Œæ¦œã€è¯é¢˜çƒ­åº¦æ’è¡Œæ¦œç­‰ç­‰ã€‚

ç›¸å…³çš„ä¸€äº› Redis å‘½ä»¤: `ZRANGE` (ä»å°åˆ°å¤§æ’åº)ã€ `ZREVRANGE` ï¼ˆä»å¤§åˆ°å°æ’åºï¼‰ã€`ZREVRANK` (æŒ‡å®šå…ƒç´ æ’å)ã€‚

<img src="images\2021060714195385.png" style="zoom:50%;" />

[ã€ŠJava é¢è¯•æŒ‡åŒ—ã€‹](https://javaguide.cn/zhuanlan/java-mian-shi-zhi-bei.html) çš„ã€ŒæŠ€æœ¯é¢è¯•é¢˜ç¯‡ã€å°±æœ‰ä¸€ç¯‡æ–‡ç« è¯¦ç»†ä»‹ç»å¦‚ä½•ä½¿ç”¨ Sorted Set æ¥è®¾è®¡åˆ¶ä½œä¸€ä¸ªæ’è¡Œæ¦œï¼Œæ„Ÿå…´è¶£çš„å°ä¼™ä¼´å¯ä»¥çœ‹çœ‹ã€‚

![](images\image-20220719071115140.png)

### Redis çš„æœ‰åºé›†åˆåº•å±‚ä¸ºä»€ä¹ˆè¦ç”¨è·³è¡¨ï¼Œè€Œä¸ç”¨å¹³è¡¡æ ‘ã€çº¢é»‘æ ‘æˆ–è€… B+æ ‘ï¼Ÿâœ…

è¿™é“é¢è¯•é¢˜å¾ˆå¤šå¤§å‚æ¯”è¾ƒå–œæ¬¢é—®ï¼Œéš¾åº¦è¿˜æ˜¯æœ‰ç‚¹å¤§çš„ã€‚

- å¹³è¡¡æ ‘ vs è·³è¡¨ï¼šå¹³è¡¡æ ‘çš„æ’å…¥ã€åˆ é™¤å’ŒæŸ¥è¯¢çš„æ—¶é—´å¤æ‚åº¦å’Œè·³è¡¨ä¸€æ ·éƒ½æ˜¯ **$O(log n)$**ã€‚å¯¹äºèŒƒå›´æŸ¥è¯¢æ¥è¯´ï¼Œå¹³è¡¡æ ‘ä¹Ÿå¯ä»¥é€šè¿‡ä¸­åºéå†çš„æ–¹å¼è¾¾åˆ°å’Œè·³è¡¨ä¸€æ ·çš„æ•ˆæœã€‚ä½†æ˜¯å®ƒçš„æ¯ä¸€æ¬¡æ’å…¥æˆ–è€…åˆ é™¤æ“ä½œéƒ½éœ€è¦ä¿è¯æ•´é¢—æ ‘å·¦å³èŠ‚ç‚¹çš„ç»å¯¹å¹³è¡¡ï¼Œåªè¦ä¸å¹³è¡¡å°±è¦é€šè¿‡**æ—‹è½¬æ“ä½œæ¥ä¿æŒå¹³è¡¡**ï¼Œè¿™ä¸ªè¿‡ç¨‹æ˜¯æ¯”è¾ƒè€—æ—¶çš„ã€‚è·³è¡¨è¯ç”Ÿçš„åˆè¡·å°±æ˜¯ä¸ºäº†å…‹æœå¹³è¡¡æ ‘çš„ä¸€äº›ç¼ºç‚¹ã€‚è·³è¡¨ä½¿ç”¨**æ¦‚ç‡å¹³è¡¡**è€Œä¸æ˜¯ä¸¥æ ¼å¼ºåˆ¶çš„å¹³è¡¡ï¼Œå› æ­¤ï¼Œ**è·³è¡¨ä¸­çš„æ’å…¥å’Œåˆ é™¤ç®—æ³•æ¯”å¹³è¡¡æ ‘çš„ç­‰æ•ˆç®—æ³•ç®€å•å¾—å¤šï¼Œé€Ÿåº¦ä¹Ÿå¿«å¾—å¤š**ã€‚

- çº¢é»‘æ ‘ vs è·³è¡¨ï¼šç›¸æ¯”è¾ƒäºçº¢é»‘æ ‘æ¥è¯´ï¼Œè·³è¡¨çš„å®ç°ä¹Ÿæ›´ç®€å•ä¸€äº›ï¼Œä¸éœ€è¦é€šè¿‡æ—‹è½¬å’ŒæŸ“è‰²ï¼ˆçº¢é»‘å˜æ¢ï¼‰æ¥ä¿è¯é»‘å¹³è¡¡ã€‚å¹¶ä¸”ï¼ŒæŒ‰ç…§åŒºé—´æ¥æŸ¥æ‰¾æ•°æ®è¿™ä¸ªæ“ä½œï¼Œçº¢é»‘æ ‘çš„æ•ˆç‡æ²¡æœ‰è·³è¡¨é«˜ã€‚
- B+æ ‘ vs è·³è¡¨ï¼šB+æ ‘æ›´é€‚åˆä½œä¸ºæ•°æ®åº“å’Œæ–‡ä»¶ç³»ç»Ÿä¸­å¸¸ç”¨çš„ç´¢å¼•ç»“æ„ä¹‹ä¸€ï¼Œå®ƒçš„æ ¸å¿ƒæ€æƒ³æ˜¯**é€šè¿‡å¯èƒ½å°‘çš„ IO å®šä½åˆ°å°½å¯èƒ½å¤šçš„ç´¢å¼•æ¥è·å¾—æŸ¥è¯¢æ•°æ®**ã€‚**å¯¹äº Redis è¿™ç§å†…å­˜æ•°æ®åº“æ¥è¯´ï¼Œå®ƒå¯¹è¿™äº›å¹¶ä¸æ„Ÿå†’ï¼Œå› ä¸º Redis ä½œä¸ºå†…å­˜æ•°æ®åº“å®ƒä¸å¯èƒ½å­˜å‚¨å¤§é‡çš„æ•°æ®ï¼Œæ‰€ä»¥å¯¹äºç´¢å¼•ä¸éœ€è¦é€šè¿‡ B+æ ‘è¿™ç§æ–¹å¼è¿›è¡Œç»´æŠ¤ï¼Œåªéœ€æŒ‰ç…§æ¦‚ç‡è¿›è¡Œéšæœºç»´æŠ¤å³å¯ï¼ŒèŠ‚çº¦å†…å­˜ã€‚è€Œä¸”ä½¿ç”¨è·³è¡¨å®ç° zset æ—¶ç›¸è¾ƒå‰è€…æ¥è¯´æ›´ç®€å•ä¸€äº›ï¼Œåœ¨è¿›è¡Œæ’å…¥æ—¶åªéœ€é€šè¿‡ç´¢å¼•å°†æ•°æ®æ’å…¥åˆ°é“¾è¡¨ä¸­åˆé€‚çš„ä½ç½®å†éšæœºç»´æŠ¤ä¸€å®šé«˜åº¦çš„ç´¢å¼•å³å¯ï¼Œä¹Ÿä¸éœ€è¦åƒ B+æ ‘é‚£æ ·æ’å…¥æ—¶å‘ç°å¤±è¡¡æ—¶è¿˜éœ€è¦å¯¹èŠ‚ç‚¹åˆ†è£‚ä¸åˆå¹¶**ã€‚

å¦å¤–ï¼Œæˆ‘è¿˜å•ç‹¬å†™äº†ä¸€ç¯‡æ–‡ç« ä»æœ‰åºé›†åˆçš„åŸºæœ¬ä½¿ç”¨åˆ°è·³è¡¨çš„æºç åˆ†æå’Œå®ç°ï¼Œè®©ä½ ä¼šå¯¹ Redis çš„æœ‰åºé›†åˆåº•å±‚å®ç°çš„è·³è¡¨æœ‰ç€æ›´æ·±åˆ»çš„ç†è§£å’ŒæŒæ¡ ï¼šï¼š[Redis ä¸ºä»€ä¹ˆç”¨è·³è¡¨å®ç°æœ‰åºé›†åˆ](https://javaguide.cn/database/redis/redis-skiplist.html)  å‚è€ƒç¬”è®°  [Redisä¸ºä»€ä¹ˆç”¨è·³è¡¨å®ç°æœ‰åºé›†åˆï¼ˆæ›´æ–°ä¸­ï¼‰](# Redisä¸ºä»€ä¹ˆç”¨è·³è¡¨å®ç°æœ‰åºé›†åˆï¼ˆæ›´æ–°ä¸­ï¼‰) 

### Set çš„åº”ç”¨åœºæ™¯æ˜¯ä»€ä¹ˆï¼Ÿ

Redis ä¸­ `Set` æ˜¯ä¸€ç§**æ— åºé›†åˆ**ï¼Œé›†åˆä¸­çš„å…ƒç´ æ²¡æœ‰å…ˆåé¡ºåºä½†éƒ½å”¯ä¸€ï¼Œæœ‰ç‚¹ç±»ä¼¼äº Java ä¸­çš„ `HashSet` ã€‚

`Set` çš„å¸¸è§åº”ç”¨åœºæ™¯å¦‚ä¸‹ï¼š

- å­˜æ”¾çš„æ•°æ®ä¸èƒ½é‡å¤çš„åœºæ™¯ï¼šç½‘ç«™ UV ç»Ÿè®¡ï¼ˆæ•°æ®é‡å·¨å¤§çš„åœºæ™¯è¿˜æ˜¯ `HyperLogLog`æ›´é€‚åˆä¸€äº›ï¼‰ã€æ–‡ç« ç‚¹èµã€åŠ¨æ€ç‚¹èµç­‰ç­‰ã€‚
- éœ€è¦è·å–å¤šä¸ªæ•°æ®æºäº¤é›†ã€å¹¶é›†å’Œå·®é›†çš„åœºæ™¯ï¼šå…±åŒå¥½å‹(äº¤é›†)ã€å…±åŒç²‰ä¸(äº¤é›†)ã€å…±åŒå…³æ³¨(äº¤é›†)ã€å¥½å‹æ¨èï¼ˆå·®é›†ï¼‰ã€éŸ³ä¹æ¨èï¼ˆå·®é›†ï¼‰ã€è®¢é˜…å·æ¨èï¼ˆå·®é›†+äº¤é›†ï¼‰ ç­‰ç­‰ã€‚
- éœ€è¦éšæœºè·å–æ•°æ®æºä¸­çš„å…ƒç´ çš„åœºæ™¯ï¼šæŠ½å¥–ç³»ç»Ÿã€éšæœºç‚¹åç­‰ç­‰ã€‚

### ä½¿ç”¨ Set å®ç°æŠ½å¥–ç³»ç»Ÿæ€ä¹ˆåšï¼Ÿ

å¦‚æœæƒ³è¦ä½¿ç”¨ `Set` å®ç°ä¸€ä¸ªç®€å•çš„æŠ½å¥–ç³»ç»Ÿçš„è¯ï¼Œç›´æ¥ä½¿ç”¨ä¸‹é¢è¿™å‡ ä¸ªå‘½ä»¤å°±å¯ä»¥äº†ï¼š

- `SADD key member1 member2 ...`ï¼šå‘æŒ‡å®šé›†åˆæ·»åŠ ä¸€ä¸ªæˆ–å¤šä¸ªå…ƒç´ ã€‚
- `SPOP key count`ï¼šéšæœºç§»é™¤å¹¶è·å–æŒ‡å®šé›†åˆä¸­ä¸€ä¸ªæˆ–å¤šä¸ªå…ƒç´ ï¼Œé€‚åˆä¸å…è®¸é‡å¤ä¸­å¥–çš„åœºæ™¯ã€‚
- `SRANDMEMBER key count` : éšæœºè·å–æŒ‡å®šé›†åˆä¸­æŒ‡å®šæ•°é‡çš„å…ƒç´ ï¼Œé€‚åˆå…è®¸é‡å¤ä¸­å¥–çš„åœºæ™¯ã€‚

### ä½¿ç”¨ Bitmap ç»Ÿè®¡æ´»è·ƒç”¨æˆ·æ€ä¹ˆåšï¼Ÿ

**`Bitmap`** å­˜å‚¨çš„æ˜¯**è¿ç»­çš„äºŒè¿›åˆ¶æ•°å­—ï¼ˆ0 å’Œ 1ï¼‰**ï¼Œé€šè¿‡ `Bitmap`, åªéœ€è¦ä¸€ä¸ª bit ä½æ¥è¡¨ç¤ºæŸä¸ªå…ƒç´ å¯¹åº”çš„å€¼æˆ–è€…çŠ¶æ€ï¼Œkey å°±æ˜¯å¯¹åº”å…ƒç´ æœ¬èº« ã€‚æˆ‘ä»¬çŸ¥é“ 8 ä¸ª bit å¯ä»¥ç»„æˆä¸€ä¸ª byteï¼Œæ‰€ä»¥ Bitmap æœ¬èº«ä¼šæå¤§çš„èŠ‚çœå‚¨å­˜ç©ºé—´ã€‚

ä½ å¯ä»¥å°† Bitmap çœ‹ä½œæ˜¯ä¸€ä¸ªå­˜å‚¨äºŒè¿›åˆ¶æ•°å­—ï¼ˆ0 å’Œ 1ï¼‰çš„æ•°ç»„ï¼Œæ•°ç»„ä¸­æ¯ä¸ªå…ƒç´ çš„ä¸‹æ ‡å«åš **`offset`ï¼ˆåç§»é‡ï¼‰**ã€‚

![](images\image-20220720194154133.png)

å¦‚æœæƒ³è¦ä½¿ç”¨ Bitmap ç»Ÿè®¡æ´»è·ƒç”¨æˆ·çš„è¯ï¼Œå¯ä»¥ä½¿ç”¨æ—¥æœŸï¼ˆç²¾ç¡®åˆ°å¤©ï¼‰ä½œä¸º keyï¼Œç„¶åç”¨æˆ· ID ä¸º offsetï¼Œå¦‚æœå½“æ—¥æ´»è·ƒè¿‡å°±è®¾ç½®ä¸º 1ã€‚

åˆå§‹åŒ–æ•°æ®ï¼š

```bash
> SETBIT 20210308 1 1
(integer) 0
> SETBIT 20210308 2 1
(integer) 0
> SETBIT 20210309 1 1
(integer) 0
```

ç»Ÿè®¡ 20210308~20210309 æ€»æ´»è·ƒç”¨æˆ·æ•°:

```bash
> BITOP and desk1 20210308 20210309
(integer) 1
> BITCOUNT desk1
(integer) 1
```

ç»Ÿè®¡ 20210308~20210309 åœ¨çº¿æ´»è·ƒç”¨æˆ·æ•°:

```bash
> BITOP or desk2 20210308 20210309
(integer) 1
> BITCOUNT desk2
(integer) 2
```

### ä½¿ç”¨ HyperLogLog ç»Ÿè®¡é¡µé¢ UV æ€ä¹ˆåšï¼Ÿ

ä½¿ç”¨ `HyperLogLog` ç»Ÿè®¡é¡µé¢ UV ä¸»è¦éœ€è¦ç”¨åˆ°ä¸‹é¢è¿™ä¸¤ä¸ªå‘½ä»¤ï¼š

- `PFADD key element1 element2 ...`ï¼šæ·»åŠ ä¸€ä¸ªæˆ–å¤šä¸ªå…ƒç´ åˆ° HyperLogLog ä¸­ã€‚
- `PFCOUNT key1 key2`ï¼šè·å–ä¸€ä¸ªæˆ–è€…å¤šä¸ª HyperLogLog çš„å”¯ä¸€è®¡æ•°ã€‚

1ã€å°†è®¿é—®æŒ‡å®šé¡µé¢çš„æ¯ä¸ªç”¨æˆ· ID æ·»åŠ åˆ° `HyperLogLog` ä¸­ã€‚

```bash
PFADD PAGE_1:UV USER1 USER2 ...... USERn
```

2ã€ç»Ÿè®¡æŒ‡å®šé¡µé¢çš„ UVã€‚

```bash
PFCOUNT PAGE_1:UV
```

## Redis æŒä¹…åŒ–æœºåˆ¶ï¼ˆé‡è¦ğŸŒŸï¼‰

Redis æŒä¹…åŒ–æœºåˆ¶ï¼ˆRDB æŒä¹…åŒ–ã€AOF æŒä¹…åŒ–ã€RDB å’Œ AOF çš„æ··åˆæŒä¹…åŒ–ï¼‰ ç›¸å…³çš„é—®é¢˜æ¯”è¾ƒå¤šï¼Œä¹Ÿæ¯”è¾ƒé‡è¦ï¼Œäºæ˜¯æˆ‘å•ç‹¬æŠ½äº†ä¸€ç¯‡æ–‡ç« æ¥æ€»ç»“ Redis æŒä¹…åŒ–æœºåˆ¶ç›¸å…³çš„çŸ¥è¯†ç‚¹å’Œé—®é¢˜ï¼š[Redis æŒä¹…åŒ–æœºåˆ¶è¯¦è§£](https://javaguide.cn/database/redis/redis-persistence.html)  å‚è€ƒç¬”è®°  [RedisæŒä¹…åŒ–æœºåˆ¶è¯¦è§£ï¼ˆæ›´æ–°ä¸­ï¼‰](# RedisæŒä¹…åŒ–æœºåˆ¶è¯¦è§£ï¼ˆæ›´æ–°ä¸­ï¼‰) 

## Redis çº¿ç¨‹æ¨¡å‹ï¼ˆé‡è¦ğŸŒŸï¼‰

å¯¹äºè¯»å†™å‘½ä»¤æ¥è¯´ï¼ŒRedis ä¸€ç›´æ˜¯å•çº¿ç¨‹æ¨¡å‹ã€‚ä¸è¿‡ï¼Œåœ¨ Redis 4.0 ç‰ˆæœ¬ä¹‹åå¼•å…¥äº†å¤šçº¿ç¨‹æ¥æ‰§è¡Œä¸€äº›å¤§é”®å€¼å¯¹çš„å¼‚æ­¥åˆ é™¤æ“ä½œï¼Œ Redis 6.0 ç‰ˆæœ¬ä¹‹åå¼•å…¥äº†å¤šçº¿ç¨‹æ¥å¤„ç†ç½‘ç»œè¯·æ±‚ï¼ˆæé«˜ç½‘ç»œ IO è¯»å†™æ€§èƒ½ï¼‰ã€‚

### Redis å•çº¿ç¨‹æ¨¡å‹äº†è§£å—ï¼Ÿ

**Redis åŸºäº Reactor æ¨¡å¼è®¾è®¡å¼€å‘äº†ä¸€å¥—é«˜æ•ˆçš„äº‹ä»¶å¤„ç†æ¨¡å‹** ï¼ˆNetty çš„çº¿ç¨‹æ¨¡å‹ä¹ŸåŸºäº Reactor æ¨¡å¼ï¼ŒReactor æ¨¡å¼ä¸æ„§æ˜¯é«˜æ€§èƒ½ IO çš„åŸºçŸ³ï¼‰ï¼Œè¿™å¥—äº‹ä»¶å¤„ç†æ¨¡å‹å¯¹åº”çš„æ˜¯ Redis ä¸­çš„==**æ–‡ä»¶äº‹ä»¶å¤„ç†å™¨ï¼ˆfile event handlerï¼‰**==ã€‚ç”±äºæ–‡ä»¶äº‹ä»¶å¤„ç†å™¨ï¼ˆfile event handlerï¼‰æ˜¯**å•çº¿ç¨‹æ–¹å¼**è¿è¡Œçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸€èˆ¬éƒ½è¯´ Redis æ˜¯å•çº¿ç¨‹æ¨¡å‹ã€‚

ã€ŠRedis è®¾è®¡ä¸å®ç°ã€‹æœ‰ä¸€æ®µè¯æ˜¯å¦‚æ˜¯ä»‹ç»æ–‡ä»¶äº‹ä»¶å¤„ç†å™¨çš„ï¼Œæˆ‘è§‰å¾—å†™å¾—æŒºä¸é”™ã€‚

> Redis åŸºäº Reactor æ¨¡å¼å¼€å‘äº†è‡ªå·±çš„ç½‘ç»œäº‹ä»¶å¤„ç†å™¨ï¼šè¿™ä¸ªå¤„ç†å™¨è¢«ç§°ä¸ºæ–‡ä»¶äº‹ä»¶å¤„ç†å™¨ï¼ˆfile event handlerï¼‰ã€‚
>
> - æ–‡ä»¶äº‹ä»¶å¤„ç†å™¨ä½¿ç”¨ **I/O å¤šè·¯å¤ç”¨ï¼ˆmultiplexingï¼‰ç¨‹åº**æ¥åŒæ—¶ç›‘å¬å¤šä¸ªå¥—æ¥å­—ï¼Œå¹¶æ ¹æ®å¥—æ¥å­—ç›®å‰æ‰§è¡Œçš„ä»»åŠ¡æ¥ä¸ºå¥—æ¥å­—å…³è”ä¸åŒçš„äº‹ä»¶å¤„ç†å™¨ã€‚
> - å½“è¢«ç›‘å¬çš„å¥—æ¥å­—å‡†å¤‡å¥½æ‰§è¡Œè¿æ¥åº”ç­”ï¼ˆacceptï¼‰ã€è¯»å–ï¼ˆreadï¼‰ã€å†™å…¥ï¼ˆwriteï¼‰ã€å…³ é—­ï¼ˆcloseï¼‰ç­‰æ“ä½œæ—¶ï¼Œä¸æ“ä½œç›¸å¯¹åº”çš„æ–‡ä»¶äº‹ä»¶å°±ä¼šäº§ç”Ÿï¼Œè¿™æ—¶æ–‡ä»¶äº‹ä»¶å¤„ç†å™¨å°±ä¼šè°ƒç”¨å¥—æ¥å­—ä¹‹å‰å…³è”å¥½çš„äº‹ä»¶å¤„ç†å™¨æ¥å¤„ç†è¿™äº›äº‹ä»¶ã€‚
>
> **è™½ç„¶æ–‡ä»¶äº‹ä»¶å¤„ç†å™¨ä»¥å•çº¿ç¨‹æ–¹å¼è¿è¡Œï¼Œä½†é€šè¿‡ä½¿ç”¨ I/O å¤šè·¯å¤ç”¨ç¨‹åºæ¥ç›‘å¬å¤šä¸ªå¥—æ¥å­—**ï¼Œæ–‡ä»¶äº‹ä»¶å¤„ç†å™¨æ—¢å®ç°äº†é«˜æ€§èƒ½çš„ç½‘ç»œé€šä¿¡æ¨¡å‹ï¼Œåˆå¯ä»¥å¾ˆå¥½åœ°ä¸ Redis æœåŠ¡å™¨ä¸­å…¶ä»–åŒæ ·ä»¥å•çº¿ç¨‹æ–¹å¼è¿è¡Œçš„æ¨¡å—è¿›è¡Œå¯¹æ¥ï¼Œè¿™ä¿æŒäº† Redis å†…éƒ¨å•çº¿ç¨‹è®¾è®¡çš„ç®€å•æ€§ã€‚

**æ—¢ç„¶æ˜¯å•çº¿ç¨‹ï¼Œé‚£æ€ä¹ˆç›‘å¬å¤§é‡çš„å®¢æˆ·ç«¯è¿æ¥å‘¢ï¼Ÿ**

Redis é€šè¿‡ ==**IO å¤šè·¯å¤ç”¨ç¨‹åº**== æ¥ç›‘å¬æ¥è‡ªå®¢æˆ·ç«¯çš„å¤§é‡è¿æ¥ï¼ˆæˆ–è€…è¯´æ˜¯ç›‘å¬å¤šä¸ª socketï¼‰ï¼Œå®ƒä¼šå°†æ„Ÿå…´è¶£çš„äº‹ä»¶åŠç±»å‹ï¼ˆè¯»ã€å†™ï¼‰æ³¨å†Œåˆ°å†…æ ¸ä¸­å¹¶ç›‘å¬æ¯ä¸ªäº‹ä»¶æ˜¯å¦å‘ç”Ÿã€‚

è¿™æ ·çš„å¥½å¤„éå¸¸æ˜æ˜¾ï¼š**I/O å¤šè·¯å¤ç”¨æŠ€æœ¯çš„ä½¿ç”¨è®© Redis ä¸éœ€è¦é¢å¤–åˆ›å»ºå¤šä½™çš„çº¿ç¨‹æ¥ç›‘å¬å®¢æˆ·ç«¯çš„å¤§é‡è¿æ¥ï¼Œé™ä½äº†èµ„æºçš„æ¶ˆè€—**ï¼ˆå’Œ NIO ä¸­çš„ `Selector` ç»„ä»¶å¾ˆåƒï¼‰ã€‚

**æ–‡ä»¶äº‹ä»¶å¤„ç†å™¨ï¼ˆfile event handlerï¼‰**ä¸»è¦æ˜¯åŒ…å« 4 ä¸ªéƒ¨åˆ†ï¼š

- **å¤šä¸ª socketï¼ˆå®¢æˆ·ç«¯è¿æ¥ï¼‰**
- **IO å¤šè·¯å¤ç”¨ç¨‹åº**ï¼ˆæ”¯æŒå¤šä¸ªå®¢æˆ·ç«¯è¿æ¥çš„å…³é”®ï¼‰
- æ–‡ä»¶äº‹ä»¶åˆ†æ´¾å™¨ï¼ˆå°† socket å…³è”åˆ°ç›¸åº”çš„äº‹ä»¶å¤„ç†å™¨ï¼‰
- **äº‹ä»¶å¤„ç†å™¨**ï¼ˆè¿æ¥åº”ç­”å¤„ç†å™¨ã€å‘½ä»¤è¯·æ±‚å¤„ç†å™¨ã€å‘½ä»¤å›å¤å¤„ç†å™¨ï¼‰

![](images\redis-event-handler.png)

ç›¸å…³é˜…è¯»ï¼š[Redis äº‹ä»¶æœºåˆ¶è¯¦è§£](http://remcarpediem.net/article/1aa2da89/) ã€‚

### Redis6.0 ä¹‹å‰ä¸ºä»€ä¹ˆä¸ä½¿ç”¨å¤šçº¿ç¨‹ï¼Ÿ

è™½ç„¶è¯´ Redis æ˜¯å•çº¿ç¨‹æ¨¡å‹ï¼Œä½†æ˜¯ï¼Œå®é™…ä¸Šï¼Œ**Redis åœ¨ 4.0 ä¹‹åçš„ç‰ˆæœ¬ä¸­å°±å·²ç»åŠ å…¥äº†å¯¹å¤šçº¿ç¨‹çš„æ”¯æŒã€‚**

ä¸è¿‡ï¼Œ**Redis 4.0 å¢åŠ çš„å¤šçº¿ç¨‹ä¸»è¦æ˜¯é’ˆå¯¹ä¸€äº›å¤§é”®å€¼å¯¹çš„åˆ é™¤æ“ä½œçš„å‘½ä»¤ï¼Œä½¿ç”¨è¿™äº›å‘½ä»¤å°±ä¼šä½¿ç”¨ä¸»çº¿ç¨‹ä¹‹å¤–çš„å…¶ä»–çº¿ç¨‹æ¥â€œå¼‚æ­¥å¤„ç†â€**ã€‚

ä¸ºæ­¤ï¼ŒRedis 4.0 ä¹‹åæ–°å¢äº†`UNLINK`ï¼ˆå¯ä»¥çœ‹ä½œæ˜¯ `DEL` çš„å¼‚æ­¥ç‰ˆæœ¬ï¼‰ã€`FLUSHALL ASYNC`ï¼ˆæ¸…ç©ºæ‰€æœ‰æ•°æ®åº“çš„æ‰€æœ‰ keyï¼Œä¸ä»…ä»…æ˜¯å½“å‰ `SELECT` çš„æ•°æ®åº“ï¼‰ã€`FLUSHDB ASYNC`ï¼ˆæ¸…ç©ºå½“å‰ `SELECT` æ•°æ®åº“ä¸­çš„æ‰€æœ‰ keyï¼‰ç­‰å¼‚æ­¥å‘½ä»¤ã€‚

![](images\redis4.0-more-thread.png)

å¤§ä½“ä¸Šæ¥è¯´ï¼ŒRedis 6.0 ä¹‹å‰ä¸»è¦è¿˜æ˜¯å•çº¿ç¨‹å¤„ç†ã€‚

**é‚£ Redis6.0 ä¹‹å‰ä¸ºä»€ä¹ˆä¸ä½¿ç”¨å¤šçº¿ç¨‹ï¼Ÿ** æˆ‘è§‰å¾—ä¸»è¦åŸå› æœ‰ 3 ç‚¹ï¼š

- å•çº¿ç¨‹ç¼–ç¨‹å®¹æ˜“å¹¶ä¸”æ›´å®¹æ˜“ç»´æŠ¤ï¼›
- Redis çš„æ€§èƒ½ç“¶é¢ˆä¸åœ¨ CPU ï¼Œä¸»è¦åœ¨å†…å­˜å’Œç½‘ç»œï¼›
- å¤šçº¿ç¨‹å°±ä¼šå­˜åœ¨æ­»é”ã€çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ç­‰é—®é¢˜ï¼Œç”šè‡³ä¼šå½±å“æ€§èƒ½ã€‚

ç›¸å…³é˜…è¯»ï¼š[ä¸ºä»€ä¹ˆ Redis é€‰æ‹©å•çº¿ç¨‹æ¨¡å‹ï¼Ÿ](https://draveness.me/whys-the-design-redis-single-thread/) ã€‚

### Redis6.0 ä¹‹åä¸ºä½•å¼•å…¥äº†å¤šçº¿ç¨‹ï¼Ÿ

**Redis6.0 å¼•å…¥å¤šçº¿ç¨‹ä¸»è¦æ˜¯ä¸ºäº†æé«˜ç½‘ç»œ IO è¯»å†™æ€§èƒ½**ï¼Œå› ä¸ºè¿™ä¸ªç®—æ˜¯ Redis ä¸­çš„ä¸€ä¸ªæ€§èƒ½ç“¶é¢ˆï¼ˆ==Redis çš„ç“¶é¢ˆä¸»è¦å—é™äºå†…å­˜å’Œç½‘ç»œ==ï¼‰ã€‚

è™½ç„¶ï¼ŒRedis6.0 å¼•å…¥äº†å¤šçº¿ç¨‹ï¼Œä½†æ˜¯ Redis çš„å¤šçº¿ç¨‹**åªæ˜¯åœ¨ç½‘ç»œæ•°æ®çš„è¯»å†™è¿™ç±»è€—æ—¶æ“ä½œä¸Šä½¿ç”¨äº†ï¼Œæ‰§è¡Œå‘½ä»¤ä»ç„¶æ˜¯å•çº¿ç¨‹é¡ºåºæ‰§è¡Œ**ã€‚å› æ­¤ï¼Œä½ ä¹Ÿä¸éœ€è¦æ‹…å¿ƒçº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚

Redis6.0 çš„å¤šçº¿ç¨‹é»˜è®¤æ˜¯ç¦ç”¨çš„ï¼Œåªä½¿ç”¨ä¸»çº¿ç¨‹ã€‚å¦‚éœ€å¼€å¯éœ€è¦è®¾ç½® IO çº¿ç¨‹æ•° > 1ï¼Œéœ€è¦ä¿®æ”¹ redis é…ç½®æ–‡ä»¶ `redis.conf`ï¼š

```bash
io-threads 4  # è®¾ç½®1çš„è¯åªä¼šå¼€å¯ä¸»çº¿ç¨‹ï¼Œå®˜ç½‘å»ºè®®4æ ¸çš„æœºå™¨å»ºè®®è®¾ç½®ä¸º2æˆ–3ä¸ªçº¿ç¨‹ï¼Œ8æ ¸çš„å»ºè®®è®¾ç½®ä¸º6ä¸ªçº¿ç¨‹
```

å¦å¤–ï¼š

- io-threads çš„ä¸ªæ•°ä¸€æ—¦è®¾ç½®ï¼Œä¸èƒ½é€šè¿‡ config åŠ¨æ€è®¾ç½®ã€‚
- å½“è®¾ç½® ssl åï¼Œio-threads å°†ä¸å·¥ä½œã€‚

å¼€å¯å¤šçº¿ç¨‹åï¼Œé»˜è®¤åªä¼šä½¿ç”¨å¤šçº¿ç¨‹è¿›è¡Œ IO å†™å…¥ writesï¼Œå³å‘é€æ•°æ®ç»™å®¢æˆ·ç«¯ï¼Œå¦‚æœéœ€è¦å¼€å¯å¤šçº¿ç¨‹ IO è¯»å– readsï¼ŒåŒæ ·éœ€è¦ä¿®æ”¹ redis é…ç½®æ–‡ä»¶ `redis.conf` :

```bash
io-threads-do-reads yes
```

ä½†æ˜¯å®˜ç½‘æè¿°å¼€å¯å¤šçº¿ç¨‹è¯»å¹¶ä¸èƒ½æœ‰å¤ªå¤§æå‡ï¼Œå› æ­¤ä¸€èˆ¬æƒ…å†µä¸‹å¹¶ä¸å»ºè®®å¼€å¯

ç›¸å…³é˜…è¯»ï¼š

- [Redis 6.0 æ–°ç‰¹æ€§-å¤šçº¿ç¨‹è¿ç¯ 13 é—®ï¼](https://mp.weixin.qq.com/s/FZu3acwK6zrCBZQ_3HoUgw)
- [Redis å¤šçº¿ç¨‹ç½‘ç»œæ¨¡å‹å…¨é¢æ­ç§˜](https://segmentfault.com/a/1190000039223696)ï¼ˆæ¨èï¼‰

### Redis åå°çº¿ç¨‹äº†è§£å—ï¼Ÿ

æˆ‘ä»¬è™½ç„¶ç»å¸¸è¯´ Redis æ˜¯å•çº¿ç¨‹æ¨¡å‹ï¼ˆä¸»è¦é€»è¾‘æ˜¯å•çº¿ç¨‹å®Œæˆçš„ï¼‰ï¼Œä½†å®é™…è¿˜æœ‰ä¸€äº›**åå°çº¿ç¨‹**ç”¨äºæ‰§è¡Œä¸€äº›æ¯”è¾ƒè€—æ—¶çš„æ“ä½œï¼š

- é€šè¿‡ `bio_close_file` åå°çº¿ç¨‹æ¥é‡Šæ”¾ AOF / RDB ç­‰è¿‡ç¨‹ä¸­äº§ç”Ÿçš„ä¸´æ—¶æ–‡ä»¶èµ„æºã€‚
- é€šè¿‡ `bio_aof_fsync` åå°çº¿ç¨‹è°ƒç”¨ `fsync` å‡½æ•°å°†ç³»ç»Ÿå†…æ ¸ç¼“å†²åŒºè¿˜æœªåŒæ­¥åˆ°åˆ°ç£ç›˜çš„æ•°æ®å¼ºåˆ¶åˆ·åˆ°ç£ç›˜ï¼ˆ AOF æ–‡ä»¶ï¼‰ã€‚
- é€šè¿‡ `bio_lazy_free`åå°çº¿ç¨‹é‡Šæ”¾å¤§å¯¹è±¡ï¼ˆå·²åˆ é™¤ï¼‰å ç”¨çš„å†…å­˜ç©ºé—´.

åœ¨`bio.h` æ–‡ä»¶ä¸­æœ‰å®šä¹‰ï¼ˆRedis 6.0 ç‰ˆæœ¬ï¼Œæºç åœ°å€ï¼š[https://github.com/redis/redis/blob/6.0/src/bio.h](https://github.com/redis/redis/blob/6.0/src/bio.h)ï¼‰ï¼š

```java
#ifndef __BIO_H
#define __BIO_H

/* Exported API */
void bioInit(void);
void bioCreateBackgroundJob(int type, void *arg1, void *arg2, void *arg3);
unsigned long long bioPendingJobsOfType(int type);
unsigned long long bioWaitStepOfType(int type);
time_t bioOlderJobOfType(int type);
void bioKillThreads(void);

/* Background job opcodes */
#define BIO_CLOSE_FILE    0 /* Deferred close(2) syscall. */
#define BIO_AOF_FSYNC     1 /* Deferred AOF fsync. */
#define BIO_LAZY_FREE     2 /* Deferred objects freeing. */
#define BIO_NUM_OPS       3

#endif
```

å…³äº Redis åå°çº¿ç¨‹çš„è¯¦ç»†ä»‹ç»å¯ä»¥æŸ¥çœ‹ [Redis 6.0 åå°çº¿ç¨‹æœ‰å“ªäº›ï¼Ÿ](https://juejin.cn/post/7102780434739626014) è¿™ç¯‡å°±æ–‡ç« ã€‚

## Redis å†…å­˜ç®¡ç†

### Redis ç»™ç¼“å­˜æ•°æ®è®¾ç½®è¿‡æœŸæ—¶é—´æœ‰å•¥ç”¨ï¼Ÿ

ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬è®¾ç½®ä¿å­˜çš„ç¼“å­˜æ•°æ®çš„æ—¶å€™éƒ½ä¼šè®¾ç½®ä¸€ä¸ªè¿‡æœŸæ—¶é—´ã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ

å› ä¸ºå†…å­˜æ˜¯æœ‰é™çš„ï¼Œå¦‚æœç¼“å­˜ä¸­çš„æ‰€æœ‰æ•°æ®éƒ½æ˜¯ä¸€ç›´ä¿å­˜çš„è¯ï¼Œåˆ†åˆ†é’Ÿç›´æ¥ Out of memoryã€‚

Redis è‡ªå¸¦äº†ç»™ç¼“å­˜æ•°æ®è®¾ç½®è¿‡æœŸæ—¶é—´çš„åŠŸèƒ½ï¼Œæ¯”å¦‚ï¼š

```bash
127.0.0.1:6379> expire key 60 # æ•°æ®åœ¨ 60s åè¿‡æœŸ
(integer) 1
127.0.0.1:6379> setex key 60 value # æ•°æ®åœ¨ 60s åè¿‡æœŸ (setex:[set] + [ex]pire)
OK
127.0.0.1:6379> ttl key # æŸ¥çœ‹æ•°æ®è¿˜æœ‰å¤šä¹…è¿‡æœŸ
(integer) 56
```

æ³¨æ„ï¼š**Redis ä¸­é™¤äº†å­—ç¬¦ä¸²ç±»å‹æœ‰è‡ªå·±ç‹¬æœ‰è®¾ç½®è¿‡æœŸæ—¶é—´çš„å‘½ä»¤ `setex` å¤–ï¼Œå…¶ä»–æ–¹æ³•éƒ½éœ€è¦ä¾é  `expire` å‘½ä»¤æ¥è®¾ç½®è¿‡æœŸæ—¶é—´ ã€‚å¦å¤–ï¼Œ `persist` å‘½ä»¤å¯ä»¥ç§»é™¤ä¸€ä¸ªé”®çš„è¿‡æœŸæ—¶é—´ã€‚**

**è¿‡æœŸæ—¶é—´é™¤äº†æœ‰åŠ©äºç¼“è§£å†…å­˜çš„æ¶ˆè€—ï¼Œè¿˜æœ‰ä»€ä¹ˆå…¶ä»–ç”¨ä¹ˆï¼Ÿ**

å¾ˆå¤šæ—¶å€™ï¼Œæˆ‘ä»¬çš„ä¸šåŠ¡åœºæ™¯å°±æ˜¯éœ€è¦æŸä¸ªæ•°æ®åªåœ¨æŸä¸€æ—¶é—´æ®µå†…å­˜åœ¨ï¼Œæ¯”å¦‚æˆ‘ä»¬çš„çŸ­ä¿¡éªŒè¯ç å¯èƒ½åªåœ¨ 1 åˆ†é’Ÿå†…æœ‰æ•ˆï¼Œç”¨æˆ·ç™»å½•çš„ Token å¯èƒ½åªåœ¨ 1 å¤©å†…æœ‰æ•ˆã€‚

å¦‚æœä½¿ç”¨ä¼ ç»Ÿçš„æ•°æ®åº“æ¥å¤„ç†çš„è¯ï¼Œä¸€èˆ¬éƒ½æ˜¯è‡ªå·±åˆ¤æ–­è¿‡æœŸï¼Œè¿™æ ·æ›´éº»çƒ¦å¹¶ä¸”æ€§èƒ½è¦å·®å¾ˆå¤šã€‚

### Redis æ˜¯å¦‚ä½•åˆ¤æ–­æ•°æ®æ˜¯å¦è¿‡æœŸçš„å‘¢ï¼Ÿ

Redis é€šè¿‡ä¸€ä¸ªå«åš ==**è¿‡æœŸå­—å…¸**==ï¼ˆå¯ä»¥çœ‹ä½œæ˜¯ hash è¡¨ï¼‰æ¥ä¿å­˜æ•°æ®è¿‡æœŸçš„æ—¶é—´ã€‚è¿‡æœŸå­—å…¸çš„**é”®**æŒ‡å‘ Redis æ•°æ®åº“ä¸­çš„æŸä¸ª key(é”®)ï¼Œè¿‡æœŸå­—å…¸çš„**å€¼**æ˜¯ä¸€ä¸ª long long ç±»å‹çš„æ•´æ•°ï¼Œè¿™ä¸ªæ•´æ•°ä¿å­˜äº† key æ‰€æŒ‡å‘çš„æ•°æ®åº“é”®çš„è¿‡æœŸæ—¶é—´ï¼ˆæ¯«ç§’ç²¾åº¦çš„ UNIX æ—¶é—´æˆ³ï¼‰ã€‚

![](images\redis-expired-dictionary.png)

è¿‡æœŸå­—å…¸æ˜¯å­˜å‚¨åœ¨ redisDb è¿™ä¸ªç»“æ„é‡Œçš„ï¼š

```c
typedef struct redisDb {
    ...

    dict *dict;     //  æ•°æ®åº“é”®ç©ºé—´,ä¿å­˜ç€æ•°æ®åº“ä¸­æ‰€æœ‰é”®å€¼å¯¹
    dict *expires   //  è¿‡æœŸå­—å…¸,ä¿å­˜ç€é”®çš„è¿‡æœŸæ—¶é—´
    ...
} redisDb;
```

### è¿‡æœŸçš„æ•°æ®çš„åˆ é™¤ç­–ç•¥äº†è§£ä¹ˆï¼Ÿ

å¦‚æœå‡è®¾ä½ è®¾ç½®äº†ä¸€æ‰¹ key åªèƒ½å­˜æ´» 1 åˆ†é’Ÿï¼Œé‚£ä¹ˆ 1 åˆ†é’Ÿåï¼ŒRedis æ˜¯æ€ä¹ˆå¯¹è¿™æ‰¹ key è¿›è¡Œåˆ é™¤çš„å‘¢ï¼Ÿ

å¸¸ç”¨çš„==è¿‡æœŸæ•°æ®çš„åˆ é™¤ç­–ç•¥==å°±ä¸¤ä¸ªï¼ˆé‡è¦ï¼è‡ªå·±é€ ç¼“å­˜è½®å­çš„æ—¶å€™éœ€è¦æ ¼å¤–è€ƒè™‘çš„ä¸œè¥¿ï¼‰ï¼š

1. **æƒ°æ€§åˆ é™¤**ï¼šåªä¼šåœ¨å–å‡º key çš„æ—¶å€™æ‰å¯¹æ•°æ®è¿›è¡Œè¿‡æœŸæ£€æŸ¥ã€‚è¿™æ ·å¯¹ CPU æœ€å‹å¥½ï¼Œä½†æ˜¯å¯èƒ½ä¼šé€ æˆå¤ªå¤šè¿‡æœŸ key æ²¡æœ‰è¢«åˆ é™¤ã€‚
2. **å®šæœŸåˆ é™¤**ï¼šæ¯éš”ä¸€æ®µæ—¶é—´æŠ½å–ä¸€æ‰¹ key æ‰§è¡Œåˆ é™¤è¿‡æœŸ key æ“ä½œã€‚å¹¶ä¸”ï¼ŒRedis åº•å±‚ä¼šé€šè¿‡é™åˆ¶åˆ é™¤æ“ä½œæ‰§è¡Œçš„æ—¶é•¿å’Œé¢‘ç‡æ¥å‡å°‘åˆ é™¤æ“ä½œå¯¹ CPU æ—¶é—´çš„å½±å“ã€‚

å®šæœŸåˆ é™¤å¯¹å†…å­˜æ›´åŠ å‹å¥½ï¼Œæƒ°æ€§åˆ é™¤å¯¹ CPU æ›´åŠ å‹å¥½ã€‚ä¸¤è€…å„æœ‰åƒç§‹ï¼Œæ‰€ä»¥ Redis é‡‡ç”¨çš„æ˜¯ **å®šæœŸåˆ é™¤+æƒ°æ€§/æ‡’æ±‰å¼åˆ é™¤** ã€‚

ä½†æ˜¯ï¼Œä»…ä»…é€šè¿‡ç»™ key è®¾ç½®è¿‡æœŸæ—¶é—´è¿˜æ˜¯æœ‰é—®é¢˜çš„ã€‚å› ä¸ºè¿˜æ˜¯å¯èƒ½å­˜åœ¨å®šæœŸåˆ é™¤å’Œæƒ°æ€§åˆ é™¤æ¼æ‰äº†å¾ˆå¤šè¿‡æœŸ key çš„æƒ…å†µã€‚è¿™æ ·å°±å¯¼è‡´å¤§é‡è¿‡æœŸ key å †ç§¯åœ¨å†…å­˜é‡Œï¼Œç„¶åå°± Out of memory äº†ã€‚

æ€ä¹ˆè§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿç­”æ¡ˆå°±æ˜¯ï¼š**Redis å†…å­˜æ·˜æ±°æœºåˆ¶ã€‚**

### Redis å†…å­˜æ·˜æ±°æœºåˆ¶äº†è§£ä¹ˆï¼Ÿ

> ç›¸å…³é—®é¢˜ï¼šMySQL é‡Œæœ‰ 2000w æ•°æ®ï¼ŒRedis ä¸­åªå­˜ 20w çš„æ•°æ®ï¼Œå¦‚ä½•ä¿è¯ Redis ä¸­çš„æ•°æ®éƒ½æ˜¯çƒ­ç‚¹æ•°æ®?

==Redis å†…å­˜æ·˜æ±°æœºåˆ¶==

Redis æä¾› 6 ç§æ•°æ®æ·˜æ±°ç­–ç•¥ï¼š

1. **volatile-lruï¼ˆleast recently usedï¼‰**ï¼šä»å·²è®¾ç½®è¿‡æœŸæ—¶é—´çš„æ•°æ®é›†ï¼ˆ`server.db[i].expires`ï¼‰ä¸­æŒ‘é€‰æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„æ•°æ®æ·˜æ±°ã€‚
2. **volatile-ttl**ï¼šä»å·²è®¾ç½®è¿‡æœŸæ—¶é—´çš„æ•°æ®é›†ï¼ˆ`server.db[i].expires`ï¼‰ä¸­æŒ‘é€‰å°†è¦è¿‡æœŸçš„æ•°æ®æ·˜æ±°ã€‚
3. **volatile-random**ï¼šä»å·²è®¾ç½®è¿‡æœŸæ—¶é—´çš„æ•°æ®é›†ï¼ˆ`server.db[i].expires`ï¼‰ä¸­ä»»æ„é€‰æ‹©æ•°æ®æ·˜æ±°ã€‚
4. **allkeys-lruï¼ˆleast recently usedï¼‰**ï¼š<u>å½“å†…å­˜ä¸è¶³ä»¥å®¹çº³æ–°å†™å…¥æ•°æ®æ—¶ï¼Œåœ¨é”®ç©ºé—´ä¸­ï¼Œç§»é™¤æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„ keyï¼ˆè¿™ä¸ªæ˜¯æœ€å¸¸ç”¨çš„ï¼‰</u>ã€‚
5. **allkeys-random**ï¼šä»æ•°æ®é›†ï¼ˆ`server.db[i].dict`ï¼‰ä¸­ä»»æ„é€‰æ‹©æ•°æ®æ·˜æ±°ã€‚
6. **no-eviction**ï¼šç¦æ­¢é©±é€æ•°æ®ï¼Œä¹Ÿå°±æ˜¯è¯´å½“å†…å­˜ä¸è¶³ä»¥å®¹çº³æ–°å†™å…¥æ•°æ®æ—¶ï¼Œæ–°å†™å…¥æ“ä½œä¼šæŠ¥é”™ã€‚è¿™ä¸ªåº”è¯¥æ²¡äººä½¿ç”¨å§ï¼

4.0 ç‰ˆæœ¬åå¢åŠ ä»¥ä¸‹ä¸¤ç§ï¼š

1. **volatile-lfuï¼ˆleast frequently usedï¼‰**ï¼šä»å·²è®¾ç½®è¿‡æœŸæ—¶é—´çš„æ•°æ®é›†ï¼ˆ`server.db[i].expires`ï¼‰ä¸­æŒ‘é€‰æœ€ä¸ç»å¸¸ä½¿ç”¨çš„æ•°æ®æ·˜æ±°ã€‚
2. **allkeys-lfuï¼ˆleast frequently usedï¼‰**ï¼šå½“å†…å­˜ä¸è¶³ä»¥å®¹çº³æ–°å†™å…¥æ•°æ®æ—¶ï¼Œåœ¨é”®ç©ºé—´ä¸­ï¼Œç§»é™¤æœ€ä¸ç»å¸¸ä½¿ç”¨çš„ keyã€‚

## å‚è€ƒ

- ã€ŠRedis å¼€å‘ä¸è¿ç»´ã€‹

- ã€ŠRedis è®¾è®¡ä¸å®ç°ã€‹

- Redis å‘½ä»¤æ‰‹å†Œï¼š[https://www.redis.com.cn/commands.html](https://www.redis.com.cn/commands.html)

- RedisSearch ç»ˆæä½¿ç”¨æŒ‡å—ï¼Œä½ å€¼å¾—æ‹¥æœ‰ï¼ï¼š[https://mp.weixin.qq.com/s/FA4XVAXJksTOHUXMsayy2g](https://mp.weixin.qq.com/s/FA4XVAXJksTOHUXMsayy2g)

- WHY Redis choose single thread (vs multi threads): https://medium.com/@jychen7/sharing-redis-single-thread-vs-multi-threads-5870bd44d153

# Rediså¸¸è§é¢è¯•é¢˜æ€»ç»“(ä¸‹)(å¿…çœ‹ğŸ‘)

## Redis äº‹åŠ¡

### ä»€ä¹ˆæ˜¯ Redis äº‹åŠ¡ï¼Ÿ

ä½ å¯ä»¥å°† Redis ä¸­çš„äº‹åŠ¡ç†è§£ä¸ºï¼š**Redis äº‹åŠ¡æä¾›äº†ä¸€ç§å°†å¤šä¸ªå‘½ä»¤è¯·æ±‚æ‰“åŒ…çš„åŠŸèƒ½ã€‚ç„¶åï¼Œå†æŒ‰é¡ºåºæ‰§è¡Œæ‰“åŒ…çš„æ‰€æœ‰å‘½ä»¤ï¼Œå¹¶ä¸”ä¸ä¼šè¢«ä¸­é€”æ‰“æ–­ã€‚**

Redis äº‹åŠ¡å®é™…å¼€å‘ä¸­ä½¿ç”¨çš„éå¸¸å°‘ï¼ŒåŠŸèƒ½æ¯”è¾ƒé¸¡è‚‹ï¼Œ**ä¸è¦å°†å…¶å’Œæˆ‘ä»¬å¹³æ—¶ç†è§£çš„å…³ç³»å‹æ•°æ®åº“çš„äº‹åŠ¡æ··æ·†äº†**ã€‚

é™¤äº†==**ä¸æ»¡è¶³åŸå­æ€§å’ŒæŒä¹…æ€§ï¼ˆæœ‰æŒä¹…åŒ–æ–¹å¼ï¼Œä½†å®é™…å¼€å‘ä¸­æŒä¹…åŒ–æ“ä½œ(AOFæŒä¹…åŒ–ï¼ševerysec/no)æ˜¯å¼‚æ­¥çš„ï¼Œå­˜åœ¨æ•°æ®ä¸¢å¤±æƒ…å†µï¼Œæ‰€ä»¥æ— æ³•ä¿è¯æ»¡è¶³ æŒä¹…æ€§ï¼‰**==ä¹‹å¤–ï¼Œäº‹åŠ¡ä¸­çš„æ¯æ¡å‘½ä»¤éƒ½ä¼šä¸ Redis æœåŠ¡å™¨è¿›è¡Œç½‘ç»œäº¤äº’ï¼Œè¿™æ˜¯æ¯”è¾ƒæµªè´¹èµ„æºçš„è¡Œä¸ºã€‚æ˜æ˜ä¸€æ¬¡æ‰¹é‡æ‰§è¡Œå¤šä¸ªå‘½ä»¤å°±å¯ä»¥äº†ï¼Œè¿™ç§æ“ä½œå®åœ¨æ˜¯çœ‹ä¸æ‡‚ã€‚

å› æ­¤ï¼ŒRedis äº‹åŠ¡æ˜¯**ä¸å»ºè®®åœ¨æ—¥å¸¸å¼€å‘ä¸­ä½¿ç”¨**çš„ã€‚

### å¦‚ä½•ä½¿ç”¨ Redis äº‹åŠ¡ï¼Ÿ

Redis å¯ä»¥é€šè¿‡ **`MULTI`ï¼Œ`EXEC`ï¼Œ`DISCARD` å’Œ `WATCH`** ç­‰å‘½ä»¤æ¥å®ç°äº‹åŠ¡(Transaction)åŠŸèƒ½ã€‚

```bash
> MULTI
OK
> SET PROJECT "JavaGuide"
QUEUED
> GET PROJECT
QUEUED
> EXEC
1) OK
2) "JavaGuide"
```

[`MULTI`](https://redis.io/commands/multi) å‘½ä»¤åå¯ä»¥è¾“å…¥å¤šä¸ªå‘½ä»¤ï¼ŒRedis ä¸ä¼šç«‹å³æ‰§è¡Œè¿™äº›å‘½ä»¤ï¼Œè€Œæ˜¯å°†å®ƒä»¬æ”¾åˆ°é˜Ÿåˆ—ï¼Œå½“è°ƒç”¨äº† [`EXEC`](https://redis.io/commands/exec) å‘½ä»¤åï¼Œå†æ‰§è¡Œæ‰€æœ‰çš„å‘½ä»¤ã€‚

è¿™ä¸ªè¿‡ç¨‹æ˜¯è¿™æ ·çš„ï¼š

1. å¼€å§‹äº‹åŠ¡ï¼ˆ`MULTI`ï¼‰ï¼›
2. å‘½ä»¤å…¥é˜Ÿ(æ‰¹é‡æ“ä½œ Redis çš„å‘½ä»¤ï¼Œå…ˆè¿›å…ˆå‡ºï¼ˆFIFOï¼‰çš„é¡ºåºæ‰§è¡Œ)ï¼›
3. æ‰§è¡Œäº‹åŠ¡(`EXEC`)ã€‚

ä½ ä¹Ÿå¯ä»¥é€šè¿‡ [`DISCARD`](https://redis.io/commands/discard) å‘½ä»¤å–æ¶ˆä¸€ä¸ªäº‹åŠ¡ï¼Œå®ƒä¼šæ¸…ç©ºäº‹åŠ¡é˜Ÿåˆ—ä¸­ä¿å­˜çš„æ‰€æœ‰å‘½ä»¤ã€‚

```bash
> MULTI
OK
> SET PROJECT "JavaGuide"
QUEUED
> GET PROJECT
QUEUED
> DISCARD
OK
```

ä½ å¯ä»¥é€šè¿‡[`WATCH`](https://redis.io/commands/watch) å‘½ä»¤ç›‘å¬æŒ‡å®šçš„ Keyï¼Œå½“è°ƒç”¨ `EXEC` å‘½ä»¤æ‰§è¡Œäº‹åŠ¡æ—¶ï¼Œå¦‚æœä¸€ä¸ªè¢« `WATCH` å‘½ä»¤ç›‘è§†çš„ Key è¢« **å…¶ä»–å®¢æˆ·ç«¯/Session** ä¿®æ”¹çš„è¯ï¼Œæ•´ä¸ªäº‹åŠ¡éƒ½ä¸ä¼šè¢«æ‰§è¡Œã€‚

```bash
# å®¢æˆ·ç«¯ 1
> SET PROJECT "RustGuide"
OK
> WATCH PROJECT
OK
> MULTI
OK
> SET PROJECT "JavaGuide"
QUEUED

# å®¢æˆ·ç«¯ 2
# åœ¨å®¢æˆ·ç«¯ 1 æ‰§è¡Œ EXEC å‘½ä»¤æäº¤äº‹åŠ¡ä¹‹å‰ä¿®æ”¹ PROJECT çš„å€¼
> SET PROJECT "GoGuide"

# å®¢æˆ·ç«¯ 1
# ä¿®æ”¹å¤±è´¥ï¼Œå› ä¸º PROJECT çš„å€¼è¢«å®¢æˆ·ç«¯2ä¿®æ”¹äº†
> EXEC
(nil)
> GET PROJECT
"GoGuide"
```

ä¸è¿‡ï¼Œå¦‚æœ **WATCH** ä¸ **äº‹åŠ¡** åœ¨åŒä¸€ä¸ª Session é‡Œï¼Œå¹¶ä¸”è¢« **WATCH** ç›‘è§†çš„ Key è¢«ä¿®æ”¹çš„æ“ä½œå‘ç”Ÿåœ¨äº‹åŠ¡å†…éƒ¨ï¼Œè¿™ä¸ªäº‹åŠ¡æ˜¯å¯ä»¥è¢«æ‰§è¡ŒæˆåŠŸçš„ï¼ˆç›¸å…³ issueï¼š[WATCH å‘½ä»¤ç¢°åˆ° MULTI å‘½ä»¤æ—¶çš„ä¸åŒæ•ˆæœ](https://github.com/Snailclimb/JavaGuide/issues/1714)ï¼‰ã€‚

äº‹åŠ¡å†…éƒ¨ä¿®æ”¹ WATCH ç›‘è§†çš„ Keyï¼š

```bash
> SET PROJECT "JavaGuide"
OK
> WATCH PROJECT
OK
> MULTI
OK
> SET PROJECT "JavaGuide1"
QUEUED
> SET PROJECT "JavaGuide2"
QUEUED
> SET PROJECT "JavaGuide3"
QUEUED
> EXEC
1) OK
2) OK
3) OK
127.0.0.1:6379> GET PROJECT
"JavaGuide3"
```

äº‹åŠ¡å¤–éƒ¨ä¿®æ”¹ WATCH ç›‘è§†çš„ Keyï¼š

```bash
> SET PROJECT "JavaGuide"
OK
> WATCH PROJECT
OK
> SET PROJECT "JavaGuide2"
OK
> MULTI
OK
> GET USER
QUEUED
> EXEC
(nil)
```

Redis å®˜ç½‘ç›¸å…³ä»‹ç» [https://redis.io/topics/transactions](https://redis.io/topics/transactions) å¦‚ä¸‹ï¼š

![](images\redis-transactions.png)

### Redis äº‹åŠ¡æ”¯æŒåŸå­æ€§å—ï¼Ÿ

Redis çš„äº‹åŠ¡å’Œæˆ‘ä»¬å¹³æ—¶ç†è§£çš„å…³ç³»å‹æ•°æ®åº“çš„äº‹åŠ¡ä¸åŒã€‚æˆ‘ä»¬çŸ¥é“äº‹åŠ¡å…·æœ‰å››å¤§ç‰¹æ€§ï¼ˆACIDï¼‰ï¼š**1. åŸå­æ€§**ï¼Œ**2. éš”ç¦»æ€§**ï¼Œ**3. æŒä¹…æ€§**ï¼Œ**4. ä¸€è‡´æ€§**ã€‚

1. **åŸå­æ€§ï¼ˆAtomicityï¼‰ï¼š** äº‹åŠ¡æ˜¯æœ€å°çš„æ‰§è¡Œå•ä½ï¼Œä¸å…è®¸åˆ†å‰²ã€‚äº‹åŠ¡çš„åŸå­æ€§ç¡®ä¿åŠ¨ä½œè¦ä¹ˆå…¨éƒ¨å®Œæˆï¼Œè¦ä¹ˆå®Œå…¨ä¸èµ·ä½œç”¨ï¼›
2. **éš”ç¦»æ€§ï¼ˆIsolationï¼‰ï¼š** å¹¶å‘è®¿é—®æ•°æ®åº“æ—¶ï¼Œä¸€ä¸ªç”¨æˆ·çš„äº‹åŠ¡ä¸è¢«å…¶ä»–äº‹åŠ¡æ‰€å¹²æ‰°ï¼Œå„å¹¶å‘äº‹åŠ¡ä¹‹é—´æ•°æ®åº“æ˜¯ç‹¬ç«‹çš„ï¼›
3. **æŒä¹…æ€§ï¼ˆDurabilityï¼‰ï¼š** ä¸€ä¸ªäº‹åŠ¡è¢«æäº¤ä¹‹åã€‚å®ƒå¯¹æ•°æ®åº“ä¸­æ•°æ®çš„æ”¹å˜æ˜¯æŒä¹…çš„ï¼Œå³ä½¿æ•°æ®åº“å‘ç”Ÿæ•…éšœä¹Ÿä¸åº”è¯¥å¯¹å…¶æœ‰ä»»ä½•å½±å“ã€‚
4. **ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰ï¼š** æ‰§è¡Œäº‹åŠ¡å‰åï¼Œæ•°æ®ä¿æŒä¸€è‡´ï¼Œå¤šä¸ªäº‹åŠ¡å¯¹åŒä¸€ä¸ªæ•°æ®è¯»å–çš„ç»“æœæ˜¯ç›¸åŒçš„ï¼›

**å•ä¸ª Redis å‘½ä»¤çš„æ‰§è¡Œæ˜¯åŸå­æ€§çš„**ï¼Œä½† Redis æ²¡æœ‰åœ¨äº‹åŠ¡ä¸Šå¢åŠ ä»»ä½•ç»´æŒåŸå­æ€§çš„æœºåˆ¶ã€‚Redis äº‹åŠ¡åœ¨è¿è¡Œé”™è¯¯çš„æƒ…å†µä¸‹ï¼Œ**é™¤äº†æ‰§è¡Œè¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯çš„å‘½ä»¤å¤–ï¼Œå…¶ä»–å‘½ä»¤éƒ½èƒ½æ­£å¸¸æ‰§è¡Œ**ã€‚å¹¶ä¸”ï¼ŒRedis äº‹åŠ¡æ˜¯**ä¸æ”¯æŒå›æ»š**ï¼ˆroll backï¼‰æ“ä½œçš„ã€‚å› æ­¤ï¼ŒRedis äº‹åŠ¡å…¶å®æ˜¯==ä¸æ»¡è¶³åŸå­æ€§==çš„ã€‚

Redis å®˜ç½‘ä¹Ÿè§£é‡Šäº†è‡ªå·±ä¸ºå•¥ä¸æ”¯æŒå›æ»šã€‚ç®€å•æ¥è¯´å°±æ˜¯ Redis å¼€å‘è€…ä»¬è§‰å¾—æ²¡å¿…è¦æ”¯æŒå›æ»šï¼Œè¿™æ ·æ›´ç®€å•ä¾¿æ·å¹¶ä¸”æ€§èƒ½æ›´å¥½ã€‚Redis å¼€å‘è€…è§‰å¾—å³ä½¿å‘½ä»¤æ‰§è¡Œé”™è¯¯ä¹Ÿåº”è¯¥åœ¨å¼€å‘è¿‡ç¨‹ä¸­å°±è¢«å‘ç°è€Œä¸æ˜¯ç”Ÿäº§è¿‡ç¨‹ä¸­ã€‚

![](images\redis-rollback.png)

**ç›¸å…³ issue** :

- [issue#452: å…³äº Redis äº‹åŠ¡ä¸æ»¡è¶³åŸå­æ€§çš„é—®é¢˜](https://github.com/Snailclimb/JavaGuide/issues/452) ã€‚
- [Issue#491:å…³äº Redis æ²¡æœ‰äº‹åŠ¡å›æ»šï¼Ÿ](https://github.com/Snailclimb/JavaGuide/issues/491)

### Redis äº‹åŠ¡æ”¯æŒæŒä¹…æ€§å—ï¼Ÿâœ…

Redis ä¸åŒäº Memcached çš„å¾ˆé‡è¦ä¸€ç‚¹å°±æ˜¯ï¼ŒRedis ==æ”¯æŒæŒä¹…åŒ–ï¼ˆæœ‰æŒä¹…åŒ–æ–¹å¼ï¼Œä½†å®é™…å¼€å‘ä¸­æŒä¹…åŒ–æ“ä½œ(AOFæŒä¹…åŒ–ï¼ševerysec/no)æ˜¯å¼‚æ­¥çš„ï¼Œå­˜åœ¨æ•°æ®ä¸¢å¤±æƒ…å†µï¼Œæ‰€ä»¥æ— æ³•ä¿è¯æ»¡è¶³ æŒä¹…æ€§ï¼‰==ï¼Œè€Œä¸”æ”¯æŒ **3 ç§æŒä¹…åŒ–æ–¹å¼**:

- **å¿«ç…§**ï¼ˆsnapshottingï¼ŒRDBï¼‰
- **åªè¿½åŠ æ–‡ä»¶**ï¼ˆappend-only file, AOFï¼‰
- **RDB å’Œ AOF** çš„æ··åˆæŒä¹…åŒ–(Redis 4.0 æ–°å¢)

ä¸ RDB æŒä¹…åŒ–ç›¸æ¯”ï¼ŒAOF æŒä¹…åŒ–çš„å®æ—¶æ€§æ›´å¥½ã€‚åœ¨ Redis çš„é…ç½®æ–‡ä»¶ä¸­å­˜åœ¨**ä¸‰ç§ä¸åŒçš„ AOF æŒä¹…åŒ–æ–¹å¼**ï¼ˆ `fsync`ç­–ç•¥ï¼‰ï¼Œå®ƒä»¬åˆ†åˆ«æ˜¯ï¼š

```bash
appendfsync always    # æ¯æ¬¡æœ‰æ•°æ®ä¿®æ”¹å‘ç”Ÿæ—¶éƒ½ä¼šè°ƒç”¨fsyncå‡½æ•°åŒæ­¥AOFæ–‡ä»¶,fsyncå®Œæˆåçº¿ç¨‹è¿”å›,è¿™æ ·ä¼šä¸¥é‡é™ä½Redisçš„é€Ÿåº¦
appendfsync everysec  # æ¯ç§’é’Ÿè°ƒç”¨fsyncå‡½æ•°åŒæ­¥ä¸€æ¬¡AOFæ–‡ä»¶
appendfsync no        # è®©æ“ä½œç³»ç»Ÿå†³å®šä½•æ—¶è¿›è¡ŒåŒæ­¥ï¼Œä¸€èˆ¬ä¸º30ç§’ä¸€æ¬¡
```

**ä¸ºä»€ä¹ˆæ— æ³•æ»¡è¶³æŒä¹…æ€§**ï¼šAOF æŒä¹…åŒ–çš„`fsync`ç­–ç•¥ä¸º noã€everysec æ—¶ï¼ˆ**å¼‚æ­¥ï¼ŒæŒä¹…åŒ–æ“ä½œä¸ä¼šç«‹å³å°†æ•°æ®å†™å…¥ç£ç›˜**ï¼‰ä¼šå­˜åœ¨**æ•°æ®ä¸¢å¤±**çš„æƒ…å†µ ã€‚always ä¸‹å¯ä»¥åŸºæœ¬æ˜¯å¯ä»¥æ»¡è¶³æŒä¹…æ€§è¦æ±‚çš„ï¼Œä½†æ€§èƒ½å¤ªå·®ï¼Œå®é™…å¼€å‘è¿‡ç¨‹ä¸­ä¸ä¼šä½¿ç”¨ã€‚==å› æ­¤ï¼ŒRedis äº‹åŠ¡çš„æŒä¹…æ€§ä¹Ÿæ˜¯æ²¡åŠæ³•ä¿è¯çš„==ã€‚

å¦‚æœéœ€è¦ä¸¥æ ¼çš„äº‹åŠ¡æŒä¹…æ€§ä¿è¯ï¼Œè¿˜éœ€è¦è€ƒè™‘åœ¨äº‹åŠ¡æ‰§è¡Œåæ˜¾å¼åœ°è°ƒç”¨ Redis çš„æŒä¹…åŒ–å‘½ä»¤æ¥è§¦å‘æŒä¹…åŒ–æ“ä½œï¼Œä»¥ç¡®ä¿äº‹åŠ¡æ‰§è¡Œç»“æœçš„æŒä¹…åŒ–ã€‚

### å¦‚ä½•è§£å†³ Redis äº‹åŠ¡çš„ç¼ºé™·ï¼Ÿ

Redis ä» 2.6 ç‰ˆæœ¬å¼€å§‹æ”¯æŒæ‰§è¡Œ **Lua è„šæœ¬**ï¼Œå®ƒçš„åŠŸèƒ½å’Œäº‹åŠ¡éå¸¸ç±»ä¼¼ã€‚æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ Lua è„šæœ¬æ¥æ‰¹é‡æ‰§è¡Œå¤šæ¡ Redis å‘½ä»¤ï¼Œè¿™äº› Redis å‘½ä»¤ä¼šè¢«æäº¤åˆ° Redis æœåŠ¡å™¨ä¸€æ¬¡æ€§æ‰§è¡Œå®Œæˆï¼Œå¤§å¹…å‡å°äº†ç½‘ç»œå¼€é”€ã€‚

ä¸€æ®µ Lua è„šæœ¬å¯ä»¥è§†ä½œä¸€æ¡å‘½ä»¤æ‰§è¡Œï¼Œä¸€æ®µ Lua è„šæœ¬æ‰§è¡Œè¿‡ç¨‹ä¸­ä¸ä¼šæœ‰å…¶ä»–è„šæœ¬æˆ– Redis å‘½ä»¤åŒæ—¶æ‰§è¡Œï¼Œä¿è¯äº†æ“ä½œä¸ä¼šè¢«å…¶ä»–æŒ‡ä»¤æ’å…¥æˆ–æ‰“æ‰°ã€‚

ä¸è¿‡ï¼Œå¦‚æœ Lua è„šæœ¬è¿è¡Œæ—¶å‡ºé”™å¹¶ä¸­é€”ç»“æŸï¼Œå‡ºé”™ä¹‹åçš„å‘½ä»¤æ˜¯ä¸ä¼šè¢«æ‰§è¡Œçš„ã€‚å¹¶ä¸”ï¼Œå‡ºé”™ä¹‹å‰æ‰§è¡Œçš„å‘½ä»¤æ˜¯æ— æ³•è¢«æ’¤é”€çš„ï¼Œæ— æ³•å®ç°ç±»ä¼¼å…³ç³»å‹æ•°æ®åº“æ‰§è¡Œå¤±è´¥å¯ä»¥å›æ»šçš„é‚£ç§åŸå­æ€§æ•ˆæœã€‚å› æ­¤ï¼Œ **ä¸¥æ ¼æ¥è¯´çš„è¯ï¼Œé€šè¿‡ Lua è„šæœ¬æ¥æ‰¹é‡æ‰§è¡Œ Redis å‘½ä»¤å®é™…ä¹Ÿæ˜¯ä¸å®Œå…¨æ»¡è¶³åŸå­æ€§çš„ã€‚**

å¦‚æœæƒ³è¦è®© Lua è„šæœ¬ä¸­çš„å‘½ä»¤å…¨éƒ¨æ‰§è¡Œï¼Œå¿…é¡»ä¿è¯è¯­å¥è¯­æ³•å’Œå‘½ä»¤éƒ½æ˜¯å¯¹çš„ã€‚

å¦å¤–ï¼ŒRedis 7.0 æ–°å¢äº† [Redis functions](https://redis.io/docs/manual/programmability/functions-intro/) ç‰¹æ€§ï¼Œä½ å¯ä»¥å°† Redis functions çœ‹ä½œæ˜¯æ¯” Lua æ›´å¼ºå¤§çš„è„šæœ¬ã€‚

## Redis æ€§èƒ½ä¼˜åŒ–ï¼ˆé‡è¦ï¼‰âœ…

é™¤äº†ä¸‹é¢ä»‹ç»çš„å†…å®¹ä¹‹å¤–ï¼Œå†æ¨èä¸¤ç¯‡ä¸é”™çš„æ–‡ç« ï¼š

- [ä½ çš„ Redis çœŸçš„å˜æ…¢äº†å—ï¼Ÿæ€§èƒ½ä¼˜åŒ–å¦‚ä½•åš - é˜¿é‡Œå¼€å‘è€…](https://mp.weixin.qq.com/s/nNEuYw0NlYGhuKKKKoWfcQ)
- [Redis å¸¸è§é˜»å¡åŸå› æ€»ç»“ - JavaGuide](https://javaguide.cn/database/redis/redis-common-blocking-problems-summary.html)

### ä½¿ç”¨æ‰¹é‡æ“ä½œå‡å°‘ç½‘ç»œä¼ è¾“

ä¸€ä¸ª Redis å‘½ä»¤çš„æ‰§è¡Œå¯ä»¥ç®€åŒ–ä¸ºä»¥ä¸‹ 4 æ­¥ï¼š

1. å‘é€å‘½ä»¤
2. å‘½ä»¤æ’é˜Ÿ
3. å‘½ä»¤æ‰§è¡Œ
4. è¿”å›ç»“æœ

å…¶ä¸­ï¼Œç¬¬ 1 æ­¥å’Œç¬¬ 4 æ­¥è€—è´¹æ—¶é—´ä¹‹å’Œç§°ä¸º **Round Trip Time (RTT,å¾€è¿”æ—¶é—´)** ï¼Œä¹Ÿå°±æ˜¯æ•°æ®åœ¨ç½‘ç»œä¸Šä¼ è¾“çš„æ—¶é—´ã€‚

ä½¿ç”¨æ‰¹é‡æ“ä½œå¯ä»¥å‡å°‘ç½‘ç»œä¼ è¾“æ¬¡æ•°ï¼Œè¿›è€Œæœ‰æ•ˆå‡å°ç½‘ç»œå¼€é”€ï¼Œå¤§å¹…å‡å°‘ RTTã€‚

å¦å¤–ï¼Œé™¤äº†èƒ½å‡å°‘ RTT ä¹‹å¤–ï¼Œå‘é€ä¸€æ¬¡å‘½ä»¤çš„ socket I/O æˆæœ¬ä¹Ÿæ¯”è¾ƒé«˜ï¼ˆæ¶‰åŠä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œå­˜åœ¨`read()`å’Œ`write()`ç³»ç»Ÿè°ƒç”¨ï¼‰ï¼Œæ‰¹é‡æ“ä½œè¿˜å¯ä»¥å‡å°‘ socket I/O æˆæœ¬ã€‚è¿™ä¸ªåœ¨å®˜æ–¹å¯¹ pipeline çš„ä»‹ç»ä¸­æœ‰æåˆ°ï¼š[https://redis.io/docs/manual/pipelining/](https://redis.io/docs/manual/pipelining/) ã€‚

#### åŸç”Ÿæ‰¹é‡æ“ä½œå‘½ä»¤

Redis ä¸­æœ‰ä¸€äº›åŸç”Ÿæ”¯æŒæ‰¹é‡æ“ä½œçš„å‘½ä»¤ï¼Œæ¯”å¦‚ï¼š

- `MGET`(è·å–ä¸€ä¸ªæˆ–å¤šä¸ªæŒ‡å®š key çš„å€¼)ã€`MSET`(è®¾ç½®ä¸€ä¸ªæˆ–å¤šä¸ªæŒ‡å®š key çš„å€¼)ã€
- `HMGET`(è·å–æŒ‡å®šå“ˆå¸Œè¡¨ä¸­ä¸€ä¸ªæˆ–è€…å¤šä¸ªæŒ‡å®šå­—æ®µçš„å€¼)ã€`HMSET`(åŒæ—¶å°†ä¸€ä¸ªæˆ–å¤šä¸ª field-value å¯¹è®¾ç½®åˆ°æŒ‡å®šå“ˆå¸Œè¡¨ä¸­)ã€
- `SADD`ï¼ˆå‘æŒ‡å®šé›†åˆæ·»åŠ ä¸€ä¸ªæˆ–å¤šä¸ªå…ƒç´ ï¼‰
- â€¦â€¦

ä¸è¿‡ï¼Œåœ¨ Redis å®˜æ–¹æä¾›çš„åˆ†ç‰‡é›†ç¾¤è§£å†³æ–¹æ¡ˆ Redis Cluster ä¸‹ï¼Œä½¿ç”¨è¿™äº›åŸç”Ÿæ‰¹é‡æ“ä½œå‘½ä»¤å¯èƒ½ä¼šå­˜åœ¨ä¸€äº›å°é—®é¢˜éœ€è¦è§£å†³ã€‚å°±æ¯”å¦‚è¯´ `MGET` æ— æ³•ä¿è¯æ‰€æœ‰çš„ key éƒ½åœ¨åŒä¸€ä¸ª **hash slot**ï¼ˆå“ˆå¸Œæ§½ï¼‰ä¸Šï¼Œ`MGET`å¯èƒ½è¿˜æ˜¯éœ€è¦å¤šæ¬¡ç½‘ç»œä¼ è¾“ï¼ŒåŸå­æ“ä½œä¹Ÿæ— æ³•ä¿è¯äº†ã€‚ä¸è¿‡ï¼Œç›¸è¾ƒäºéæ‰¹é‡æ“ä½œï¼Œè¿˜æ˜¯å¯ä»¥èŠ‚çœä¸å°‘ç½‘ç»œä¼ è¾“æ¬¡æ•°ã€‚

æ•´ä¸ªæ­¥éª¤çš„ç®€åŒ–ç‰ˆå¦‚ä¸‹ï¼ˆé€šå¸¸ç”± Redis å®¢æˆ·ç«¯å®ç°ï¼Œæ— éœ€æˆ‘ä»¬è‡ªå·±å†æ‰‹åŠ¨å®ç°ï¼‰ï¼š

1. æ‰¾åˆ° key å¯¹åº”çš„æ‰€æœ‰ hash slotï¼›
2. åˆ†åˆ«å‘å¯¹åº”çš„ Redis èŠ‚ç‚¹å‘èµ· `MGET` è¯·æ±‚è·å–æ•°æ®ï¼›
3. ç­‰å¾…æ‰€æœ‰è¯·æ±‚æ‰§è¡Œç»“æŸï¼Œé‡æ–°ç»„è£…ç»“æœæ•°æ®ï¼Œä¿æŒè·Ÿå…¥å‚ key çš„é¡ºåºä¸€è‡´ï¼Œç„¶åè¿”å›ç»“æœã€‚

å¦‚æœæƒ³è¦è§£å†³è¿™ä¸ªå¤šæ¬¡ç½‘ç»œä¼ è¾“çš„é—®é¢˜ï¼Œæ¯”è¾ƒå¸¸ç”¨çš„åŠæ³•æ˜¯è‡ªå·±ç»´æŠ¤ key ä¸ slot çš„å…³ç³»ã€‚ä¸è¿‡è¿™æ ·ä¸å¤ªçµæ´»ï¼Œè™½ç„¶å¸¦æ¥äº†æ€§èƒ½æå‡ï¼Œä½†åŒæ ·è®©ç³»ç»Ÿå¤æ‚æ€§æå‡ã€‚

> Redis Cluster å¹¶æ²¡æœ‰ä½¿ç”¨ä¸€è‡´æ€§å“ˆå¸Œï¼Œé‡‡ç”¨çš„æ˜¯ **å“ˆå¸Œæ§½åˆ†åŒº** ï¼Œæ¯ä¸€ä¸ªé”®å€¼å¯¹éƒ½å±äºä¸€ä¸ª **hash slot**ï¼ˆå“ˆå¸Œæ§½ï¼‰ ã€‚å½“å®¢æˆ·ç«¯å‘é€å‘½ä»¤è¯·æ±‚çš„æ—¶å€™ï¼Œéœ€è¦å…ˆæ ¹æ® key é€šè¿‡ä¸Šé¢çš„è®¡ç®—å…¬ç¤ºæ‰¾åˆ°çš„å¯¹åº”çš„å“ˆå¸Œæ§½ï¼Œç„¶åå†æŸ¥è¯¢å“ˆå¸Œæ§½å’ŒèŠ‚ç‚¹çš„æ˜ å°„å…³ç³»ï¼Œå³å¯æ‰¾åˆ°ç›®æ ‡ Redis èŠ‚ç‚¹ã€‚
>
> æˆ‘åœ¨ [Redis é›†ç¾¤è¯¦è§£ï¼ˆä»˜è´¹ï¼‰](https://javaguide.cn/database/redis/redis-cluster.html) è¿™ç¯‡æ–‡ç« ä¸­è¯¦ç»†ä»‹ç»äº† Redis Cluster è¿™éƒ¨åˆ†çš„å†…å®¹ï¼Œæ„Ÿå…´è¶£åœ°å¯ä»¥çœ‹çœ‹ã€‚

#### pipeline

å¯¹äºä¸æ”¯æŒæ‰¹é‡æ“ä½œçš„å‘½ä»¤ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨ **pipelineï¼ˆæµæ°´çº¿)** å°†ä¸€æ‰¹ Redis å‘½ä»¤å°è£…æˆä¸€ç»„ï¼Œè¿™äº› Redis å‘½ä»¤ä¼šè¢«ä¸€æ¬¡æ€§æäº¤åˆ° Redis æœåŠ¡å™¨ï¼Œåªéœ€è¦ä¸€æ¬¡ç½‘ç»œä¼ è¾“ã€‚ä¸è¿‡ï¼Œéœ€è¦æ³¨æ„æ§åˆ¶ä¸€æ¬¡æ‰¹é‡æ“ä½œçš„ **å…ƒç´ ä¸ªæ•°**(ä¾‹å¦‚ 500 ä»¥å†…ï¼Œå®é™…ä¹Ÿå’Œå…ƒç´ å­—èŠ‚æ•°æœ‰å…³)ï¼Œé¿å…ç½‘ç»œä¼ è¾“çš„æ•°æ®é‡è¿‡å¤§ã€‚

ä¸`MGET`ã€`MSET`ç­‰åŸç”Ÿæ‰¹é‡æ“ä½œå‘½ä»¤ä¸€æ ·ï¼Œpipeline åŒæ ·åœ¨ Redis Cluster ä¸Šä½¿ç”¨ä¼šå­˜åœ¨ä¸€äº›å°é—®é¢˜ã€‚åŸå› ç±»ä¼¼ï¼Œæ— æ³•ä¿è¯æ‰€æœ‰çš„ key éƒ½åœ¨åŒä¸€ä¸ª **hash slot**ï¼ˆå“ˆå¸Œæ§½ï¼‰ä¸Šã€‚å¦‚æœæƒ³è¦ä½¿ç”¨çš„è¯ï¼Œå®¢æˆ·ç«¯éœ€è¦è‡ªå·±ç»´æŠ¤ key ä¸ slot çš„å…³ç³»ã€‚

åŸç”Ÿæ‰¹é‡æ“ä½œå‘½ä»¤å’Œ pipeline çš„æ˜¯æœ‰åŒºåˆ«çš„ï¼Œä½¿ç”¨çš„æ—¶å€™éœ€è¦æ³¨æ„ï¼š

- åŸç”Ÿæ‰¹é‡æ“ä½œå‘½ä»¤æ˜¯åŸå­æ“ä½œï¼Œpipeline æ˜¯**éåŸå­æ“ä½œ**ã€‚
- pipeline **å¯ä»¥æ‰“åŒ…ä¸åŒçš„å‘½ä»¤**ï¼ŒåŸç”Ÿæ‰¹é‡æ“ä½œå‘½ä»¤ä¸å¯ä»¥ã€‚
- åŸç”Ÿæ‰¹é‡æ“ä½œå‘½ä»¤æ˜¯ Redis æœåŠ¡ç«¯æ”¯æŒå®ç°çš„ï¼Œè€Œ pipeline éœ€è¦**æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯çš„å…±åŒå®ç°**ã€‚

é¡ºå¸¦è¡¥å……ä¸€ä¸‹ pipeline å’Œ Redis äº‹åŠ¡çš„å¯¹æ¯”ï¼š

- äº‹åŠ¡æ˜¯åŸå­æ“ä½œï¼Œpipeline æ˜¯éåŸå­æ“ä½œã€‚ä¸¤ä¸ªä¸åŒçš„äº‹åŠ¡ä¸ä¼šåŒæ—¶è¿è¡Œï¼Œè€Œ pipeline å¯ä»¥åŒæ—¶ä»¥äº¤é”™æ–¹å¼æ‰§è¡Œã€‚
- Redis äº‹åŠ¡ä¸­æ¯ä¸ªå‘½ä»¤éƒ½éœ€è¦å‘é€åˆ°æœåŠ¡ç«¯ï¼Œè€Œ Pipeline åªéœ€è¦å‘é€ä¸€æ¬¡ï¼Œè¯·æ±‚æ¬¡æ•°æ›´å°‘ã€‚

> **==äº‹åŠ¡å¯ä»¥çœ‹ä½œæ˜¯ä¸€ä¸ªåŸå­æ“ä½œ(å®é™…ä¸Šä¸æ˜¯)ï¼Œä½†å…¶å®å¹¶ä¸æ»¡è¶³åŸå­æ€§ã€‚å½“æˆ‘ä»¬æåˆ° Redis ä¸­çš„åŸå­æ“ä½œæ—¶ï¼Œä¸»è¦æŒ‡çš„æ˜¯è¿™ä¸ªæ“ä½œï¼ˆæ¯”å¦‚äº‹åŠ¡ã€Lua è„šæœ¬ï¼‰ä¸ä¼šè¢«å…¶ä»–æ“ä½œï¼ˆæ¯”å¦‚å…¶ä»–äº‹åŠ¡ã€Lua è„šæœ¬ï¼‰æ‰“æ‰°ï¼Œå¹¶ä¸èƒ½å®Œå…¨ä¿è¯è¿™ä¸ªæ“ä½œä¸­çš„æ‰€æœ‰å†™å‘½ä»¤è¦ä¹ˆéƒ½æ‰§è¡Œè¦ä¹ˆéƒ½ä¸æ‰§è¡Œã€‚è¿™ä¸»è¦ä¹Ÿæ˜¯å› ä¸º Redis æ˜¯ä¸æ”¯æŒå›æ»šæ“ä½œã€‚==** 

<img src="images\redis-pipeline-vs-transaction.png" style="zoom: 25%;" />

å¦å¤–ï¼Œpipeline **ä¸é€‚ç”¨äºæ‰§è¡Œé¡ºåºæœ‰ä¾èµ–å…³ç³»çš„ä¸€æ‰¹å‘½ä»¤**ã€‚å°±æ¯”å¦‚è¯´ï¼Œä½ éœ€è¦å°†å‰ä¸€ä¸ªå‘½ä»¤çš„ç»“æœç»™åç»­çš„å‘½ä»¤ä½¿ç”¨ï¼Œpipeline å°±æ²¡åŠæ³•æ»¡è¶³ä½ çš„éœ€æ±‚äº†ã€‚å¯¹äºè¿™ç§éœ€æ±‚ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ **Lua è„šæœ¬** ã€‚

#### Lua è„šæœ¬

Lua è„šæœ¬åŒæ ·æ”¯æŒæ‰¹é‡æ“ä½œå¤šæ¡å‘½ä»¤ã€‚ä¸€æ®µ Lua è„šæœ¬å¯ä»¥è§†ä½œä¸€æ¡å‘½ä»¤æ‰§è¡Œï¼Œå¯ä»¥çœ‹ä½œæ˜¯ **åŸå­æ“ä½œï¼ˆè¿™é‡ŒæŒ‡çš„æ˜¯ä¸ä¼šè¢«å…¶ä»–æ“ä½œæ‰“æ‰°ï¼Œä½†å®é™…ä¸å…·å¤‡åŸå­æ€§ï¼Œå› ä¸ºRedisä¸æ”¯æŒå›æ»šï¼‰** ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸€æ®µ Lua è„šæœ¬æ‰§è¡Œè¿‡ç¨‹ä¸­ä¸ä¼šæœ‰å…¶ä»–è„šæœ¬æˆ– Redis å‘½ä»¤åŒæ—¶æ‰§è¡Œï¼Œä¿è¯äº†æ“ä½œä¸ä¼šè¢«å…¶ä»–æŒ‡ä»¤æ’å…¥æˆ–æ‰“æ‰°ï¼Œè¿™æ˜¯ pipeline æ‰€ä¸å…·å¤‡çš„ã€‚

å¹¶ä¸”ï¼ŒLua è„šæœ¬ä¸­æ”¯æŒä¸€äº›ç®€å•çš„é€»è¾‘å¤„ç†æ¯”å¦‚ä½¿ç”¨å‘½ä»¤è¯»å–å€¼å¹¶åœ¨ Lua è„šæœ¬ä¸­è¿›è¡Œå¤„ç†ï¼Œè¿™åŒæ ·æ˜¯ pipeline æ‰€ä¸å…·å¤‡çš„ã€‚

ä¸è¿‡ï¼Œ Lua è„šæœ¬ä¾ç„¶å­˜åœ¨ä¸‹é¢è¿™äº›ç¼ºé™·ï¼š

- å¦‚æœ Lua è„šæœ¬è¿è¡Œæ—¶å‡ºé”™å¹¶ä¸­é€”ç»“æŸï¼Œä¹‹åçš„æ“ä½œä¸ä¼šè¿›è¡Œï¼Œä½†æ˜¯ä¹‹å‰å·²ç»å‘ç”Ÿçš„å†™æ“ä½œä¸ä¼šæ’¤é”€ï¼Œæ‰€ä»¥å³ä½¿ä½¿ç”¨äº† Lua è„šæœ¬ï¼Œä¹Ÿä¸èƒ½å®ç°ç±»ä¼¼æ•°æ®åº“å›æ»šçš„åŸå­æ€§ã€‚
- Redis Cluster ä¸‹ Lua è„šæœ¬çš„åŸå­æ“ä½œä¹Ÿæ— æ³•ä¿è¯äº†ï¼ŒåŸå› åŒæ ·æ˜¯æ— æ³•ä¿è¯æ‰€æœ‰çš„ key éƒ½åœ¨åŒä¸€ä¸ª **hash slot**ï¼ˆå“ˆå¸Œæ§½ï¼‰ä¸Šã€‚

### å¤§é‡ key é›†ä¸­è¿‡æœŸé—®é¢˜

æˆ‘åœ¨å‰é¢æåˆ°è¿‡ï¼šå¯¹äºè¿‡æœŸ keyï¼ŒRedis é‡‡ç”¨çš„æ˜¯ **å®šæœŸåˆ é™¤+æƒ°æ€§/æ‡’æ±‰å¼åˆ é™¤** ç­–ç•¥ã€‚

å®šæœŸåˆ é™¤æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå¦‚æœçªç„¶é‡åˆ°å¤§é‡è¿‡æœŸ key çš„è¯ï¼Œå®¢æˆ·ç«¯è¯·æ±‚å¿…é¡»ç­‰å¾…å®šæœŸæ¸…ç†è¿‡æœŸ key ä»»åŠ¡çº¿ç¨‹æ‰§è¡Œå®Œæˆï¼Œå› ä¸ºè¿™ä¸ªè¿™ä¸ªå®šæœŸä»»åŠ¡çº¿ç¨‹æ˜¯åœ¨ Redis ä¸»çº¿ç¨‹ä¸­æ‰§è¡Œçš„ã€‚è¿™å°±å¯¼è‡´å®¢æˆ·ç«¯è¯·æ±‚æ²¡åŠæ³•è¢«åŠæ—¶å¤„ç†ï¼Œå“åº”é€Ÿåº¦ä¼šæ¯”è¾ƒæ…¢ã€‚

**å¦‚ä½•è§£å†³å‘¢ï¼Ÿ** ä¸‹é¢æ˜¯ä¸¤ç§å¸¸è§çš„æ–¹æ³•ï¼š

1. **ç»™ key è®¾ç½®éšæœºè¿‡æœŸæ—¶é—´**ã€‚
2. **å¼€å¯ lazy-freeï¼ˆæƒ°æ€§åˆ é™¤/å»¶è¿Ÿé‡Šæ”¾ï¼‰** ã€‚lazy-free ç‰¹æ€§æ˜¯ Redis 4.0 å¼€å§‹å¼•å…¥çš„ï¼ŒæŒ‡çš„æ˜¯è®© Redis é‡‡ç”¨å¼‚æ­¥æ–¹å¼å»¶è¿Ÿé‡Šæ”¾ key ä½¿ç”¨çš„å†…å­˜ï¼Œå°†è¯¥æ“ä½œäº¤ç»™å•ç‹¬çš„å­çº¿ç¨‹å¤„ç†ï¼Œé¿å…é˜»å¡ä¸»çº¿ç¨‹ã€‚

ä¸ªäººå»ºè®®ä¸ç®¡æ˜¯å¦å¼€å¯ lazy-freeï¼Œæˆ‘ä»¬éƒ½å°½é‡ç»™ key è®¾ç½®éšæœºè¿‡æœŸæ—¶é—´ã€‚

### Redis bigkeyï¼ˆå¤§ Keyï¼‰âœ…

#### ä»€ä¹ˆæ˜¯ bigkeyï¼Ÿ

ç®€å•æ¥è¯´ï¼Œå¦‚æœä¸€ä¸ª key å¯¹åº”çš„ value æ‰€å ç”¨çš„å†…å­˜æ¯”è¾ƒå¤§ï¼Œé‚£è¿™ä¸ª key å°±å¯ä»¥çœ‹ä½œæ˜¯ `bigkey`ã€‚å…·ä½“å¤šå¤§æ‰ç®—å¤§å‘¢ï¼Ÿæœ‰ä¸€ä¸ªä¸æ˜¯ç‰¹åˆ«ç²¾ç¡®çš„å‚è€ƒæ ‡å‡†ï¼š

- String ç±»å‹çš„ value è¶…è¿‡ 1MB
- å¤åˆç±»å‹ï¼ˆListã€Hashã€Setã€Sorted Set ç­‰ï¼‰çš„ value åŒ…å«çš„å…ƒç´ è¶…è¿‡ 5000 ä¸ªï¼ˆä¸è¿‡ï¼Œå¯¹äºå¤åˆç±»å‹çš„ value æ¥è¯´ï¼Œä¸ä¸€å®šåŒ…å«çš„å…ƒç´ è¶Šå¤šï¼Œå ç”¨çš„å†…å­˜å°±è¶Šå¤šï¼‰ã€‚

![](images\bigkey-criterion.png)

#### bigkey æ˜¯æ€ä¹ˆäº§ç”Ÿçš„ï¼Ÿæœ‰ä»€ä¹ˆå±å®³ï¼Ÿ

bigkey é€šå¸¸æ˜¯ç”±äºä¸‹é¢è¿™äº›åŸå› äº§ç”Ÿçš„ï¼š

- ç¨‹åºè®¾è®¡ä¸å½“ï¼Œæ¯”å¦‚ç›´æ¥ä½¿ç”¨ String ç±»å‹å­˜å‚¨è¾ƒå¤§çš„æ–‡ä»¶å¯¹åº”çš„äºŒè¿›åˆ¶æ•°æ®ã€‚
- å¯¹äºä¸šåŠ¡çš„æ•°æ®è§„æ¨¡è€ƒè™‘ä¸å‘¨åˆ°ï¼Œæ¯”å¦‚ä½¿ç”¨é›†åˆç±»å‹çš„æ—¶å€™æ²¡æœ‰è€ƒè™‘åˆ°æ•°æ®é‡çš„å¿«é€Ÿå¢é•¿ã€‚
- æœªåŠæ—¶æ¸…ç†åƒåœ¾æ•°æ®ï¼Œæ¯”å¦‚å“ˆå¸Œä¸­å†—ä½™äº†å¤§é‡çš„æ— ç”¨é”®å€¼å¯¹ã€‚

bigkey é™¤äº†**ä¼šæ¶ˆè€—æ›´å¤šçš„å†…å­˜ç©ºé—´å’Œå¸¦å®½**ï¼Œè¿˜ä¼šå¯¹æ€§èƒ½é€ æˆæ¯”è¾ƒå¤§çš„å½±å“ã€‚

åœ¨ [Redis å¸¸è§é˜»å¡åŸå› æ€»ç»“]()è¿™ç¯‡æ–‡ç« ä¸­æˆ‘ä»¬æåˆ°ï¼š**å¤§ key è¿˜ä¼šé€ æˆé˜»å¡é—®é¢˜**ã€‚å…·ä½“æ¥è¯´ï¼Œä¸»è¦ä½“ç°åœ¨ä¸‹é¢ä¸‰ä¸ªæ–¹é¢ï¼š

1. å®¢æˆ·ç«¯è¶…æ—¶é˜»å¡ï¼šç”±äº Redis æ‰§è¡Œå‘½ä»¤æ˜¯å•çº¿ç¨‹å¤„ç†ï¼Œç„¶ååœ¨æ“ä½œå¤§ key æ—¶ä¼šæ¯”è¾ƒè€—æ—¶ï¼Œé‚£ä¹ˆå°±ä¼šé˜»å¡ Redisï¼Œä»å®¢æˆ·ç«¯è¿™ä¸€è§†è§’çœ‹ï¼Œå°±æ˜¯å¾ˆä¹…å¾ˆä¹…éƒ½æ²¡æœ‰å“åº”ã€‚
2. ç½‘ç»œé˜»å¡ï¼šæ¯æ¬¡è·å–å¤§ key äº§ç”Ÿçš„ç½‘ç»œæµé‡è¾ƒå¤§ï¼Œå¦‚æœä¸€ä¸ª key çš„å¤§å°æ˜¯ 1 MBï¼Œæ¯ç§’è®¿é—®é‡ä¸º 1000ï¼Œé‚£ä¹ˆæ¯ç§’ä¼šäº§ç”Ÿ 1000MB çš„æµé‡ï¼Œè¿™å¯¹äºæ™®é€šåƒå…†ç½‘å¡çš„æœåŠ¡å™¨æ¥è¯´æ˜¯ç¾éš¾æ€§çš„ã€‚
3. å·¥ä½œçº¿ç¨‹é˜»å¡ï¼šå¦‚æœä½¿ç”¨ del åˆ é™¤å¤§ key æ—¶ï¼Œä¼šé˜»å¡å·¥ä½œçº¿ç¨‹ï¼Œè¿™æ ·å°±æ²¡åŠæ³•å¤„ç†åç»­çš„å‘½ä»¤ã€‚

å¤§ key é€ æˆçš„é˜»å¡é—®é¢˜è¿˜ä¼š**è¿›ä¸€æ­¥å½±å“åˆ°ä¸»ä»åŒæ­¥å’Œé›†ç¾¤æ‰©å®¹**ã€‚

ç»¼ä¸Šï¼Œå¤§ key å¸¦æ¥çš„æ½œåœ¨é—®é¢˜æ˜¯éå¸¸å¤šçš„ï¼Œæˆ‘ä»¬åº”è¯¥å°½é‡é¿å… Redis ä¸­å­˜åœ¨ bigkeyã€‚

#### å¦‚ä½•å‘ç° bigkeyï¼Ÿ

**1ã€ä½¿ç”¨ Redis è‡ªå¸¦çš„ `--bigkeys` å‚æ•°æ¥æŸ¥æ‰¾ã€‚**

```bash
# redis-cli -p 6379 --bigkeys

# Scanning the entire keyspace to find biggest keys as well as
# average sizes per key type.  You can use -i 0.1 to sleep 0.1 sec
# per 100 SCAN commands (not usually needed).

[00.00%] Biggest string found so far '"ballcat:oauth:refresh_auth:f6cdb384-9a9d-4f2f-af01-dc3f28057c20"' with 4437 bytes
[00.00%] Biggest list   found so far '"my-list"' with 17 items

-------- summary -------

Sampled 5 keys in the keyspace!
Total key length in bytes is 264 (avg len 52.80)

Biggest   list found '"my-list"' has 17 items
Biggest string found '"ballcat:oauth:refresh_auth:f6cdb384-9a9d-4f2f-af01-dc3f28057c20"' has 4437 bytes

1 lists with 17 items (20.00% of keys, avg size 17.00)
0 hashs with 0 fields (00.00% of keys, avg size 0.00)
4 strings with 4831 bytes (80.00% of keys, avg size 1207.75)
0 streams with 0 entries (00.00% of keys, avg size 0.00)
0 sets with 0 members (00.00% of keys, avg size 0.00)
0 zsets with 0 members (00.00% of keys, avg size 0.00
```

ä»è¿™ä¸ªå‘½ä»¤çš„è¿è¡Œç»“æœï¼Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼šè¿™ä¸ªå‘½ä»¤ä¼šæ‰«æ(Scan) Redis ä¸­çš„æ‰€æœ‰ key ï¼Œä¼šå¯¹ Redis çš„æ€§èƒ½æœ‰ä¸€ç‚¹å½±å“ã€‚å¹¶ä¸”ï¼Œè¿™ç§æ–¹å¼åªèƒ½æ‰¾å‡ºæ¯ç§æ•°æ®ç»“æ„ top 1 bigkeyï¼ˆå ç”¨å†…å­˜æœ€å¤§çš„ String æ•°æ®ç±»å‹ï¼ŒåŒ…å«å…ƒç´ æœ€å¤šçš„å¤åˆæ•°æ®ç±»å‹ï¼‰ã€‚ç„¶è€Œï¼Œä¸€ä¸ª key çš„å…ƒç´ å¤šå¹¶ä¸ä»£è¡¨å ç”¨å†…å­˜ä¹Ÿå¤šï¼Œéœ€è¦æˆ‘ä»¬æ ¹æ®å…·ä½“çš„ä¸šåŠ¡æƒ…å†µæ¥è¿›ä¸€æ­¥åˆ¤æ–­ã€‚

åœ¨çº¿ä¸Šæ‰§è¡Œè¯¥å‘½ä»¤æ—¶ï¼Œä¸ºäº†é™ä½å¯¹ Redis çš„å½±å“ï¼Œéœ€è¦æŒ‡å®š `-i` å‚æ•°æ§åˆ¶æ‰«æçš„é¢‘ç‡ã€‚`redis-cli -p 6379 --bigkeys -i 3` è¡¨ç¤ºæ‰«æè¿‡ç¨‹ä¸­æ¯æ¬¡æ‰«æåä¼‘æ¯çš„æ—¶é—´é—´éš”ä¸º 3 ç§’ã€‚

**2ã€ä½¿ç”¨ Redis è‡ªå¸¦çš„ SCAN å‘½ä»¤**

`SCAN` å‘½ä»¤å¯ä»¥æŒ‰ç…§ä¸€å®šçš„æ¨¡å¼å’Œæ•°é‡è¿”å›åŒ¹é…çš„ keyã€‚è·å–äº† key ä¹‹åï¼Œå¯ä»¥åˆ©ç”¨ `STRLEN`ã€`HLEN`ã€`LLEN`ç­‰å‘½ä»¤è¿”å›å…¶é•¿åº¦æˆ–æˆå‘˜æ•°é‡ã€‚

| æ•°æ®ç»“æ„   | å‘½ä»¤   | å¤æ‚åº¦ | ç»“æœï¼ˆå¯¹åº” keyï¼‰   |
| ---------- | ------ | ------ | ------------------ |
| String     | STRLEN | O(1)   | å­—ç¬¦ä¸²å€¼çš„é•¿åº¦     |
| Hash       | HLEN   | O(1)   | å“ˆå¸Œè¡¨ä¸­å­—æ®µçš„æ•°é‡ |
| List       | LLEN   | O(1)   | åˆ—è¡¨å…ƒç´ æ•°é‡       |
| Set        | SCARD  | O(1)   | é›†åˆå…ƒç´ æ•°é‡       |
| Sorted Set | ZCARD  | O(1)   | æœ‰åºé›†åˆçš„å…ƒç´ æ•°é‡ |

å¯¹äºé›†åˆç±»å‹è¿˜å¯ä»¥ä½¿ç”¨ `MEMORY USAGE` å‘½ä»¤ï¼ˆRedis 4.0+ï¼‰ï¼Œè¿™ä¸ªå‘½ä»¤ä¼šè¿”å›é”®å€¼å¯¹å ç”¨çš„å†…å­˜ç©ºé—´ã€‚

**3ã€å€ŸåŠ©å¼€æºå·¥å…·åˆ†æ RDBï¼ˆå¿«ç…§ï¼‰ æ–‡ä»¶ã€‚**

é€šè¿‡åˆ†æ RDB æ–‡ä»¶æ¥æ‰¾å‡º big keyã€‚è¿™ç§æ–¹æ¡ˆçš„å‰ææ˜¯ä½ çš„ Redis é‡‡ç”¨çš„æ˜¯ RDB æŒä¹…åŒ–ã€‚

ç½‘ä¸Šæœ‰ç°æˆçš„ä»£ç /å·¥å…·å¯ä»¥ç›´æ¥æ‹¿æ¥ä½¿ç”¨ï¼š

- [redis-rdb-tools](https://github.com/sripathikrishnan/redis-rdb-tools)ï¼šPython è¯­è¨€å†™çš„ç”¨æ¥åˆ†æ Redis çš„ RDB å¿«ç…§æ–‡ä»¶ç”¨çš„å·¥å…·
- [rdb_bigkeys](https://github.com/weiyanwei412/rdb_bigkeys) : Go è¯­è¨€å†™çš„ç”¨æ¥åˆ†æ Redis çš„ RDB å¿«ç…§æ–‡ä»¶ç”¨çš„å·¥å…·ï¼Œæ€§èƒ½æ›´å¥½ã€‚

**4ã€å€ŸåŠ©å…¬æœ‰äº‘çš„ Redis åˆ†ææœåŠ¡ã€‚**

å¦‚æœä½ ç”¨çš„æ˜¯å…¬æœ‰äº‘çš„ Redis æœåŠ¡çš„è¯ï¼Œå¯ä»¥çœ‹çœ‹å…¶æ˜¯å¦æä¾›äº† key åˆ†æåŠŸèƒ½ï¼ˆä¸€èˆ¬éƒ½æä¾›äº†ï¼‰ã€‚

è¿™é‡Œä»¥é˜¿é‡Œäº‘ Redis ä¸ºä¾‹è¯´æ˜ï¼Œå®ƒæ”¯æŒ bigkey å®æ—¶åˆ†æã€å‘ç°ï¼Œæ–‡æ¡£åœ°å€ï¼š[https://www.alibabacloud.com/help/zh/apsaradb-for-redis/latest/use-the-real-time-key-statistics-feature](https://www.alibabacloud.com/help/zh/apsaradb-for-redis/latest/use-the-real-time-key-statistics-feature) ã€‚

![](images\aliyun-key-analysis.png)

#### å¦‚ä½•å¤„ç† bigkeyï¼Ÿâœ…

bigkey çš„å¸¸è§å¤„ç†ä»¥åŠä¼˜åŒ–åŠæ³•å¦‚ä¸‹ï¼ˆè¿™äº›æ–¹æ³•å¯ä»¥é…åˆèµ·æ¥ä½¿ç”¨ï¼‰ï¼š

- **åˆ†å‰² bigkey**ï¼šå°†ä¸€ä¸ª bigkey åˆ†å‰²ä¸ºå¤šä¸ªå° keyã€‚ä¾‹å¦‚ï¼Œå°†ä¸€ä¸ªå«æœ‰ä¸Šä¸‡å­—æ®µæ•°é‡çš„ Hash æŒ‰ç…§ä¸€å®šç­–ç•¥ï¼ˆæ¯”å¦‚äºŒæ¬¡å“ˆå¸Œï¼‰æ‹†åˆ†ä¸ºå¤šä¸ª Hashã€‚
- **æ‰‹åŠ¨æ¸…ç†**ï¼šRedis 4.0+ å¯ä»¥ä½¿ç”¨ `UNLINK` å‘½ä»¤æ¥å¼‚æ­¥åˆ é™¤ä¸€ä¸ªæˆ–å¤šä¸ªæŒ‡å®šçš„ keyã€‚Redis 4.0 ä»¥ä¸‹å¯ä»¥è€ƒè™‘ä½¿ç”¨ `SCAN` å‘½ä»¤ç»“åˆ `DEL` å‘½ä»¤æ¥åˆ†æ‰¹æ¬¡åˆ é™¤ã€‚
- **é‡‡ç”¨åˆé€‚çš„æ•°æ®ç»“æ„**ï¼šä¾‹å¦‚ï¼Œæ–‡ä»¶äºŒè¿›åˆ¶æ•°æ®ä¸ä½¿ç”¨ String ä¿å­˜ã€ä½¿ç”¨ HyperLogLog ç»Ÿè®¡é¡µé¢ UVã€Bitmap ä¿å­˜çŠ¶æ€ä¿¡æ¯ï¼ˆ0/1ï¼‰ã€‚
- **å¼€å¯ lazy-freeï¼ˆæƒ°æ€§åˆ é™¤/å»¶è¿Ÿé‡Šæ”¾ï¼‰** ï¼šlazy-free ç‰¹æ€§æ˜¯ Redis 4.0 å¼€å§‹å¼•å…¥çš„ï¼ŒæŒ‡çš„æ˜¯è®© Redis é‡‡ç”¨å¼‚æ­¥æ–¹å¼å»¶è¿Ÿé‡Šæ”¾ key ä½¿ç”¨çš„å†…å­˜ï¼Œå°†è¯¥æ“ä½œäº¤ç»™å•ç‹¬çš„å­çº¿ç¨‹å¤„ç†ï¼Œé¿å…é˜»å¡ä¸»çº¿ç¨‹ã€‚

### Redis hotkeyï¼ˆçƒ­ Keyï¼‰âœ…

#### ä»€ä¹ˆæ˜¯ hotkeyï¼Ÿ

å¦‚æœä¸€ä¸ª key çš„è®¿é—®æ¬¡æ•°æ¯”è¾ƒå¤šä¸”æ˜æ˜¾å¤šäºå…¶ä»– key çš„è¯ï¼Œé‚£è¿™ä¸ª key å°±å¯ä»¥çœ‹ä½œæ˜¯ **`hotkeyï¼ˆçƒ­ Keyï¼‰`**ã€‚ä¾‹å¦‚åœ¨ Redis å®ä¾‹çš„æ¯ç§’å¤„ç†è¯·æ±‚è¾¾åˆ° 5000 æ¬¡ï¼Œè€Œå…¶ä¸­æŸä¸ª key çš„æ¯ç§’è®¿é—®é‡å°±é«˜è¾¾ 2000 æ¬¡ï¼Œé‚£è¿™ä¸ª key å°±å¯ä»¥çœ‹ä½œæ˜¯ hotkeyã€‚

hotkey å‡ºç°çš„åŸå› ä¸»è¦æ˜¯æŸä¸ªçƒ­ç‚¹æ•°æ®è®¿é—®é‡æš´å¢ï¼Œå¦‚é‡å¤§çš„çƒ­æœäº‹ä»¶ã€å‚ä¸ç§’æ€çš„å•†å“ã€‚

#### hotkey æœ‰ä»€ä¹ˆå±å®³ï¼Ÿ

å¤„ç† hotkey ä¼šå ç”¨å¤§é‡çš„ CPU å’Œå¸¦å®½ï¼Œå¯èƒ½ä¼šå½±å“ Redis å®ä¾‹å¯¹å…¶ä»–è¯·æ±‚çš„æ­£å¸¸å¤„ç†ã€‚æ­¤å¤–ï¼Œå¦‚æœçªç„¶è®¿é—® hotkey çš„è¯·æ±‚è¶…å‡ºäº† Redis çš„å¤„ç†èƒ½åŠ›ï¼ŒRedis å°±ä¼šç›´æ¥å®•æœºã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œå¤§é‡è¯·æ±‚å°†è½åˆ°åé¢çš„æ•°æ®åº“ä¸Šï¼Œå¯èƒ½ä¼šå¯¼è‡´æ•°æ®åº“å´©æºƒã€‚

å› æ­¤ï¼Œhotkey å¾ˆå¯èƒ½æˆä¸ºç³»ç»Ÿæ€§èƒ½çš„ç“¶é¢ˆç‚¹ï¼Œéœ€è¦å•ç‹¬å¯¹å…¶è¿›è¡Œä¼˜åŒ–ï¼Œä»¥ç¡®ä¿ç³»ç»Ÿçš„é«˜å¯ç”¨æ€§å’Œç¨³å®šæ€§ã€‚

#### å¦‚ä½•å‘ç° hotkeyï¼Ÿ

**1ã€ä½¿ç”¨ Redis è‡ªå¸¦çš„ `--hotkeys` å‚æ•°æ¥æŸ¥æ‰¾ã€‚**

Redis 4.0.3 ç‰ˆæœ¬ä¸­æ–°å¢äº† `hotkeys` å‚æ•°ï¼Œè¯¥å‚æ•°èƒ½å¤Ÿè¿”å›æ‰€æœ‰ key çš„è¢«è®¿é—®æ¬¡æ•°ã€‚

ä½¿ç”¨è¯¥æ–¹æ¡ˆçš„å‰ææ¡ä»¶æ˜¯ Redis Server çš„ `maxmemory-policy` å‚æ•°è®¾ç½®ä¸º LFU ç®—æ³•ï¼Œä¸ç„¶å°±ä¼šå‡ºç°å¦‚ä¸‹æ‰€ç¤ºçš„é”™è¯¯ã€‚

```bash
# redis-cli -p 6379 --hotkeys

# Scanning the entire keyspace to find hot keys as well as
# average sizes per key type.  You can use -i 0.1 to sleep 0.1 sec
# per 100 SCAN commands (not usually needed).

Error: ERR An LFU maxmemory policy is not selected, access frequency not tracked. Please note that when switching between policies at runtime LRU and LFU data will take some time to adjust.
```

Redis ä¸­æœ‰ä¸¤ç§ LFU ç®—æ³•ï¼š

1. **volatile-lfuï¼ˆleast frequently usedï¼‰**ï¼šä»å·²è®¾ç½®è¿‡æœŸæ—¶é—´çš„æ•°æ®é›†ï¼ˆ`server.db[i].expires`ï¼‰ä¸­æŒ‘é€‰æœ€ä¸ç»å¸¸ä½¿ç”¨çš„æ•°æ®æ·˜æ±°ã€‚
2. **allkeys-lfuï¼ˆleast frequently usedï¼‰**ï¼šå½“å†…å­˜ä¸è¶³ä»¥å®¹çº³æ–°å†™å…¥æ•°æ®æ—¶ï¼Œåœ¨é”®ç©ºé—´ä¸­ï¼Œç§»é™¤æœ€ä¸ç»å¸¸ä½¿ç”¨çš„ keyã€‚

ä»¥ä¸‹æ˜¯é…ç½®æ–‡ä»¶ `redis.conf` ä¸­çš„ç¤ºä¾‹ï¼š

```properties
# ä½¿ç”¨ volatile-lfu ç­–ç•¥
maxmemory-policy volatile-lfu

# æˆ–è€…ä½¿ç”¨ allkeys-lfu ç­–ç•¥
maxmemory-policy allkeys-lfu
```

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ`hotkeys` å‚æ•°å‘½ä»¤ä¹Ÿä¼šå¢åŠ  Redis å®ä¾‹çš„ CPU å’Œå†…å­˜æ¶ˆè€—ï¼ˆå…¨å±€æ‰«æï¼‰ï¼Œå› æ­¤éœ€è¦è°¨æ…ä½¿ç”¨ã€‚

**2ã€ä½¿ç”¨`MONITOR` å‘½ä»¤ã€‚**

`MONITOR` å‘½ä»¤æ˜¯ Redis æä¾›çš„ä¸€ç§å®æ—¶æŸ¥çœ‹ Redis çš„æ‰€æœ‰æ“ä½œçš„æ–¹å¼ï¼Œå¯ä»¥ç”¨äºä¸´æ—¶ç›‘æ§ Redis å®ä¾‹çš„æ“ä½œæƒ…å†µï¼ŒåŒ…æ‹¬è¯»å†™ã€åˆ é™¤ç­‰æ“ä½œã€‚

ç”±äºè¯¥å‘½ä»¤å¯¹ Redis æ€§èƒ½çš„å½±å“æ¯”è¾ƒå¤§ï¼Œå› æ­¤ç¦æ­¢é•¿æ—¶é—´å¼€å¯ `MONITOR`ï¼ˆç”Ÿäº§ç¯å¢ƒä¸­å»ºè®®è°¨æ…ä½¿ç”¨è¯¥å‘½ä»¤ï¼‰ã€‚

```java
# redis-cli
127.0.0.1:6379> MONITOR
OK
1683638260.637378 [0 172.17.0.1:61516] "ping"
1683638267.144236 [0 172.17.0.1:61518] "smembers" "mySet"
1683638268.941863 [0 172.17.0.1:61518] "smembers" "mySet"
1683638269.551671 [0 172.17.0.1:61518] "smembers" "mySet"
1683638270.646256 [0 172.17.0.1:61516] "ping"
1683638270.849551 [0 172.17.0.1:61518] "smembers" "mySet"
1683638271.926945 [0 172.17.0.1:61518] "smembers" "mySet"
1683638274.276599 [0 172.17.0.1:61518] "smembers" "mySet2"
1683638276.327234 [0 172.17.0.1:61518] "smembers" "mySet"
```

åœ¨å‘ç”Ÿç´§æ€¥æƒ…å†µæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥é€‰æ‹©åœ¨åˆé€‚çš„æ—¶æœºçŸ­æš‚æ‰§è¡Œ `MONITOR` å‘½ä»¤å¹¶å°†è¾“å‡ºé‡å®šå‘è‡³æ–‡ä»¶ï¼Œåœ¨å…³é—­ `MONITOR` å‘½ä»¤åé€šè¿‡å¯¹æ–‡ä»¶ä¸­è¯·æ±‚è¿›è¡Œå½’ç±»åˆ†æå³å¯æ‰¾å‡ºè¿™æ®µæ—¶é—´ä¸­çš„ hotkeyã€‚

**3ã€å€ŸåŠ©å¼€æºé¡¹ç›®ã€‚**

äº¬ä¸œé›¶å”®çš„ [hotkey](https://gitee.com/jd-platform-opensource/hotkey) è¿™ä¸ªé¡¹ç›®ä¸å…‰æ”¯æŒ hotkey çš„å‘ç°ï¼Œè¿˜æ”¯æŒ hotkey çš„å¤„ç†ã€‚

![](images\jd-hotkey.png)

**4ã€æ ¹æ®ä¸šåŠ¡æƒ…å†µæå‰é¢„ä¼°ã€‚**

å¯ä»¥æ ¹æ®ä¸šåŠ¡æƒ…å†µæ¥é¢„ä¼°ä¸€äº› hotkeyï¼Œæ¯”å¦‚å‚ä¸ç§’æ€æ´»åŠ¨çš„å•†å“æ•°æ®ç­‰ã€‚ä¸è¿‡ï¼Œæˆ‘ä»¬æ— æ³•é¢„ä¼°æ‰€æœ‰ hotkey çš„å‡ºç°ï¼Œæ¯”å¦‚çªå‘çš„çƒ­ç‚¹æ–°é—»äº‹ä»¶ç­‰ã€‚

**5ã€ä¸šåŠ¡ä»£ç ä¸­è®°å½•åˆ†æã€‚**

åœ¨ä¸šåŠ¡ä»£ç ä¸­æ·»åŠ ç›¸åº”çš„é€»è¾‘å¯¹ key çš„è®¿é—®æƒ…å†µè¿›è¡Œè®°å½•åˆ†æã€‚ä¸è¿‡ï¼Œè¿™ç§æ–¹å¼ä¼šè®©ä¸šåŠ¡ä»£ç çš„å¤æ‚æ€§å¢åŠ ï¼Œä¸€èˆ¬ä¹Ÿä¸ä¼šé‡‡ç”¨ã€‚

**6ã€å€ŸåŠ©å…¬æœ‰äº‘çš„ Redis åˆ†ææœåŠ¡ã€‚**

å¦‚æœä½ ç”¨çš„æ˜¯å…¬æœ‰äº‘çš„ Redis æœåŠ¡çš„è¯ï¼Œå¯ä»¥çœ‹çœ‹å…¶æ˜¯å¦æä¾›äº† key åˆ†æåŠŸèƒ½ï¼ˆä¸€èˆ¬éƒ½æä¾›äº†ï¼‰ã€‚

è¿™é‡Œä»¥é˜¿é‡Œäº‘ Redis ä¸ºä¾‹è¯´æ˜ï¼Œå®ƒæ”¯æŒ hotkey å®æ—¶åˆ†æã€å‘ç°ï¼Œæ–‡æ¡£åœ°å€ï¼š[https://www.alibabacloud.com/help/zh/apsaradb-for-redis/latest/use-the-real-time-key-statistics-feature](https://www.alibabacloud.com/help/zh/apsaradb-for-redis/latest/use-the-real-time-key-statistics-feature) ã€‚

![](images\aliyun-key-analysis (1).png)

#### å¦‚ä½•è§£å†³ hotkeyï¼Ÿâœ…

hotkey çš„å¸¸è§å¤„ç†ä»¥åŠä¼˜åŒ–åŠæ³•å¦‚ä¸‹ï¼ˆè¿™äº›æ–¹æ³•å¯ä»¥é…åˆèµ·æ¥ä½¿ç”¨ï¼‰ï¼š

- **è¯»å†™åˆ†ç¦»**ï¼šä¸»èŠ‚ç‚¹å¤„ç†å†™è¯·æ±‚ï¼Œä»èŠ‚ç‚¹å¤„ç†è¯»è¯·æ±‚ã€‚
- **ä½¿ç”¨ Redis Cluster**ï¼šå°†çƒ­ç‚¹æ•°æ®åˆ†æ•£å­˜å‚¨åœ¨å¤šä¸ª Redis èŠ‚ç‚¹ä¸Šã€‚
- **äºŒçº§ç¼“å­˜**ï¼šhotkey é‡‡ç”¨äºŒçº§ç¼“å­˜çš„æ–¹å¼è¿›è¡Œå¤„ç†ï¼Œå°† hotkey å­˜æ”¾ä¸€ä»½åˆ° JVM æœ¬åœ°å†…å­˜ä¸­ï¼ˆå¯ä»¥ç”¨ Caffeineï¼‰ã€‚

é™¤äº†è¿™äº›æ–¹æ³•ä¹‹å¤–ï¼Œå¦‚æœä½ ä½¿ç”¨çš„å…¬æœ‰äº‘çš„ Redis æœåŠ¡è¯ï¼Œè¿˜å¯ä»¥ç•™æ„å…¶æä¾›çš„å¼€ç®±å³ç”¨çš„è§£å†³æ–¹æ¡ˆã€‚

è¿™é‡Œä»¥é˜¿é‡Œäº‘ Redis ä¸ºä¾‹è¯´æ˜ï¼Œå®ƒæ”¯æŒé€šè¿‡ä»£ç†æŸ¥è¯¢ç¼“å­˜åŠŸèƒ½ï¼ˆProxy Query Cacheï¼‰ä¼˜åŒ–çƒ­ç‚¹ Key é—®é¢˜ã€‚

![](images\aliyun-hotkey-proxy-query-cache.png)

### æ…¢æŸ¥è¯¢å‘½ä»¤

#### ä¸ºä»€ä¹ˆä¼šæœ‰æ…¢æŸ¥è¯¢å‘½ä»¤ï¼Ÿ

æˆ‘ä»¬çŸ¥é“ä¸€ä¸ª Redis å‘½ä»¤çš„æ‰§è¡Œå¯ä»¥ç®€åŒ–ä¸ºä»¥ä¸‹ 4 æ­¥ï¼š

1. å‘é€å‘½ä»¤
2. å‘½ä»¤æ’é˜Ÿ
3. å‘½ä»¤æ‰§è¡Œ
4. è¿”å›ç»“æœ

Redis æ…¢æŸ¥è¯¢ç»Ÿè®¡çš„æ˜¯å‘½ä»¤æ‰§è¡Œè¿™ä¸€æ­¥éª¤çš„è€—æ—¶ï¼Œ**æ…¢æŸ¥è¯¢å‘½ä»¤ä¹Ÿå°±æ˜¯é‚£äº›å‘½ä»¤æ‰§è¡Œæ—¶é—´è¾ƒé•¿çš„å‘½ä»¤**ã€‚

Redis ä¸ºä»€ä¹ˆä¼šæœ‰æ…¢æŸ¥è¯¢å‘½ä»¤å‘¢ï¼Ÿ

Redis ä¸­çš„å¤§éƒ¨åˆ†å‘½ä»¤éƒ½æ˜¯ O(1)æ—¶é—´å¤æ‚åº¦ï¼Œä½†ä¹Ÿæœ‰å°‘éƒ¨åˆ† O(n) æ—¶é—´å¤æ‚åº¦çš„å‘½ä»¤ï¼Œä¾‹å¦‚ï¼š

- `KEYS *`ï¼šä¼šè¿”å›æ‰€æœ‰ç¬¦åˆè§„åˆ™çš„ keyã€‚
- `HGETALL`ï¼šä¼šè¿”å›ä¸€ä¸ª Hash ä¸­æ‰€æœ‰çš„é”®å€¼å¯¹ã€‚
- `LRANGE`ï¼šä¼šè¿”å› List ä¸­æŒ‡å®šèŒƒå›´å†…çš„å…ƒç´ ã€‚
- `SMEMBERS`ï¼šè¿”å› Set ä¸­çš„æ‰€æœ‰å…ƒç´ ã€‚
- `SINTER`/`SUNION`/`SDIFF`ï¼šè®¡ç®—å¤šä¸ª Set çš„äº¤é›†/å¹¶é›†/å·®é›†ã€‚
- â€¦â€¦

ç”±äºè¿™äº›å‘½ä»¤æ—¶é—´å¤æ‚åº¦æ˜¯ O(n)ï¼Œæœ‰æ—¶å€™ä¹Ÿä¼šå…¨è¡¨æ‰«æï¼Œéšç€ n çš„å¢å¤§ï¼Œæ‰§è¡Œè€—æ—¶ä¹Ÿä¼šè¶Šé•¿ã€‚ä¸è¿‡ï¼Œ è¿™äº›å‘½ä»¤å¹¶ä¸æ˜¯ä¸€å®šä¸èƒ½ä½¿ç”¨ï¼Œä½†æ˜¯éœ€è¦æ˜ç¡® N çš„å€¼ã€‚å¦å¤–ï¼Œæœ‰éå†çš„éœ€æ±‚å¯ä»¥ä½¿ç”¨ `HSCAN`ã€`SSCAN`ã€`ZSCAN` ä»£æ›¿ã€‚

é™¤äº†è¿™äº› O(n)æ—¶é—´å¤æ‚åº¦çš„å‘½ä»¤å¯èƒ½ä¼šå¯¼è‡´æ…¢æŸ¥è¯¢ä¹‹å¤–ï¼Œ è¿˜æœ‰ä¸€äº›æ—¶é—´å¤æ‚åº¦å¯èƒ½åœ¨ O(N) ä»¥ä¸Šçš„å‘½ä»¤ï¼Œä¾‹å¦‚ï¼š

- `ZRANGE`/`ZREVRANGE`ï¼šè¿”å›æŒ‡å®š Sorted Set ä¸­æŒ‡å®šæ’åèŒƒå›´å†…çš„æ‰€æœ‰å…ƒç´ ã€‚æ—¶é—´å¤æ‚åº¦ä¸º O(log(n)+m)ï¼Œn ä¸ºæ‰€æœ‰å…ƒç´ çš„æ•°é‡ï¼Œ m ä¸ºè¿”å›çš„å…ƒç´ æ•°é‡ï¼Œå½“ m å’Œ n ç›¸å½“å¤§æ—¶ï¼ŒO(n) çš„æ—¶é—´å¤æ‚åº¦æ›´å°ã€‚
- `ZREMRANGEBYRANK`/`ZREMRANGEBYSCORE`ï¼šç§»é™¤ Sorted Set ä¸­æŒ‡å®šæ’åèŒƒå›´/æŒ‡å®š score èŒƒå›´å†…çš„æ‰€æœ‰å…ƒç´ ã€‚æ—¶é—´å¤æ‚åº¦ä¸º O(log(n)+m)ï¼Œn ä¸ºæ‰€æœ‰å…ƒç´ çš„æ•°é‡ï¼Œ m è¢«åˆ é™¤å…ƒç´ çš„æ•°é‡ï¼Œå½“ m å’Œ n ç›¸å½“å¤§æ—¶ï¼ŒO(n) çš„æ—¶é—´å¤æ‚åº¦æ›´å°ã€‚
- â€¦â€¦

#### å¦‚ä½•æ‰¾åˆ°æ…¢æŸ¥è¯¢å‘½ä»¤ï¼Ÿ

åœ¨ `redis.conf` æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ **`slowlog-log-slower-than`** å‚æ•°è®¾ç½®**è€—æ—¶å‘½ä»¤çš„é˜ˆå€¼**ï¼Œå¹¶ä½¿ç”¨ **`slowlog-max-len`** å‚æ•°è®¾ç½®**è€—æ—¶å‘½ä»¤çš„æœ€å¤§è®°å½•æ¡æ•°**ã€‚

å½“ Redis æœåŠ¡å™¨æ£€æµ‹åˆ°æ‰§è¡Œæ—¶é—´è¶…è¿‡ `slowlog-log-slower-than`é˜ˆå€¼çš„å‘½ä»¤æ—¶ï¼Œå°±ä¼šå°†è¯¥å‘½ä»¤è®°å½•åœ¨**æ…¢æŸ¥è¯¢æ—¥å¿—(slow log)** ä¸­ï¼Œè¿™ç‚¹å’Œ MySQL è®°å½•æ…¢æŸ¥è¯¢è¯­å¥ç±»ä¼¼ã€‚å½“æ…¢æŸ¥è¯¢æ—¥å¿—è¶…è¿‡è®¾å®šçš„æœ€å¤§è®°å½•æ¡æ•°ä¹‹åï¼ŒRedis ä¼šæŠŠæœ€æ—©çš„æ‰§è¡Œå‘½ä»¤ä¾æ¬¡èˆå¼ƒã€‚

âš ï¸æ³¨æ„ï¼šç”±äºæ…¢æŸ¥è¯¢æ—¥å¿—ä¼šå ç”¨ä¸€å®šå†…å­˜ç©ºé—´ï¼Œå¦‚æœè®¾ç½®æœ€å¤§è®°å½•æ¡æ•°è¿‡å¤§ï¼Œå¯èƒ½ä¼šå¯¼è‡´å†…å­˜å ç”¨è¿‡é«˜çš„é—®é¢˜ã€‚

`slowlog-log-slower-than`å’Œ`slowlog-max-len`çš„é»˜è®¤é…ç½®å¦‚ä¸‹(å¯ä»¥è‡ªè¡Œä¿®æ”¹)ï¼š

```nginx
# The following time is expressed in microseconds, so 1000000 is equivalent
# to one second. Note that a negative number disables the slow log, while
# a value of zero forces the logging of every command.
slowlog-log-slower-than 10000

# There is no limit to this length. Just be aware that it will consume memory.
# You can reclaim memory used by the slow log with SLOWLOG RESET.
slowlog-max-len 128
```

é™¤äº†ä¿®æ”¹é…ç½®æ–‡ä»¶ä¹‹å¤–ï¼Œä½ ä¹Ÿå¯ä»¥ç›´æ¥é€šè¿‡ `CONFIG` å‘½ä»¤ç›´æ¥è®¾ç½®ï¼š

```bash
# å‘½ä»¤æ‰§è¡Œè€—æ—¶è¶…è¿‡ 10000 å¾®å¦™ï¼ˆå³10æ¯«ç§’ï¼‰å°±ä¼šè¢«è®°å½•
CONFIG SET slowlog-log-slower-than 10000
# åªä¿ç•™æœ€è¿‘ 128 æ¡è€—æ—¶å‘½ä»¤
CONFIG SET slowlog-max-len 128
```

è·å–æ…¢æŸ¥è¯¢æ—¥å¿—çš„å†…å®¹å¾ˆç®€å•ï¼Œç›´æ¥ä½¿ç”¨**`SLOWLOG GET`** å‘½ä»¤å³å¯ã€‚

```java
127.0.0.1:6379> SLOWLOG GET #æ…¢æ—¥å¿—æŸ¥è¯¢
 1) 1) (integer) 5
   2) (integer) 1684326682
   3) (integer) 12000
   4) 1) "KEYS"
      2) "*"
   5) "172.17.0.1:61152"
   6) ""
  // ...
```

æ…¢æŸ¥è¯¢æ—¥å¿—ä¸­çš„æ¯ä¸ªæ¡ç›®éƒ½ç”±ä»¥ä¸‹å…­ä¸ªå€¼ç»„æˆï¼š

1. å”¯ä¸€æ¸è¿›çš„æ—¥å¿—æ ‡è¯†ç¬¦ã€‚
2. å¤„ç†è®°å½•å‘½ä»¤çš„ Unix æ—¶é—´æˆ³ã€‚
3. æ‰§è¡Œæ‰€éœ€çš„æ—¶é—´é‡ï¼Œä»¥å¾®ç§’ä¸ºå•ä½ã€‚
4. ç»„æˆå‘½ä»¤å‚æ•°çš„æ•°ç»„ã€‚
5. å®¢æˆ·ç«¯ IP åœ°å€å’Œç«¯å£ã€‚
6. å®¢æˆ·ç«¯åç§°ã€‚

`SLOWLOG GET` å‘½ä»¤é»˜è®¤è¿”å›æœ€è¿‘ 10 æ¡çš„çš„æ…¢æŸ¥è¯¢å‘½ä»¤ï¼Œä½ ä¹Ÿè‡ªå·±å¯ä»¥æŒ‡å®šè¿”å›çš„æ…¢æŸ¥è¯¢å‘½ä»¤çš„æ•°é‡ `SLOWLOG GET N`ã€‚

ä¸‹é¢æ˜¯å…¶ä»–æ¯”è¾ƒå¸¸ç”¨çš„æ…¢æŸ¥è¯¢ç›¸å…³çš„å‘½ä»¤ï¼š

```bash
# è¿”å›æ…¢æŸ¥è¯¢å‘½ä»¤çš„æ•°é‡
127.0.0.1:6379> SLOWLOG LEN
(integer) 128
# æ¸…ç©ºæ…¢æŸ¥è¯¢å‘½ä»¤
127.0.0.1:6379> SLOWLOG RESET
OK
```

### Redis å†…å­˜ç¢ç‰‡

**ç›¸å…³é—®é¢˜**ï¼š

1. ä»€ä¹ˆæ˜¯å†…å­˜ç¢ç‰‡?ä¸ºä»€ä¹ˆä¼šæœ‰ Redis å†…å­˜ç¢ç‰‡?
2. å¦‚ä½•æ¸…ç† Redis å†…å­˜ç¢ç‰‡ï¼Ÿ

**å‚è€ƒç­”æ¡ˆ**ï¼š[Redis å†…å­˜ç¢ç‰‡è¯¦è§£](https://javaguide.cn/database/redis/redis-memory-fragmentation.html)  å‚è€ƒç¬”è®°  [Rediså†…å­˜ç¢ç‰‡è¯¦è§£ï¼ˆæ›´æ–°ä¸­ï¼‰](# Rediså†…å­˜ç¢ç‰‡è¯¦è§£ï¼ˆæ›´æ–°ä¸­ï¼‰) 

## Redis ç”Ÿäº§é—®é¢˜ï¼ˆé‡è¦ï¼‰âœ…

### ç¼“å­˜ç©¿é€ âœ…

#### ä»€ä¹ˆæ˜¯ç¼“å­˜ç©¿é€ï¼Ÿ

==**ç¼“å­˜ç©¿é€**==è¯´ç®€å•ç‚¹å°±æ˜¯å¤§é‡è¯·æ±‚çš„ key æ˜¯ä¸åˆç†çš„ï¼Œ**æ ¹æœ¬ä¸å­˜åœ¨äºç¼“å­˜ä¸­ï¼Œä¹Ÿä¸å­˜åœ¨äºæ•°æ®åº“ä¸­** ã€‚è¿™å°±å¯¼è‡´è¿™äº›è¯·æ±‚ç›´æ¥åˆ°äº†æ•°æ®åº“ä¸Šï¼Œæ ¹æœ¬æ²¡æœ‰ç»è¿‡ç¼“å­˜è¿™ä¸€å±‚ï¼Œå¯¹æ•°æ®åº“é€ æˆäº†å·¨å¤§çš„å‹åŠ›ï¼Œå¯èƒ½ç›´æ¥å°±è¢«è¿™ä¹ˆå¤šè¯·æ±‚å¼„å®•æœºäº†ã€‚

![](images\redis-cache-penetration.png)

ä¸¾ä¸ªä¾‹å­ï¼šæŸä¸ªé»‘å®¢æ•…æ„åˆ¶é€ ä¸€äº›éæ³•çš„ key å‘èµ·å¤§é‡è¯·æ±‚ï¼Œå¯¼è‡´å¤§é‡è¯·æ±‚è½åˆ°æ•°æ®åº“ï¼Œç»“æœæ•°æ®åº“ä¸Šä¹Ÿæ²¡æœ‰æŸ¥åˆ°å¯¹åº”çš„æ•°æ®ã€‚ä¹Ÿå°±æ˜¯è¯´è¿™äº›è¯·æ±‚æœ€ç»ˆéƒ½è½åˆ°äº†æ•°æ®åº“ä¸Šï¼Œå¯¹æ•°æ®åº“é€ æˆäº†å·¨å¤§çš„å‹åŠ›ã€‚

#### æœ‰å“ªäº›è§£å†³åŠæ³•ï¼Ÿâœ…

æœ€åŸºæœ¬çš„å°±æ˜¯é¦–å…ˆåšå¥½å‚æ•°æ ¡éªŒï¼Œä¸€äº›ä¸åˆæ³•çš„å‚æ•°è¯·æ±‚ç›´æ¥æŠ›å‡ºå¼‚å¸¸ä¿¡æ¯è¿”å›ç»™å®¢æˆ·ç«¯ã€‚æ¯”å¦‚æŸ¥è¯¢çš„æ•°æ®åº“ id ä¸èƒ½å°äº 0ã€ä¼ å…¥çš„é‚®ç®±æ ¼å¼ä¸å¯¹çš„æ—¶å€™ç›´æ¥è¿”å›é”™è¯¯æ¶ˆæ¯ç»™å®¢æˆ·ç«¯ç­‰ç­‰ã€‚

**1ï¼‰ç¼“å­˜æ— æ•ˆ key**

å¦‚æœç¼“å­˜å’Œæ•°æ®åº“éƒ½æŸ¥ä¸åˆ°æŸä¸ª key çš„æ•°æ®å°±å†™ä¸€ä¸ªåˆ° Redis ä¸­å»å¹¶è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œå…·ä½“å‘½ä»¤å¦‚ä¸‹ï¼š`SET key value EX 10086` ã€‚è¿™ç§æ–¹å¼å¯ä»¥è§£å†³è¯·æ±‚çš„ key å˜åŒ–ä¸é¢‘ç¹çš„æƒ…å†µï¼Œå¦‚æœé»‘å®¢æ¶æ„æ”»å‡»ï¼Œæ¯æ¬¡æ„å»ºä¸åŒçš„è¯·æ±‚ keyï¼Œä¼šå¯¼è‡´ Redis ä¸­ç¼“å­˜å¤§é‡æ— æ•ˆçš„ key ã€‚å¾ˆæ˜æ˜¾ï¼Œè¿™ç§æ–¹æ¡ˆå¹¶ä¸èƒ½ä»æ ¹æœ¬ä¸Šè§£å†³æ­¤é—®é¢˜ã€‚å¦‚æœéè¦ç”¨è¿™ç§æ–¹å¼æ¥è§£å†³ç©¿é€é—®é¢˜çš„è¯ï¼Œå°½é‡å°†æ— æ•ˆçš„ key çš„è¿‡æœŸæ—¶é—´è®¾ç½®çŸ­ä¸€ç‚¹æ¯”å¦‚ 1 åˆ†é’Ÿã€‚

å¦å¤–ï¼Œè¿™é‡Œå¤šè¯´ä¸€å˜´ï¼Œä¸€èˆ¬æƒ…å†µä¸‹æˆ‘ä»¬æ˜¯è¿™æ ·è®¾è®¡ key çš„ï¼š`è¡¨å:åˆ—å:ä¸»é”®å:ä¸»é”®å€¼` ã€‚

å¦‚æœç”¨ Java ä»£ç å±•ç¤ºçš„è¯ï¼Œå·®ä¸å¤šæ˜¯ä¸‹é¢è¿™æ ·çš„ï¼š

```java
public Object getObjectInclNullById(Integer id) {
    // ä»ç¼“å­˜ä¸­è·å–æ•°æ®
    Object cacheValue = cache.get(id);
    // ç¼“å­˜ä¸ºç©º
    if (cacheValue == null) {
        // ä»æ•°æ®åº“ä¸­è·å–
        Object storageValue = storage.get(key);
        // ç¼“å­˜ç©ºå¯¹è±¡
        cache.set(key, storageValue);
        // å¦‚æœå­˜å‚¨æ•°æ®ä¸ºç©ºï¼Œéœ€è¦è®¾ç½®ä¸€ä¸ªè¿‡æœŸæ—¶é—´(300ç§’)
        if (storageValue == null) {
            // å¿…é¡»è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œå¦åˆ™æœ‰è¢«æ”»å‡»çš„é£é™©
            cache.expire(key, 60 * 5);
        }
        return storageValue;
    }
    return cacheValue;
}
```

**2ï¼‰å¸ƒéš†è¿‡æ»¤å™¨** âœ…

å¸ƒéš†è¿‡æ»¤å™¨`Bloom Filter`æ˜¯ä¸€ä¸ªéå¸¸ç¥å¥‡çš„æ•°æ®ç»“æ„ï¼Œé€šè¿‡å®ƒæˆ‘ä»¬å¯ä»¥éå¸¸æ–¹ä¾¿åœ°åˆ¤æ–­ä¸€ä¸ªç»™å®šæ•°æ®æ˜¯å¦å­˜åœ¨äºæµ·é‡æ•°æ®ä¸­ã€‚æˆ‘ä»¬å¯ä»¥æŠŠå®ƒçœ‹ä½œç”±**äºŒè¿›åˆ¶å‘é‡ï¼ˆæˆ–è€…è¯´ä½æ•°ç»„ï¼‰**å’Œä¸€ç³»åˆ—**éšæœºæ˜ å°„å‡½æ•°ï¼ˆå“ˆå¸Œå‡½æ•°ï¼‰**ä¸¤éƒ¨åˆ†ç»„æˆçš„æ•°æ®ç»“æ„ã€‚ç›¸æ¯”äºæˆ‘ä»¬å¹³æ—¶å¸¸ç”¨çš„ Listã€Mapã€Set ç­‰æ•°æ®ç»“æ„ï¼Œå®ƒå ç”¨ç©ºé—´æ›´å°‘å¹¶ä¸”æ•ˆç‡æ›´é«˜ï¼Œä½†æ˜¯ç¼ºç‚¹æ˜¯å…¶è¿”å›çš„**ç»“æœæ˜¯æ¦‚ç‡æ€§**çš„ï¼Œè€Œä¸æ˜¯éå¸¸å‡†ç¡®çš„ã€‚ç†è®ºæƒ…å†µä¸‹æ·»åŠ åˆ°é›†åˆä¸­çš„å…ƒç´ è¶Šå¤šï¼Œè¯¯æŠ¥çš„å¯èƒ½æ€§å°±è¶Šå¤§ã€‚å¹¶ä¸”ï¼Œå­˜æ”¾åœ¨å¸ƒéš†è¿‡æ»¤å™¨çš„æ•°æ®ä¸å®¹æ˜“åˆ é™¤ã€‚

![](images\bloom-filter-simple-schematic-diagram.png)

`Bloom Filter` ä¼šä½¿ç”¨ä¸€ä¸ªè¾ƒå¤§çš„ **bit æ•°ç»„**æ¥ä¿å­˜æ‰€æœ‰çš„æ•°æ®ï¼Œæ•°ç»„ä¸­çš„**æ¯ä¸ªå…ƒç´ éƒ½åªå ç”¨ 1 bit** ï¼Œå¹¶ä¸”**æ¯ä¸ªå…ƒç´ åªèƒ½æ˜¯ 0 æˆ–è€… 1ï¼ˆä»£è¡¨ false æˆ–è€… trueï¼‰**ï¼Œè¿™ä¹Ÿæ˜¯ Bloom Filter èŠ‚çœå†…å­˜çš„æ ¸å¿ƒæ‰€åœ¨ã€‚è¿™æ ·æ¥ç®—çš„è¯ï¼Œç”³è¯·ä¸€ä¸ª 100w ä¸ªå…ƒç´ çš„ä½æ•°ç»„åªå ç”¨ 1000000Bit / 8 = 125000 Byte = 125000/1024 KB â‰ˆ 122KB çš„ç©ºé—´ã€‚

![](images\bloom-filter-bit-table.png)

å…·ä½“æ˜¯è¿™æ ·åšçš„ï¼šæŠŠæ‰€æœ‰å¯èƒ½å­˜åœ¨çš„è¯·æ±‚çš„å€¼éƒ½å­˜æ”¾åœ¨å¸ƒéš†è¿‡æ»¤å™¨ä¸­ï¼Œå½“ç”¨æˆ·è¯·æ±‚è¿‡æ¥ï¼Œå…ˆåˆ¤æ–­ç”¨æˆ·å‘æ¥çš„è¯·æ±‚çš„å€¼æ˜¯å¦å­˜åœ¨äºå¸ƒéš†è¿‡æ»¤å™¨ä¸­ã€‚ä¸å­˜åœ¨çš„è¯ï¼Œç›´æ¥è¿”å›è¯·æ±‚å‚æ•°é”™è¯¯ä¿¡æ¯ç»™å®¢æˆ·ç«¯ï¼Œå­˜åœ¨çš„è¯æ‰ä¼šèµ°ä¸‹é¢çš„æµç¨‹ã€‚

åŠ å…¥å¸ƒéš†è¿‡æ»¤å™¨ä¹‹åçš„ç¼“å­˜å¤„ç†æµç¨‹å›¾å¦‚ä¸‹ã€‚

![](images\redis-cache-penetration-bloom-filter.png)

æ›´å¤šå…³äºå¸ƒéš†è¿‡æ»¤å™¨çš„è¯¦ç»†ä»‹ç»å¯ä»¥çœ‹çœ‹æˆ‘çš„è¿™ç¯‡åŸåˆ›ï¼š[ä¸äº†è§£å¸ƒéš†è¿‡æ»¤å™¨ï¼Ÿä¸€æ–‡ç»™ä½ æ•´çš„æ˜æ˜ç™½ç™½ï¼](https://javaguide.cn/cs-basics/data-structure/bloom-filter.html) ï¼Œå¼ºçƒˆæ¨èã€‚

**3ï¼‰æ¥å£é™æµ**

æ ¹æ®ç”¨æˆ·æˆ–è€… IP å¯¹æ¥å£è¿›è¡Œé™æµï¼Œå¯¹äºå¼‚å¸¸é¢‘ç¹çš„è®¿é—®è¡Œä¸ºï¼Œè¿˜å¯ä»¥é‡‡å–é»‘åå•æœºåˆ¶ï¼Œä¾‹å¦‚å°†å¼‚å¸¸ IP åˆ—å…¥é»‘åå•ã€‚

### ç¼“å­˜å‡»ç©¿ âœ…

#### ä»€ä¹ˆæ˜¯ç¼“å­˜å‡»ç©¿ï¼Ÿ

==ç¼“å­˜å‡»ç©¿==ä¸­ï¼Œè¯·æ±‚çš„ key å¯¹åº”çš„æ˜¯ **çƒ­ç‚¹æ•°æ®** ï¼Œè¯¥æ•°æ® **å­˜åœ¨äºæ•°æ®åº“ä¸­ï¼Œä½†ä¸å­˜åœ¨äºç¼“å­˜ä¸­ï¼ˆé€šå¸¸æ˜¯å› ä¸ºç¼“å­˜ä¸­çš„é‚£ä»½æ•°æ®å·²ç»è¿‡æœŸï¼‰** ã€‚è¿™å°±å¯èƒ½ä¼šå¯¼è‡´ç¬æ—¶å¤§é‡çš„è¯·æ±‚ç›´æ¥æ‰“åˆ°äº†æ•°æ®åº“ä¸Šï¼Œå¯¹æ•°æ®åº“é€ æˆäº†å·¨å¤§çš„å‹åŠ›ï¼Œå¯èƒ½ç›´æ¥å°±è¢«è¿™ä¹ˆå¤šè¯·æ±‚å¼„å®•æœºäº†ã€‚

![](images\redis-cache-breakdown.png)

ä¸¾ä¸ªä¾‹å­ï¼šç§’æ€è¿›è¡Œè¿‡ç¨‹ä¸­ï¼Œç¼“å­˜ä¸­çš„æŸä¸ªç§’æ€å•†å“çš„æ•°æ®çªç„¶è¿‡æœŸï¼Œè¿™å°±å¯¼è‡´ç¬æ—¶å¤§é‡å¯¹è¯¥å•†å“çš„è¯·æ±‚ç›´æ¥è½åˆ°æ•°æ®åº“ä¸Šï¼Œå¯¹æ•°æ®åº“é€ æˆäº†å·¨å¤§çš„å‹åŠ›ã€‚

#### æœ‰å“ªäº›è§£å†³åŠæ³•ï¼Ÿ

1. è®¾ç½®çƒ­ç‚¹æ•°æ®æ°¸ä¸è¿‡æœŸæˆ–è€…è¿‡æœŸæ—¶é—´æ¯”è¾ƒé•¿ã€‚
2. é’ˆå¯¹çƒ­ç‚¹æ•°æ®æå‰é¢„çƒ­ï¼Œå°†å…¶å­˜å…¥ç¼“å­˜ä¸­å¹¶è®¾ç½®åˆç†çš„è¿‡æœŸæ—¶é—´æ¯”å¦‚ç§’æ€åœºæ™¯ä¸‹çš„æ•°æ®åœ¨ç§’æ€ç»“æŸä¹‹å‰ä¸è¿‡æœŸã€‚
3. è¯·æ±‚æ•°æ®åº“å†™æ•°æ®åˆ°ç¼“å­˜ä¹‹å‰ï¼Œå…ˆè·å–äº’æ–¥é”ï¼Œä¿è¯åªæœ‰ä¸€ä¸ªè¯·æ±‚ä¼šè½åˆ°æ•°æ®åº“ä¸Šï¼Œå‡å°‘æ•°æ®åº“çš„å‹åŠ›ã€‚

#### ç¼“å­˜ç©¿é€å’Œç¼“å­˜å‡»ç©¿æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

**ç¼“å­˜ç©¿é€**ä¸­ï¼Œè¯·æ±‚çš„ key æ—¢**ä¸å­˜åœ¨äºç¼“å­˜ä¸­ï¼Œä¹Ÿä¸å­˜åœ¨äºæ•°æ®åº“**ä¸­ã€‚

**ç¼“å­˜å‡»ç©¿**ä¸­ï¼Œè¯·æ±‚çš„ key å¯¹åº”çš„æ˜¯ **çƒ­ç‚¹æ•°æ®** ï¼Œè¯¥æ•°æ® **å­˜åœ¨äºæ•°æ®åº“ä¸­ï¼Œä½†ä¸å­˜åœ¨äºç¼“å­˜ä¸­ï¼ˆé€šå¸¸æ˜¯å› ä¸ºç¼“å­˜ä¸­çš„é‚£ä»½æ•°æ®å·²ç»è¿‡æœŸï¼‰** ã€‚

### ç¼“å­˜é›ªå´© âœ…

#### ä»€ä¹ˆæ˜¯ç¼“å­˜é›ªå´©ï¼Ÿ

æˆ‘å‘ç°ç¼“å­˜é›ªå´©è¿™åå­—èµ·çš„æœ‰ç‚¹æ„æ€ï¼Œå“ˆå“ˆã€‚

å®é™…ä¸Šï¼Œ==ç¼“å­˜é›ªå´©==æè¿°çš„å°±æ˜¯è¿™æ ·ä¸€ä¸ªç®€å•çš„åœºæ™¯ï¼š**ç¼“å­˜åœ¨åŒä¸€æ—¶é—´å¤§é¢ç§¯çš„å¤±æ•ˆï¼Œå¯¼è‡´å¤§é‡çš„è¯·æ±‚éƒ½ç›´æ¥è½åˆ°äº†æ•°æ®åº“ä¸Šï¼Œå¯¹æ•°æ®åº“é€ æˆäº†å·¨å¤§çš„å‹åŠ›ã€‚** è¿™å°±å¥½æ¯”é›ªå´©ä¸€æ ·ï¼Œæ‘§æ¯æ‹‰æœ½ä¹‹åŠ¿ï¼Œæ•°æ®åº“çš„å‹åŠ›å¯æƒ³è€ŒçŸ¥ï¼Œå¯èƒ½ç›´æ¥å°±è¢«è¿™ä¹ˆå¤šè¯·æ±‚å¼„å®•æœºäº†ã€‚

å¦å¤–ï¼Œç¼“å­˜æœåŠ¡å®•æœºä¹Ÿä¼šå¯¼è‡´ç¼“å­˜é›ªå´©ç°è±¡ï¼Œå¯¼è‡´æ‰€æœ‰çš„è¯·æ±‚éƒ½è½åˆ°äº†æ•°æ®åº“ä¸Šã€‚

![](images\redis-cache-avalanche.png)

ä¸¾ä¸ªä¾‹å­ï¼šæ•°æ®åº“ä¸­çš„å¤§é‡æ•°æ®åœ¨åŒä¸€æ—¶é—´è¿‡æœŸï¼Œè¿™ä¸ªæ—¶å€™çªç„¶æœ‰å¤§é‡çš„è¯·æ±‚éœ€è¦è®¿é—®è¿™äº›è¿‡æœŸçš„æ•°æ®ã€‚è¿™å°±å¯¼è‡´å¤§é‡çš„è¯·æ±‚ç›´æ¥è½åˆ°æ•°æ®åº“ä¸Šï¼Œå¯¹æ•°æ®åº“é€ æˆäº†å·¨å¤§çš„å‹åŠ›ã€‚

#### æœ‰å“ªäº›è§£å†³åŠæ³•ï¼Ÿâœ…

**é’ˆå¯¹ Redis æœåŠ¡ä¸å¯ç”¨çš„æƒ…å†µï¼š**

1. é‡‡ç”¨ Redis é›†ç¾¤ï¼Œé¿å…å•æœºå‡ºç°é—®é¢˜æ•´ä¸ªç¼“å­˜æœåŠ¡éƒ½æ²¡åŠæ³•ä½¿ç”¨ã€‚
2. é™æµï¼Œé¿å…åŒæ—¶å¤„ç†å¤§é‡çš„è¯·æ±‚ã€‚
3. å¤šçº§ç¼“å­˜ï¼Œä¾‹å¦‚æœ¬åœ°ç¼“å­˜+Redis ç¼“å­˜çš„ç»„åˆï¼Œå½“ Redis ç¼“å­˜å‡ºç°é—®é¢˜æ—¶ï¼Œè¿˜å¯ä»¥ä»æœ¬åœ°ç¼“å­˜ä¸­è·å–åˆ°éƒ¨åˆ†æ•°æ®ã€‚

**é’ˆå¯¹çƒ­ç‚¹ç¼“å­˜å¤±æ•ˆçš„æƒ…å†µï¼š**

1. è®¾ç½®ä¸åŒçš„å¤±æ•ˆæ—¶é—´æ¯”å¦‚éšæœºè®¾ç½®ç¼“å­˜çš„å¤±æ•ˆæ—¶é—´ã€‚
2. ç¼“å­˜æ°¸ä¸å¤±æ•ˆï¼ˆä¸å¤ªæ¨èï¼Œå®ç”¨æ€§å¤ªå·®ï¼‰ã€‚
3. ç¼“å­˜é¢„çƒ­ï¼Œä¹Ÿå°±æ˜¯åœ¨ç¨‹åºå¯åŠ¨åæˆ–è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œä¸»åŠ¨å°†çƒ­ç‚¹æ•°æ®åŠ è½½åˆ°ç¼“å­˜ä¸­ã€‚

**ç¼“å­˜é¢„çƒ­å¦‚ä½•å®ç°ï¼Ÿ**

å¸¸è§çš„ç¼“å­˜é¢„çƒ­æ–¹å¼æœ‰ä¸¤ç§ï¼š

1. ä½¿ç”¨å®šæ—¶ä»»åŠ¡ï¼Œæ¯”å¦‚ xxl-jobï¼Œæ¥å®šæ—¶è§¦å‘ç¼“å­˜é¢„çƒ­çš„é€»è¾‘ï¼Œå°†æ•°æ®åº“ä¸­çš„çƒ­ç‚¹æ•°æ®æŸ¥è¯¢å‡ºæ¥å¹¶å­˜å…¥ç¼“å­˜ä¸­ã€‚
2. ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæ¯”å¦‚ Kafkaï¼Œæ¥å¼‚æ­¥åœ°è¿›è¡Œç¼“å­˜é¢„çƒ­ï¼Œå°†æ•°æ®åº“ä¸­çš„çƒ­ç‚¹æ•°æ®çš„ä¸»é”®æˆ–è€… ID å‘é€åˆ°æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Œç„¶åç”±ç¼“å­˜æœåŠ¡æ¶ˆè´¹æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„æ•°æ®ï¼Œæ ¹æ®ä¸»é”®æˆ–è€… ID æŸ¥è¯¢æ•°æ®åº“å¹¶æ›´æ–°ç¼“å­˜ã€‚

#### ç¼“å­˜é›ªå´©å’Œç¼“å­˜å‡»ç©¿æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

ç¼“å­˜é›ªå´©å’Œç¼“å­˜å‡»ç©¿æ¯”è¾ƒåƒï¼Œä½†ç¼“å­˜é›ªå´©å¯¼è‡´çš„åŸå› æ˜¯ç¼“å­˜ä¸­çš„å¤§é‡æˆ–è€…æ‰€æœ‰æ•°æ®å¤±æ•ˆï¼Œç¼“å­˜å‡»ç©¿å¯¼è‡´çš„åŸå› ä¸»è¦æ˜¯æŸä¸ªçƒ­ç‚¹æ•°æ®ä¸å­˜åœ¨ä¸ç¼“å­˜ä¸­ï¼ˆé€šå¸¸æ˜¯å› ä¸ºç¼“å­˜ä¸­çš„é‚£ä»½æ•°æ®å·²ç»è¿‡æœŸï¼‰ã€‚

### å¦‚ä½•ä¿è¯ç¼“å­˜å’Œæ•°æ®åº“æ•°æ®çš„ä¸€è‡´æ€§ï¼Ÿ

ç»†è¯´çš„è¯å¯ä»¥æ‰¯å¾ˆå¤šï¼Œä½†æ˜¯æˆ‘è§‰å¾—å…¶å®æ²¡å¤ªå¤§å¿…è¦ï¼ˆå°å£° BBï¼šå¾ˆå¤šè§£å†³æ–¹æ¡ˆæˆ‘ä¹Ÿæ²¡å¤ªå¼„æ˜ç™½ï¼‰ã€‚æˆ‘ä¸ªäººè§‰å¾—å¼•å…¥ç¼“å­˜ä¹‹åï¼Œå¦‚æœä¸ºäº†çŸ­æ—¶é—´çš„ä¸ä¸€è‡´æ€§é—®é¢˜ï¼Œé€‰æ‹©è®©ç³»ç»Ÿè®¾è®¡å˜å¾—æ›´åŠ å¤æ‚çš„è¯ï¼Œå®Œå…¨æ²¡å¿…è¦ã€‚

ä¸‹é¢å•ç‹¬å¯¹ **Cache Aside Patternï¼ˆæ—è·¯ç¼“å­˜æ¨¡å¼ï¼‰** æ¥èŠèŠã€‚

Cache Aside Pattern ä¸­é‡åˆ°å†™è¯·æ±‚æ˜¯è¿™æ ·çš„ï¼šæ›´æ–°æ•°æ®åº“ï¼Œç„¶åç›´æ¥åˆ é™¤ç¼“å­˜ ã€‚

å¦‚æœæ›´æ–°æ•°æ®åº“æˆåŠŸï¼Œè€Œåˆ é™¤ç¼“å­˜è¿™ä¸€æ­¥å¤±è´¥çš„æƒ…å†µçš„è¯ï¼Œç®€å•è¯´æœ‰ä¸¤ä¸ªè§£å†³æ–¹æ¡ˆï¼š

1. **ç¼“å­˜å¤±æ•ˆæ—¶é—´å˜çŸ­ï¼ˆä¸æ¨èï¼Œæ²»æ ‡ä¸æ²»æœ¬ï¼‰**ï¼šæˆ‘ä»¬è®©ç¼“å­˜æ•°æ®çš„è¿‡æœŸæ—¶é—´å˜çŸ­ï¼Œè¿™æ ·çš„è¯ç¼“å­˜å°±ä¼šä»æ•°æ®åº“ä¸­åŠ è½½æ•°æ®ã€‚å¦å¤–ï¼Œè¿™ç§è§£å†³åŠæ³•å¯¹äºå…ˆæ“ä½œç¼“å­˜åæ“ä½œæ•°æ®åº“çš„åœºæ™¯ä¸é€‚ç”¨ã€‚
2. **å¢åŠ ç¼“å­˜æ›´æ–°é‡è¯•æœºåˆ¶ï¼ˆå¸¸ç”¨ï¼‰**ï¼šå¦‚æœç¼“å­˜æœåŠ¡å½“å‰ä¸å¯ç”¨å¯¼è‡´ç¼“å­˜åˆ é™¤å¤±è´¥çš„è¯ï¼Œæˆ‘ä»¬å°±éš”ä¸€æ®µæ—¶é—´è¿›è¡Œé‡è¯•ï¼Œé‡è¯•æ¬¡æ•°å¯ä»¥è‡ªå·±å®šã€‚ä¸è¿‡ï¼Œè¿™é‡Œæ›´é€‚åˆå¼•å…¥æ¶ˆæ¯é˜Ÿåˆ—å®ç°å¼‚æ­¥é‡è¯•ï¼Œå°†åˆ é™¤ç¼“å­˜é‡è¯•çš„æ¶ˆæ¯æŠ•é€’åˆ°æ¶ˆæ¯é˜Ÿåˆ—ï¼Œç„¶åç”±ä¸“é—¨çš„æ¶ˆè´¹è€…æ¥é‡è¯•ï¼Œç›´åˆ°æˆåŠŸã€‚è™½ç„¶è¯´å¤šå¼•å…¥äº†ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼Œä½†å…¶æ•´ä½“å¸¦æ¥çš„æ”¶ç›Šè¿˜æ˜¯è¦æ›´é«˜ä¸€äº›ã€‚

ç›¸å…³æ–‡ç« æ¨èï¼š[ç¼“å­˜å’Œæ•°æ®åº“ä¸€è‡´æ€§é—®é¢˜ï¼Œçœ‹è¿™ç¯‡å°±å¤Ÿäº† - æ°´æ»´ä¸é“¶å¼¹](https://mp.weixin.qq.com/s?__biz=MzIyOTYxNDI5OA==&mid=2247487312&idx=1&sn=fa19566f5729d6598155b5c676eee62d&chksm=e8beb8e5dfc931f3e35655da9da0b61c79f2843101c130cf38996446975014f958a6481aacf1&scene=178&cur_album_id=1699766580538032128#rd)ã€‚

### å“ªäº›æƒ…å†µå¯èƒ½ä¼šå¯¼è‡´ Redis é˜»å¡ï¼Ÿ

å•ç‹¬æŠ½äº†ä¸€ç¯‡æ–‡ç« æ¥æ€»ç»“å¯èƒ½ä¼šå¯¼è‡´ Redis é˜»å¡çš„æƒ…å†µï¼š[Redis å¸¸è§é˜»å¡åŸå› æ€»ç»“](https://javaguide.cn/database/redis/redis-common-blocking-problems-summary.html)  å‚è€ƒç¬”è®°  [Rediså¸¸è§é˜»å¡åŸå› æ€»ç»“ï¼ˆæ›´æ–°ä¸­ï¼‰](# Rediså¸¸è§é˜»å¡åŸå› æ€»ç»“ï¼ˆæ›´æ–°ä¸­ï¼‰) 

## Redis é›†ç¾¤

**Redis Sentinel**ï¼š(Sentinel--->å“¨å…µ)

1. ä»€ä¹ˆæ˜¯ Sentinelï¼Ÿ æœ‰ä»€ä¹ˆç”¨ï¼Ÿ
2. Sentinel å¦‚ä½•æ£€æµ‹èŠ‚ç‚¹æ˜¯å¦ä¸‹çº¿ï¼Ÿä¸»è§‚ä¸‹çº¿ä¸å®¢è§‚ä¸‹çº¿çš„åŒºåˆ«?
3. Sentinel æ˜¯å¦‚ä½•å®ç°æ•…éšœè½¬ç§»çš„ï¼Ÿ
4. ä¸ºä»€ä¹ˆå»ºè®®éƒ¨ç½²å¤šä¸ª sentinel èŠ‚ç‚¹ï¼ˆå“¨å…µé›†ç¾¤ï¼‰ï¼Ÿ
5. Sentinel å¦‚ä½•é€‰æ‹©å‡ºæ–°çš„ masterï¼ˆé€‰ä¸¾æœºåˆ¶ï¼‰?
6. å¦‚ä½•ä» Sentinel é›†ç¾¤ä¸­é€‰æ‹©å‡º Leader ï¼Ÿ
7. Sentinel å¯ä»¥é˜²æ­¢è„‘è£‚å—ï¼Ÿ

**Redis Cluster**ï¼šï¼ˆCluster----> é›†ç¾¤ï¼‰

1. ä¸ºä»€ä¹ˆéœ€è¦ Redis Clusterï¼Ÿè§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼Ÿæœ‰ä»€ä¹ˆä¼˜åŠ¿ï¼Ÿ
2. Redis Cluster æ˜¯å¦‚ä½•åˆ†ç‰‡çš„ï¼Ÿ
3. ä¸ºä»€ä¹ˆ Redis Cluster çš„å“ˆå¸Œæ§½æ˜¯ 16384 ä¸ª?
4. å¦‚ä½•ç¡®å®šç»™å®š key çš„åº”è¯¥åˆ†å¸ƒåˆ°å“ªä¸ªå“ˆå¸Œæ§½ä¸­ï¼Ÿ
5. Redis Cluster æ”¯æŒé‡æ–°åˆ†é…å“ˆå¸Œæ§½å—ï¼Ÿ
6. Redis Cluster æ‰©å®¹ç¼©å®¹æœŸé—´å¯ä»¥æä¾›æœåŠ¡å—ï¼Ÿ
7. Redis Cluster ä¸­çš„èŠ‚ç‚¹æ˜¯æ€ä¹ˆè¿›è¡Œé€šä¿¡çš„ï¼Ÿ

**å‚è€ƒç­”æ¡ˆ**ï¼š[Redis é›†ç¾¤è¯¦è§£ï¼ˆä»˜è´¹ï¼‰](https://javaguide.cn/database/redis/redis-cluster.html)ã€‚

## Redis ä½¿ç”¨è§„èŒƒ

å®é™…ä½¿ç”¨ Redis çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å°½é‡è¦å‡†å®ˆä¸€äº›å¸¸è§çš„è§„èŒƒï¼Œæ¯”å¦‚ï¼š

1. ä½¿ç”¨è¿æ¥æ± ï¼šé¿å…é¢‘ç¹åˆ›å»ºå…³é—­å®¢æˆ·ç«¯è¿æ¥ã€‚
2. å°½é‡ä¸ä½¿ç”¨ O(n)æŒ‡ä»¤ï¼Œä½¿ç”¨ O(n) å‘½ä»¤æ—¶è¦å…³æ³¨ n çš„æ•°é‡ï¼šåƒ `KEYS *`ã€`HGETALL`ã€`LRANGE`ã€`SMEMBERS`ã€`SINTER`/`SUNION`/`SDIFF`ç­‰ O(n) å‘½ä»¤å¹¶éä¸èƒ½ä½¿ç”¨ï¼Œä½†æ˜¯éœ€è¦æ˜ç¡® n çš„å€¼ã€‚å¦å¤–ï¼Œæœ‰éå†çš„éœ€æ±‚å¯ä»¥ä½¿ç”¨ `HSCAN`ã€`SSCAN`ã€`ZSCAN` ä»£æ›¿ã€‚
3. ä½¿ç”¨æ‰¹é‡æ“ä½œå‡å°‘ç½‘ç»œä¼ è¾“ï¼šåŸç”Ÿæ‰¹é‡æ“ä½œå‘½ä»¤ï¼ˆæ¯”å¦‚ `MGET`ã€`MSET`ç­‰ç­‰ï¼‰ã€pipelineã€Lua è„šæœ¬ã€‚
4. å°½é‡ä¸ä½¿ç”¨ Redis äº‹åŠ¡ï¼šRedis äº‹åŠ¡å®ç°çš„åŠŸèƒ½æ¯”è¾ƒé¸¡è‚‹ï¼Œå¯ä»¥ä½¿ç”¨ Lua è„šæœ¬ä»£æ›¿ã€‚
5. ç¦æ­¢é•¿æ—¶é—´å¼€å¯ monitorï¼šå¯¹æ€§èƒ½å½±å“æ¯”è¾ƒå¤§ã€‚
6. æ§åˆ¶ key çš„ç”Ÿå‘½å‘¨æœŸï¼šé¿å… Redis ä¸­å­˜æ”¾äº†å¤ªå¤šä¸ç»å¸¸è¢«è®¿é—®çš„æ•°æ®ã€‚
7. â€¦â€¦

ç›¸å…³æ–‡ç« æ¨èï¼š[é˜¿é‡Œäº‘ Redis å¼€å‘è§„èŒƒ](https://developer.aliyun.com/article/531067) ã€‚

## å‚è€ƒ

- ã€ŠRedis å¼€å‘ä¸è¿ç»´ã€‹

- ã€ŠRedis è®¾è®¡ä¸å®ç°ã€‹

- Redis Transactions : [https://redis.io/docs/manual/transactions/](https://redis.io/docs/manual/transactions/)

- What is Redis Pipelineï¼š[https://buildatscale.tech/what-is-redis-pipeline/](https://buildatscale.tech/what-is-redis-pipeline/)

- ä¸€æ–‡è¯¦è§£ Redis ä¸­ BigKeyã€HotKey çš„å‘ç°ä¸å¤„ç†ï¼š[https://mp.weixin.qq.com/s/FPYE1B839_8Yk1-YSiW-1Q](https://mp.weixin.qq.com/s/FPYE1B839_8Yk1-YSiW-1Q)

- Bigkey é—®é¢˜çš„è§£å†³æ€è·¯ä¸æ–¹å¼æ¢ç´¢:[https://mp.weixin.qq.com/s/Sej7D9TpdAobcCmdYdMIyA](https://mp.weixin.qq.com/s/Sej7D9TpdAobcCmdYdMIyA)

- Redis å»¶è¿Ÿé—®é¢˜å…¨é¢æ’éšœæŒ‡å—ï¼šhttps://mp.weixin.qq.com/s/mIc6a9mfEGdaNDD3MmfFsg

# ğŸŒŸğŸŒŸğŸŒŸä»¥ä¸‹ä¸ºé‡è¦çŸ¥è¯†ç‚¹ğŸŒŸğŸŒŸğŸŒŸ

---

# å¦‚ä½•åŸºäºRediså®ç°å»¶æ—¶ä»»åŠ¡ï¼ˆæ›´æ–°ä¸­ï¼‰

åŸºäº Redis å®ç°å»¶æ—¶ä»»åŠ¡çš„åŠŸèƒ½æ— éå°±ä¸‹é¢ä¸¤ç§æ–¹æ¡ˆï¼š

1. **Redis è¿‡æœŸäº‹ä»¶ç›‘å¬**
2. **Redisson å†…ç½®çš„å»¶æ—¶é˜Ÿåˆ—**

é¢è¯•çš„æ—¶å€™ï¼Œä½ å¯ä»¥å…ˆè¯´è‡ªå·±è€ƒè™‘äº†è¿™ä¸¤ç§æ–¹æ¡ˆï¼Œä½†æœ€åå‘ç° Redis è¿‡æœŸäº‹ä»¶ç›‘å¬è¿™ç§æ–¹æ¡ˆå­˜åœ¨å¾ˆå¤šé—®é¢˜ï¼Œå› æ­¤ä½ æœ€ç»ˆé€‰æ‹©äº† Redisson å†…ç½®çš„ DelayedQueue è¿™ç§æ–¹æ¡ˆã€‚

è¿™ä¸ªæ—¶å€™é¢è¯•å®˜å¯èƒ½ä¼šè¿½é—®ä½ ä¸€äº›ç›¸å…³çš„é—®é¢˜ï¼Œæˆ‘ä»¬åé¢ä¼šæåˆ°ï¼Œæå‰å‡†å¤‡å°±å¥½äº†ã€‚

å¦å¤–ï¼Œé™¤äº†ä¸‹é¢ä»‹ç»åˆ°çš„è¿™äº›é—®é¢˜ä¹‹å¤–ï¼ŒRedis ç›¸å…³çš„å¸¸è§é—®é¢˜å»ºè®®ä½ éƒ½å¤ä¹ ä¸€éï¼Œä¸æ’é™¤é¢è¯•å®˜ä¼šé¡ºå¸¦é—®ä½ ä¸€äº› Redis çš„å…¶ä»–é—®é¢˜ã€‚

### Redis è¿‡æœŸäº‹ä»¶ç›‘å¬å®ç°å»¶æ—¶ä»»åŠ¡åŠŸèƒ½çš„åŸç†ï¼Ÿ

Redis 2.0 å¼•å…¥äº†**å‘å¸ƒè®¢é˜… (pub/sub) åŠŸèƒ½**ã€‚åœ¨ pub/sub ä¸­ï¼Œå¼•å…¥äº†ä¸€ä¸ªå«åš **channelï¼ˆé¢‘é“ï¼‰** çš„æ¦‚å¿µï¼Œæœ‰ç‚¹ç±»ä¼¼äºæ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„ **topicï¼ˆä¸»é¢˜ï¼‰**ã€‚

pub/sub æ¶‰åŠ**å‘å¸ƒè€…ï¼ˆpublisherï¼‰**å’Œ**è®¢é˜…è€…ï¼ˆsubscriberï¼Œä¹Ÿå«æ¶ˆè´¹è€…ï¼‰**ä¸¤ä¸ªè§’è‰²ï¼š

- å‘å¸ƒè€…é€šè¿‡ `PUBLISH` æŠ•é€’æ¶ˆæ¯ç»™æŒ‡å®š channelã€‚
- è®¢é˜…è€…é€šè¿‡`SUBSCRIBE`è®¢é˜…å®ƒå…³å¿ƒçš„ channelã€‚å¹¶ä¸”ï¼Œè®¢é˜…è€…å¯ä»¥è®¢é˜…ä¸€ä¸ªæˆ–è€…å¤šä¸ª channelã€‚

![](images\redis-pub-sub (1).png)

åœ¨ pub/sub æ¨¡å¼ä¸‹ï¼Œç”Ÿäº§è€…éœ€è¦æŒ‡å®šæ¶ˆæ¯å‘é€åˆ°å“ªä¸ª channel ä¸­ï¼Œè€Œæ¶ˆè´¹è€…åˆ™è®¢é˜…å¯¹åº”çš„ channel ä»¥è·å–æ¶ˆæ¯ã€‚

Redis ä¸­æœ‰å¾ˆå¤šé»˜è®¤çš„ channelï¼Œè¿™äº› channel æ˜¯ç”± Redis æœ¬èº«å‘å®ƒä»¬å‘é€æ¶ˆæ¯çš„ï¼Œè€Œä¸æ˜¯æˆ‘ä»¬è‡ªå·±ç¼–å†™çš„ä»£ç ã€‚å…¶ä¸­ï¼Œ`__keyevent@0__:expired` å°±æ˜¯ä¸€ä¸ªé»˜è®¤çš„ channelï¼Œè´Ÿè´£ç›‘å¬ key çš„è¿‡æœŸäº‹ä»¶ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå½“ä¸€ä¸ª key è¿‡æœŸä¹‹åï¼ŒRedis ä¼šå‘å¸ƒä¸€ä¸ª key è¿‡æœŸçš„äº‹ä»¶åˆ°`__keyevent@<db>__:expired`è¿™ä¸ª channel ä¸­ã€‚

æˆ‘ä»¬åªéœ€è¦ç›‘å¬è¿™ä¸ª channelï¼Œå°±å¯ä»¥æ‹¿åˆ°è¿‡æœŸçš„ key çš„æ¶ˆæ¯ï¼Œè¿›è€Œå®ç°äº†å»¶æ—¶ä»»åŠ¡åŠŸèƒ½ã€‚

è¿™ä¸ªåŠŸèƒ½è¢« Redis å®˜æ–¹ç§°ä¸º **keyspace notifications** ï¼Œä½œç”¨æ˜¯å®æ—¶ç›‘æ§ Redis é”®å’Œå€¼çš„å˜åŒ–ã€‚

### Redis è¿‡æœŸäº‹ä»¶ç›‘å¬å®ç°å»¶æ—¶ä»»åŠ¡åŠŸèƒ½æœ‰ä»€ä¹ˆç¼ºé™·ï¼Ÿ

**1ã€æ—¶æ•ˆæ€§å·®**

å®˜æ–¹æ–‡æ¡£çš„ä¸€æ®µä»‹ç»è§£é‡Šäº†æ—¶æ•ˆæ€§å·®çš„åŸå› ï¼Œåœ°å€ï¼š[https://redis.io/docs/manual/keyspace-notifications/#timing-of-expired-events](https://redis.io/docs/manual/keyspace-notifications/#timing-of-expired-events) ã€‚

![](images\redis-timing-of-expired-events.png)

è¿™æ®µè¯çš„æ ¸å¿ƒæ˜¯ï¼š**è¿‡æœŸäº‹ä»¶æ¶ˆæ¯æ˜¯åœ¨ Redis æœåŠ¡å™¨åˆ é™¤ key æ—¶å‘å¸ƒçš„ï¼Œè€Œä¸æ˜¯ä¸€ä¸ª key è¿‡æœŸä¹‹åå°±ä¼šå°±ä¼šç›´æ¥å‘å¸ƒ**ã€‚

æˆ‘ä»¬çŸ¥é“å¸¸ç”¨çš„è¿‡æœŸæ•°æ®çš„åˆ é™¤ç­–ç•¥å°±ä¸¤ä¸ªï¼š

1. **æƒ°æ€§åˆ é™¤**ï¼šåªä¼šåœ¨å–å‡º key çš„æ—¶å€™æ‰å¯¹æ•°æ®è¿›è¡Œè¿‡æœŸæ£€æŸ¥ã€‚è¿™æ ·å¯¹ CPU æœ€å‹å¥½ï¼Œä½†æ˜¯å¯èƒ½ä¼šé€ æˆå¤ªå¤šè¿‡æœŸ key æ²¡æœ‰è¢«åˆ é™¤ã€‚
2. **å®šæœŸåˆ é™¤**ï¼šæ¯éš”ä¸€æ®µæ—¶é—´æŠ½å–ä¸€æ‰¹ key æ‰§è¡Œåˆ é™¤è¿‡æœŸ key æ“ä½œã€‚å¹¶ä¸”ï¼ŒRedis åº•å±‚ä¼šé€šè¿‡é™åˆ¶åˆ é™¤æ“ä½œæ‰§è¡Œçš„æ—¶é•¿å’Œé¢‘ç‡æ¥å‡å°‘åˆ é™¤æ“ä½œå¯¹ CPU æ—¶é—´çš„å½±å“ã€‚

å®šæœŸåˆ é™¤å¯¹å†…å­˜æ›´åŠ å‹å¥½ï¼Œæƒ°æ€§åˆ é™¤å¯¹ CPU æ›´åŠ å‹å¥½ã€‚ä¸¤è€…å„æœ‰åƒç§‹ï¼Œæ‰€ä»¥ Redis é‡‡ç”¨çš„æ˜¯ **å®šæœŸåˆ é™¤+æƒ°æ€§/æ‡’æ±‰å¼åˆ é™¤** ã€‚

å› æ­¤ï¼Œå°±ä¼šå­˜åœ¨æˆ‘è®¾ç½®äº† key çš„è¿‡æœŸæ—¶é—´ï¼Œä½†åˆ°äº†æŒ‡å®šæ—¶é—´ key è¿˜æœªè¢«åˆ é™¤ï¼Œè¿›è€Œæ²¡æœ‰å‘å¸ƒè¿‡æœŸäº‹ä»¶çš„æƒ…å†µã€‚

**2ã€ä¸¢æ¶ˆæ¯**

**Redis çš„ pub/sub æ¨¡å¼ä¸­çš„æ¶ˆæ¯å¹¶ä¸æ”¯æŒæŒä¹…åŒ–**ï¼Œè¿™ä¸æ¶ˆæ¯é˜Ÿåˆ—ä¸åŒã€‚åœ¨ Redis çš„ pub/sub æ¨¡å¼ä¸­ï¼Œå‘å¸ƒè€…å°†æ¶ˆæ¯å‘é€ç»™æŒ‡å®šçš„é¢‘é“ï¼Œè®¢é˜…è€…ç›‘å¬ç›¸åº”çš„é¢‘é“ä»¥æ¥æ”¶æ¶ˆæ¯ã€‚å½“æ²¡æœ‰è®¢é˜…è€…æ—¶ï¼Œæ¶ˆæ¯ä¼šè¢«ç›´æ¥ä¸¢å¼ƒï¼Œåœ¨ Redis ä¸­ä¸ä¼šå­˜å‚¨è¯¥æ¶ˆæ¯ã€‚

**3ã€å¤šæœåŠ¡å®ä¾‹ä¸‹æ¶ˆæ¯é‡å¤æ¶ˆè´¹**

Redis çš„ pub/sub æ¨¡å¼ç›®å‰åªæœ‰**å¹¿æ’­æ¨¡å¼**ï¼Œè¿™æ„å‘³ç€å½“ç”Ÿäº§è€…å‘ç‰¹å®šé¢‘é“å‘å¸ƒä¸€æ¡æ¶ˆæ¯æ—¶ï¼Œæ‰€æœ‰è®¢é˜…ç›¸å…³é¢‘é“çš„æ¶ˆè´¹è€…éƒ½èƒ½å¤Ÿæ”¶åˆ°è¯¥æ¶ˆæ¯ã€‚

è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦æ³¨æ„å¤šä¸ªæœåŠ¡å®ä¾‹é‡å¤å¤„ç†æ¶ˆæ¯çš„é—®é¢˜ï¼Œè¿™ä¼šå¢åŠ ä»£ç å¼€å‘é‡å’Œç»´æŠ¤éš¾åº¦ã€‚

### Redisson å»¶è¿Ÿé˜Ÿåˆ—åŸç†æ˜¯ä»€ä¹ˆï¼Ÿæœ‰ä»€ä¹ˆä¼˜åŠ¿ï¼Ÿ

`Redisson` æ˜¯ä¸€ä¸ªå¼€æºçš„ Java è¯­è¨€ Redis å®¢æˆ·ç«¯ï¼Œæä¾›äº†å¾ˆå¤šå¼€ç®±å³ç”¨çš„åŠŸèƒ½ï¼Œæ¯”å¦‚å¤šç§åˆ†å¸ƒå¼é”çš„å®ç°ã€å»¶æ—¶é˜Ÿåˆ—ã€‚

æˆ‘ä»¬å¯ä»¥å€ŸåŠ© Redisson å†…ç½®çš„å»¶æ—¶é˜Ÿåˆ— `RDelayedQueue` æ¥å®ç°å»¶æ—¶ä»»åŠ¡åŠŸèƒ½ã€‚

Redisson çš„å»¶è¿Ÿé˜Ÿåˆ— RDelayedQueue æ˜¯åŸºäº Redis çš„ `SortedSet` æ¥å®ç°çš„ã€‚SortedSet æ˜¯ä¸€ä¸ª**æœ‰åºé›†åˆ**ï¼Œå…¶ä¸­çš„æ¯ä¸ªå…ƒç´ éƒ½å¯ä»¥è®¾ç½®ä¸€ä¸ªåˆ†æ•°ï¼Œä»£è¡¨è¯¥å…ƒç´ çš„æƒé‡ã€‚Redisson åˆ©ç”¨è¿™ä¸€ç‰¹æ€§ï¼Œå°†éœ€è¦å»¶è¿Ÿæ‰§è¡Œçš„ä»»åŠ¡æ’å…¥åˆ° SortedSet ä¸­ï¼Œå¹¶ç»™å®ƒä»¬è®¾ç½®ç›¸åº”çš„**è¿‡æœŸæ—¶é—´ä½œä¸ºåˆ†æ•°**ã€‚

Redisson ä½¿ç”¨ `zrangebyscore` å‘½ä»¤æ‰«æ SortedSet ä¸­è¿‡æœŸçš„å…ƒç´ ï¼Œç„¶åå°†è¿™äº›è¿‡æœŸå…ƒç´ ä» SortedSet ä¸­ç§»é™¤ï¼Œå¹¶å°†å®ƒä»¬åŠ å…¥åˆ°**å°±ç»ªæ¶ˆæ¯åˆ—è¡¨**ä¸­ã€‚å°±ç»ªæ¶ˆæ¯åˆ—è¡¨æ˜¯ä¸€ä¸ª**é˜»å¡é˜Ÿåˆ—**ï¼Œæœ‰æ¶ˆæ¯è¿›å…¥å°±ä¼šè¢«ç›‘å¬åˆ°ã€‚è¿™æ ·åšå¯ä»¥é¿å…å¯¹æ•´ä¸ª SortedSet è¿›è¡Œè½®è¯¢ï¼Œæé«˜äº†æ‰§è¡Œæ•ˆç‡ã€‚

ç›¸æ¯”äº Redis è¿‡æœŸäº‹ä»¶ç›‘å¬å®ç°å»¶æ—¶ä»»åŠ¡åŠŸèƒ½ï¼Œè¿™ç§æ–¹å¼å…·å¤‡ä¸‹é¢è¿™äº›ä¼˜åŠ¿ï¼š

1. **å‡å°‘äº†ä¸¢æ¶ˆæ¯çš„å¯èƒ½**ï¼šDelayedQueue ä¸­çš„æ¶ˆæ¯ä¼šè¢«**æŒä¹…åŒ–**ï¼Œå³ä½¿ Redis å®•æœºäº†ï¼Œæ ¹æ®æŒä¹…åŒ–æœºåˆ¶ï¼Œä¹Ÿåªå¯èƒ½ä¸¢å¤±ä¸€ç‚¹æ¶ˆæ¯ï¼Œå½±å“ä¸å¤§ã€‚å½“ç„¶äº†ï¼Œä½ ä¹Ÿå¯ä»¥ä½¿ç”¨æ‰«ææ•°æ®åº“çš„æ–¹æ³•ä½œä¸ºè¡¥å¿æœºåˆ¶ã€‚
2. **æ¶ˆæ¯ä¸å­˜åœ¨é‡å¤æ¶ˆè´¹é—®é¢˜**ï¼šæ¯ä¸ªå®¢æˆ·ç«¯éƒ½æ˜¯ä»**åŒä¸€ä¸ªç›®æ ‡é˜Ÿåˆ—**ä¸­è·å–ä»»åŠ¡çš„ï¼Œä¸å­˜åœ¨é‡å¤æ¶ˆè´¹çš„é—®é¢˜ã€‚

è·Ÿ Redisson å†…ç½®çš„å»¶æ—¶é˜Ÿåˆ—ç›¸æ¯”ï¼Œæ¶ˆæ¯é˜Ÿåˆ—å¯ä»¥é€šè¿‡ä¿éšœæ¶ˆæ¯æ¶ˆè´¹çš„å¯é æ€§ã€æ§åˆ¶æ¶ˆæ¯ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çš„æ•°é‡ç­‰æ‰‹æ®µæ¥å®ç°æ›´é«˜çš„ååé‡å’Œæ›´å¼ºçš„å¯é æ€§ï¼Œå®é™…é¡¹ç›®ä¸­é¦–é€‰ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—çš„å»¶æ—¶æ¶ˆæ¯è¿™ç§æ–¹æ¡ˆã€‚

# 3ç§å¸¸ç”¨çš„ç¼“å­˜è¯»å†™ç­–ç•¥è¯¦è§£ï¼ˆæ›´æ–°ä¸­ï¼‰âœ…

çœ‹åˆ°å¾ˆå¤šå°ä¼™ä¼´ç®€å†ä¸Šå†™äº†â€œ**ç†Ÿç»ƒä½¿ç”¨ç¼“å­˜**â€ï¼Œä½†æ˜¯è¢«æˆ‘é—®åˆ°â€œ**ç¼“å­˜å¸¸ç”¨çš„ 3 ç§è¯»å†™ç­–ç•¥**â€çš„æ—¶å€™å´ä¸€è„¸æ‡µé€¼ã€‚

åœ¨æˆ‘çœ‹æ¥ï¼Œé€ æˆè¿™ä¸ªé—®é¢˜çš„åŸå› æ˜¯æˆ‘ä»¬åœ¨å­¦ä¹  Redis çš„æ—¶å€™ï¼Œå¯èƒ½åªæ˜¯ç®€å•å†™äº†ä¸€äº› Demoï¼Œå¹¶æ²¡æœ‰å»å…³æ³¨ç¼“å­˜çš„è¯»å†™ç­–ç•¥ï¼Œæˆ–è€…è¯´å‹æ ¹ä¸çŸ¥é“è¿™å›äº‹ã€‚

ä½†æ˜¯ï¼Œææ‡‚ 3 ç§å¸¸è§çš„ç¼“å­˜è¯»å†™ç­–ç•¥å¯¹äºå®é™…å·¥ä½œä¸­ä½¿ç”¨ç¼“å­˜ä»¥åŠé¢è¯•ä¸­è¢«é—®åˆ°ç¼“å­˜éƒ½æ˜¯éå¸¸æœ‰å¸®åŠ©çš„ï¼

**ä¸‹é¢ä»‹ç»åˆ°çš„ä¸‰ç§æ¨¡å¼å„æœ‰ä¼˜åŠ£ï¼Œä¸å­˜åœ¨æœ€ä½³æ¨¡å¼ï¼Œæ ¹æ®å…·ä½“çš„ä¸šåŠ¡åœºæ™¯é€‰æ‹©é€‚åˆè‡ªå·±çš„ç¼“å­˜è¯»å†™æ¨¡å¼ã€‚**

### Cache Aside Patternï¼ˆæ—è·¯ç¼“å­˜æ¨¡å¼ï¼‰

`Cache Aside Pattern` æ˜¯æˆ‘ä»¬å¹³æ—¶ä½¿ç”¨æ¯”è¾ƒå¤šçš„ä¸€ä¸ªç¼“å­˜è¯»å†™æ¨¡å¼ï¼Œæ¯”è¾ƒé€‚åˆ**è¯»è¯·æ±‚æ¯”è¾ƒå¤šçš„åœºæ™¯**ã€‚

Cache Aside Pattern ä¸­æœåŠ¡ç«¯éœ€è¦åŒæ—¶ç»´ç³» db å’Œ cacheï¼Œå¹¶ä¸”æ˜¯**ä»¥ db çš„ç»“æœä¸ºå‡†**ã€‚

ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªç­–ç•¥æ¨¡å¼ä¸‹çš„**ç¼“å­˜è¯»å†™æ­¥éª¤**ã€‚

**å†™**ï¼š

- å…ˆæ›´æ–° db
- ç„¶åç›´æ¥åˆ é™¤ cache

ç®€å•ç”»äº†ä¸€å¼ å›¾å¸®åŠ©å¤§å®¶ç†è§£å†™çš„æ­¥éª¤ã€‚

![](images\cache-aside-write.png)

**è¯»** :

- ä» cache ä¸­è¯»å–æ•°æ®ï¼Œè¯»å–åˆ°å°±ç›´æ¥è¿”å›
- cache ä¸­è¯»å–ä¸åˆ°çš„è¯ï¼Œå°±ä» db ä¸­è¯»å–æ•°æ®è¿”å›
- å†æŠŠæ•°æ®æ”¾åˆ° cache ä¸­ã€‚

ç®€å•ç”»äº†ä¸€å¼ å›¾å¸®åŠ©å¤§å®¶ç†è§£è¯»çš„æ­¥éª¤ã€‚

![](images\cache-aside-read.png)

ä½ ä»…ä»…äº†è§£äº†ä¸Šé¢è¿™äº›å†…å®¹çš„è¯æ˜¯è¿œè¿œä¸å¤Ÿçš„ï¼Œæˆ‘ä»¬è¿˜è¦ææ‡‚å…¶ä¸­çš„åŸç†ã€‚

æ¯”å¦‚è¯´é¢è¯•å®˜å¾ˆå¯èƒ½ä¼šè¿½é—®ï¼šâ€œ**åœ¨å†™æ•°æ®çš„è¿‡ç¨‹ä¸­ï¼Œå¯ä»¥å…ˆåˆ é™¤ cache ï¼Œåæ›´æ–° db ä¹ˆï¼Ÿ**â€

**ç­”æ¡ˆï¼š** é‚£è‚¯å®šæ˜¯ä¸è¡Œçš„ï¼å› ä¸ºè¿™æ ·å¯èƒ½ä¼šé€ æˆ **æ•°æ®åº“ï¼ˆdbï¼‰å’Œç¼“å­˜ï¼ˆCacheï¼‰æ•°æ®ä¸ä¸€è‡´ **çš„é—®é¢˜ã€‚

ä¸¾ä¾‹ï¼šè¯·æ±‚ 1 å…ˆå†™æ•°æ® Aï¼Œè¯·æ±‚ 2 éšåè¯»æ•°æ® A çš„è¯ï¼Œå°±å¾ˆæœ‰å¯èƒ½äº§ç”Ÿæ•°æ®ä¸ä¸€è‡´æ€§çš„é—®é¢˜ã€‚

è¿™ä¸ªè¿‡ç¨‹å¯ä»¥ç®€å•æè¿°ä¸ºï¼š

> è¯·æ±‚ 1 å…ˆæŠŠ cache ä¸­çš„ A æ•°æ®åˆ é™¤ -> è¯·æ±‚ 2 ä» db ä¸­è¯»å–æ•°æ®->è¯·æ±‚ 1 å†æŠŠ db ä¸­çš„ A æ•°æ®æ›´æ–°

å½“ä½ è¿™æ ·å›ç­”ä¹‹åï¼Œé¢è¯•å®˜å¯èƒ½ä¼šç´§æ¥ç€å°±è¿½é—®ï¼šâ€œ**åœ¨å†™æ•°æ®çš„è¿‡ç¨‹ä¸­ï¼Œå…ˆæ›´æ–° dbï¼Œååˆ é™¤ cache å°±æ²¡æœ‰é—®é¢˜äº†ä¹ˆï¼Ÿ**â€

**ç­”æ¡ˆï¼š** ç†è®ºä¸Šæ¥è¯´è¿˜æ˜¯å¯èƒ½ä¼šå‡ºç°æ•°æ®ä¸ä¸€è‡´æ€§çš„é—®é¢˜ï¼Œä¸è¿‡æ¦‚ç‡éå¸¸å°ï¼Œå› ä¸ºç¼“å­˜çš„å†™å…¥é€Ÿåº¦æ˜¯æ¯”æ•°æ®åº“çš„å†™å…¥é€Ÿåº¦å¿«å¾ˆå¤šã€‚

ä¸¾ä¾‹ï¼šè¯·æ±‚ 1 å…ˆè¯»æ•°æ® Aï¼Œè¯·æ±‚ 2 éšåå†™æ•°æ® Aï¼Œå¹¶ä¸”æ•°æ® A åœ¨è¯·æ±‚ 1 è¯·æ±‚ä¹‹å‰ä¸åœ¨ç¼“å­˜ä¸­çš„è¯ï¼Œä¹Ÿæœ‰å¯èƒ½äº§ç”Ÿæ•°æ®ä¸ä¸€è‡´æ€§çš„é—®é¢˜ã€‚

è¿™ä¸ªè¿‡ç¨‹å¯ä»¥ç®€å•æè¿°ä¸ºï¼š

> è¯·æ±‚ 1 ä» db è¯»æ•°æ® A-> è¯·æ±‚ 2 æ›´æ–° db ä¸­çš„æ•°æ® Aï¼ˆæ­¤æ—¶ç¼“å­˜ä¸­æ— æ•°æ® A ï¼Œæ•…ä¸ç”¨æ‰§è¡Œåˆ é™¤ç¼“å­˜æ“ä½œ ï¼‰ -> è¯·æ±‚ 1 å°†æ•°æ® A å†™å…¥ cache

ç°åœ¨æˆ‘ä»¬å†æ¥åˆ†æä¸€ä¸‹ **Cache Aside Pattern çš„ç¼ºé™·**ã€‚

**ç¼ºé™· 1ï¼šé¦–æ¬¡è¯·æ±‚æ•°æ®ä¸€å®šä¸åœ¨ cache çš„é—®é¢˜**

è§£å†³åŠæ³•ï¼šå¯ä»¥å°†çƒ­ç‚¹æ•°æ®å¯ä»¥æå‰æ”¾å…¥ cache ä¸­ã€‚

**ç¼ºé™· 2ï¼šå†™æ“ä½œæ¯”è¾ƒé¢‘ç¹çš„è¯å¯¼è‡´ cache ä¸­çš„æ•°æ®ä¼šè¢«é¢‘ç¹è¢«åˆ é™¤ï¼Œè¿™æ ·ä¼šå½±å“ç¼“å­˜å‘½ä¸­ç‡ ã€‚**

è§£å†³åŠæ³•ï¼š

- æ•°æ®åº“å’Œç¼“å­˜æ•°æ®å¼ºä¸€è‡´åœºæ™¯ï¼šæ›´æ–° db çš„æ—¶å€™åŒæ ·æ›´æ–° cache(å³ ä¸ç›´æ¥åˆ é™¤ï¼Œè€Œæ˜¯æ›´æ–°)ï¼Œä¸è¿‡æˆ‘ä»¬éœ€è¦åŠ ä¸€ä¸ªé”/åˆ†å¸ƒå¼é”æ¥ä¿è¯æ›´æ–° cache çš„æ—¶å€™ä¸å­˜åœ¨çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚
- å¯ä»¥çŸ­æš‚åœ°å…è®¸æ•°æ®åº“å’Œç¼“å­˜æ•°æ®ä¸ä¸€è‡´çš„åœºæ™¯ï¼šæ›´æ–° db çš„æ—¶å€™åŒæ ·æ›´æ–° cacheï¼Œä½†æ˜¯ç»™ç¼“å­˜åŠ ä¸€ä¸ªæ¯”è¾ƒçŸ­çš„è¿‡æœŸæ—¶é—´ï¼Œè¿™æ ·çš„è¯å°±å¯ä»¥ä¿è¯å³ä½¿æ•°æ®ä¸ä¸€è‡´çš„è¯å½±å“ä¹Ÿæ¯”è¾ƒå°ã€‚

### Read/Write Through Patternï¼ˆè¯»å†™ç©¿é€ï¼‰

`Read/Write Through Pattern` ä¸­æœåŠ¡ç«¯æŠŠ **cache** è§†ä¸ºä¸»è¦æ•°æ®å­˜å‚¨ï¼Œä»ä¸­è¯»å–æ•°æ®å¹¶å°†æ•°æ®å†™å…¥å…¶ä¸­ã€‚cache æœåŠ¡è´Ÿè´£å°†æ­¤æ•°æ®è¯»å–å’Œå†™å…¥ dbï¼Œä»è€Œå‡è½»äº†åº”ç”¨ç¨‹åºçš„èŒè´£ã€‚

è¿™ç§ç¼“å­˜è¯»å†™ç­–ç•¥å°ä¼™ä¼´ä»¬åº”è¯¥ä¹Ÿå‘ç°äº†åœ¨å¹³æ—¶åœ¨å¼€å‘è¿‡ç¨‹ä¸­éå¸¸å°‘è§ã€‚æŠ›å»æ€§èƒ½æ–¹é¢çš„å½±å“ï¼Œå¤§æ¦‚ç‡æ˜¯å› ä¸ºæˆ‘ä»¬ç»å¸¸ä½¿ç”¨çš„åˆ†å¸ƒå¼ç¼“å­˜ Redis å¹¶æ²¡æœ‰æä¾› cache å°†æ•°æ®å†™å…¥ db çš„åŠŸèƒ½ã€‚

**å†™ï¼ˆWrite Throughï¼‰ï¼š**

- å…ˆæŸ¥ cacheï¼Œcache ä¸­ä¸å­˜åœ¨ï¼Œç›´æ¥æ›´æ–° dbã€‚
- cache ä¸­å­˜åœ¨ï¼Œåˆ™å…ˆæ›´æ–° cacheï¼Œç„¶å cache æœåŠ¡è‡ªå·±æ›´æ–° dbï¼ˆ**åŒæ­¥æ›´æ–° cache å’Œ db**ï¼‰ã€‚

ç®€å•ç”»äº†ä¸€å¼ å›¾å¸®åŠ©å¤§å®¶ç†è§£å†™çš„æ­¥éª¤ã€‚

![](images\write-through.png)

**è¯»(Read Through)ï¼š**

- ä» cache ä¸­è¯»å–æ•°æ®ï¼Œè¯»å–åˆ°å°±ç›´æ¥è¿”å› ã€‚
- è¯»å–ä¸åˆ°çš„è¯ï¼Œå…ˆä» db åŠ è½½ï¼Œå†™å…¥åˆ° cache åè¿”å›å“åº”ã€‚

ç®€å•ç”»äº†ä¸€å¼ å›¾å¸®åŠ©å¤§å®¶ç†è§£è¯»çš„æ­¥éª¤ã€‚

![](images\read-through.png)

Read-Through Pattern å®é™…åªæ˜¯åœ¨ Cache-Aside Pattern ä¹‹ä¸Šè¿›è¡Œäº†å°è£…ã€‚åœ¨ Cache-Aside Pattern ä¸‹ï¼Œå‘ç”Ÿè¯»è¯·æ±‚çš„æ—¶å€™ï¼Œå¦‚æœ cache ä¸­ä¸å­˜åœ¨å¯¹åº”çš„æ•°æ®ï¼Œæ˜¯ç”±å®¢æˆ·ç«¯è‡ªå·±è´Ÿè´£æŠŠæ•°æ®å†™å…¥ cacheï¼Œè€Œ **Read Through Pattern åˆ™æ˜¯ cache æœåŠ¡è‡ªå·±æ¥å†™å…¥ç¼“å­˜çš„**ï¼Œè¿™å¯¹å®¢æˆ·ç«¯æ˜¯é€æ˜çš„ã€‚

å’Œ Cache Aside Pattern ä¸€æ ·ï¼Œ Read-Through Pattern ä¹Ÿæœ‰**é¦–æ¬¡è¯·æ±‚æ•°æ®ä¸€å®šä¸å† cache çš„é—®é¢˜ï¼Œå¯¹äºçƒ­ç‚¹æ•°æ®å¯ä»¥æå‰æ”¾å…¥ç¼“å­˜ä¸­**ã€‚

### Write Behind Patternï¼ˆå¼‚æ­¥ç¼“å­˜å†™å…¥ï¼‰

`Write Behind Pattern` å’Œ Read/Write Through Pattern å¾ˆç›¸ä¼¼ï¼Œä¸¤è€…éƒ½æ˜¯ç”± **cache æœåŠ¡**æ¥è´Ÿè´£ cache å’Œ db çš„è¯»å†™ã€‚

ä½†æ˜¯ï¼Œä¸¤ä¸ªåˆæœ‰å¾ˆå¤§çš„ä¸åŒï¼š**Read/Write Through æ˜¯åŒæ­¥æ›´æ–° cache å’Œ dbï¼Œè€Œ Write Behind åˆ™æ˜¯åªæ›´æ–°ç¼“å­˜ï¼Œä¸ç›´æ¥æ›´æ–° dbï¼Œè€Œæ˜¯æ”¹ä¸ºå¼‚æ­¥æ‰¹é‡çš„æ–¹å¼æ¥æ›´æ–° dbã€‚**

å¾ˆæ˜æ˜¾ï¼Œè¿™ç§æ–¹å¼å¯¹æ•°æ®ä¸€è‡´æ€§å¸¦æ¥äº†æ›´å¤§çš„æŒ‘æˆ˜ï¼Œæ¯”å¦‚ cache æ•°æ®å¯èƒ½è¿˜æ²¡å¼‚æ­¥æ›´æ–° db çš„è¯ï¼Œcache æœåŠ¡å¯èƒ½å°±å°±æŒ‚æ‰äº†ã€‚

è¿™ç§ç­–ç•¥åœ¨æˆ‘ä»¬å¹³æ—¶å¼€å‘è¿‡ç¨‹ä¸­ä¹Ÿéå¸¸éå¸¸å°‘è§ï¼Œä½†æ˜¯ä¸ä»£è¡¨å®ƒçš„åº”ç”¨åœºæ™¯å°‘ï¼Œæ¯”å¦‚æ¶ˆæ¯é˜Ÿåˆ—ä¸­æ¶ˆæ¯çš„å¼‚æ­¥å†™å…¥ç£ç›˜ã€MySQL çš„ Innodb Buffer Pool æœºåˆ¶éƒ½ç”¨åˆ°äº†è¿™ç§ç­–ç•¥ã€‚

Write Behind Pattern ä¸‹ db çš„å†™æ€§èƒ½éå¸¸é«˜ï¼Œéå¸¸**é€‚åˆä¸€äº›æ•°æ®ç»å¸¸å˜åŒ–åˆå¯¹æ•°æ®ä¸€è‡´æ€§è¦æ±‚æ²¡é‚£ä¹ˆé«˜çš„åœºæ™¯**ï¼Œæ¯”å¦‚æµè§ˆé‡ã€ç‚¹èµé‡ã€‚



# Redis 5 ç§åŸºæœ¬æ•°æ®ç±»å‹è¯¦è§£ï¼ˆæ›´æ–°ä¸­ï¼‰âœ…

Redis å…±æœ‰ ==5 ç§åŸºæœ¬æ•°æ®ç±»å‹==ï¼š**Stringï¼ˆå­—ç¬¦ä¸²ï¼‰ã€Listï¼ˆåˆ—è¡¨ï¼‰ã€Setï¼ˆé›†åˆï¼‰ã€Hashï¼ˆæ•£åˆ—ï¼‰ã€Zsetï¼ˆæœ‰åºé›†åˆï¼‰**ã€‚

è¿™ 5 ç§æ•°æ®ç±»å‹æ˜¯ç›´æ¥æä¾›ç»™ç”¨æˆ·ä½¿ç”¨çš„ï¼Œæ˜¯æ•°æ®çš„ä¿å­˜å½¢å¼ï¼Œå…¶åº•å±‚å®ç°ä¸»è¦ä¾èµ–è¿™==8 ç§æ•°æ®ç»“æ„==ï¼š**ç®€å•åŠ¨æ€å­—ç¬¦ä¸²ï¼ˆSDSï¼‰ã€LinkedListï¼ˆåŒå‘é“¾è¡¨ï¼‰ã€Dictï¼ˆå“ˆå¸Œè¡¨/å­—å…¸ï¼‰ã€SkipListï¼ˆè·³è·ƒè¡¨ï¼‰ã€Intsetï¼ˆæ•´æ•°é›†åˆï¼‰ã€ZipListï¼ˆå‹ç¼©åˆ—è¡¨ï¼‰ã€QuickListï¼ˆå¿«é€Ÿåˆ—è¡¨ï¼‰**ã€‚

Redis 5 ç§åŸºæœ¬æ•°æ®ç±»å‹å¯¹åº”çš„åº•å±‚æ•°æ®ç»“æ„å®ç°å¦‚ä¸‹è¡¨æ‰€ç¤ºï¼š

| String | List                         | Hash          | Set          | Zset              |
| :----- | :--------------------------- | :------------ | :----------- | :---------------- |
| SDS    | LinkedList/ZipList/QuickList | Dictã€ZipList | Dictã€Intset | ZipListã€SkipList |

Redis 3.2 ä¹‹å‰ï¼ŒList åº•å±‚å®ç°æ˜¯ LinkedList æˆ–è€… ZipListã€‚ Redis 3.2 ä¹‹åï¼Œå¼•å…¥äº† LinkedList å’Œ ZipList çš„ç»“åˆ QuickListï¼ŒList çš„åº•å±‚å®ç°å˜ä¸º QuickListã€‚ä» Redis 7.0 å¼€å§‹ï¼Œ ZipList è¢« ListPack å–ä»£ã€‚

ä½ å¯ä»¥åœ¨ Redis å®˜ç½‘ä¸Šæ‰¾åˆ° Redis æ•°æ®ç±»å‹/ç»“æ„éå¸¸è¯¦ç»†çš„ä»‹ç»ï¼š

- [Redis Data Structures](https://redis.com/redis-enterprise/data-structures/)
- [Redis Data types tutorial](https://redis.io/docs/manual/data-types/data-types-tutorial/)

æœªæ¥éšç€ Redis æ–°ç‰ˆæœ¬çš„å‘å¸ƒï¼Œå¯èƒ½ä¼šæœ‰æ–°çš„æ•°æ®ç»“æ„å‡ºç°ï¼Œé€šè¿‡æŸ¥é˜… Redis å®˜ç½‘å¯¹åº”çš„ä»‹ç»ï¼Œä½ æ€»èƒ½è·å–åˆ°æœ€é è°±çš„ä¿¡æ¯ã€‚

![](images\image-20220720181630203.png)

## Stringï¼ˆå­—ç¬¦ä¸²ï¼‰

### ä»‹ç»

`String` æ˜¯ Redis ä¸­æœ€ç®€å•åŒæ—¶ä¹Ÿæ˜¯æœ€å¸¸ç”¨çš„ä¸€ä¸ªæ•°æ®ç±»å‹ã€‚

String æ˜¯ä¸€ç§**äºŒè¿›åˆ¶å®‰å…¨**çš„æ•°æ®ç±»å‹ï¼Œå¯ä»¥ç”¨æ¥å­˜å‚¨ä»»ä½•ç±»å‹çš„æ•°æ®æ¯”å¦‚**å­—ç¬¦ä¸²ã€æ•´æ•°ã€æµ®ç‚¹æ•°ã€å›¾ç‰‡ï¼ˆå›¾ç‰‡çš„ base64 ç¼–ç æˆ–è€…è§£ç æˆ–è€…å›¾ç‰‡çš„è·¯å¾„ï¼‰ã€åºåˆ—åŒ–åçš„å¯¹è±¡ã€‚**

![](images\image-20220719124403897.png)

è™½ç„¶ **Redis æ˜¯ç”¨ C è¯­è¨€å†™**çš„ï¼Œä½†æ˜¯ Redis å¹¶**æ²¡æœ‰ä½¿ç”¨ C çš„å­—ç¬¦ä¸²**è¡¨ç¤ºï¼Œè€Œæ˜¯è‡ªå·±æ„å»ºäº†ä¸€ç§ ==**ç®€å•åŠ¨æ€å­—ç¬¦ä¸²**ï¼ˆSimple Dynamic Stringï¼Œ**SDS**ï¼‰==ã€‚ç›¸æ¯”äº C çš„åŸç”Ÿå­—ç¬¦ä¸²ï¼ŒRedis çš„ SDS ä¸å…‰å¯ä»¥ä¿å­˜æ–‡æœ¬æ•°æ®è¿˜å¯ä»¥ä¿å­˜äºŒè¿›åˆ¶æ•°æ®ï¼Œå¹¶ä¸”**è·å–å­—ç¬¦ä¸²é•¿åº¦å¤æ‚åº¦ä¸º O(1)ï¼ˆC å­—ç¬¦ä¸²ä¸º O(N)ï¼‰**,é™¤æ­¤ä¹‹å¤–ï¼ŒRedis çš„ SDS API æ˜¯å®‰å…¨çš„ï¼Œ**ä¸ä¼šé€ æˆç¼“å†²åŒºæº¢å‡º**ã€‚

### å¸¸ç”¨å‘½ä»¤

| å‘½ä»¤                            | ä»‹ç»                             |
| ------------------------------- | -------------------------------- |
| SET key value                   | è®¾ç½®æŒ‡å®š key çš„å€¼                |
| SETNX key value                 | åªæœ‰åœ¨ key ä¸å­˜åœ¨æ—¶è®¾ç½® key çš„å€¼ |
| GET key                         | è·å–æŒ‡å®š key çš„å€¼                |
| MSET key1 value1 key2 value2 â€¦â€¦ | è®¾ç½®ä¸€ä¸ªæˆ–å¤šä¸ªæŒ‡å®š key çš„å€¼      |
| MGET key1 key2 ...              | è·å–ä¸€ä¸ªæˆ–å¤šä¸ªæŒ‡å®š key çš„å€¼      |
| STRLEN key                      | è¿”å› key æ‰€å‚¨å­˜çš„å­—ç¬¦ä¸²å€¼çš„é•¿åº¦  |
| INCR key                        | å°† key ä¸­å‚¨å­˜çš„æ•°å­—å€¼å¢ä¸€        |
| DECR key                        | å°† key ä¸­å‚¨å­˜çš„æ•°å­—å€¼å‡ä¸€        |
| EXISTS key                      | åˆ¤æ–­æŒ‡å®š key æ˜¯å¦å­˜åœ¨            |
| DEL keyï¼ˆé€šç”¨ï¼‰                 | åˆ é™¤æŒ‡å®šçš„ key                   |
| EXPIRE key secondsï¼ˆé€šç”¨ï¼‰      | ç»™æŒ‡å®š key è®¾ç½®è¿‡æœŸæ—¶é—´          |

æ›´å¤š Redis String å‘½ä»¤ä»¥åŠè¯¦ç»†ä½¿ç”¨æŒ‡å—ï¼Œè¯·æŸ¥çœ‹ Redis å®˜ç½‘å¯¹åº”çš„ä»‹ç»ï¼š[https://redis.io/commands/?group=string](https://redis.io/commands/?group=string) ã€‚

**åŸºæœ¬æ“ä½œ**ï¼š

```bash
> SET key value
OK
> GET key
"value"
> EXISTS key
(integer) 1
> STRLEN key
(integer) 5
> DEL key
(integer) 1
> GET key
(nil)
```

**æ‰¹é‡è®¾ç½®**ï¼š

```bash
> MSET key1 value1 key2 value2
OK
> MGET key1 key2  # æ‰¹é‡è·å–å¤šä¸ª key å¯¹åº”çš„ value
1) "value1"
2) "value2"
```

**è®¡æ•°å™¨ï¼ˆå­—ç¬¦ä¸²çš„å†…å®¹ä¸ºæ•´æ•°çš„æ—¶å€™å¯ä»¥ä½¿ç”¨ï¼‰ï¼š**

```bash
> SET number 1
OK
> INCR number  # å°† key ä¸­å‚¨å­˜çš„æ•°å­—å€¼å¢ä¸€
(integer) 2
> GET number
"2"
> DECR number  # å°† key ä¸­å‚¨å­˜çš„æ•°å­—å€¼å‡ä¸€
(integer) 1
> GET number
"1"
```

**è®¾ç½®è¿‡æœŸæ—¶é—´ï¼ˆé»˜è®¤ä¸ºæ°¸ä¸è¿‡æœŸï¼‰**ï¼š

```bash
> EXPIRE key 60
(integer) 1
> SETEX key 60 value  # è®¾ç½®å€¼å¹¶è®¾ç½®è¿‡æœŸæ—¶é—´
OK
> TTL key
(integer) 56
```

### åº”ç”¨åœºæ™¯

**éœ€è¦å­˜å‚¨å¸¸è§„æ•°æ®çš„åœºæ™¯**

- ä¸¾ä¾‹ï¼šç¼“å­˜ Sessionã€Tokenã€å›¾ç‰‡åœ°å€ã€åºåˆ—åŒ–åçš„å¯¹è±¡(ç›¸æ¯”è¾ƒäº Hash å­˜å‚¨æ›´èŠ‚çœå†…å­˜)ã€‚
- ç›¸å…³å‘½ä»¤ï¼š`SET`ã€`GET`ã€‚

**éœ€è¦è®¡æ•°çš„åœºæ™¯**

- ä¸¾ä¾‹ï¼šç”¨æˆ·å•ä½æ—¶é—´çš„è¯·æ±‚æ•°ï¼ˆç®€å•é™æµå¯ä»¥ç”¨åˆ°ï¼‰ã€é¡µé¢å•ä½æ—¶é—´çš„è®¿é—®æ•°ã€‚
- ç›¸å…³å‘½ä»¤ï¼š`SET`ã€`GET`ã€ `INCR`ã€`DECR` ã€‚

**åˆ†å¸ƒå¼é”**

åˆ©ç”¨ `SETNX key value` å‘½ä»¤å¯ä»¥å®ç°ä¸€ä¸ªæœ€ç®€æ˜“çš„åˆ†å¸ƒå¼é”ï¼ˆå­˜åœ¨ä¸€äº›ç¼ºé™·ï¼Œé€šå¸¸ä¸å»ºè®®è¿™æ ·å®ç°åˆ†å¸ƒå¼é”ï¼‰ã€‚

## Listï¼ˆåˆ—è¡¨ï¼‰

### ä»‹ç»

Redis ä¸­çš„ `List` å…¶å®å°±æ˜¯é“¾è¡¨æ•°æ®ç»“æ„çš„å®ç°ã€‚æˆ‘åœ¨ [çº¿æ€§æ•°æ®ç»“æ„ :æ•°ç»„ã€é“¾è¡¨ã€æ ˆã€é˜Ÿåˆ—](https://javaguide.cn/cs-basics/data-structure/linear-data-structure.html) è¿™ç¯‡æ–‡ç« ä¸­è¯¦ç»†ä»‹ç»äº†é“¾è¡¨è¿™ç§æ•°æ®ç»“æ„ï¼Œæˆ‘è¿™é‡Œå°±ä¸å¤šåšä»‹ç»äº†ã€‚

è®¸å¤šé«˜çº§ç¼–ç¨‹è¯­è¨€éƒ½å†…ç½®äº†é“¾è¡¨çš„å®ç°æ¯”å¦‚ Java ä¸­çš„ `LinkedList`ï¼Œä½†æ˜¯ C è¯­è¨€å¹¶æ²¡æœ‰å®ç°é“¾è¡¨ï¼Œæ‰€ä»¥ Redis å®ç°äº†è‡ªå·±çš„é“¾è¡¨æ•°æ®ç»“æ„ã€‚Redis çš„ List çš„å®ç°ä¸ºä¸€ä¸ª **åŒå‘é“¾è¡¨**ï¼Œå³å¯ä»¥æ”¯æŒåå‘æŸ¥æ‰¾å’Œéå†ï¼Œæ›´æ–¹ä¾¿æ“ä½œï¼Œä¸è¿‡å¸¦æ¥äº†éƒ¨åˆ†é¢å¤–çš„å†…å­˜å¼€é”€ã€‚

![](images\image-20220719124413287.png)

### å¸¸ç”¨å‘½ä»¤

| å‘½ä»¤                        | ä»‹ç»                                       |
| --------------------------- | ------------------------------------------ |
| RPUSH key value1 value2 ... | åœ¨æŒ‡å®šåˆ—è¡¨çš„å°¾éƒ¨ï¼ˆå³è¾¹ï¼‰æ·»åŠ ä¸€ä¸ªæˆ–å¤šä¸ªå…ƒç´  |
| LPUSH key value1 value2 ... | åœ¨æŒ‡å®šåˆ—è¡¨çš„å¤´éƒ¨ï¼ˆå·¦è¾¹ï¼‰æ·»åŠ ä¸€ä¸ªæˆ–å¤šä¸ªå…ƒç´  |
| LSET key index value        | å°†æŒ‡å®šåˆ—è¡¨ç´¢å¼• index ä½ç½®çš„å€¼è®¾ç½®ä¸º value  |
| LPOP key                    | ç§»é™¤å¹¶è·å–æŒ‡å®šåˆ—è¡¨çš„ç¬¬ä¸€ä¸ªå…ƒç´ (æœ€å·¦è¾¹)     |
| RPOP key                    | ç§»é™¤å¹¶è·å–æŒ‡å®šåˆ—è¡¨çš„æœ€åä¸€ä¸ªå…ƒç´ (æœ€å³è¾¹)   |
| LLEN key                    | è·å–åˆ—è¡¨å…ƒç´ æ•°é‡                           |
| LRANGE key start end        | è·å–åˆ—è¡¨ start å’Œ end ä¹‹é—´ çš„å…ƒç´           |

æ›´å¤š Redis List å‘½ä»¤ä»¥åŠè¯¦ç»†ä½¿ç”¨æŒ‡å—ï¼Œè¯·æŸ¥çœ‹ Redis å®˜ç½‘å¯¹åº”çš„ä»‹ç»ï¼š[https://redis.io/commands/?group=list](https://redis.io/commands/?group=list) ã€‚

**é€šè¿‡ `RPUSH/LPOP` æˆ–è€… `LPUSH/RPOP`å®ç°é˜Ÿåˆ—**ï¼š

```bash
> RPUSH myList value1
(integer) 1
> RPUSH myList value2 value3
(integer) 3
> LPOP myList
"value1"
> LRANGE myList 0 1
1) "value2"
2) "value3"
> LRANGE myList 0 -1  # -1 è¡¨ç¤ºåˆ°æœ€åï¼Ÿ
1) "value2"
2) "value3"
```

**é€šè¿‡ `RPUSH/RPOP`æˆ–è€…`LPUSH/LPOP` å®ç°æ ˆ**ï¼š

```bash
> RPUSH myList2 value1 value2 value3
(integer) 3
> RPOP myList2 # å°† listçš„æœ€å³è¾¹çš„å…ƒç´ å–å‡º
"value3"
```

æˆ‘ä¸“é—¨ç”»äº†ä¸€ä¸ªå›¾æ–¹ä¾¿å¤§å®¶ç†è§£ `RPUSH` , `LPOP` , `lpush` , `RPOP` å‘½ä»¤ï¼š

![](images\redis-list.png)

**é€šè¿‡ `LRANGE` æŸ¥çœ‹å¯¹åº”ä¸‹æ ‡èŒƒå›´çš„åˆ—è¡¨å…ƒç´ **ï¼š

```bash
> RPUSH myList value1 value2 value3
(integer) 3
> LRANGE myList 0 1
1) "value1"
2) "value2"
> LRANGE myList 0 -1
1) "value1"
2) "value2"
3) "value3"
```

é€šè¿‡ `LRANGE` å‘½ä»¤ï¼Œä½ å¯ä»¥åŸºäº List å®ç°åˆ†é¡µæŸ¥è¯¢ï¼Œæ€§èƒ½éå¸¸é«˜ï¼

**é€šè¿‡ `LLEN` æŸ¥çœ‹é“¾è¡¨é•¿åº¦**ï¼š

```bash
> LLEN myList
(integer) 3
```

### åº”ç”¨åœºæ™¯

**ä¿¡æ¯æµå±•ç¤º**

- ä¸¾ä¾‹ï¼šæœ€æ–°æ–‡ç« ã€æœ€æ–°åŠ¨æ€ã€‚
- ç›¸å…³å‘½ä»¤ï¼š`LPUSH`ã€`LRANGE`ã€‚

**æ¶ˆæ¯é˜Ÿåˆ—**

`List` å¯ä»¥ç”¨æ¥åšæ¶ˆæ¯é˜Ÿåˆ—ï¼Œåªæ˜¯åŠŸèƒ½è¿‡äºç®€å•ä¸”å­˜åœ¨å¾ˆå¤šç¼ºé™·ï¼Œä¸å»ºè®®è¿™æ ·åšã€‚

ç›¸å¯¹æ¥è¯´ï¼ŒRedis 5.0 æ–°å¢åŠ çš„ä¸€ä¸ªæ•°æ®ç»“æ„ `Stream` æ›´é€‚åˆåšæ¶ˆæ¯é˜Ÿåˆ—ä¸€äº›ï¼Œåªæ˜¯åŠŸèƒ½ä¾ç„¶éå¸¸ç®€é™‹ã€‚å’Œä¸“ä¸šçš„æ¶ˆæ¯é˜Ÿåˆ—ç›¸æ¯”ï¼Œè¿˜æ˜¯æœ‰å¾ˆå¤šæ¬ ç¼ºçš„åœ°æ–¹æ¯”å¦‚æ¶ˆæ¯ä¸¢å¤±å’Œå †ç§¯é—®é¢˜ä¸å¥½è§£å†³ã€‚

## Hashï¼ˆå“ˆå¸Œï¼‰

### ä»‹ç»

Redis ä¸­çš„ `Hash` æ˜¯ä¸€ä¸ª **String ç±»å‹çš„ field-valueï¼ˆé”®å€¼å¯¹ï¼‰ çš„æ˜ å°„è¡¨**ï¼Œç‰¹åˆ«é€‚åˆç”¨äºå­˜å‚¨å¯¹è±¡ï¼Œåç»­æ“ä½œçš„æ—¶å€™ï¼Œä½ å¯ä»¥ç›´æ¥ä¿®æ”¹è¿™ä¸ªå¯¹è±¡ä¸­çš„æŸäº›å­—æ®µçš„å€¼ã€‚

Hash ç±»ä¼¼äº JDK1.8 å‰çš„ `HashMap`ï¼Œå†…éƒ¨å®ç°ä¹Ÿå·®ä¸å¤š(**æ•°ç»„ + é“¾è¡¨**)ã€‚ä¸è¿‡ï¼ŒRedis çš„ Hash åšäº†æ›´å¤šä¼˜åŒ–ã€‚

![](images\image-20220719124421703.png)

### å¸¸ç”¨å‘½ä»¤

| å‘½ä»¤                                      | ä»‹ç»  (ä¸‹é¢å¯ä»¥ç†è§£ä¸ºå­—æ®µå°±æ˜¯é”®)                         |
| ----------------------------------------- | -------------------------------------------------------- |
| HSET key field value                      | è®¾ç½®æŒ‡å®šå“ˆå¸Œè¡¨ä¸­æŒ‡å®šå­—æ®µçš„å€¼                             |
| HSETNX key field value                    | åªæœ‰æŒ‡å®šå­—æ®µä¸å­˜åœ¨æ—¶è®¾ç½®æŒ‡å®šå­—æ®µçš„å€¼                     |
| HMSET key field1 value1 field2 value2 ... | åŒæ—¶å°†ä¸€ä¸ªæˆ–å¤šä¸ª field-value (åŸŸ-å€¼)å¯¹è®¾ç½®åˆ°æŒ‡å®šå“ˆå¸Œè¡¨ä¸­ |
| HGET key field                            | è·å–æŒ‡å®šå“ˆå¸Œè¡¨ä¸­æŒ‡å®šå­—æ®µçš„å€¼                             |
| HMGET key field1 field2 ...               | è·å–æŒ‡å®šå“ˆå¸Œè¡¨ä¸­ä¸€ä¸ªæˆ–è€…å¤šä¸ªæŒ‡å®šå­—æ®µçš„å€¼                 |
| HGETALL key                               | è·å–æŒ‡å®šå“ˆå¸Œè¡¨ä¸­æ‰€æœ‰çš„é”®å€¼å¯¹                             |
| HEXISTS key field                         | æŸ¥çœ‹æŒ‡å®šå“ˆå¸Œè¡¨ä¸­æŒ‡å®šçš„å­—æ®µæ˜¯å¦å­˜åœ¨                       |
| HDEL key field1 field2 ...                | åˆ é™¤ä¸€ä¸ªæˆ–å¤šä¸ªå“ˆå¸Œè¡¨å­—æ®µ                                 |
| HLEN key                                  | è·å–æŒ‡å®šå“ˆå¸Œè¡¨ä¸­å­—æ®µçš„æ•°é‡                               |
| HINCRBY key field increment               | å¯¹æŒ‡å®šå“ˆå¸Œä¸­çš„æŒ‡å®šå­—æ®µåšè¿ç®—æ“ä½œï¼ˆæ­£æ•°ä¸ºåŠ ï¼Œè´Ÿæ•°ä¸ºå‡ï¼‰   |

æ›´å¤š Redis Hash å‘½ä»¤ä»¥åŠè¯¦ç»†ä½¿ç”¨æŒ‡å—ï¼Œè¯·æŸ¥çœ‹ Redis å®˜ç½‘å¯¹åº”çš„ä»‹ç»ï¼š[https://redis.io/commands/?group=hash](https://redis.io/commands/?group=hash) ã€‚

**æ¨¡æ‹Ÿå¯¹è±¡æ•°æ®å­˜å‚¨**ï¼š

```bash
> HMSET userInfoKey name "guide" description "dev" age 24
OK
> HEXISTS userInfoKey name  # æŸ¥çœ‹ key å¯¹åº”çš„ valueä¸­æŒ‡å®šçš„å­—æ®µæ˜¯å¦å­˜åœ¨ã€‚
(integer) 1
> HGET userInfoKey name  # è·å–å­˜å‚¨åœ¨å“ˆå¸Œè¡¨ä¸­æŒ‡å®šå­—æ®µçš„å€¼ã€‚
"guide"
> HGET userInfoKey age
"24"
> HGETALL userInfoKey  # è·å–åœ¨å“ˆå¸Œè¡¨ä¸­æŒ‡å®š key çš„æ‰€æœ‰å­—æ®µå’Œå€¼
1) "name"
2) "guide"
3) "description"
4) "dev"
5) "age"
6) "24"
> HSET userInfoKey name "GuideGeGe"
> HGET userInfoKey name
"GuideGeGe"
> HINCRBY userInfoKey age 2
(integer) 26
```

### åº”ç”¨åœºæ™¯

**å¯¹è±¡æ•°æ®å­˜å‚¨åœºæ™¯**

- ä¸¾ä¾‹ï¼šç”¨æˆ·ä¿¡æ¯ã€å•†å“ä¿¡æ¯ã€æ–‡ç« ä¿¡æ¯ã€è´­ç‰©è½¦ä¿¡æ¯ã€‚
- ç›¸å…³å‘½ä»¤ï¼š`HSET` ï¼ˆè®¾ç½®å•ä¸ªå­—æ®µçš„å€¼ï¼‰ã€`HMSET`ï¼ˆè®¾ç½®å¤šä¸ªå­—æ®µçš„å€¼ï¼‰ã€`HGET`ï¼ˆè·å–å•ä¸ªå­—æ®µçš„å€¼ï¼‰ã€`HMGET`ï¼ˆè·å–å¤šä¸ªå­—æ®µçš„å€¼ï¼‰ã€‚

## Setï¼ˆé›†åˆï¼‰

### ä»‹ç»

Redis ä¸­çš„ `Set` ç±»å‹æ˜¯ä¸€ç§**æ— åºé›†åˆ**ï¼Œé›†åˆä¸­çš„å…ƒç´ æ²¡æœ‰å…ˆåé¡ºåºä½†éƒ½**å”¯ä¸€**ï¼Œæœ‰ç‚¹ç±»ä¼¼äº Java ä¸­çš„ `HashSet` ã€‚å½“ä½ éœ€è¦å­˜å‚¨ä¸€ä¸ªåˆ—è¡¨æ•°æ®ï¼Œåˆä¸å¸Œæœ›å‡ºç°é‡å¤æ•°æ®æ—¶ï¼ŒSet æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é€‰æ‹©ï¼Œå¹¶ä¸” Set æä¾›äº†åˆ¤æ–­æŸä¸ªå…ƒç´ æ˜¯å¦åœ¨ä¸€ä¸ª Set é›†åˆå†…çš„é‡è¦æ¥å£ï¼Œè¿™ä¸ªä¹Ÿæ˜¯ List æ‰€ä¸èƒ½æä¾›çš„ã€‚

ä½ å¯ä»¥åŸºäº Set è½»æ˜“å®ç°äº¤é›†ã€å¹¶é›†ã€å·®é›†çš„æ“ä½œï¼Œæ¯”å¦‚ä½ å¯ä»¥å°†ä¸€ä¸ªç”¨æˆ·æ‰€æœ‰çš„å…³æ³¨äººå­˜åœ¨ä¸€ä¸ªé›†åˆä¸­ï¼Œå°†å…¶æ‰€æœ‰ç²‰ä¸å­˜åœ¨ä¸€ä¸ªé›†åˆã€‚è¿™æ ·çš„è¯ï¼ŒSet å¯ä»¥éå¸¸æ–¹ä¾¿çš„å®ç°å¦‚å…±åŒå…³æ³¨ã€å…±åŒç²‰ä¸ã€å…±åŒå–œå¥½ç­‰åŠŸèƒ½ã€‚è¿™ä¸ªè¿‡ç¨‹ä¹Ÿå°±æ˜¯æ±‚äº¤é›†çš„è¿‡ç¨‹ã€‚

![](images\image-20220719124430264.png)

### å¸¸ç”¨å‘½ä»¤

| å‘½ä»¤                                  | ä»‹ç»                                      |
| ------------------------------------- | ----------------------------------------- |
| SADD key member1 member2 ...          | å‘æŒ‡å®šé›†åˆæ·»åŠ ä¸€ä¸ªæˆ–å¤šä¸ªå…ƒç´               |
| SMEMBERS key                          | è·å–æŒ‡å®šé›†åˆä¸­çš„æ‰€æœ‰å…ƒç´                   |
| SCARD key                             | è·å–æŒ‡å®šé›†åˆçš„å…ƒç´ æ•°é‡                    |
| SISMEMBER key member                  | åˆ¤æ–­æŒ‡å®šå…ƒç´ æ˜¯å¦åœ¨æŒ‡å®šé›†åˆä¸­              |
| SINTER key1 key2 ...                  | è·å–ç»™å®šæ‰€æœ‰é›†åˆçš„äº¤é›†                    |
| SINTERSTORE destination key1 key2 ... | å°†ç»™å®šæ‰€æœ‰é›†åˆçš„äº¤é›†å­˜å‚¨åœ¨ destination ä¸­ |
| SUNION key1 key2 ...                  | è·å–ç»™å®šæ‰€æœ‰é›†åˆçš„å¹¶é›†                    |
| SUNIONSTORE destination key1 key2 ... | å°†ç»™å®šæ‰€æœ‰é›†åˆçš„å¹¶é›†å­˜å‚¨åœ¨ destination ä¸­ |
| SDIFF key1 key2 ...                   | è·å–ç»™å®šæ‰€æœ‰é›†åˆçš„å·®é›†                    |
| SDIFFSTORE destination key1 key2 ...  | å°†ç»™å®šæ‰€æœ‰é›†åˆçš„å·®é›†å­˜å‚¨åœ¨ destination ä¸­ |
| SPOP key count                        | éšæœºç§»é™¤å¹¶è·å–æŒ‡å®šé›†åˆä¸­ä¸€ä¸ªæˆ–å¤šä¸ªå…ƒç´     |
| SRANDMEMBER key count                 | éšæœºè·å–æŒ‡å®šé›†åˆä¸­æŒ‡å®šæ•°é‡çš„å…ƒç´           |

æ›´å¤š Redis Set å‘½ä»¤ä»¥åŠè¯¦ç»†ä½¿ç”¨æŒ‡å—ï¼Œè¯·æŸ¥çœ‹ Redis å®˜ç½‘å¯¹åº”çš„ä»‹ç»ï¼š[https://redis.io/commands/?group=set](https://redis.io/commands/?group=set) ã€‚

**åŸºæœ¬æ“ä½œ**ï¼š

```bash
> SADD mySet value1 value2
(integer) 2
> SADD mySet value1  # ä¸å…è®¸æœ‰é‡å¤å…ƒç´ ï¼Œå› æ­¤æ·»åŠ å¤±è´¥
(integer) 0
> SMEMBERS mySet
1) "value1"
2) "value2"
> SCARD mySet
(integer) 2
> SISMEMBER mySet value1
(integer) 1
> SADD mySet2 value2 value3
(integer) 2
```

- `mySet` : `value1`ã€`value2` ã€‚
- `mySet2`ï¼š`value2`ã€`value3` ã€‚

**æ±‚äº¤é›†**ï¼š

```bash
> SINTERSTORE mySet3 mySet mySet2
(integer) 1
> SMEMBERS mySet3
1) "value2"
```

**æ±‚å¹¶é›†**ï¼š

```bash
> SUNION mySet mySet2
1) "value3"
2) "value2"
3) "value1"
```

**æ±‚å·®é›†**ï¼š

```bash
> SDIFF mySet mySet2 # å·®é›†æ˜¯ç”±æ‰€æœ‰å±äº mySet ä½†ä¸å±äº A çš„å…ƒç´ ç»„æˆçš„é›†åˆ
1) "value1"
```

### åº”ç”¨åœºæ™¯

**éœ€è¦å­˜æ”¾çš„æ•°æ®ä¸èƒ½é‡å¤çš„åœºæ™¯**

- ä¸¾ä¾‹ï¼šç½‘ç«™ UV ç»Ÿè®¡ï¼ˆæ•°æ®é‡å·¨å¤§çš„åœºæ™¯è¿˜æ˜¯ `HyperLogLog`æ›´é€‚åˆä¸€äº›ï¼‰ã€æ–‡ç« ç‚¹èµã€åŠ¨æ€ç‚¹èµç­‰åœºæ™¯ã€‚
- ç›¸å…³å‘½ä»¤ï¼š`SCARD`ï¼ˆè·å–é›†åˆæ•°é‡ï¼‰ ã€‚

![](images\image-20220719073733851.png)

**éœ€è¦è·å–å¤šä¸ªæ•°æ®æºäº¤é›†ã€å¹¶é›†å’Œå·®é›†çš„åœºæ™¯**

- ä¸¾ä¾‹ï¼šå…±åŒå¥½å‹(äº¤é›†)ã€å…±åŒç²‰ä¸(äº¤é›†)ã€å…±åŒå…³æ³¨(äº¤é›†)ã€å¥½å‹æ¨èï¼ˆå·®é›†ï¼‰ã€éŸ³ä¹æ¨èï¼ˆå·®é›†ï¼‰ã€è®¢é˜…å·æ¨èï¼ˆå·®é›†+äº¤é›†ï¼‰ ç­‰åœºæ™¯ã€‚
- ç›¸å…³å‘½ä»¤ï¼š`SINTER`ï¼ˆäº¤é›†ï¼‰ã€`SINTERSTORE` ï¼ˆäº¤é›†ï¼‰ã€`SUNION` ï¼ˆå¹¶é›†ï¼‰ã€`SUNIONSTORE`ï¼ˆå¹¶é›†ï¼‰ã€`SDIFF`ï¼ˆå·®é›†ï¼‰ã€`SDIFFSTORE` ï¼ˆå·®é›†ï¼‰ã€‚

![](images\image-20220719074543513.png)

**éœ€è¦éšæœºè·å–æ•°æ®æºä¸­çš„å…ƒç´ çš„åœºæ™¯**

- ä¸¾ä¾‹ï¼šæŠ½å¥–ç³»ç»Ÿã€éšæœºç‚¹åç­‰åœºæ™¯ã€‚
- ç›¸å…³å‘½ä»¤ï¼š`SPOP`ï¼ˆéšæœºè·å–é›†åˆä¸­çš„å…ƒç´ å¹¶ç§»é™¤ï¼Œé€‚åˆä¸å…è®¸é‡å¤ä¸­å¥–çš„åœºæ™¯ï¼‰ã€`SRANDMEMBER`ï¼ˆéšæœºè·å–é›†åˆä¸­çš„å…ƒç´ ï¼Œé€‚åˆå…è®¸é‡å¤ä¸­å¥–çš„åœºæ™¯ï¼‰ã€‚

## Sorted Setï¼ˆæœ‰åºé›†åˆï¼‰

### ä»‹ç»

`Sorted Setï¼ˆZsetï¼‰` ç±»ä¼¼äº Setï¼Œä½†å’Œ Set ç›¸æ¯”ï¼ŒSorted Set å¢åŠ äº†ä¸€ä¸ª**æƒé‡å‚æ•° `score`ï¼ˆæˆå‘˜å”¯ä¸€ä½†åˆ†æ•°å¯ä»¥é‡å¤ï¼‰**ï¼Œä½¿å¾—é›†åˆä¸­çš„å…ƒç´ èƒ½å¤ŸæŒ‰ `score` è¿›è¡Œ**æœ‰åºæ’åˆ—ï¼ˆä»å°åˆ°å¤§ï¼‰**ï¼Œè¿˜å¯ä»¥é€šè¿‡ `score` çš„èŒƒå›´æ¥è·å–å…ƒç´ çš„åˆ—è¡¨ã€‚æœ‰ç‚¹åƒæ˜¯ Java ä¸­ `HashMap` å’Œ `TreeSet` çš„ç»“åˆä½“ã€‚

![](images\image-20220719124437791.png)

### å¸¸ç”¨å‘½ä»¤

| å‘½ä»¤                                          | ä»‹ç»                                                         |
| --------------------------------------------- | ------------------------------------------------------------ |
| ZADD key score1 member1 score2 member2 ...    | å‘æŒ‡å®šæœ‰åºé›†åˆæ·»åŠ ä¸€ä¸ªæˆ–å¤šä¸ªå…ƒç´                              |
| ZCARD KEY                                     | è·å–æŒ‡å®šæœ‰åºé›†åˆçš„å…ƒç´ æ•°é‡                                   |
| ZSCORE key member                             | è·å–æŒ‡å®šæœ‰åºé›†åˆä¸­æŒ‡å®šå…ƒç´ çš„ score å€¼                        |
| ZINTERSTORE destination numkeys key1 key2 ... | å°†ç»™å®šæ‰€æœ‰æœ‰åºé›†åˆçš„äº¤é›†å­˜å‚¨åœ¨ destination ä¸­ï¼Œå¯¹ç›¸åŒå…ƒç´ å¯¹åº”çš„ score å€¼è¿›è¡Œ SUM èšåˆæ“ä½œï¼Œnumkeys ä¸ºé›†åˆæ•°é‡ |
| ZUNIONSTORE destination numkeys key1 key2 ... | æ±‚å¹¶é›†ï¼Œå…¶å®ƒå’Œ ZINTERSTORE ç±»ä¼¼                              |
| ZDIFFSTORE destination numkeys key1 key2 ...  | æ±‚å·®é›†ï¼Œå…¶å®ƒå’Œ ZINTERSTORE ç±»ä¼¼                              |
| ZRANGE key start end                          | è·å–æŒ‡å®šæœ‰åºé›†åˆ start å’Œ end ä¹‹é—´çš„å…ƒç´ ï¼ˆscore ä»ä½åˆ°é«˜ï¼‰   |
| ZREVRANGE key start end                       | è·å–æŒ‡å®šæœ‰åºé›†åˆ start å’Œ end ä¹‹é—´çš„å…ƒç´ ï¼ˆscore ä»é«˜åˆ°åº•ï¼‰   |
| ZREVRANK key member                           | è·å–æŒ‡å®šæœ‰åºé›†åˆä¸­æŒ‡å®šå…ƒç´ çš„æ’å(score ä»å¤§åˆ°å°æ’åº)         |

æ›´å¤š Redis Sorted Set å‘½ä»¤ä»¥åŠè¯¦ç»†ä½¿ç”¨æŒ‡å—ï¼Œè¯·æŸ¥çœ‹ Redis å®˜ç½‘å¯¹åº”çš„ä»‹ç»ï¼š[https://redis.io/commands/?group=sorted-set](https://redis.io/commands/?group=sorted-set) ã€‚

**åŸºæœ¬æ“ä½œ**ï¼š

```bash
> ZADD myZset 2.0 value1 1.0 value2
(integer) 2
> ZCARD myZset
2
> ZSCORE myZset value1
2.0
> ZRANGE myZset 0 1  # score ä»ä½åˆ°é«˜
1) "value2"
2) "value1"
> ZREVRANGE myZset 0 1  # score ä»é«˜åˆ°åº•
1) "value1"
2) "value2"
> ZADD myZset2 4.0 value2 3.0 value3
(integer) 2
```

- `myZset` : `value1`(2.0)ã€`value2`(1.0) ã€‚
- `myZset2`ï¼š`value2` ï¼ˆ4.0ï¼‰ã€`value3`(3.0) ã€‚

**è·å–æŒ‡å®šå…ƒç´ çš„æ’å**ï¼š

```bash
> ZREVRANK myZset value1
0
> ZREVRANK myZset value2
1
```

**æ±‚äº¤é›†**ï¼š

```bash
> ZINTERSTORE myZset3 2 myZset myZset2
1
> ZRANGE myZset3 0 1 WITHSCORES
value2
5  # SUM èšåˆäº†
```

**æ±‚å¹¶é›†**ï¼š

```bash
> ZUNIONSTORE myZset4 2 myZset myZset2
3
> ZRANGE myZset4 0 2 WITHSCORES
value1
2
value3
3
value2
5
```

**æ±‚å·®é›†**ï¼š

```bash
> ZDIFF 2 myZset myZset2 WITHSCORES
value1
2
```

### åº”ç”¨åœºæ™¯

**éœ€è¦éšæœºè·å–æ•°æ®æºä¸­çš„å…ƒç´ æ ¹æ®æŸä¸ªæƒé‡è¿›è¡Œæ’åºçš„åœºæ™¯**

- ä¸¾ä¾‹ï¼šå„ç§æ’è¡Œæ¦œæ¯”å¦‚ç›´æ’­é—´é€ç¤¼ç‰©çš„æ’è¡Œæ¦œã€æœ‹å‹åœˆçš„å¾®ä¿¡æ­¥æ•°æ’è¡Œæ¦œã€ç‹è€…è£è€€ä¸­çš„æ®µä½æ’è¡Œæ¦œã€è¯é¢˜çƒ­åº¦æ’è¡Œæ¦œç­‰ç­‰ã€‚
- ç›¸å…³å‘½ä»¤ï¼š`ZRANGE` (ä»å°åˆ°å¤§æ’åº)ã€ `ZREVRANGE` ï¼ˆä»å¤§åˆ°å°æ’åºï¼‰ã€`ZREVRANK` (æŒ‡å®šå…ƒç´ æ’å)ã€‚

<img src="images\2021060714195385 (1).png" style="zoom: 50%;" />

[ã€ŠJava é¢è¯•æŒ‡åŒ—ã€‹](https://javaguide.cn/zhuanlan/java-mian-shi-zhi-bei.html) çš„ã€ŒæŠ€æœ¯é¢è¯•é¢˜ç¯‡ã€å°±æœ‰ä¸€ç¯‡æ–‡ç« è¯¦ç»†ä»‹ç»å¦‚ä½•ä½¿ç”¨ Sorted Set æ¥è®¾è®¡åˆ¶ä½œä¸€ä¸ªæ’è¡Œæ¦œã€‚

![](images\image-20220719071115140 (1).png)

**éœ€è¦å­˜å‚¨çš„æ•°æ®æœ‰ä¼˜å…ˆçº§æˆ–è€…é‡è¦ç¨‹åº¦çš„åœºæ™¯** æ¯”å¦‚ä¼˜å…ˆçº§ä»»åŠ¡é˜Ÿåˆ—ã€‚

- ä¸¾ä¾‹ï¼šä¼˜å…ˆçº§ä»»åŠ¡é˜Ÿåˆ—ã€‚
- ç›¸å…³å‘½ä»¤ï¼š`ZRANGE` (ä»å°åˆ°å¤§æ’åº)ã€ `ZREVRANGE` ï¼ˆä»å¤§åˆ°å°æ’åºï¼‰ã€`ZREVRANK` (æŒ‡å®šå…ƒç´ æ’å)ã€‚

## æ€»ç»“ âœ…

| æ•°æ®ç±»å‹ | è¯´æ˜                                                         |
| -------- | ------------------------------------------------------------ |
| String   | ä¸€ç§äºŒè¿›åˆ¶å®‰å…¨çš„æ•°æ®ç±»å‹ï¼Œå¯ä»¥ç”¨æ¥**å­˜å‚¨ä»»ä½•ç±»å‹çš„æ•°æ®**æ¯”å¦‚å­—ç¬¦ä¸²ã€æ•´æ•°ã€æµ®ç‚¹æ•°ã€å›¾ç‰‡ï¼ˆå›¾ç‰‡çš„ base64 ç¼–ç æˆ–è€…è§£ç æˆ–è€…å›¾ç‰‡çš„è·¯å¾„ï¼‰ã€åºåˆ—åŒ–åçš„å¯¹è±¡ã€‚ |
| List     | Redis çš„ List çš„å®ç°ä¸ºä¸€ä¸ª**åŒå‘é“¾è¡¨**ï¼Œå³å¯ä»¥æ”¯æŒåå‘æŸ¥æ‰¾å’Œéå†ï¼Œæ›´æ–¹ä¾¿æ“ä½œï¼Œä¸è¿‡å¸¦æ¥äº†éƒ¨åˆ†é¢å¤–çš„å†…å­˜å¼€é”€ã€‚ |
| Hash     | ä¸€ä¸ª **String ç±»å‹çš„ field-valueï¼ˆé”®å€¼å¯¹ï¼‰ çš„æ˜ å°„è¡¨**ï¼Œç‰¹åˆ«é€‚åˆç”¨äº**å­˜å‚¨å¯¹è±¡**ï¼Œåç»­æ“ä½œçš„æ—¶å€™ï¼Œä½ å¯ä»¥ç›´æ¥ä¿®æ”¹è¿™ä¸ªå¯¹è±¡ä¸­çš„æŸäº›å­—æ®µçš„å€¼ã€‚ |
| Set      | **æ— åºé›†åˆ**ï¼Œé›†åˆä¸­çš„å…ƒç´ æ²¡æœ‰å…ˆåé¡ºåºä½†éƒ½**å”¯ä¸€**ï¼Œæœ‰ç‚¹ç±»ä¼¼äº Java ä¸­çš„ `HashSet` ã€‚ |
| Zset     | å’Œ Set ç›¸æ¯”ï¼ŒSorted Set å¢åŠ äº†ä¸€ä¸ª**æƒé‡å‚æ•° `score`**ï¼Œä½¿å¾—é›†åˆä¸­çš„å…ƒç´ èƒ½å¤ŸæŒ‰ `score` è¿›è¡Œ**æœ‰åºæ’åˆ—ï¼ˆä»å°åˆ°å¤§ï¼‰**ï¼Œè¿˜å¯ä»¥é€šè¿‡ `score` çš„èŒƒå›´æ¥è·å–å…ƒç´ çš„åˆ—è¡¨ã€‚æœ‰ç‚¹åƒæ˜¯ Java ä¸­ `HashMap` å’Œ `TreeSet` çš„ç»“åˆä½“ã€‚ |

## å‚è€ƒ

- Redis Data Structuresï¼š[https://redis.com/redis-enterprise/data-structures/](https://redis.com/redis-enterprise/data-structures/) ã€‚

- Redis Commandsï¼š[https://redis.io/commands/](https://redis.io/commands/) ã€‚

- Redis Data types tutorialï¼š[https://redis.io/docs/manual/data-types/data-types-tutorial/](https://redis.io/docs/manual/data-types/data-types-tutorial/) ã€‚

- Redis å­˜å‚¨å¯¹è±¡ä¿¡æ¯æ˜¯ç”¨ Hash è¿˜æ˜¯ String : https://segmentfault.com/a/1190000040032006



# Redis 3 ç§ç‰¹æ®Šæ•°æ®ç±»å‹è¯¦è§£ï¼ˆæ›´æ–°ä¸­ï¼‰

é™¤äº† 5 ç§åŸºæœ¬çš„æ•°æ®ç±»å‹ä¹‹å¤–ï¼ŒRedis è¿˜æ”¯æŒ 3 ç§ç‰¹æ®Šçš„æ•°æ®ç±»å‹ï¼šBitmapã€HyperLogLogã€GEOã€‚

## Bitmap ï¼ˆä½å›¾ï¼‰

### ä»‹ç»

æ ¹æ®å®˜ç½‘ä»‹ç»ï¼š

> Bitmaps are not an actual data type, but a set of bit-oriented operations defined on the String type which is treated like a bit vector. Since strings are binary safe blobs and their maximum length is 512 MB, they are suitable to set up to 2^32 different bits.
>
> **Bitmap ä¸æ˜¯ Redis ä¸­çš„å®é™…æ•°æ®ç±»å‹ï¼Œè€Œæ˜¯åœ¨ String ç±»å‹ä¸Šå®šä¹‰çš„ä¸€ç»„é¢å‘ä½çš„æ“ä½œï¼Œå°†å…¶è§†ä¸ºä½å‘é‡**ã€‚ç”±äºå­—ç¬¦ä¸²æ˜¯äºŒè¿›åˆ¶å®‰å…¨çš„å—ï¼Œä¸”æœ€å¤§é•¿åº¦ä¸º 512 MBï¼Œå®ƒä»¬é€‚åˆç”¨äºè®¾ç½®æœ€å¤š **$2^{32}$** ä¸ªä¸åŒçš„ä½ã€‚

`Bitmap` å­˜å‚¨çš„æ˜¯**è¿ç»­çš„äºŒè¿›åˆ¶æ•°å­—ï¼ˆ0 å’Œ 1ï¼‰**ï¼Œé€šè¿‡ Bitmap, åªéœ€è¦**ä¸€ä¸ª bit ä½æ¥è¡¨ç¤ºæŸä¸ªå…ƒç´ å¯¹åº”çš„å€¼æˆ–è€…çŠ¶æ€**ï¼Œ**key å°±æ˜¯å¯¹åº”å…ƒç´ æœ¬èº«** ã€‚æˆ‘ä»¬çŸ¥é“ 8 ä¸ª bit å¯ä»¥ç»„æˆä¸€ä¸ª byteï¼Œæ‰€ä»¥ Bitmap æœ¬èº«ä¼šæå¤§çš„èŠ‚çœå‚¨å­˜ç©ºé—´ã€‚

ä½ å¯ä»¥å°† Bitmap çœ‹ä½œæ˜¯ä¸€ä¸ªå­˜å‚¨äºŒè¿›åˆ¶æ•°å­—ï¼ˆ0 å’Œ 1ï¼‰çš„**æ•°ç»„**ï¼Œæ•°ç»„ä¸­æ¯ä¸ªå…ƒç´ çš„ä¸‹æ ‡å«åš **offsetï¼ˆåç§»é‡ï¼‰**ã€‚

![](images\image-20220720194154133 (1).png)

### å¸¸ç”¨å‘½ä»¤

| å‘½ä»¤                                  | ä»‹ç»                                                         |
| ------------------------------------- | ------------------------------------------------------------ |
| SETBIT key offset value               | è®¾ç½®æŒ‡å®š offset ä½ç½®çš„å€¼                                     |
| GETBIT key offset                     | è·å–æŒ‡å®š offset ä½ç½®çš„å€¼                                     |
| BITCOUNT key start end                | è·å– start å’Œ end ä¹‹é—´å€¼ä¸º 1 çš„å…ƒç´ ä¸ªæ•°                      |
| BITOP operation destkey key1 key2 ... | å¯¹ä¸€ä¸ªæˆ–å¤šä¸ª Bitmap è¿›è¡Œè¿ç®—ï¼Œå¯ç”¨è¿ç®—ç¬¦æœ‰ AND, OR, XOR ä»¥åŠ NOT |

**Bitmap åŸºæœ¬æ“ä½œæ¼”ç¤º**ï¼š

```bash
# SETBIT ä¼šè¿”å›ä¹‹å‰ä½çš„å€¼ï¼ˆé»˜è®¤æ˜¯ 0ï¼‰è¿™é‡Œä¼šç”Ÿæˆ 7 ä¸ªä½
> SETBIT mykey 7 1
(integer) 0
> SETBIT mykey 7 0
(integer) 1
> GETBIT mykey 7
(integer) 0
> SETBIT mykey 6 1
(integer) 0
> SETBIT mykey 8 1
(integer) 0
# é€šè¿‡ bitcount ç»Ÿè®¡è¢«è®¾ç½®ä¸º 1 çš„ä½çš„æ•°é‡ã€‚
> BITCOUNT mykey
(integer) 2
```

### åº”ç”¨åœºæ™¯

**éœ€è¦ä¿å­˜çŠ¶æ€ä¿¡æ¯ï¼ˆ0/1 å³å¯è¡¨ç¤ºï¼‰çš„åœºæ™¯**

- ä¸¾ä¾‹ï¼šç”¨æˆ·ç­¾åˆ°æƒ…å†µã€æ´»è·ƒç”¨æˆ·æƒ…å†µã€ç”¨æˆ·è¡Œä¸ºç»Ÿè®¡ï¼ˆæ¯”å¦‚æ˜¯å¦ç‚¹èµè¿‡æŸä¸ªè§†é¢‘ï¼‰ã€‚
- ç›¸å…³å‘½ä»¤ï¼š`SETBIT`ã€`GETBIT`ã€`BITCOUNT`ã€`BITOP`ã€‚

## HyperLogLogï¼ˆåŸºæ•°ç»Ÿè®¡ï¼‰

### ä»‹ç»

`HyperLogLog` æ˜¯ä¸€ç§æœ‰åçš„**åŸºæ•°è®¡æ•°æ¦‚ç‡ç®—æ³•** ï¼ŒåŸºäº LogLog Counting(LLC)ä¼˜åŒ–æ”¹è¿›å¾—æ¥ï¼Œå¹¶ä¸æ˜¯ Redis ç‰¹æœ‰çš„ï¼ŒRedis åªæ˜¯å®ç°äº†è¿™ä¸ªç®—æ³•å¹¶æä¾›äº†ä¸€äº›å¼€ç®±å³ç”¨çš„ APIã€‚

Redis æä¾›çš„ HyperLogLog å ç”¨ç©ºé—´éå¸¸éå¸¸å°ï¼Œåªéœ€è¦ 12k çš„ç©ºé—´å°±èƒ½å­˜å‚¨æ¥è¿‘`2^64`ä¸ªä¸åŒå…ƒç´ ã€‚è¿™æ˜¯çœŸçš„å‰å®³ï¼Œè¿™å°±æ˜¯æ•°å­¦çš„é­…åŠ›ä¹ˆï¼å¹¶ä¸”ï¼ŒRedis å¯¹ HyperLogLog çš„å­˜å‚¨ç»“æ„åšäº†ä¼˜åŒ–ï¼Œé‡‡ç”¨ä¸¤ç§æ–¹å¼è®¡æ•°ï¼š

- **ç¨€ç–çŸ©é˜µ**ï¼šè®¡æ•°è¾ƒå°‘çš„æ—¶å€™ï¼Œå ç”¨ç©ºé—´å¾ˆå°ã€‚
- **ç¨ å¯†çŸ©é˜µ**ï¼šè®¡æ•°è¾¾åˆ°æŸä¸ªé˜ˆå€¼çš„æ—¶å€™ï¼Œå ç”¨ 12k çš„ç©ºé—´ã€‚

Redis å®˜æ–¹æ–‡æ¡£ä¸­æœ‰å¯¹åº”çš„è¯¦ç»†è¯´æ˜ï¼š

![](images\image-20220721091424563.png)

åŸºæ•°è®¡æ•°æ¦‚ç‡ç®—æ³•ä¸ºäº†èŠ‚çœå†…å­˜å¹¶ä¸ä¼šç›´æ¥å­˜å‚¨å…ƒæ•°æ®ï¼Œè€Œæ˜¯é€šè¿‡ä¸€å®šçš„æ¦‚ç‡ç»Ÿè®¡æ–¹æ³•é¢„ä¼°åŸºæ•°å€¼ï¼ˆé›†åˆä¸­åŒ…å«å…ƒç´ çš„ä¸ªæ•°ï¼‰ã€‚å› æ­¤ï¼Œ HyperLogLog çš„è®¡æ•°ç»“æœå¹¶ä¸æ˜¯ä¸€ä¸ªç²¾ç¡®å€¼ï¼Œå­˜åœ¨ä¸€å®šçš„è¯¯å·®ï¼ˆæ ‡å‡†è¯¯å·®ä¸º `0.81%` ï¼‰ã€‚

![](images\image-20220720194154133 (2).png)

HyperLogLog çš„ä½¿ç”¨éå¸¸ç®€å•ï¼Œä½†åŸç†éå¸¸å¤æ‚ã€‚HyperLogLog çš„åŸç†ä»¥åŠåœ¨ Redis ä¸­çš„å®ç°å¯ä»¥çœ‹è¿™ç¯‡æ–‡ç« ï¼š[HyperLogLog ç®—æ³•çš„åŸç†è®²è§£ä»¥åŠ Redis æ˜¯å¦‚ä½•åº”ç”¨å®ƒçš„](https://juejin.cn/post/6844903785744056333) ã€‚

å†æ¨èä¸€ä¸ªå¯ä»¥å¸®åŠ©ç†è§£ HyperLogLog åŸç†çš„å·¥å…·ï¼š[Sketch of the Day: HyperLogLog â€” Cornerstone of a Big Data Infrastructure](http://content.research.neustar.biz/blog/hll.html) ã€‚

é™¤äº† HyperLogLog ä¹‹å¤–ï¼ŒRedis è¿˜æä¾›äº†å…¶ä»–çš„æ¦‚ç‡æ•°æ®ç»“æ„ï¼Œå¯¹åº”çš„å®˜æ–¹æ–‡æ¡£åœ°å€ï¼š[https://redis.io/docs/data-types/probabilistic/](https://redis.io/docs/data-types/probabilistic/) ã€‚

### å¸¸ç”¨å‘½ä»¤

HyperLogLog ç›¸å…³çš„å‘½ä»¤éå¸¸å°‘ï¼Œæœ€å¸¸ç”¨çš„ä¹Ÿå°± 3 ä¸ªã€‚

| å‘½ä»¤                                      | ä»‹ç»                                                         |
| ----------------------------------------- | ------------------------------------------------------------ |
| PFADD key element1 element2 ...           | æ·»åŠ ä¸€ä¸ªæˆ–å¤šä¸ªå…ƒç´ åˆ° HyperLogLog ä¸­                          |
| PFCOUNT key1 key2                         | è·å–ä¸€ä¸ªæˆ–è€…å¤šä¸ª HyperLogLog çš„å”¯ä¸€è®¡æ•°ã€‚                    |
| PFMERGE destkey sourcekey1 sourcekey2 ... | å°†å¤šä¸ª HyperLogLog åˆå¹¶åˆ° destkey ä¸­ï¼Œdestkey ä¼šç»“åˆå¤šä¸ªæºï¼Œç®—å‡ºå¯¹åº”çš„å”¯ä¸€è®¡æ•°ã€‚ |

**HyperLogLog åŸºæœ¬æ“ä½œæ¼”ç¤º**ï¼š

```bash
> PFADD hll foo bar zap
(integer) 1
> PFADD hll zap zap zap
(integer) 0
> PFADD hll foo bar
(integer) 0
> PFCOUNT hll
(integer) 3
> PFADD some-other-hll 1 2 3
(integer) 1
> PFCOUNT hll some-other-hll
(integer) 6
> PFMERGE desthll hll some-other-hll
"OK"
> PFCOUNT desthll
(integer) 6
```

### åº”ç”¨åœºæ™¯

**æ•°é‡é‡å·¨å¤§ï¼ˆç™¾ä¸‡ã€åƒä¸‡çº§åˆ«ä»¥ä¸Šï¼‰çš„è®¡æ•°åœºæ™¯**

- ä¸¾ä¾‹ï¼šçƒ­é—¨ç½‘ç«™æ¯æ—¥/æ¯å‘¨/æ¯æœˆè®¿é—® ip æ•°ç»Ÿè®¡ã€çƒ­é—¨å¸–å­ uv ç»Ÿè®¡ã€
- ç›¸å…³å‘½ä»¤ï¼š`PFADD`ã€`PFCOUNT` ã€‚

## Geospatial (åœ°ç†ä½ç½®)

### ä»‹ç»

`Geospatial index`ï¼ˆåœ°ç†ç©ºé—´ç´¢å¼•ï¼Œç®€ç§° GEOï¼‰ ä¸»è¦ç”¨äº**å­˜å‚¨åœ°ç†ä½ç½®ä¿¡æ¯ï¼ŒåŸºäº Sorted Set å®ç°**ã€‚

é€šè¿‡ GEO æˆ‘ä»¬å¯ä»¥è½»æ¾å®ç°ä¸¤ä¸ªä½ç½®è·ç¦»çš„è®¡ç®—ã€è·å–æŒ‡å®šä½ç½®é™„è¿‘çš„å…ƒç´ ç­‰åŠŸèƒ½ã€‚

![](images\image-20220720194359494.png)

### å¸¸ç”¨å‘½ä»¤

| å‘½ä»¤                                             | ä»‹ç»                                                         |
| ------------------------------------------------ | ------------------------------------------------------------ |
| GEOADD key longitude1 latitude1 member1 ...      | æ·»åŠ ä¸€ä¸ªæˆ–å¤šä¸ªå…ƒç´ å¯¹åº”çš„ç»çº¬åº¦ä¿¡æ¯åˆ° GEO ä¸­                  |
| GEOPOS key member1 member2 ...                   | è¿”å›ç»™å®šå…ƒç´ çš„ç»çº¬åº¦ä¿¡æ¯                                     |
| GEODIST key member1 member2 M/KM/FT/MI           | è¿”å›ä¸¤ä¸ªç»™å®šå…ƒç´ ä¹‹é—´çš„è·ç¦»                                   |
| GEORADIUS key longitude latitude radius distance | è·å–æŒ‡å®šä½ç½®é™„è¿‘ distance èŒƒå›´å†…çš„å…¶ä»–å…ƒç´ ï¼Œæ”¯æŒ ASC(ç”±è¿‘åˆ°è¿œ)ã€DESCï¼ˆç”±è¿œåˆ°è¿‘ï¼‰ã€Count(æ•°é‡) ç­‰å‚æ•° |
| GEORADIUSBYMEMBER key member radius distance     | ç±»ä¼¼äº GEORADIUS å‘½ä»¤ï¼Œåªæ˜¯å‚ç…§çš„ä¸­å¿ƒç‚¹æ˜¯ GEO ä¸­çš„å…ƒç´        |

**åŸºæœ¬æ“ä½œ**ï¼š

```bash
> GEOADD personLocation 116.33 39.89 user1 116.34 39.90 user2 116.35 39.88 user3
3
> GEOPOS personLocation user1
116.3299986720085144
39.89000061669732844
> GEODIST personLocation user1 user2 km
1.4018
```

é€šè¿‡ Redis å¯è§†åŒ–å·¥å…·æŸ¥çœ‹ `personLocation` ï¼Œæœä¸å…¶ç„¶ï¼Œåº•å±‚å°±æ˜¯ Sorted Setã€‚

**GEO ä¸­å­˜å‚¨çš„åœ°ç†ä½ç½®ä¿¡æ¯çš„ç»çº¬åº¦æ•°æ®é€šè¿‡ GeoHash ç®—æ³•è½¬æ¢æˆäº†ä¸€ä¸ªæ•´æ•°ï¼Œè¿™ä¸ªæ•´æ•°ä½œä¸º Sorted Set çš„ score(æƒé‡å‚æ•°)ä½¿ç”¨**ã€‚

![](images\image-20220721201545147.png)

**è·å–æŒ‡å®šä½ç½®èŒƒå›´å†…çš„å…¶ä»–å…ƒç´ **ï¼š

```bash
> GEORADIUS personLocation 116.33 39.87 3 km
user3
user1
> GEORADIUS personLocation 116.33 39.87 2 km
> GEORADIUS personLocation 116.33 39.87 5 km
user3
user1
user2
> GEORADIUSBYMEMBER personLocation user1 5 km
user3
user1
user2
> GEORADIUSBYMEMBER personLocation user1 2 km
user1
user2
```

`GEORADIUS` å‘½ä»¤çš„åº•å±‚åŸç†è§£æå¯ä»¥çœ‹çœ‹é˜¿é‡Œçš„è¿™ç¯‡æ–‡ç« ï¼š[Redis åˆ°åº•æ˜¯æ€ä¹ˆå®ç°â€œé™„è¿‘çš„äººâ€è¿™ä¸ªåŠŸèƒ½çš„å‘¢ï¼Ÿ](https://juejin.cn/post/6844903966061363207) ã€‚

**ç§»é™¤å…ƒç´ **ï¼š

GEO åº•å±‚æ˜¯ Sorted Set ï¼Œä½ å¯ä»¥å¯¹ GEO ä½¿ç”¨ Sorted Set ç›¸å…³çš„å‘½ä»¤ã€‚

```bash
> ZREM personLocation user1
1
> ZRANGE personLocation 0 -1
user3
user2
> ZSCORE personLocation user2
4069879562983946
```

### åº”ç”¨åœºæ™¯

**éœ€è¦ç®¡ç†ä½¿ç”¨åœ°ç†ç©ºé—´æ•°æ®çš„åœºæ™¯**

- ä¸¾ä¾‹ï¼šé™„è¿‘çš„äººã€‚
- ç›¸å…³å‘½ä»¤: `GEOADD`ã€`GEORADIUS`ã€`GEORADIUSBYMEMBER` ã€‚

## æ€»ç»“ âœ…

| æ•°æ®ç±»å‹         | è¯´æ˜                                                         |
| ---------------- | ------------------------------------------------------------ |
| Bitmap           | ä½ å¯ä»¥å°† Bitmap çœ‹ä½œæ˜¯ä¸€ä¸ªå­˜å‚¨äºŒè¿›åˆ¶æ•°å­—ï¼ˆ0 å’Œ 1ï¼‰çš„**æ•°ç»„**ï¼Œæ•°ç»„ä¸­æ¯ä¸ªå…ƒç´ çš„ä¸‹æ ‡å«åš **offsetï¼ˆåç§»é‡ï¼‰**ã€‚é€šè¿‡ Bitmap, åªéœ€è¦ä¸€ä¸ª bit ä½æ¥è¡¨ç¤ºæŸä¸ªå…ƒç´ å¯¹åº”çš„å€¼æˆ–è€…çŠ¶æ€ï¼Œkey å°±æ˜¯å¯¹åº”å…ƒç´ æœ¬èº« ã€‚æˆ‘ä»¬çŸ¥é“ 8 ä¸ª bit å¯ä»¥ç»„æˆä¸€ä¸ª byteï¼Œæ‰€ä»¥ Bitmap æœ¬èº«ä¼šæå¤§çš„èŠ‚çœå‚¨å­˜ç©ºé—´ã€‚ |
| HyperLogLog      | Redis æä¾›çš„ HyperLogLog å ç”¨ç©ºé—´éå¸¸éå¸¸å°ï¼Œåªéœ€è¦ 12k çš„ç©ºé—´å°±èƒ½å­˜å‚¨æ¥è¿‘`2^64`ä¸ªä¸åŒå…ƒç´ ã€‚ä¸è¿‡ï¼ŒHyperLogLog çš„è®¡æ•°ç»“æœå¹¶ä¸æ˜¯ä¸€ä¸ªç²¾ç¡®å€¼ï¼Œ**å­˜åœ¨ä¸€å®šçš„è¯¯å·®**ï¼ˆæ ‡å‡†è¯¯å·®ä¸º `0.81%` ï¼‰ã€‚ |
| Geospatial index | Geospatial indexï¼ˆåœ°ç†ç©ºé—´ç´¢å¼•ï¼Œç®€ç§° GEOï¼‰ ä¸»è¦ç”¨äº**å­˜å‚¨åœ°ç†ä½ç½®ä¿¡æ¯ï¼ŒåŸºäº Sorted Set å®ç°**ã€‚ |

## å‚è€ƒ

- Redis Data Structuresï¼š[https://redis.com/redis-enterprise/data-structures/](https://redis.com/redis-enterprise/data-structures/) ã€‚
- ã€ŠRedis æ·±åº¦å†é™©ï¼šæ ¸å¿ƒåŸç†ä¸åº”ç”¨å®è·µã€‹1.6 å››ä¸¤æ‹¨åƒæ–¤â€”â€”HyperLogLog
- å¸ƒéš†è¿‡æ»¤å™¨,ä½å›¾,HyperLogLogï¼šhttps://hogwartsrico.github.io/2020/06/08/BloomFilter-HyperLogLog-BitMap/index.html



# Redisä¸ºä»€ä¹ˆç”¨è·³è¡¨å®ç°æœ‰åºé›†åˆï¼ˆæ›´æ–°ä¸­ï¼‰

## å‰è¨€

è¿‘å‡ å¹´é’ˆå¯¹ Redis é¢è¯•æ—¶ä¼šæ¶‰åŠå¸¸è§æ•°æ®ç»“æ„çš„åº•å±‚è®¾è®¡ï¼Œå…¶ä¸­å°±æœ‰è¿™ä¹ˆä¸€é“æ¯”è¾ƒæœ‰æ„æ€çš„é¢è¯•é¢˜ï¼šâ€œRedis çš„æœ‰åºé›†åˆåº•å±‚ä¸ºä»€ä¹ˆè¦ç”¨è·³è¡¨ï¼Œè€Œä¸ç”¨å¹³è¡¡æ ‘ã€çº¢é»‘æ ‘æˆ–è€… B+æ ‘ï¼Ÿâ€ã€‚

æœ¬æ–‡å°±ä»¥è¿™é“å¤§å‚å¸¸é—®çš„é¢è¯•é¢˜ä¸ºåˆ‡å…¥ç‚¹ï¼Œå¸¦å¤§å®¶è¯¦ç»†äº†è§£ä¸€ä¸‹==**è·³è¡¨**==è¿™ä¸ªæ•°æ®ç»“æ„ã€‚

æœ¬æ–‡æ•´ä½“è„‰ç»œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œç¬”è€…ä¼šä»æœ‰åºé›†åˆçš„åŸºæœ¬ä½¿ç”¨åˆ°è·³è¡¨çš„æºç åˆ†æå’Œå®ç°ï¼Œè®©ä½ ä¼šå¯¹ Redis çš„æœ‰åºé›†åˆåº•å±‚å®ç°çš„è·³è¡¨æœ‰ç€æ›´æ·±åˆ»çš„ç†è§£å’ŒæŒæ¡ã€‚

![](images\202401222005468.png)

## è·³è¡¨åœ¨ Redis ä¸­çš„è¿ç”¨

è¿™é‡Œæˆ‘ä»¬éœ€è¦å…ˆäº†è§£ä¸€ä¸‹ Redis ç”¨åˆ°è·³è¡¨çš„æ•°æ®ç»“æ„æœ‰åºé›†åˆçš„ä½¿ç”¨ï¼ŒRedis æœ‰ä¸ªæ¯”è¾ƒå¸¸ç”¨çš„æ•°æ®ç»“æ„å«==**æœ‰åºé›†åˆ(sorted setï¼Œç®€ç§° zset)**==ï¼Œæ­£å¦‚å…¶åå®ƒæ˜¯ä¸€ä¸ªå¯ä»¥ä¿è¯æœ‰åºä¸”å…ƒç´ å”¯ä¸€çš„é›†åˆï¼Œæ‰€ä»¥å®ƒç»å¸¸ç”¨äºæ’è¡Œæ¦œç­‰éœ€è¦è¿›è¡Œç»Ÿè®¡æ’åˆ—çš„åœºæ™¯ã€‚

è¿™é‡Œæˆ‘ä»¬é€šè¿‡å‘½ä»¤è¡Œçš„å½¢å¼æ¼”ç¤ºä¸€ä¸‹æ’è¡Œæ¦œçš„å®ç°ï¼Œå¯ä»¥çœ‹åˆ°ç¬”è€…åˆ†åˆ«è¾“å…¥ 3 åç”¨æˆ·ï¼š**xiaoming**ã€**xiaohong**ã€**xiaowang**ï¼Œå®ƒä»¬çš„**score**åˆ†åˆ«æ˜¯ 60ã€80ã€60ï¼Œæœ€ç»ˆæŒ‰ç…§æˆç»©å‡çº§é™åºæ’åˆ—ã€‚

```bash
127.0.0.1:6379> zadd rankList 60 xiaoming
(integer) 1
127.0.0.1:6379> zadd rankList 80 xiaohong
(integer) 1
127.0.0.1:6379> zadd rankList 60 xiaowang
(integer) 1

# è¿”å›æœ‰åºé›†ä¸­æŒ‡å®šåŒºé—´å†…çš„æˆå‘˜ï¼Œé€šè¿‡ç´¢å¼•ï¼Œåˆ†æ•°ä»é«˜åˆ°ä½
127.0.0.1:6379> ZREVRANGE rankList 0 100 WITHSCORES
1) "xiaohong"
2) "80"
3) "xiaowang"
4) "60"
5) "xiaoming"
6) "60"
```

æ­¤æ—¶æˆ‘ä»¬é€šè¿‡ `object` æŒ‡ä»¤æŸ¥çœ‹ zset çš„æ•°æ®ç»“æ„ï¼Œå¯ä»¥çœ‹åˆ°å½“å‰æœ‰åºé›†åˆå­˜å‚¨çš„è¿˜æ˜¯æ˜¯**ziplist(å‹ç¼©åˆ—è¡¨)**ã€‚

```bash
127.0.0.1:6379> object encoding rankList
"ziplist"
```

å› ä¸ºè®¾è®¡è€…è€ƒè™‘åˆ° Redis æ•°æ®å­˜æ”¾äºå†…å­˜ï¼Œä¸ºäº†èŠ‚çº¦å®è´µçš„å†…å­˜ç©ºé—´åœ¨æœ‰åºé›†åˆåœ¨**å…ƒç´ å°äº 64 å­—èŠ‚ä¸”ä¸ªæ•°å°äº 128** çš„æ—¶å€™ï¼Œä¼šä½¿ç”¨ **ziplist**ï¼Œè€Œè¿™ä¸ªé˜ˆå€¼çš„é»˜è®¤å€¼çš„è®¾ç½®å°±æ¥è‡ªä¸‹é¢è¿™ä¸¤ä¸ªé…ç½®é¡¹ã€‚

```bash
zset-max-ziplist-value 64
zset-max-ziplist-entries 128
```

ä¸€æ—¦æœ‰åºé›†åˆä¸­çš„æŸä¸ªå…ƒç´ è¶…å‡ºè¿™ä¸¤ä¸ªå…¶ä¸­çš„ä¸€ä¸ªé˜ˆå€¼å®ƒå°±ä¼šè½¬ä¸º **skiplist**ï¼ˆå®é™…æ˜¯ dict+skiplistï¼Œè¿˜ä¼šå€Ÿç”¨å­—å…¸æ¥æé«˜è·å–æŒ‡å®šå…ƒç´ çš„æ•ˆç‡ï¼‰ã€‚

æˆ‘ä»¬ä¸å¦¨åœ¨æ·»åŠ ä¸€ä¸ªå¤§äº 64 å­—èŠ‚çš„å…ƒç´ ï¼Œå¯ä»¥çœ‹åˆ°æœ‰åºé›†åˆçš„åº•å±‚å­˜å‚¨è½¬ä¸º skiplistã€‚

```bash
127.0.0.1:6379> zadd rankList 90 yigemingzihuichaoguo64zijiedeyonghumingchengyongyuceshitiaobiaodeshijiyunyong
(integer) 1

# è¶…è¿‡é˜ˆå€¼ï¼Œè½¬ä¸ºè·³è¡¨
127.0.0.1:6379> object encoding rankList
"skiplist"
```

ä¹Ÿå°±æ˜¯è¯´ï¼ŒZSet æœ‰ä¸¤ç§ä¸åŒçš„å®ç°ï¼Œåˆ†åˆ«æ˜¯ ziplist å’Œ skiplistï¼Œå…·ä½“ä½¿ç”¨å“ªç§ç»“æ„è¿›è¡Œå­˜å‚¨çš„è§„åˆ™å¦‚ä¸‹ï¼š

- å½“æœ‰åºé›†åˆå¯¹è±¡åŒæ—¶æ»¡è¶³ä»¥ä¸‹ä¸¤ä¸ªæ¡ä»¶æ—¶ï¼Œä½¿ç”¨ ziplistï¼š 
  1. ZSet ä¿å­˜çš„é”®å€¼å¯¹æ•°é‡å°‘äº 128 ä¸ªï¼›
  2. æ¯ä¸ªå…ƒç´ çš„é•¿åº¦å°äº 64 å­—èŠ‚ã€‚
- å¦‚æœä¸æ»¡è¶³ä¸Šè¿°ä¸¤ä¸ªæ¡ä»¶ï¼Œé‚£ä¹ˆä½¿ç”¨ skiplist ã€‚

## æ‰‹å†™ä¸€ä¸ªè·³è¡¨

ä¸ºäº†æ›´å¥½çš„å›ç­”ä¸Šè¿°é—®é¢˜ä»¥åŠæ›´å¥½çš„ç†è§£å’ŒæŒæ¡è·³è¡¨ï¼Œè¿™é‡Œå¯ä»¥é€šè¿‡æ‰‹å†™ä¸€ä¸ªç®€å•çš„è·³è¡¨çš„å½¢å¼æ¥å¸®åŠ©è¯»è€…ç†è§£è·³è¡¨è¿™ä¸ªæ•°æ®ç»“æ„ã€‚

æˆ‘ä»¬éƒ½çŸ¥é“æœ‰åºé“¾è¡¨åœ¨æ·»åŠ ã€æŸ¥è¯¢ã€åˆ é™¤çš„å¹³å‡æ—¶é—´å¤æ‚éƒ½éƒ½æ˜¯**O(n)å³çº¿æ€§å¢é•¿ï¼Œæ‰€ä»¥ä¸€æ—¦èŠ‚ç‚¹æ•°é‡è¾¾åˆ°ä¸€å®šä½“é‡åå…¶æ€§èƒ½è¡¨ç°å°±ä¼šéå¸¸å·®åŠ²ã€‚è€Œè·³è¡¨æˆ‘ä»¬å®Œå…¨å¯ä»¥ç†è§£ä¸ºåœ¨åŸå§‹é“¾è¡¨åŸºç¡€ä¸Šï¼Œå»ºç«‹å¤šçº§ç´¢å¼•ï¼Œé€šè¿‡å¤šçº§ç´¢å¼•æ£€ç´¢å®šä½å°†å¢åˆ æ”¹æŸ¥çš„æ—¶é—´å¤æ‚åº¦å˜ä¸ºO(log n)**ã€‚

å¯èƒ½è¿™é‡Œè¯´çš„æœ‰äº›æŠ½è±¡ï¼Œæˆ‘ä»¬ä¸¾ä¸ªä¾‹å­ï¼Œä»¥ä¸‹å›¾è·³è¡¨ä¸ºä¾‹ï¼Œå…¶åŸå§‹é“¾è¡¨å­˜å‚¨æŒ‰åºå­˜å‚¨ 1-10ï¼Œæœ‰ 2 çº§ç´¢å¼•ï¼Œæ¯çº§ç´¢å¼•çš„ç´¢å¼•ä¸ªæ•°éƒ½æ˜¯åŸºäºä¸‹å±‚å…ƒç´ ä¸ªæ•°çš„ä¸€åŠã€‚

![](images\202401222005436.png)

å‡å¦‚æˆ‘ä»¬éœ€è¦æŸ¥è¯¢å…ƒç´  6ï¼Œå…¶å·¥ä½œæµç¨‹å¦‚ä¸‹ï¼š

1. ä» 2 çº§ç´¢å¼•å¼€å§‹ï¼Œå…ˆæ¥åˆ°èŠ‚ç‚¹ 4ã€‚
2. æŸ¥çœ‹ 4 çš„åç»§èŠ‚ç‚¹ï¼Œæ˜¯ 8 çš„ 2 çº§ç´¢å¼•ï¼Œè¿™ä¸ªå€¼å¤§äº 6ï¼Œè¯´æ˜ 2 çº§ç´¢å¼•åç»­çš„ç´¢å¼•éƒ½æ˜¯å¤§äº 6 çš„ï¼Œæ²¡æœ‰å†å¾€åæœå¯»çš„å¿…è¦ï¼Œæˆ‘ä»¬ç´¢å¼•å‘ä¸‹æŸ¥æ‰¾ã€‚
3. æ¥åˆ° 4 çš„ 1 çº§ç´¢å¼•ï¼Œæ¯”å¯¹å…¶åç»§èŠ‚ç‚¹ä¸º 6ï¼ŒæŸ¥æ‰¾ç»“æŸã€‚

ç›¸è¾ƒäºåŸå§‹æœ‰åºé“¾è¡¨éœ€è¦ 6 æ¬¡ï¼Œæˆ‘ä»¬çš„è·³è¡¨é€šè¿‡å»ºç«‹å¤šçº§ç´¢å¼•ï¼Œæˆ‘ä»¬åªéœ€ä¸¤æ¬¡å°±ç›´æ¥å®šä½åˆ°äº†ç›®æ ‡å…ƒç´ ï¼Œå…¶æŸ¥å¯»çš„å¤æ‚åº¦è¢«ç›´æ¥ä¼˜åŒ–ä¸º**O(log n)**ã€‚

![](images\202401222005524.png)

å¯¹åº”çš„æ·»åŠ ä¹Ÿæ˜¯ä¸€ä¸ªé“ç†ï¼Œå‡å¦‚æˆ‘ä»¬éœ€è¦åœ¨è¿™ä¸ªæœ‰åºé›†åˆä¸­æ·»åŠ ä¸€ä¸ªå…ƒç´  7ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±éœ€è¦é€šè¿‡è·³è¡¨æ‰¾åˆ°**å°äºå…ƒç´  7 çš„æœ€å¤§å€¼**ï¼Œä¹Ÿå°±æ˜¯ä¸‹å›¾å…ƒç´  6 çš„ä½ç½®ï¼Œå°†å…¶æ’å…¥åˆ°å…ƒç´  6 çš„åé¢ï¼Œè®©å…ƒç´  6 çš„ç´¢å¼•æŒ‡å‘æ–°æ’å…¥çš„èŠ‚ç‚¹ 7ï¼Œå…¶å·¥ä½œæµç¨‹å¦‚ä¸‹ï¼š

1. ä» 2 çº§ç´¢å¼•å¼€å§‹å®šä½åˆ°äº†å…ƒç´  4 çš„ç´¢å¼•ã€‚
2. æŸ¥çœ‹ç´¢å¼• 4 çš„åç»§ç´¢å¼•ä¸º 8ï¼Œç´¢å¼•å‘ä¸‹æ¨è¿›ã€‚
3. æ¥åˆ° 1 çº§ç´¢å¼•ï¼Œå‘ç°ç´¢å¼• 4 åç»§ç´¢å¼•ä¸º 6ï¼Œå°äºæ’å…¥å…ƒç´  7ï¼ŒæŒ‡é’ˆæ¨è¿›åˆ°ç´¢å¼• 6 ä½ç½®ã€‚
4. ç»§ç»­æ¯”è¾ƒ 6 çš„åç»§èŠ‚ç‚¹ä¸ºç´¢å¼• 8ï¼Œå¤§äºå…ƒç´  7ï¼Œç´¢å¼•ç»§ç»­å‘ä¸‹ã€‚
5. æœ€ç»ˆæˆ‘ä»¬æ¥åˆ° 6 çš„åŸå§‹èŠ‚ç‚¹ï¼Œå‘ç°å…¶åç»§èŠ‚ç‚¹ä¸º 7ï¼ŒæŒ‡é’ˆæ²¡æœ‰ç»§ç»­å‘ä¸‹çš„ç©ºé—´ï¼Œè‡ªæ­¤æˆ‘ä»¬å¯çŸ¥å…ƒç´  6 å°±æ˜¯å°äºæ’å…¥å…ƒç´  7 çš„æœ€å¤§å€¼ï¼Œäºæ˜¯ä¾¿å°†å…ƒç´  7 æ’å…¥ã€‚

![](images\202401222005480.png)

è¿™é‡Œæˆ‘ä»¬åˆé¢ä¸´ä¸€ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬æ˜¯å¦éœ€è¦ä¸ºå…ƒç´  7 å»ºç«‹ç´¢å¼•ï¼Œç´¢å¼•å¤šé«˜åˆé€‚ï¼Ÿ

æˆ‘ä»¬ä¸Šæ–‡æåˆ°ï¼Œç†æƒ³æƒ…å†µæ˜¯æ¯ä¸€å±‚ç´¢å¼•æ˜¯ä¸‹ä¸€å±‚å…ƒç´ ä¸ªæ•°çš„äºŒåˆ†ä¹‹ä¸€ï¼Œå‡è®¾æˆ‘ä»¬çš„æ€»å…±æœ‰ 16 ä¸ªå…ƒç´ ï¼Œå¯¹åº”å„çº§ç´¢å¼•å…ƒç´ ä¸ªæ•°åº”è¯¥æ˜¯ï¼š

```bash
1. ä¸€çº§ç´¢å¼•:16/2=8
2. äºŒçº§ç´¢å¼•:8/2 =4
3. ä¸‰çº§ç´¢å¼•:4/2=2
```

ç”±æ­¤æˆ‘ä»¬ç”¨æ•°å­¦å½’çº³æ³•å¯çŸ¥ï¼š

```bash
1. ä¸€çº§ç´¢å¼•:16/2=16/2^1=8
2. äºŒçº§ç´¢å¼•:8/2 => 16/2^2 =4
3. ä¸‰çº§ç´¢å¼•:4/2=>16/2^3=2
```

å‡è®¾å…ƒç´ ä¸ªæ•°ä¸º nï¼Œé‚£ä¹ˆå¯¹åº” k å±‚ç´¢å¼•çš„å…ƒç´ ä¸ªæ•° r è®¡ç®—å…¬å¼ä¸º:

```bash
r=n/2^k
```

åŒç†æˆ‘ä»¬å†æ¥æ¨æ–­ä»¥ä¸‹ç´¢å¼•çš„æœ€å¤§é«˜åº¦ï¼Œä¸€èˆ¬æ¥è¯´æœ€é«˜çº§ç´¢å¼•çš„å…ƒç´ ä¸ªæ•°ä¸º 2ï¼Œæˆ‘ä»¬è®¾å…ƒç´ æ€»ä¸ªæ•°ä¸º nï¼Œç´¢å¼•é«˜åº¦ä¸º hï¼Œä»£å…¥ä¸Šè¿°å…¬å¼å¯å¾—ï¼š

```bash
2= n/2^h
=> 2*2^h=n
=> 2^(h+1)=n
=> h+1=log2^n
=> h=log2^n -1
```

è€Œ Redis åˆæ˜¯å†…å­˜æ•°æ®åº“ï¼Œæˆ‘ä»¬å‡è®¾å…ƒç´ æœ€å¤§ä¸ªæ•°æ˜¯**65536**ï¼Œæˆ‘ä»¬æŠŠ**65536**ä»£å…¥ä¸Šè¿°å…¬å¼å¯çŸ¥æœ€å¤§é«˜åº¦ä¸º 16ã€‚æ‰€ä»¥æˆ‘ä»¬å»ºè®®æ·»åŠ ä¸€ä¸ªå…ƒç´ åä¸ºå…¶å»ºç«‹çš„ç´¢å¼•é«˜åº¦ä¸è¶…è¿‡ 16ã€‚

å› ä¸ºæˆ‘ä»¬è¦æ±‚å°½å¯èƒ½ä¿è¯æ¯ä¸€ä¸ªä¸Šçº§ç´¢å¼•éƒ½æ˜¯ä¸‹çº§ç´¢å¼•çš„ä¸€åŠï¼Œåœ¨å®ç°é«˜åº¦ç”Ÿæˆç®—æ³•æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥è¿™æ ·è®¾è®¡ï¼š

1. è·³è¡¨çš„é«˜åº¦è®¡ç®—ä»åŸå§‹é“¾è¡¨å¼€å§‹ï¼Œå³é»˜è®¤æƒ…å†µä¸‹æ’å…¥çš„å…ƒç´ çš„é«˜åº¦ä¸º 1ï¼Œä»£è¡¨æ²¡æœ‰ç´¢å¼•ï¼Œåªæœ‰å…ƒç´ èŠ‚ç‚¹ã€‚
2. è®¾è®¡ä¸€ä¸ªä¸ºæ’å…¥å…ƒç´ ç”ŸæˆèŠ‚ç‚¹ç´¢å¼•é«˜åº¦ level çš„æ–¹æ³•ã€‚
3. è¿›è¡Œä¸€æ¬¡éšæœºè¿ç®—ï¼Œéšæœºæ•°å€¼èŒƒå›´ä¸º 0-1 ä¹‹é—´ã€‚
4. å¦‚æœéšæœºæ•°å¤§äº 0.5 åˆ™ä¸ºå½“å‰å…ƒç´ æ·»åŠ ä¸€çº§ç´¢å¼•ï¼Œè‡ªæ­¤æˆ‘ä»¬ä¿è¯ç”Ÿæˆä¸€çº§ç´¢å¼•çš„æ¦‚ç‡ä¸º**50%**ï¼Œè¿™ä¹Ÿå°±ä¿è¯äº† 1 çº§ç´¢å¼•ç†æƒ³æƒ…å†µä¸‹åªæœ‰ä¸€åŠçš„å…ƒç´ ä¼šç”Ÿæˆç´¢å¼•ã€‚
5. åŒç†åç»­æ¯æ¬¡éšæœºç®—æ³•å¾—åˆ°çš„å€¼å¤§äº 0.5 æ—¶ï¼Œæˆ‘ä»¬çš„ç´¢å¼•é«˜åº¦å°±åŠ  1ï¼Œè¿™æ ·å°±å¯ä»¥ä¿è¯èŠ‚ç‚¹ç”Ÿæˆçš„ 2 çº§ç´¢å¼•æ¦‚ç‡ä¸º**25%**ï¼Œ3 çº§ç´¢å¼•ä¸º**12.5%**â€¦â€¦

æˆ‘ä»¬å›è¿‡å¤´ï¼Œä¸Šè¿°æ’å…¥ 7 ä¹‹åï¼Œæˆ‘ä»¬é€šè¿‡éšæœºç®—æ³•å¾—åˆ° 2ï¼Œå³è¦ä¸ºå…¶å»ºç«‹ 1 çº§ç´¢å¼•ï¼š

![](images\202401222005505.png)

æœ€åæˆ‘ä»¬å†æ¥è¯´è¯´åˆ é™¤ï¼Œå‡è®¾æˆ‘ä»¬è¿™é‡Œè¦åˆ é™¤å…ƒç´  10ï¼Œæˆ‘ä»¬å¿…é¡»å®šä½åˆ°å½“å‰è·³è¡¨**å„å±‚**å…ƒç´ å°äº 10 çš„æœ€å¤§å€¼ï¼Œç´¢å¼•æ‰§è¡Œæ­¥éª¤ä¸ºï¼š

1. 2 çº§ç´¢å¼• 4 çš„åç»§èŠ‚ç‚¹ä¸º 8ï¼ŒæŒ‡é’ˆæ¨è¿›ã€‚
2. ç´¢å¼• 8 æ— åç»§èŠ‚ç‚¹ï¼Œè¯¥å±‚æ— è¦åˆ é™¤çš„å…ƒç´ ï¼ŒæŒ‡é’ˆç›´æ¥å‘ä¸‹ã€‚
3. 1 çº§ç´¢å¼• 8 åç»§èŠ‚ç‚¹ä¸º 10ï¼Œè¯´æ˜ 1 çº§ç´¢å¼• 8 åœ¨è¿›è¡Œåˆ é™¤æ—¶éœ€è¦å°†è‡ªå·±çš„æŒ‡é’ˆå’Œ 1 çº§ç´¢å¼• 10 æ–­å¼€è”ç³»ï¼Œå°† 10 åˆ é™¤ã€‚
4. 1 çº§ç´¢å¼•å®Œæˆå®šä½åï¼ŒæŒ‡é’ˆå‘ä¸‹ï¼Œåç»§èŠ‚ç‚¹ä¸º 9ï¼ŒæŒ‡é’ˆæ¨è¿›ã€‚
5. 9 çš„åç»§èŠ‚ç‚¹ä¸º 10ï¼ŒåŒç†éœ€è¦è®©å…¶æŒ‡å‘ nullï¼Œå°† 10 åˆ é™¤ã€‚

![](images\202401222005503.png)

### æ¨¡æ¿å®šä¹‰

æœ‰äº†æ•´ä½“çš„æ€è·¯ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥å¼€å§‹å®ç°ä¸€ä¸ªè·³è¡¨äº†ï¼Œé¦–å…ˆå®šä¹‰ä¸€ä¸‹è·³è¡¨ä¸­çš„èŠ‚ç‚¹**Node**ï¼Œä»ä¸Šæ–‡çš„æ¼”ç¤ºä¸­å¯ä»¥çœ‹å‡ºæ¯ä¸€ä¸ª**Node**å®ƒéƒ½åŒ…å«ä»¥ä¸‹å‡ ä¸ªå…ƒç´ ï¼š

1. å­˜å‚¨çš„**value**å€¼ã€‚
2. åç»§èŠ‚ç‚¹çš„åœ°å€ã€‚
3. å¤šçº§ç´¢å¼•ã€‚

ä¸ºäº†æ›´æ–¹ä¾¿ç»Ÿä¸€ç®¡ç†**Node**åç»§èŠ‚ç‚¹åœ°å€å’Œå¤šçº§ç´¢å¼•æŒ‡å‘çš„å…ƒç´ åœ°å€ï¼Œç¬”è€…åœ¨**Node**ä¸­è®¾ç½®äº†ä¸€ä¸ª**forwards**æ•°ç»„ï¼Œç”¨äºè®°å½•åŸå§‹é“¾è¡¨èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹å’Œå¤šçº§ç´¢å¼•çš„åç»§èŠ‚ç‚¹æŒ‡å‘ã€‚

ä»¥ä¸‹å›¾ä¸ºä¾‹ï¼Œæˆ‘ä»¬**forwards**æ•°ç»„é•¿åº¦ä¸º 5ï¼Œå…¶ä¸­**ç´¢å¼• 0**è®°å½•çš„æ˜¯åŸå§‹é“¾è¡¨èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹åœ°å€ï¼Œè€Œå…¶ä½™è‡ªåº•å‘ä¸Šè¡¨ç¤ºä» 1 çº§ç´¢å¼•åˆ° 4 çº§ç´¢å¼•çš„åç»§èŠ‚ç‚¹æŒ‡å‘ã€‚

![](images\202401222005347.png)

äºæ˜¯æˆ‘ä»¬çš„å°±æœ‰äº†è¿™æ ·ä¸€ä¸ªä»£ç å®šä¹‰ï¼Œå¯ä»¥çœ‹å‡ºç¬”è€…å¯¹äºæ•°ç»„çš„é•¿åº¦è®¾ç½®ä¸ºå›ºå®šçš„ 16**(ä¸Šæ–‡çš„æ¨ç®—æœ€å¤§é«˜åº¦å»ºè®®æ˜¯ 16)**ï¼Œé»˜è®¤**data**ä¸º-1ï¼ŒèŠ‚ç‚¹æœ€å¤§é«˜åº¦**maxLevel**åˆå§‹åŒ–ä¸º 1ï¼Œæ³¨æ„è¿™ä¸ª**maxLevel**çš„å€¼ä»£è¡¨åŸå§‹é“¾è¡¨åŠ ä¸Šç´¢å¼•çš„æ€»é«˜åº¦ã€‚

```java
/**
 * è·³è¡¨ç´¢å¼•æœ€å¤§é«˜åº¦ä¸º16
 */
private static final int MAX_LEVEL = 16;

class Node {
    private int data = -1;
    private Node[] forwards = new Node[MAX_LEVEL];
    private int maxLevel = 1;

}
```

### å…ƒç´ æ·»åŠ 

å®šä¹‰å¥½èŠ‚ç‚¹ä¹‹åï¼Œæˆ‘ä»¬å…ˆå®ç°ä»¥ä¸‹å…ƒç´ çš„æ·»åŠ ï¼Œæ·»åŠ å…ƒç´ æ—¶é¦–å…ˆè‡ªç„¶æ˜¯è®¾ç½®**data**è¿™ä¸€æ­¥æˆ‘ä»¬ç›´æ¥æ ¹æ®å°†ä¼ å…¥çš„**value**è®¾ç½®åˆ°**data**ä¸Šå³å¯ã€‚

ç„¶åå°±æ˜¯é«˜åº¦**maxLevel**çš„è®¾ç½® ï¼Œæˆ‘ä»¬åœ¨ä¸Šæ–‡ä¹Ÿå·²ç»ç»™å‡ºäº†æ€è·¯ï¼Œé»˜è®¤é«˜åº¦ä¸º 1ï¼Œå³åªæœ‰ä¸€ä¸ªåŸå§‹é“¾è¡¨èŠ‚ç‚¹ï¼Œé€šè¿‡éšæœºç®—æ³•æ¯æ¬¡å¤§äº 0.5 ç´¢å¼•é«˜åº¦åŠ  1ï¼Œç”±æ­¤æˆ‘ä»¬å¾—å‡ºé«˜åº¦è®¡ç®—çš„ç®—æ³•`randomLevel()`ï¼š

```java
/**
 * ç†è®ºæ¥è®²ï¼Œä¸€çº§ç´¢å¼•ä¸­å…ƒç´ ä¸ªæ•°åº”è¯¥å åŸå§‹æ•°æ®çš„ 50%ï¼ŒäºŒçº§ç´¢å¼•ä¸­å…ƒç´ ä¸ªæ•°å  25%ï¼Œä¸‰çº§ç´¢å¼•12.5% ï¼Œä¸€ç›´åˆ°æœ€é¡¶å±‚ã€‚
 * å› ä¸ºè¿™é‡Œæ¯ä¸€å±‚çš„æ™‹å‡æ¦‚ç‡æ˜¯ 50%ã€‚å¯¹äºæ¯ä¸€ä¸ªæ–°æ’å…¥çš„èŠ‚ç‚¹ï¼Œéƒ½éœ€è¦è°ƒç”¨ randomLevel ç”Ÿæˆä¸€ä¸ªåˆç†çš„å±‚æ•°ã€‚
 * è¯¥ randomLevel æ–¹æ³•ä¼šéšæœºç”Ÿæˆ 1~MAX_LEVEL ä¹‹é—´çš„æ•°ï¼Œä¸” ï¼š
 * 50%çš„æ¦‚ç‡è¿”å› 1
 * 25%çš„æ¦‚ç‡è¿”å› 2
 *  12.5%çš„æ¦‚ç‡è¿”å› 3 ...
 * @return
 */
private int randomLevel() {
    int level = 1;
    while (Math.random() > PROB && level < MAX_LEVEL) {
        ++level;
    }
    return level;
}
```

ç„¶åå†è®¾ç½®å½“å‰è¦æ’å…¥çš„**Node**å’Œ**Node**ç´¢å¼•çš„åç»§èŠ‚ç‚¹åœ°å€ï¼Œè¿™ä¸€æ­¥ç¨å¾®å¤æ‚ä¸€ç‚¹ï¼Œæˆ‘ä»¬å‡è®¾å½“å‰èŠ‚ç‚¹çš„é«˜åº¦ä¸º 4ï¼Œå³ 1 ä¸ªèŠ‚ç‚¹åŠ  3 ä¸ªç´¢å¼•ï¼Œæ‰€ä»¥æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªé•¿åº¦ä¸º 4 çš„æ•°ç»„**maxOfMinArr** ï¼Œéå†å„çº§ç´¢å¼•èŠ‚ç‚¹ä¸­å°äºå½“å‰**value**çš„æœ€å¤§å€¼ã€‚

å‡è®¾æˆ‘ä»¬è¦æ’å…¥çš„**value**ä¸º 5ï¼Œæˆ‘ä»¬çš„æ•°ç»„æŸ¥æ‰¾ç»“æœå½“å‰èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹å’Œ 1 çº§ç´¢å¼•ã€2 çº§ç´¢å¼•çš„å‰é©±èŠ‚ç‚¹éƒ½ä¸º 4ï¼Œä¸‰çº§ç´¢å¼•ä¸ºç©ºã€‚

![](images\202401222005299.png)

ç„¶åæˆ‘ä»¬åŸºäºè¿™ä¸ªæ•°ç»„**maxOfMinArr** å®šä½åˆ°å„çº§çš„åç»§èŠ‚ç‚¹ï¼Œè®©æ’å…¥çš„å…ƒç´  5 æŒ‡å‘è¿™äº›åç»§èŠ‚ç‚¹ï¼Œè€Œ**maxOfMinArr**æŒ‡å‘ 5ï¼Œç»“æœå¦‚ä¸‹å›¾ï¼š

![](images\202401222005369.png)

è½¬åŒ–æˆä»£ç å°±æ˜¯ä¸‹é¢è¿™ä¸ªå½¢å¼ï¼Œæ˜¯ä¸æ˜¯å¾ˆç®€å•å‘¢ï¼Ÿæˆ‘ä»¬ç»§ç»­ï¼š

```java
/**
 * é»˜è®¤æƒ…å†µä¸‹çš„é«˜åº¦ä¸º1ï¼Œå³åªæœ‰è‡ªå·±ä¸€ä¸ªèŠ‚ç‚¹
 */
private int levelCount = 1;

/**
 * è·³è¡¨æœ€åº•å±‚çš„èŠ‚ç‚¹ï¼Œå³å¤´èŠ‚ç‚¹
 */
private Node h = new Node();

public void add(int value) {

    //éšæœºç”Ÿæˆé«˜åº¦
    int level = randomLevel();

    Node newNode = new Node();
    newNode.data = value;
    newNode.maxLevel = level;

    //åˆ›å»ºä¸€ä¸ªnodeæ•°ç»„ï¼Œç”¨äºè®°å½•å°äºå½“å‰valueçš„æœ€å¤§å€¼
    Node[] maxOfMinArr = new Node[level];
    //é»˜è®¤æƒ…å†µä¸‹æŒ‡å‘å¤´èŠ‚ç‚¹
    for (int i = 0; i < level; i++) {
        maxOfMinArr[i] = h;
    }

    //åŸºäºä¸Šè¿°ç»“æœæ‹¿åˆ°å½“å‰èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹
    Node p = h;
    for (int i = level - 1; i >= 0; i--) {
        while (p.forwards[i] != null && p.forwards[i].data < value) {
            p = p.forwards[i];
        }
        maxOfMinArr[i] = p;
    }

    //æ›´æ–°å‰é©±èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹ä¸ºå½“å‰èŠ‚ç‚¹newNode
    for (int i = 0; i < level; i++) {
        newNode.forwards[i] = maxOfMinArr[i].forwards[i];
        maxOfMinArr[i].forwards[i] = newNode;
    }

    //å¦‚æœå½“å‰newNodeé«˜åº¦å¤§äºè·³è¡¨æœ€é«˜é«˜åº¦åˆ™æ›´æ–°levelCount
    if (levelCount < level) {
        levelCount = level;
    }

}
```

### å…ƒç´ æŸ¥è¯¢

æŸ¥è¯¢é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œä»è·³è¡¨æœ€é«˜çº§çš„ç´¢å¼•å¼€å§‹å®šä½æ‰¾åˆ°**å°äº**è¦æŸ¥çš„ value çš„æœ€å¤§å€¼ï¼Œä»¥ä¸‹å›¾ä¸ºä¾‹ï¼Œæˆ‘ä»¬å¸Œæœ›æŸ¥æ‰¾åˆ°èŠ‚ç‚¹ 8ï¼š

1. è·³è¡¨çš„ 3 çº§ç´¢å¼•é¦–å…ˆæ‰¾æ‰¾åˆ° 5 çš„ç´¢å¼•ï¼Œ5 çš„ 3 çº§ç´¢å¼•**forwards[3]**æŒ‡å‘ç©ºï¼Œç´¢å¼•ç›´æ¥å‘ä¸‹ã€‚
2. æ¥åˆ° 5 çš„ 2 çº§ç´¢å¼•ï¼Œå…¶åç»§**forwards[2]**æŒ‡å‘ 8ï¼Œç»§ç»­å‘ä¸‹ã€‚
3. 5 çš„ 1 çº§ç´¢å¼•**forwards[1]**æŒ‡å‘ç´¢å¼• 6ï¼Œç»§ç»­å‘å‰ã€‚
4. ç´¢å¼• 6 çš„**forwards[1]**æŒ‡å‘ç´¢å¼• 8ï¼Œç»§ç»­å‘ä¸‹ã€‚
5. æˆ‘ä»¬åœ¨åŸå§‹èŠ‚ç‚¹å‘å‰æ‰¾åˆ°èŠ‚ç‚¹ 7ã€‚
6. èŠ‚ç‚¹ 7 åç»­å°±æ˜¯èŠ‚ç‚¹ 8ï¼Œç»§ç»­å‘å‰ä¸ºèŠ‚ç‚¹ 8ï¼Œæ— æ³•ç»§ç»­å‘ä¸‹ï¼Œç»“æŸæœå¯»ã€‚
7. åˆ¤æ–­ 7 çš„å‰é©±ï¼Œç­‰äº 8ï¼ŒæŸ¥æ‰¾ç»“æŸã€‚

![](images\202401222005323.png)



æ‰€ä»¥æˆ‘ä»¬çš„ä»£ç å®ç°ä¹Ÿå¾ˆä¸Šè¿°æ­¥éª¤å·®ä¸å¤šï¼Œä»æœ€é«˜çº§ç´¢å¼•å¼€å§‹å‘å‰æŸ¥æ‰¾ï¼Œå¦‚æœä¸ä¸ºç©ºä¸”å°äºè¦æŸ¥æ‰¾çš„å€¼ï¼Œåˆ™ç»§ç»­å‘å‰æœå¯»ï¼Œé‡åˆ°ä¸å°äºçš„èŠ‚ç‚¹åˆ™ç»§ç»­å‘ä¸‹ï¼Œå¦‚æ­¤å¾€å¤ï¼Œç›´åˆ°å¾—åˆ°å½“å‰è·³è¡¨ä¸­å°äºæŸ¥æ‰¾å€¼çš„æœ€å¤§èŠ‚ç‚¹ï¼ŒæŸ¥çœ‹å…¶å‰é©±æ˜¯å¦ç­‰äºè¦æŸ¥æ‰¾çš„å€¼ï¼š

```java
public Node get(int value) {
    Node p = h;
    //æ‰¾åˆ°å°äºvalueçš„æœ€å¤§å€¼
    for (int i = levelCount - 1; i >= 0; i--) {
        while (p.forwards[i] != null && p.forwards[i].data < value) {
            p = p.forwards[i];
        }
    }
    //å¦‚æœpçš„å‰é©±èŠ‚ç‚¹ç­‰äºvalueåˆ™ç›´æ¥è¿”å›
    if (p.forwards[0] != null && p.forwards[0].data == value) {
        return p.forwards[0];
    }

    return null;
}
```

### å…ƒç´ åˆ é™¤

æœ€åæ˜¯åˆ é™¤é€»è¾‘ï¼Œéœ€è¦æŸ¥æ‰¾å„å±‚çº§**å°äº**è¦åˆ é™¤èŠ‚ç‚¹çš„æœ€å¤§å€¼ï¼Œå‡è®¾æˆ‘ä»¬è¦åˆ é™¤ 10ï¼š

1. 3 çº§ç´¢å¼•å¾—åˆ°å°äº 10 çš„æœ€å¤§å€¼ä¸º 5ï¼Œç»§ç»­å‘ä¸‹ã€‚
2. 2 çº§ç´¢å¼•ä»ç´¢å¼• 5 å¼€å§‹æŸ¥æ‰¾ï¼Œå‘ç°å°äº 10 çš„æœ€å¤§å€¼ä¸º 8ï¼Œç»§ç»­å‘ä¸‹ã€‚
3. åŒç† 1 çº§ç´¢å¼•å¾—åˆ° 8ï¼Œç»§ç»­å‘ä¸‹ã€‚
4. åŸå§‹èŠ‚ç‚¹æ‰¾åˆ° 9ã€‚
5. ä»æœ€é«˜çº§ç´¢å¼•å¼€å§‹ï¼ŒæŸ¥çœ‹æ¯ä¸ªå°äº 10 çš„èŠ‚ç‚¹åç»§èŠ‚ç‚¹æ˜¯å¦ä¸º 10ï¼Œå¦‚æœç­‰äº 10ï¼Œåˆ™è®©è¿™ä¸ªèŠ‚ç‚¹æŒ‡å‘ 10 çš„åç»§èŠ‚ç‚¹ï¼Œå°†èŠ‚ç‚¹ 10 åŠå…¶ç´¢å¼•äº¤ç”± GC å›æ”¶ã€‚

![](images\202401222005350.png)

```java
/**
 * åˆ é™¤
 *
 * @param value
 */
public void delete(int value) {
    Node p = h;
    //æ‰¾åˆ°å„çº§èŠ‚ç‚¹å°äºvalueçš„æœ€å¤§å€¼
    Node[] updateArr = new Node[levelCount];
    for (int i = levelCount - 1; i >= 0; i--) {
        while (p.forwards[i] != null && p.forwards[i].data < value) {
            p = p.forwards[i];
        }
        updateArr[i] = p;
    }
    //æŸ¥çœ‹åŸå§‹å±‚èŠ‚ç‚¹å‰é©±æ˜¯å¦ç­‰äºvalueï¼Œè‹¥ç­‰äºåˆ™è¯´æ˜å­˜åœ¨è¦åˆ é™¤çš„å€¼
    if (p.forwards[0] != null && p.forwards[0].data == value) {
        //ä»æœ€é«˜çº§ç´¢å¼•å¼€å§‹æŸ¥çœ‹å…¶å‰é©±æ˜¯å¦ç­‰äºvalueï¼Œè‹¥ç­‰äºåˆ™å°†å½“å‰èŠ‚ç‚¹æŒ‡å‘valueèŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹
        for (int i = levelCount - 1; i >= 0; i--) {
            if (updateArr[i].forwards[i] != null && updateArr[i].forwards[i].data == value) {
                updateArr[i].forwards[i] = updateArr[i].forwards[i].forwards[i];
            }
        }
    }

    //ä»æœ€é«˜çº§å¼€å§‹æŸ¥çœ‹æ˜¯å¦æœ‰ä¸€çº§ç´¢å¼•ä¸ºç©ºï¼Œè‹¥ä¸ºç©ºåˆ™å±‚çº§å‡1
    while (levelCount > 1 && h.forwards[levelCount - 1] == null) {
        levelCount--;
    }

}
```

### å®Œæ•´ä»£ç ä»¥åŠæµ‹è¯•

å®Œæ•´ä»£ç å¦‚ä¸‹ï¼Œè¯»è€…å¯è‡ªè¡Œå‚é˜…:

```java
public class SkipList {

    /**
     * è·³è¡¨ç´¢å¼•æœ€å¤§é«˜åº¦ä¸º16
     */
    private static final int MAX_LEVEL = 16;

    /**
     * æ¯ä¸ªèŠ‚ç‚¹æ·»åŠ ä¸€å±‚ç´¢å¼•é«˜åº¦çš„æ¦‚ç‡ä¸ºäºŒåˆ†ä¹‹ä¸€
     */
    private static final float PROB = 0.5 f;

    /**
     * é»˜è®¤æƒ…å†µä¸‹çš„é«˜åº¦ä¸º1ï¼Œå³åªæœ‰è‡ªå·±ä¸€ä¸ªèŠ‚ç‚¹
     */
    private int levelCount = 1;

    /**
     * è·³è¡¨æœ€åº•å±‚çš„èŠ‚ç‚¹ï¼Œå³å¤´èŠ‚ç‚¹
     */
    private Node h = new Node();

    public SkipList() {}

    public class Node {
        private int data = -1;
        /**
         *
         */
        private Node[] forwards = new Node[MAX_LEVEL];
        private int maxLevel = 0;

        @Override
        public String toString() {
            return "Node{" +
                "data=" + data +
                ", maxLevel=" + maxLevel +
                '}';
        }
    }

    public void add(int value) {

        //éšæœºç”Ÿæˆé«˜åº¦
        int level = randomLevel();

        Node newNode = new Node();
        newNode.data = value;
        newNode.maxLevel = level;

        //åˆ›å»ºä¸€ä¸ªnodeæ•°ç»„ï¼Œç”¨äºè®°å½•å°äºå½“å‰valueçš„æœ€å¤§å€¼
        Node[] maxOfMinArr = new Node[level];
        //é»˜è®¤æƒ…å†µä¸‹æŒ‡å‘å¤´èŠ‚ç‚¹
        for (int i = 0; i < level; i++) {
            maxOfMinArr[i] = h;
        }

        //åŸºäºä¸Šè¿°ç»“æœæ‹¿åˆ°å½“å‰èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹
        Node p = h;
        for (int i = level - 1; i >= 0; i--) {
            while (p.forwards[i] != null && p.forwards[i].data < value) {
                p = p.forwards[i];
            }
            maxOfMinArr[i] = p;
        }

        //æ›´æ–°å‰é©±èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹ä¸ºå½“å‰èŠ‚ç‚¹newNode
        for (int i = 0; i < level; i++) {
            newNode.forwards[i] = maxOfMinArr[i].forwards[i];
            maxOfMinArr[i].forwards[i] = newNode;
        }

        //å¦‚æœå½“å‰newNodeé«˜åº¦å¤§äºè·³è¡¨æœ€é«˜é«˜åº¦åˆ™æ›´æ–°levelCount
        if (levelCount < level) {
            levelCount = level;
        }

    }

    /**
     * ç†è®ºæ¥è®²ï¼Œä¸€çº§ç´¢å¼•ä¸­å…ƒç´ ä¸ªæ•°åº”è¯¥å åŸå§‹æ•°æ®çš„ 50%ï¼ŒäºŒçº§ç´¢å¼•ä¸­å…ƒç´ ä¸ªæ•°å  25%ï¼Œä¸‰çº§ç´¢å¼•12.5% ï¼Œä¸€ç›´åˆ°æœ€é¡¶å±‚ã€‚
     * å› ä¸ºè¿™é‡Œæ¯ä¸€å±‚çš„æ™‹å‡æ¦‚ç‡æ˜¯ 50%ã€‚å¯¹äºæ¯ä¸€ä¸ªæ–°æ’å…¥çš„èŠ‚ç‚¹ï¼Œéƒ½éœ€è¦è°ƒç”¨ randomLevel ç”Ÿæˆä¸€ä¸ªåˆç†çš„å±‚æ•°ã€‚
     * è¯¥ randomLevel æ–¹æ³•ä¼šéšæœºç”Ÿæˆ 1~MAX_LEVEL ä¹‹é—´çš„æ•°ï¼Œä¸” ï¼š
     * 50%çš„æ¦‚ç‡è¿”å› 1
     * 25%çš„æ¦‚ç‡è¿”å› 2
     *  12.5%çš„æ¦‚ç‡è¿”å› 3 ...
     * @return
     */
    private int randomLevel() {
        int level = 1;
        while (Math.random() > PROB && level < MAX_LEVEL) {
            ++level;
        }
        return level;
    }

    public Node get(int value) {
        Node p = h;
        //æ‰¾åˆ°å°äºvalueçš„æœ€å¤§å€¼
        for (int i = levelCount - 1; i >= 0; i--) {
            while (p.forwards[i] != null && p.forwards[i].data < value) {
                p = p.forwards[i];
            }
        }
        //å¦‚æœpçš„å‰é©±èŠ‚ç‚¹ç­‰äºvalueåˆ™ç›´æ¥è¿”å›
        if (p.forwards[0] != null && p.forwards[0].data == value) {
            return p.forwards[0];
        }

        return null;
    }

    /**
     * åˆ é™¤
     *
     * @param value
     */
    public void delete(int value) {
        Node p = h;
        //æ‰¾åˆ°å„çº§èŠ‚ç‚¹å°äºvalueçš„æœ€å¤§å€¼
        Node[] updateArr = new Node[levelCount];
        for (int i = levelCount - 1; i >= 0; i--) {
            while (p.forwards[i] != null && p.forwards[i].data < value) {
                p = p.forwards[i];
            }
            updateArr[i] = p;
        }
        //æŸ¥çœ‹åŸå§‹å±‚èŠ‚ç‚¹å‰é©±æ˜¯å¦ç­‰äºvalueï¼Œè‹¥ç­‰äºåˆ™è¯´æ˜å­˜åœ¨è¦åˆ é™¤çš„å€¼
        if (p.forwards[0] != null && p.forwards[0].data == value) {
            //ä»æœ€é«˜çº§ç´¢å¼•å¼€å§‹æŸ¥çœ‹å…¶å‰é©±æ˜¯å¦ç­‰äºvalueï¼Œè‹¥ç­‰äºåˆ™å°†å½“å‰èŠ‚ç‚¹æŒ‡å‘valueèŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹
            for (int i = levelCount - 1; i >= 0; i--) {
                if (updateArr[i].forwards[i] != null && updateArr[i].forwards[i].data == value) {
                    updateArr[i].forwards[i] = updateArr[i].forwards[i].forwards[i];
                }
            }
        }

        //ä»æœ€é«˜çº§å¼€å§‹æŸ¥çœ‹æ˜¯å¦æœ‰ä¸€çº§ç´¢å¼•ä¸ºç©ºï¼Œè‹¥ä¸ºç©ºåˆ™å±‚çº§å‡1
        while (levelCount > 1 && h.forwards[levelCount - 1] == null) {
            levelCount--;
        }

    }

    public void printAll() {
        Node p = h;
        //åŸºäºæœ€åº•å±‚çš„éç´¢å¼•å±‚è¿›è¡Œéå†ï¼Œåªè¦åç»§èŠ‚ç‚¹ä¸ä¸ºç©ºï¼Œåˆ™é€Ÿé€Ÿå‡ºå½“å‰èŠ‚ç‚¹ï¼Œå¹¶ç§»åŠ¨åˆ°åç»§èŠ‚ç‚¹
        while (p.forwards[0] != null) {
            System.out.println(p.forwards[0]);
            p = p.forwards[0];
        }

    }

}
```

å¯¹åº”æµ‹è¯•ä»£ç å’Œè¾“å‡ºç»“æœå¦‚ä¸‹ï¼š

```java
public static void main(String[] args) {
        SkipList skipList = new SkipList();
        for (int i = 0; i < 24; i++) {
            skipList.add(i);
        }

        System.out.println("**********è¾“å‡ºæ·»åŠ ç»“æœ**********");
        skipList.printAll();

        SkipList.Node node = skipList.get(22);
        System.out.println("**********æŸ¥è¯¢ç»“æœ:" + node+" **********");

        skipList.delete(22);
        System.out.println("**********åˆ é™¤ç»“æœ**********");
        skipList.printAll();


    }
```

è¾“å‡ºç»“æœ:

```java
**********è¾“å‡ºæ·»åŠ ç»“æœ**********
Node{data=0, maxLevel=2}
Node{data=1, maxLevel=3}
Node{data=2, maxLevel=1}
Node{data=3, maxLevel=1}
Node{data=4, maxLevel=2}
Node{data=5, maxLevel=2}
Node{data=6, maxLevel=2}
Node{data=7, maxLevel=2}
Node{data=8, maxLevel=4}
Node{data=9, maxLevel=1}
Node{data=10, maxLevel=1}
Node{data=11, maxLevel=1}
Node{data=12, maxLevel=1}
Node{data=13, maxLevel=1}
Node{data=14, maxLevel=1}
Node{data=15, maxLevel=3}
Node{data=16, maxLevel=4}
Node{data=17, maxLevel=2}
Node{data=18, maxLevel=1}
Node{data=19, maxLevel=1}
Node{data=20, maxLevel=1}
Node{data=21, maxLevel=3}
Node{data=22, maxLevel=1}
Node{data=23, maxLevel=1}
**********æŸ¥è¯¢ç»“æœ:Node{data=22, maxLevel=1} **********
**********åˆ é™¤ç»“æœ**********
Node{data=0, maxLevel=2}
Node{data=1, maxLevel=3}
Node{data=2, maxLevel=1}
Node{data=3, maxLevel=1}
Node{data=4, maxLevel=2}
Node{data=5, maxLevel=2}
Node{data=6, maxLevel=2}
Node{data=7, maxLevel=2}
Node{data=8, maxLevel=4}
Node{data=9, maxLevel=1}
Node{data=10, maxLevel=1}
Node{data=11, maxLevel=1}
Node{data=12, maxLevel=1}
Node{data=13, maxLevel=1}
Node{data=14, maxLevel=1}
Node{data=15, maxLevel=3}
Node{data=16, maxLevel=4}
Node{data=17, maxLevel=2}
Node{data=18, maxLevel=1}
Node{data=19, maxLevel=1}
Node{data=20, maxLevel=1}
Node{data=21, maxLevel=3}
Node{data=23, maxLevel=1}
```

## å’Œå…¶ä½™ä¸‰ç§æ•°æ®ç»“æ„çš„æ¯”è¾ƒ âœ…

æœ€åï¼Œæˆ‘ä»¬å†æ¥å›ç­”ä¸€ä¸‹æ–‡ç« å¼€å¤´çš„é‚£é“é¢è¯•é¢˜: â€œRedis çš„æœ‰åºé›†åˆåº•å±‚ä¸ºä»€ä¹ˆè¦ç”¨è·³è¡¨ï¼Œè€Œä¸ç”¨å¹³è¡¡æ ‘ã€çº¢é»‘æ ‘æˆ–è€… B+æ ‘ï¼Ÿâ€ã€‚

### å¹³è¡¡æ ‘ vs è·³è¡¨

å…ˆæ¥è¯´è¯´å®ƒå’Œå¹³è¡¡æ ‘çš„æ¯”è¾ƒï¼Œå¹³è¡¡æ ‘æˆ‘ä»¬åˆä¼šç§°ä¹‹ä¸º **AVL æ ‘**ï¼Œæ˜¯ä¸€ä¸ªä¸¥æ ¼çš„å¹³è¡¡äºŒå‰æ ‘ï¼Œå¹³è¡¡æ¡ä»¶å¿…é¡»æ»¡è¶³ï¼ˆæ‰€æœ‰èŠ‚ç‚¹çš„å·¦å³å­æ ‘é«˜åº¦å·®ä¸è¶…è¿‡ 1ï¼Œå³å¹³è¡¡å› å­ä¸ºèŒƒå›´ä¸º `[-1,1]`ï¼‰ã€‚å¹³è¡¡æ ‘çš„æ’å…¥ã€åˆ é™¤å’ŒæŸ¥è¯¢çš„æ—¶é—´å¤æ‚åº¦å’Œè·³è¡¨ä¸€æ ·éƒ½æ˜¯ **O(log n)**ã€‚

å¯¹äºèŒƒå›´æŸ¥è¯¢æ¥è¯´ï¼Œå®ƒä¹Ÿå¯ä»¥é€šè¿‡ä¸­åºéå†çš„æ–¹å¼è¾¾åˆ°å’Œè·³è¡¨ä¸€æ ·çš„æ•ˆæœã€‚ä½†æ˜¯**å®ƒçš„æ¯ä¸€æ¬¡æ’å…¥æˆ–è€…åˆ é™¤æ“ä½œéƒ½éœ€è¦ä¿è¯æ•´é¢—æ ‘å·¦å³èŠ‚ç‚¹çš„ç»å¯¹å¹³è¡¡ï¼Œåªè¦ä¸å¹³è¡¡å°±è¦é€šè¿‡æ—‹è½¬æ“ä½œæ¥ä¿æŒå¹³è¡¡ï¼Œè¿™ä¸ªè¿‡ç¨‹æ˜¯æ¯”è¾ƒè€—æ—¶çš„**ã€‚

![](images\202401222005312.png)

è·³è¡¨è¯ç”Ÿçš„åˆè¡·å°±æ˜¯ä¸ºäº†å…‹æœå¹³è¡¡æ ‘çš„ä¸€äº›ç¼ºç‚¹ï¼Œè·³è¡¨çš„å‘æ˜è€…åœ¨è®ºæ–‡[ã€ŠSkip lists: a probabilistic alternative to balanced treesã€‹](https://15721.courses.cs.cmu.edu/spring2018/papers/08-oltpindexes1/pugh-skiplists-cacm1990.pdf)ä¸­æœ‰è¯¦ç»†æåˆ°ï¼š

![](images\skiplist-a-probabilistic-alternative-to-balanced-trees.png)

> Skip lists are a data structure that can be used in place of balanced trees. Skip lists use probabilistic balancing rather than strictly enforced balancing and as a result the algorithms for insertion and deletion in skip lists are much simpler and significantly faster than equivalent algorithms for balanced trees.
>
> è·³è¡¨æ˜¯ä¸€ç§å¯ä»¥ç”¨æ¥ä»£æ›¿å¹³è¡¡æ ‘çš„æ•°æ®ç»“æ„ã€‚è·³è¡¨ä½¿ç”¨æ¦‚ç‡å¹³è¡¡è€Œä¸æ˜¯ä¸¥æ ¼å¼ºåˆ¶çš„å¹³è¡¡ï¼Œå› æ­¤ï¼Œ**è·³è¡¨ä¸­çš„æ’å…¥å’Œåˆ é™¤ç®—æ³•æ¯”å¹³è¡¡æ ‘çš„ç­‰æ•ˆç®—æ³•ç®€å•å¾—å¤šï¼Œé€Ÿåº¦ä¹Ÿå¿«å¾—å¤š**ã€‚

ç¬”è€…è¿™é‡Œä¹Ÿè´´å‡ºäº† AVL æ ‘æ’å…¥æ“ä½œçš„æ ¸å¿ƒä»£ç ï¼Œå¯ä»¥çœ‹å‡ºæ¯ä¸€æ¬¡æ·»åŠ æ“ä½œéƒ½éœ€è¦è¿›è¡Œä¸€æ¬¡é€’å½’å®šä½æ’å…¥ä½ç½®ï¼Œç„¶åè¿˜éœ€è¦æ ¹æ®å›æº¯åˆ°æ ¹èŠ‚ç‚¹æ£€æŸ¥æ²¿é€”çš„å„å±‚èŠ‚ç‚¹æ˜¯å¦å¤±è¡¡ï¼Œå†é€šè¿‡æ—‹è½¬èŠ‚ç‚¹çš„æ–¹å¼è¿›è¡Œè°ƒæ•´ã€‚

```java
// å‘äºŒåˆ†æœç´¢æ ‘ä¸­æ·»åŠ æ–°çš„å…ƒç´ (key, value)
public void add(K key, V value) {
    root = add(root, key, value);
}

// å‘ä»¥nodeä¸ºæ ¹çš„äºŒåˆ†æœç´¢æ ‘ä¸­æ’å…¥å…ƒç´ (key, value)ï¼Œé€’å½’ç®—æ³•
// è¿”å›æ’å…¥æ–°èŠ‚ç‚¹åäºŒåˆ†æœç´¢æ ‘çš„æ ¹
private Node add(Node node, K key, V value) {

    if (node == null) {
        size++;
        return new Node(key, value);
    }

    if (key.compareTo(node.key) < 0)
        node.left = add(node.left, key, value);
    else if (key.compareTo(node.key) > 0)
        node.right = add(node.right, key, value);
    else // key.compareTo(node.key) == 0
        node.value = value;

    node.height = 1 + Math.max(getHeight(node.left), getHeight(node.right));

    int balanceFactor = getBalanceFactor(node);

    // LLå‹éœ€è¦å³æ—‹
    if (balanceFactor > 1 && getBalanceFactor(node.left) >= 0) {
        return rightRotate(node);
    }

    //RRå‹å¤±è¡¡éœ€è¦å·¦æ—‹
    if (balanceFactor < -1 && getBalanceFactor(node.right) <= 0) {
        return leftRotate(node);
    }

    //LRéœ€è¦å…ˆå·¦æ—‹æˆLLå‹ï¼Œç„¶åå†å³æ—‹
    if (balanceFactor > 1 && getBalanceFactor(node.left) < 0) {
        node.left = leftRotate(node.left);
        return rightRotate(node);
    }

    //RL
    if (balanceFactor < -1 && getBalanceFactor(node.right) > 0) {
        node.right = rightRotate(node.right);
        return leftRotate(node);
    }
    return node;
}
```

### çº¢é»‘æ ‘ vs è·³è¡¨

çº¢é»‘æ ‘ï¼ˆRed Black Treeï¼‰ä¹Ÿæ˜¯ä¸€ç§**è‡ªå¹³è¡¡äºŒå‰æŸ¥æ‰¾æ ‘**ï¼Œå®ƒçš„**æŸ¥è¯¢æ€§èƒ½ç•¥å¾®é€Šè‰²äº AVL æ ‘ï¼Œä½†æ’å…¥å’Œåˆ é™¤æ•ˆç‡æ›´é«˜**ã€‚çº¢é»‘æ ‘çš„æ’å…¥ã€åˆ é™¤å’ŒæŸ¥è¯¢çš„æ—¶é—´å¤æ‚åº¦å’Œè·³è¡¨ä¸€æ ·éƒ½æ˜¯ **O(log n)**ã€‚

çº¢é»‘æ ‘æ˜¯ä¸€ä¸ª**é»‘å¹³è¡¡æ ‘**ï¼Œå³ä»ä»»æ„èŠ‚ç‚¹åˆ°å¦å¤–ä¸€ä¸ªå¶å­èŠ‚ç‚¹ï¼Œå®ƒæ‰€ç»è¿‡çš„é»‘èŠ‚ç‚¹æ˜¯ä¸€æ ·çš„ã€‚å½“**å¯¹å®ƒè¿›è¡Œæ’å…¥æ“ä½œæ—¶ï¼Œéœ€è¦é€šè¿‡æ—‹è½¬å’ŒæŸ“è‰²ï¼ˆçº¢é»‘å˜æ¢ï¼‰æ¥ä¿è¯é»‘å¹³è¡¡**ã€‚ä¸è¿‡ï¼Œç›¸è¾ƒäº AVL æ ‘ä¸ºäº†ç»´æŒå¹³è¡¡çš„å¼€é”€è¦å°ä¸€äº›ã€‚å…³äºçº¢é»‘æ ‘çš„è¯¦ç»†ä»‹ç»ï¼Œå¯ä»¥æŸ¥çœ‹è¿™ç¯‡æ–‡ç« ï¼š[çº¢é»‘æ ‘](https://javaguide.cn/cs-basics/data-structure/red-black-tree.html)ã€‚

ç›¸æ¯”è¾ƒäºçº¢é»‘æ ‘æ¥è¯´ï¼Œ**è·³è¡¨çš„å®ç°ä¹Ÿæ›´ç®€å•ä¸€äº›**ã€‚å¹¶ä¸”ï¼Œ**æŒ‰ç…§åŒºé—´æ¥æŸ¥æ‰¾æ•°æ®è¿™ä¸ªæ“ä½œï¼Œçº¢é»‘æ ‘çš„æ•ˆç‡æ²¡æœ‰è·³è¡¨é«˜**ã€‚

![](images\202401222005709.png)

å¯¹åº”çº¢é»‘æ ‘æ·»åŠ çš„æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼Œè¯»è€…å¯è‡ªè¡Œå‚é˜…ç†è§£ï¼š

```java
private Node < K, V > add(Node < K, V > node, K key, V val) {

    if (node == null) {
        size++;
        return new Node(key, val);

    }

    if (key.compareTo(node.key) < 0) {
        node.left = add(node.left, key, val);
    } else if (key.compareTo(node.key) > 0) {
        node.right = add(node.right, key, val);
    } else {
        node.val = val;
    }

    //å·¦èŠ‚ç‚¹ä¸ä¸ºçº¢ï¼Œå³èŠ‚ç‚¹ä¸ºçº¢ï¼Œå·¦æ—‹
    if (isRed(node.right) && !isRed(node.left)) {
        node = leftRotate(node);
    }

    //å·¦é“¾å³æ—‹
    if (isRed(node.left) && isRed(node.left.left)) {
        node = rightRotate(node);
    }

    //é¢œè‰²ç¿»è½¬
    if (isRed(node.left) && isRed(node.right)) {
        flipColors(node);
    }

    return node;
}
```

### B+æ ‘ vs è·³è¡¨

æƒ³å¿…ä½¿ç”¨ MySQL çš„è¯»è€…éƒ½çŸ¥é“ ==B+æ ‘==è¿™ä¸ªæ•°æ®ç»“æ„ï¼ŒB+æ ‘æ˜¯ä¸€ç§å¸¸ç”¨çš„æ•°æ®ç»“æ„ï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š

1. **å¤šå‰æ ‘ç»“æ„**ï¼šå®ƒæ˜¯ä¸€æ£µå¤šå‰æ ‘ï¼Œæ¯ä¸ªèŠ‚ç‚¹å¯ä»¥åŒ…å«å¤šä¸ªå­èŠ‚ç‚¹ï¼Œå‡å°äº†æ ‘çš„é«˜åº¦ï¼ŒæŸ¥è¯¢æ•ˆç‡é«˜ã€‚
2. **å­˜å‚¨æ•ˆç‡é«˜**ï¼šå…¶ä¸­éå¶å­èŠ‚ç‚¹å­˜å‚¨å¤šä¸ª keyï¼Œå¶å­èŠ‚ç‚¹å­˜å‚¨ valueï¼Œä½¿å¾—æ¯ä¸ªèŠ‚ç‚¹èƒ½å¤Ÿå­˜å‚¨æ›´å¤šçš„é”®ï¼Œæ ¹æ®ç´¢å¼•è¿›è¡ŒèŒƒå›´æŸ¥è¯¢æ—¶æŸ¥è¯¢æ•ˆç‡æ›´é«˜ã€‚
3. **å¹³è¡¡æ€§**ï¼šå®ƒæ˜¯ç»å¯¹çš„å¹³è¡¡ï¼Œå³æ ‘çš„å„ä¸ªåˆ†æ”¯é«˜åº¦ç›¸å·®ä¸å¤§ï¼Œç¡®ä¿æŸ¥è¯¢å’Œæ’å…¥æ—¶é—´å¤æ‚åº¦ä¸º**O(log n)**ã€‚
4. **é¡ºåºè®¿é—®**ï¼šå¶å­èŠ‚ç‚¹é—´é€šè¿‡é“¾è¡¨æŒ‡é’ˆç›¸è¿ï¼ŒèŒƒå›´æŸ¥è¯¢è¡¨ç°å‡ºè‰²ã€‚
5. **æ•°æ®å‡åŒ€åˆ†å¸ƒ**ï¼šB+æ ‘æ’å…¥æ—¶å¯èƒ½ä¼šå¯¼è‡´æ•°æ®é‡æ–°åˆ†å¸ƒï¼Œä½¿å¾—æ•°æ®åœ¨æ•´æ£µæ ‘åˆ†å¸ƒæ›´åŠ å‡åŒ€ï¼Œä¿è¯èŒƒå›´æŸ¥è¯¢å’Œåˆ é™¤æ•ˆç‡ã€‚

![](images\202401222005649.png)

æ‰€ä»¥ï¼ŒB+æ ‘æ›´é€‚åˆä½œä¸ºæ•°æ®åº“å’Œæ–‡ä»¶ç³»ç»Ÿä¸­å¸¸ç”¨çš„ç´¢å¼•ç»“æ„ä¹‹ä¸€ï¼Œå®ƒçš„æ ¸å¿ƒæ€æƒ³æ˜¯**é€šè¿‡å°½å¯èƒ½å°‘çš„ IO å®šä½åˆ°å°½å¯èƒ½å¤šçš„ç´¢å¼•æ¥è·å¾—æŸ¥è¯¢æ•°æ®**ã€‚**å¯¹äº Redis è¿™ç§å†…å­˜æ•°æ®åº“æ¥è¯´ï¼Œå®ƒå¯¹è¿™äº›å¹¶ä¸æ„Ÿå†’ï¼Œå› ä¸º Redis ä½œä¸ºå†…å­˜æ•°æ®åº“å®ƒä¸å¯èƒ½å­˜å‚¨å¤§é‡çš„æ•°æ®ï¼Œæ‰€ä»¥å¯¹äºç´¢å¼•ä¸éœ€è¦é€šè¿‡ B+æ ‘è¿™ç§æ–¹å¼è¿›è¡Œç»´æŠ¤ï¼Œåªéœ€æŒ‰ç…§æ¦‚ç‡è¿›è¡Œéšæœºç»´æŠ¤å³å¯ï¼ŒèŠ‚çº¦å†…å­˜ã€‚è€Œä¸”ä½¿ç”¨è·³è¡¨å®ç° zset æ—¶ç›¸è¾ƒå‰è€…æ¥è¯´æ›´ç®€å•ä¸€äº›ï¼Œåœ¨è¿›è¡Œæ’å…¥æ—¶åªéœ€é€šè¿‡ç´¢å¼•å°†æ•°æ®æ’å…¥åˆ°é“¾è¡¨ä¸­åˆé€‚çš„ä½ç½®å†éšæœºç»´æŠ¤ä¸€å®šé«˜åº¦çš„ç´¢å¼•å³å¯ï¼Œä¹Ÿä¸éœ€è¦åƒ B+æ ‘é‚£æ ·æ’å…¥æ—¶å‘ç°å¤±è¡¡æ—¶è¿˜éœ€è¦å¯¹èŠ‚ç‚¹åˆ†è£‚ä¸åˆå¹¶**ã€‚

### Redis ä½œè€…ç»™å‡ºçš„ç†ç”±

å½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡ Redis çš„ä½œè€…è‡ªå·±ç»™å‡ºçš„ç†ç”±:

> There are a few reasons:
>  1ã€They are not very memory intensive. It's up to you basically. Changing parameters about the probability of a node to have a given number of levels will make then less memory intensive than btrees.
>  2ã€A sorted set is often target of many ZRANGE or ZREVRANGE operations, that is, traversing the skip list as a linked list. With this operation the cache locality of skip lists is at least as good as with other kind of balanced trees.
>
> 3ã€They are simpler to implement, debug, and so forth. For instance thanks to the skip list simplicity I received a patch (already in Redis master) with augmented skip lists implementing ZRANK in O(log(N)). It required little changes to the code.

ç¿»è¯‘è¿‡æ¥çš„æ„æ€å°±æ˜¯:

> æœ‰å‡ ä¸ªåŸå› ï¼š
>
> 1ã€å®ƒä»¬ä¸æ˜¯å¾ˆå ç”¨å†…å­˜ã€‚è¿™ä¸»è¦å–å†³äºä½ ã€‚æ”¹å˜èŠ‚ç‚¹æ‹¥æœ‰ç»™å®šå±‚æ•°çš„æ¦‚ç‡çš„å‚æ•°ï¼Œä¼šä½¿å®ƒä»¬æ¯” B æ ‘æ›´èŠ‚çœå†…å­˜ã€‚
>
> 2ã€æœ‰åºé›†åˆç»å¸¸æ˜¯è®¸å¤š ZRANGE æˆ– ZREVRANGE æ“ä½œçš„ç›®æ ‡ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä»¥é“¾è¡¨çš„æ–¹å¼éå†è·³è¡¨ã€‚é€šè¿‡è¿™ç§æ“ä½œï¼Œè·³è¡¨çš„ç¼“å­˜å±€éƒ¨æ€§è‡³å°‘å’Œå…¶ä»–ç±»å‹çš„å¹³è¡¡æ ‘ä¸€æ ·å¥½ã€‚
>
> 3ã€å®ƒä»¬æ›´å®¹æ˜“å®ç°ã€è°ƒè¯•ç­‰ç­‰ã€‚ä¾‹å¦‚ï¼Œç”±äºè·³è¡¨çš„ç®€å•æ€§ï¼Œæˆ‘æ”¶åˆ°äº†ä¸€ä¸ªè¡¥ä¸ï¼ˆå·²ç»åœ¨ Redis ä¸»åˆ†æ”¯ä¸­ï¼‰ï¼Œç”¨å¢å¼ºçš„è·³è¡¨å®ç°äº† O(log(N))çš„ ZRANKã€‚å®ƒåªéœ€è¦å¯¹ä»£ç åšå¾ˆå°‘çš„ä¿®æ”¹ã€‚

## å°ç»“

æœ¬æ–‡é€šè¿‡å¤§é‡ç¯‡å¹…ä»‹ç»è·³è¡¨çš„å·¥ä½œåŸç†å’Œå®ç°ï¼Œå¸®åŠ©è¯»è€…æ›´è¿›ä¸€æ­¥çš„ç†Ÿæ‚‰è·³è¡¨è¿™ä¸€æ•°æ®ç»“æ„çš„ä¼˜åŠ£ï¼Œæœ€åå†ç»“åˆå„ä¸ªæ•°æ®ç»“æ„æ“ä½œçš„ç‰¹ç‚¹è¿›è¡Œæ¯”å¯¹ï¼Œä»è€Œå¸®åŠ©è¯»è€…æ›´å¥½çš„ç†è§£è¿™é“é¢è¯•é¢˜ï¼Œå»ºè®®è¯»è€…å®ç°ç†è§£è·³è¡¨æ—¶ï¼Œå°½å¯èƒ½é…åˆæ‰§ç¬”æ¨¡æ‹Ÿæ¥äº†è§£è·³è¡¨çš„å¢åˆ æ”¹æŸ¥è¯¦ç»†è¿‡ç¨‹ã€‚

## å‚è€ƒ

- ä¸ºå•¥ redis ä½¿ç”¨è·³è¡¨(skiplist)è€Œä¸æ˜¯ä½¿ç”¨ red-blackï¼Ÿ:[https://www.zhihu.com/question/20202931/answer/16086538](https://www.zhihu.com/question/20202931/answer/16086538)
- Skip List--è·³è¡¨ï¼ˆå…¨ç½‘æœ€è¯¦ç»†çš„è·³è¡¨æ–‡ç« æ²¡æœ‰ä¹‹ä¸€ï¼‰:[https://www.jianshu.com/p/9d8296562806](https://www.jianshu.com/p/9d8296562806)
- Redis å¯¹è±¡ä¸åº•å±‚æ•°æ®ç»“æ„è¯¦è§£:[https://blog.csdn.net/shark_chili3007/article/details/104171986](https://blog.csdn.net/shark_chili3007/article/details/104171986)
- Redis æœ‰åºé›†åˆ(sorted set):[https://www.runoob.com/redis/redis-sorted-sets.html](https://www.runoob.com/redis/redis-sorted-sets.html)
- çº¢é»‘æ ‘å’Œè·³è¡¨æ¯”è¾ƒ:[https://zhuanlan.zhihu.com/p/576984787](https://zhuanlan.zhihu.com/p/576984787)
- ä¸ºä»€ä¹ˆ redis çš„ zset ç”¨è·³è·ƒè¡¨è€Œä¸ç”¨ b+ treeï¼Ÿ:https://blog.csdn.net/f80407515/article/details/129136998



# RedisæŒä¹…åŒ–æœºåˆ¶è¯¦è§£ï¼ˆæ›´æ–°ä¸­ï¼‰âœ…

ä½¿ç”¨ç¼“å­˜çš„æ—¶å€™ï¼Œæˆ‘ä»¬ç»å¸¸éœ€è¦**å¯¹å†…å­˜ä¸­çš„æ•°æ®è¿›è¡ŒæŒä¹…åŒ–ä¹Ÿå°±æ˜¯å°†å†…å­˜ä¸­çš„æ•°æ®å†™å…¥åˆ°ç¡¬ç›˜ä¸­**ã€‚å¤§éƒ¨åˆ†åŸå› æ˜¯ä¸ºäº†ä¹‹å**é‡ç”¨æ•°æ®**ï¼ˆæ¯”å¦‚é‡å¯æœºå™¨ã€æœºå™¨æ•…éšœä¹‹åæ¢å¤æ•°æ®ï¼‰ï¼Œæˆ–è€…æ˜¯ä¸ºäº†åš**æ•°æ®åŒæ­¥**ï¼ˆæ¯”å¦‚ Redis é›†ç¾¤çš„ä¸»ä»èŠ‚ç‚¹é€šè¿‡ RDB æ–‡ä»¶åŒæ­¥æ•°æ®ï¼‰ã€‚

Redis ä¸åŒäº Memcached çš„å¾ˆé‡è¦ä¸€ç‚¹å°±æ˜¯ï¼ŒRedis æ”¯æŒæŒä¹…åŒ–ï¼Œè€Œä¸”æ”¯æŒ 3 ç§æŒä¹…åŒ–æ–¹å¼ï¼š

- **å¿«ç…§**ï¼ˆsnapshottingï¼ŒRDBï¼‰
- **åªè¿½åŠ æ–‡ä»¶**ï¼ˆappend-only file, AOFï¼‰
- **RDB å’Œ AOF çš„æ··åˆæŒä¹…åŒ–**(Redis 4.0 æ–°å¢)

å®˜æ–¹æ–‡æ¡£åœ°å€ï¼š[https://redis.io/topics/persistence](https://redis.io/topics/persistence) ã€‚

![](images\redis4.0-persitence.png)

## RDB æŒä¹…åŒ– âœ…

### ä»€ä¹ˆæ˜¯ RDB æŒä¹…åŒ–ï¼Ÿ

Redis å¯ä»¥é€šè¿‡**åˆ›å»ºå¿«ç…§**æ¥è·å¾—å­˜å‚¨åœ¨å†…å­˜é‡Œé¢çš„æ•°æ®åœ¨ **æŸä¸ªæ—¶é—´ç‚¹** ä¸Šçš„ **å‰¯æœ¬**ã€‚Redis åˆ›å»ºå¿«ç…§ä¹‹åï¼Œå¯ä»¥å¯¹å¿«ç…§è¿›è¡Œå¤‡ä»½ï¼Œå¯ä»¥å°†å¿«ç…§å¤åˆ¶åˆ°å…¶ä»–æœåŠ¡å™¨ä»è€Œåˆ›å»ºå…·æœ‰ç›¸åŒæ•°æ®çš„æœåŠ¡å™¨å‰¯æœ¬ï¼ˆRedis ä¸»ä»ç»“æ„ï¼Œä¸»è¦ç”¨æ¥æé«˜ Redis æ€§èƒ½ï¼‰ï¼Œè¿˜å¯ä»¥å°†å¿«ç…§ç•™åœ¨åŸåœ°ä»¥ä¾¿é‡å¯æœåŠ¡å™¨çš„æ—¶å€™ä½¿ç”¨ã€‚

å¿«ç…§æŒä¹…åŒ–æ˜¯ Redis **é»˜è®¤**é‡‡ç”¨çš„æŒä¹…åŒ–æ–¹å¼ï¼Œåœ¨ `redis.conf` é…ç½®æ–‡ä»¶ä¸­é»˜è®¤æœ‰æ­¤ä¸‹é…ç½®ï¼š

```clojure
save 900 1           #åœ¨900ç§’(15åˆ†é’Ÿ)ä¹‹åï¼Œå¦‚æœè‡³å°‘æœ‰1ä¸ªkeyå‘ç”Ÿå˜åŒ–ï¼ŒRediså°±ä¼šè‡ªåŠ¨è§¦å‘bgsaveå‘½ä»¤åˆ›å»ºå¿«ç…§ã€‚

save 300 10          #åœ¨300ç§’(5åˆ†é’Ÿ)ä¹‹åï¼Œå¦‚æœè‡³å°‘æœ‰10ä¸ªkeyå‘ç”Ÿå˜åŒ–ï¼ŒRediså°±ä¼šè‡ªåŠ¨è§¦å‘bgsaveå‘½ä»¤åˆ›å»ºå¿«ç…§ã€‚

save 60 10000        #åœ¨60ç§’(1åˆ†é’Ÿ)ä¹‹åï¼Œå¦‚æœè‡³å°‘æœ‰10000ä¸ªkeyå‘ç”Ÿå˜åŒ–ï¼ŒRediså°±ä¼šè‡ªåŠ¨è§¦å‘bgsaveå‘½ä»¤åˆ›å»ºå¿«ç…§ã€‚
```

### RDB åˆ›å»ºå¿«ç…§æ—¶ä¼šé˜»å¡ä¸»çº¿ç¨‹å—ï¼Ÿ

Redis æä¾›äº†ä¸¤ä¸ªå‘½ä»¤æ¥ç”Ÿæˆ RDB å¿«ç…§æ–‡ä»¶ï¼š

- **`save`** : åŒæ­¥ä¿å­˜æ“ä½œï¼Œä¼š**é˜»å¡** Redis ä¸»çº¿ç¨‹ï¼›
- **`bgsave`** : fork å‡ºä¸€ä¸ªå­è¿›ç¨‹ï¼Œ**å­è¿›ç¨‹**æ‰§è¡Œï¼Œä¸ä¼šé˜»å¡ Redis ä¸»çº¿ç¨‹ï¼Œé»˜è®¤é€‰é¡¹ã€‚

> è¿™é‡Œè¯´ Redis ä¸»çº¿ç¨‹è€Œä¸æ˜¯ä¸»è¿›ç¨‹çš„ä¸»è¦æ˜¯å› ä¸º Redis å¯åŠ¨ä¹‹åä¸»è¦æ˜¯é€šè¿‡å•çº¿ç¨‹çš„æ–¹å¼å®Œæˆä¸»è¦çš„å·¥ä½œã€‚å¦‚æœä½ æƒ³å°†å…¶æè¿°ä¸º Redis ä¸»è¿›ç¨‹ï¼Œä¹Ÿæ²¡æ¯›ç—…ã€‚

## AOF æŒä¹…åŒ– âœ…

### ä»€ä¹ˆæ˜¯ AOF æŒä¹…åŒ–ï¼Ÿ

ä¸å¿«ç…§æŒä¹…åŒ–ç›¸æ¯”ï¼Œ**AOF æŒä¹…åŒ–çš„å®æ—¶æ€§æ›´å¥½**ã€‚é»˜è®¤æƒ…å†µä¸‹ Redis æ²¡æœ‰å¼€å¯ AOFï¼ˆappend only fileï¼‰æ–¹å¼çš„æŒä¹…åŒ–ï¼ˆRedis 6.0 ä¹‹åå·²ç»é»˜è®¤æ˜¯å¼€å¯äº†ï¼‰ï¼Œå¯ä»¥é€šè¿‡ `appendonly` å‚æ•°å¼€å¯ï¼š

```bash
appendonly yes
```

å¼€å¯ AOF æŒä¹…åŒ–åæ¯æ‰§è¡Œä¸€æ¡ä¼šæ›´æ”¹ Redis ä¸­çš„æ•°æ®çš„å‘½ä»¤ï¼ŒRedis å°±ä¼šå°†è¯¥å‘½ä»¤å†™å…¥åˆ° **AOF ç¼“å†²åŒº** `server.aof_buf` ä¸­ï¼Œç„¶åå†å†™å…¥åˆ° **AOF æ–‡ä»¶**ä¸­ï¼ˆå®é™…ä¸Šæ­¤æ—¶è¿˜åœ¨**ç³»ç»Ÿå†…æ ¸ç¼“å­˜åŒº**æœªåŒæ­¥åˆ°ç£ç›˜AOFæ–‡ä»¶ä¸­ï¼‰ï¼Œæœ€åå†æ ¹æ®æŒä¹…åŒ–æ–¹å¼ï¼ˆ **`fsync`ç­–ç•¥**ï¼‰çš„é…ç½®æ¥å†³å®šä½•æ—¶å°†ç³»ç»Ÿå†…æ ¸ç¼“å­˜åŒºçš„æ•°æ®**åŒæ­¥åˆ°ç¡¬ç›˜ï¼ˆAOF æ–‡ä»¶ï¼‰**ä¸­çš„ã€‚

åªæœ‰åŒæ­¥åˆ°ç£ç›˜ä¸­æ‰ç®—æŒä¹…åŒ–ä¿å­˜äº†ï¼Œå¦åˆ™ä¾ç„¶å­˜åœ¨æ•°æ®ä¸¢å¤±çš„é£é™©ï¼Œæ¯”å¦‚è¯´ï¼šç³»ç»Ÿå†…æ ¸ç¼“å­˜åŒºçš„æ•°æ®è¿˜æœªåŒæ­¥ï¼Œç£ç›˜æœºå™¨å°±å®•æœºäº†ï¼Œé‚£è¿™éƒ¨åˆ†æ•°æ®å°±ç®—ä¸¢å¤±äº†ã€‚

AOF æ–‡ä»¶çš„ä¿å­˜ä½ç½®å’Œ RDB æ–‡ä»¶çš„ä½ç½®ç›¸åŒï¼Œéƒ½æ˜¯é€šè¿‡ `dir` å‚æ•°è®¾ç½®çš„ï¼Œé»˜è®¤çš„æ–‡ä»¶åæ˜¯ `appendonly.aof`ã€‚

### AOF å·¥ä½œåŸºæœ¬æµç¨‹æ˜¯æ€æ ·çš„ï¼Ÿ

1. **å‘½ä»¤è¿½åŠ ï¼ˆappendï¼‰**ï¼šæ‰€æœ‰çš„**å†™å‘½ä»¤**ä¼šè¿½åŠ åˆ° **AOF ç¼“å†²åŒº**ä¸­ã€‚
2. **æ–‡ä»¶å†™å…¥ï¼ˆwriteï¼‰**ï¼šå°† AOF ç¼“å†²åŒºçš„æ•°æ®å†™å…¥åˆ° ~~AOF æ–‡ä»¶ä¸­~~(å®é™…ä¸Šæ˜¯**ç³»ç»Ÿå†…æ ¸ç¼“å†²åŒº**)ã€‚è¿™ä¸€æ­¥éœ€è¦è°ƒç”¨`write`å‡½æ•°ï¼ˆç³»ç»Ÿè°ƒç”¨ï¼‰ï¼Œ`write`å°†æ•°æ®å†™å…¥åˆ°äº†ç³»ç»Ÿå†…æ ¸ç¼“å†²åŒºä¹‹åç›´æ¥è¿”å›äº†ï¼ˆå»¶è¿Ÿå†™ï¼‰ã€‚**æ³¨æ„ï¼ï¼ï¼æ­¤æ—¶å¹¶æ²¡æœ‰åŒæ­¥åˆ°ç£ç›˜**ã€‚
3. **æ–‡ä»¶åŒæ­¥ï¼ˆfsyncï¼‰**ï¼šAOF ç¼“å†²åŒºæ ¹æ®å¯¹åº”çš„æŒä¹…åŒ–æ–¹å¼ï¼ˆ **`fsync` ç­–ç•¥**ï¼‰å‘ç¡¬ç›˜åšåŒæ­¥æ“ä½œã€‚è¿™ä¸€æ­¥éœ€è¦è°ƒç”¨ `fsync` å‡½æ•°ï¼ˆç³»ç»Ÿè°ƒç”¨ï¼‰ï¼Œ `fsync` é’ˆå¯¹å•ä¸ªæ–‡ä»¶æ“ä½œï¼Œå¯¹å…¶è¿›è¡Œå¼ºåˆ¶ç¡¬ç›˜åŒæ­¥ï¼Œ`fsync` å°†**é˜»å¡**ç›´åˆ°å†™å…¥ç£ç›˜å®Œæˆåè¿”å›ï¼Œä¿è¯äº†æ•°æ®æŒä¹…åŒ–ã€‚
4. **æ–‡ä»¶é‡å†™ï¼ˆrewriteï¼‰**ï¼šéšç€ AOF æ–‡ä»¶è¶Šæ¥è¶Šå¤§ï¼Œéœ€è¦å®šæœŸå¯¹ AOF æ–‡ä»¶è¿›è¡Œé‡å†™ï¼Œè¾¾åˆ°å‹ç¼©çš„ç›®çš„ã€‚é‡å†™aofæ–‡ä»¶çš„æ“ä½œï¼Œå¹¶æ²¡æœ‰è¯»å–æ—§çš„aofæ–‡ä»¶ï¼Œè€Œæ˜¯å°†æ•´ä¸ªå†…å­˜ä¸­çš„æ•°æ®åº“å†…å®¹ç”¨å‘½ä»¤çš„æ–¹å¼é‡å†™äº†ä¸€ä¸ª**æ–°çš„aofæ–‡ä»¶**ï¼Œè¿™ç‚¹å’Œå¿«ç…§æœ‰ç‚¹ç±»ä¼¼ã€‚
5. **é‡å¯åŠ è½½ï¼ˆloadï¼‰**ï¼šå½“ Redis é‡å¯æ—¶ï¼Œå¯ä»¥åŠ è½½ AOF æ–‡ä»¶è¿›è¡Œæ•°æ®æ¢å¤ã€‚

> Linux ç³»ç»Ÿç›´æ¥æä¾›äº†ä¸€äº›å‡½æ•°ç”¨äºå¯¹æ–‡ä»¶å’Œè®¾å¤‡è¿›è¡Œè®¿é—®å’Œæ§åˆ¶ï¼Œè¿™äº›å‡½æ•°è¢«ç§°ä¸º **ç³»ç»Ÿè°ƒç”¨ï¼ˆsyscallï¼‰**ã€‚

è¿™é‡Œå¯¹ä¸Šé¢æåˆ°çš„ä¸€äº› Linux ç³»ç»Ÿè°ƒç”¨å†åšä¸€éè§£é‡Šï¼š

- `write`ï¼š**å†™å…¥ç³»ç»Ÿå†…æ ¸ç¼“å†²åŒºä¹‹åç›´æ¥è¿”å›ï¼ˆä»…ä»…æ˜¯å†™åˆ°ç¼“å†²åŒºï¼‰ï¼Œä¸ä¼šç«‹å³åŒæ­¥åˆ°ç¡¬ç›˜**ã€‚è™½ç„¶æé«˜äº†æ•ˆç‡ï¼Œä½†ä¹Ÿå¸¦æ¥äº†æ•°æ®ä¸¢å¤±çš„é£é™©ã€‚åŒæ­¥ç¡¬ç›˜æ“ä½œé€šå¸¸ä¾èµ–äºç³»ç»Ÿè°ƒåº¦æœºåˆ¶ï¼ŒLinux å†…æ ¸é€šå¸¸ä¸º 30s åŒæ­¥ä¸€æ¬¡ï¼Œå…·ä½“å€¼å–å†³äºå†™å‡ºçš„æ•°æ®é‡å’Œ I/O ç¼“å†²åŒºçš„çŠ¶æ€ã€‚
- `fsync`ï¼š**`fsync`ç”¨äºå¼ºåˆ¶åˆ·æ–°ç³»ç»Ÿå†…æ ¸ç¼“å†²åŒºï¼ˆåŒæ­¥åˆ°åˆ°ç£ç›˜ï¼‰**ï¼Œç¡®ä¿å†™ç£ç›˜æ“ä½œç»“æŸæ‰ä¼šè¿”å›ã€‚

AOF å·¥ä½œæµç¨‹å›¾å¦‚ä¸‹ï¼š

![](images\aof-work-process.png)

### AOF æŒä¹…åŒ–æ–¹å¼æœ‰å“ªäº›ï¼Ÿ

åœ¨ Redis çš„é…ç½®æ–‡ä»¶ä¸­å­˜åœ¨ä¸‰ç§ä¸åŒçš„ AOF æŒä¹…åŒ–æ–¹å¼ï¼ˆ ==`fsync` ç­–ç•¥==ï¼‰ï¼Œå®ƒä»¬åˆ†åˆ«æ˜¯ï¼š

1. `appendfsync always`ï¼šä¸»çº¿ç¨‹è°ƒç”¨ `write` æ‰§è¡Œå†™æ“ä½œåï¼Œåå°çº¿ç¨‹ï¼ˆ `aof_fsync` çº¿ç¨‹ï¼‰**ç«‹å³**ä¼šè°ƒç”¨ `fsync` å‡½æ•°åŒæ­¥ AOF æ–‡ä»¶ï¼ˆåˆ·ç›˜ï¼‰ï¼Œ`fsync` å®Œæˆåçº¿ç¨‹è¿”å›ï¼Œè¿™æ ·ä¼šä¸¥é‡é™ä½ Redis çš„æ€§èƒ½ï¼ˆ`write` + `fsync`ï¼‰ã€‚
2. `appendfsync everysec`ï¼šä¸»çº¿ç¨‹è°ƒç”¨ `write` æ‰§è¡Œå†™æ“ä½œåç«‹å³è¿”å›ï¼Œç”±åå°çº¿ç¨‹ï¼ˆ `aof_fsync` çº¿ç¨‹ï¼‰**æ¯ç§’é’Ÿ**è°ƒç”¨ `fsync` å‡½æ•°ï¼ˆç³»ç»Ÿè°ƒç”¨ï¼‰åŒæ­¥ä¸€æ¬¡ AOF æ–‡ä»¶ï¼ˆ`write`+`fsync`ï¼Œ`fsync`é—´éš”ä¸º 1 ç§’ï¼‰
3. `appendfsync no`ï¼šä¸»çº¿ç¨‹è°ƒç”¨ `write` æ‰§è¡Œå†™æ“ä½œåç«‹å³è¿”å›ï¼Œè®©**æ“ä½œç³»ç»Ÿå†³å®š**ä½•æ—¶è¿›è¡ŒåŒæ­¥ï¼ŒLinux ä¸‹ä¸€èˆ¬ä¸º **30 ç§’**ä¸€æ¬¡ï¼ˆ`write`ä½†ä¸`fsync`ï¼Œ`fsync` çš„æ—¶æœºç”±æ“ä½œç³»ç»Ÿå†³å®šï¼‰ã€‚

å¯ä»¥çœ‹å‡ºï¼š**è¿™ 3 ç§æŒä¹…åŒ–æ–¹å¼çš„ä¸»è¦åŒºåˆ«åœ¨äº `fsync` åŒæ­¥ AOF æ–‡ä»¶çš„æ—¶æœºï¼ˆåˆ·ç›˜ï¼‰**ã€‚==å½“é€‰æ‹© `appendfsync everysec` å’Œ `appendfsync no` æ—¶ï¼ŒæŒä¹…åŒ–æ“ä½œä¸ä¼šç«‹å³å°†æ•°æ®å†™å…¥ç£ç›˜ä¸­ï¼Œä¼šå­˜åœ¨**æ•°æ®ä¸¢å¤±**çš„æƒ…å†µ ï¼Œä¹Ÿå°±æ— æ³•ä¿è¯ **æŒä¹…æ€§**==ã€‚

ä¸ºäº†å…¼é¡¾æ•°æ®å’Œå†™å…¥æ€§èƒ½ï¼Œå¯ä»¥è€ƒè™‘ `appendfsync everysec` é€‰é¡¹ ï¼Œè®© Redis æ¯ç§’åŒæ­¥ä¸€æ¬¡ AOF æ–‡ä»¶ï¼ŒRedis æ€§èƒ½å—åˆ°çš„å½±å“è¾ƒå°ã€‚è€Œä¸”è¿™æ ·å³ä½¿å‡ºç°ç³»ç»Ÿå´©æºƒï¼Œç”¨æˆ·æœ€å¤šåªä¼šä¸¢å¤±ä¸€ç§’ä¹‹å†…äº§ç”Ÿçš„æ•°æ®ã€‚å½“ç¡¬ç›˜å¿™äºæ‰§è¡Œå†™å…¥æ“ä½œçš„æ—¶å€™ï¼ŒRedis è¿˜ä¼šä¼˜é›…çš„æ”¾æ…¢è‡ªå·±çš„é€Ÿåº¦ä»¥ä¾¿é€‚åº”ç¡¬ç›˜çš„æœ€å¤§å†™å…¥é€Ÿåº¦ã€‚

ä» Redis 7.0.0 å¼€å§‹ï¼ŒRedis ä½¿ç”¨äº† ==**Multi Part AOF** æœºåˆ¶==ã€‚é¡¾åæ€ä¹‰ï¼ŒMulti Part AOF å°±æ˜¯**å°†åŸæ¥çš„å•ä¸ª AOF æ–‡ä»¶æ‹†åˆ†æˆå¤šä¸ª AOF æ–‡ä»¶**ã€‚åœ¨ Multi Part AOF ä¸­ï¼ŒAOF æ–‡ä»¶è¢«åˆ†ä¸ºä¸‰ç§ç±»å‹ï¼Œåˆ†åˆ«ä¸ºï¼š

- **BASE**ï¼šè¡¨ç¤ºåŸºç¡€ AOF æ–‡ä»¶ï¼Œå®ƒä¸€èˆ¬ç”±å­è¿›ç¨‹é€šè¿‡é‡å†™äº§ç”Ÿï¼Œè¯¥æ–‡ä»¶æœ€å¤šåªæœ‰ä¸€ä¸ªã€‚
- **INCR**ï¼šè¡¨ç¤ºå¢é‡ AOF æ–‡ä»¶ï¼Œå®ƒä¸€èˆ¬ä¼šåœ¨ AOFRW å¼€å§‹æ‰§è¡Œæ—¶è¢«åˆ›å»ºï¼Œè¯¥æ–‡ä»¶å¯èƒ½å­˜åœ¨å¤šä¸ªã€‚
- **HISTORY**ï¼šè¡¨ç¤ºå†å² AOF æ–‡ä»¶ï¼Œå®ƒç”± BASE å’Œ INCR AOF å˜åŒ–è€Œæ¥ï¼Œæ¯æ¬¡ AOFRW æˆåŠŸå®Œæˆæ—¶ï¼Œæœ¬æ¬¡ AOFRW ä¹‹å‰å¯¹åº”çš„ BASE å’Œ INCR AOF éƒ½å°†å˜ä¸º HISTORYï¼ŒHISTORY ç±»å‹çš„ AOF ä¼šè¢« Redis è‡ªåŠ¨åˆ é™¤ã€‚

Multi Part AOF ä¸æ˜¯é‡ç‚¹ï¼Œäº†è§£å³å¯ï¼Œè¯¦ç»†ä»‹ç»å¯ä»¥çœ‹çœ‹é˜¿é‡Œå¼€å‘è€…çš„[Redis 7.0 Multi Part AOF çš„è®¾è®¡å’Œå®ç°](https://zhuanlan.zhihu.com/p/467217082) è¿™ç¯‡æ–‡ç« ã€‚

**ç›¸å…³ issue**ï¼š[Redis çš„ AOF æ–¹å¼ #783](https://github.com/Snailclimb/JavaGuide/issues/783)ã€‚

### AOF ä¸ºä»€ä¹ˆæ˜¯åœ¨æ‰§è¡Œå®Œå‘½ä»¤ä¹‹åè®°å½•æ—¥å¿—ï¼Ÿ

**å…³ç³»å‹æ•°æ®åº“ï¼ˆå¦‚ MySQLï¼‰é€šå¸¸éƒ½æ˜¯æ‰§è¡Œå‘½ä»¤ä¹‹å‰è®°å½•æ—¥å¿—ï¼ˆæ–¹ä¾¿æ•…éšœæ¢å¤ï¼‰ï¼Œè€Œ Redis AOF æŒä¹…åŒ–æœºåˆ¶æ˜¯åœ¨æ‰§è¡Œå®Œå‘½ä»¤ä¹‹åå†è®°å½•æ—¥å¿—**ã€‚

![](images\redis-aof-write-log-disc.png)

**ä¸ºä»€ä¹ˆæ˜¯åœ¨æ‰§è¡Œå®Œå‘½ä»¤ä¹‹åè®°å½•æ—¥å¿—å‘¢ï¼Ÿ**

- é¿å…é¢å¤–çš„æ£€æŸ¥å¼€é”€ï¼ŒAOF è®°å½•æ—¥å¿—ä¸ä¼šå¯¹å‘½ä»¤è¿›è¡Œè¯­æ³•æ£€æŸ¥ï¼›
- åœ¨å‘½ä»¤æ‰§è¡Œå®Œä¹‹åå†è®°å½•ï¼Œä¸ä¼šé˜»å¡å½“å‰çš„å‘½ä»¤æ‰§è¡Œã€‚

è¿™æ ·ä¹Ÿå¸¦æ¥äº†é£é™©ï¼ˆæˆ‘åœ¨å‰é¢ä»‹ç» AOF æŒä¹…åŒ–çš„æ—¶å€™ä¹Ÿæåˆ°è¿‡ï¼‰ï¼š

- å¦‚æœåˆšæ‰§è¡Œå®Œå‘½ä»¤ Redis å°±å®•æœºä¼šå¯¼è‡´å¯¹åº”çš„ä¿®æ”¹ä¸¢å¤±ï¼›
- å¯èƒ½ä¼šé˜»å¡åç»­å…¶ä»–å‘½ä»¤çš„æ‰§è¡Œï¼ˆ**AOF è®°å½•æ—¥å¿—æ˜¯åœ¨ Redis ä¸»çº¿ç¨‹ä¸­è¿›è¡Œçš„**ï¼‰ã€‚

### AOF é‡å†™äº†è§£å—ï¼Ÿ

**å½“ AOF å˜å¾—å¤ªå¤§æ—¶ï¼ŒRedis èƒ½å¤Ÿåœ¨åå°è‡ªåŠ¨é‡å†™ AOF äº§ç”Ÿä¸€ä¸ªæ–°çš„ AOF æ–‡ä»¶ï¼Œè¿™ä¸ªæ–°çš„ AOF æ–‡ä»¶å’ŒåŸæœ‰çš„ AOF æ–‡ä»¶æ‰€ä¿å­˜çš„æ•°æ®åº“çŠ¶æ€ä¸€æ ·ï¼Œä½†ä½“ç§¯æ›´å°**ã€‚

![](images\aof-rewrite.png)

> AOF é‡å†™ï¼ˆrewriteï¼‰ æ˜¯ä¸€ä¸ªæœ‰æ­§ä¹‰çš„åå­—ï¼Œè¯¥åŠŸèƒ½æ˜¯**é€šè¿‡è¯»å–æ•°æ®åº“ä¸­çš„é”®å€¼å¯¹æ¥å®ç°çš„ï¼Œç¨‹åºæ— é¡»å¯¹ç°æœ‰ AOF æ–‡ä»¶è¿›è¡Œä»»ä½•è¯»å…¥ã€åˆ†ææˆ–è€…å†™å…¥æ“ä½œ**ã€‚

ç”±äº AOF é‡å†™ä¼šè¿›è¡Œå¤§é‡çš„å†™å…¥æ“ä½œï¼Œä¸ºäº†é¿å…å¯¹ Redis æ­£å¸¸å¤„ç†å‘½ä»¤è¯·æ±‚é€ æˆå½±å“ï¼ŒRedis å°† AOF é‡å†™ç¨‹åºæ”¾åˆ°**å­è¿›ç¨‹**é‡Œæ‰§è¡Œã€‚

AOF æ–‡ä»¶é‡å†™æœŸé—´ï¼ŒRedis è¿˜ä¼šç»´æŠ¤ä¸€ä¸ª **AOF é‡å†™ç¼“å†²åŒº**ï¼Œ<u>è¯¥ç¼“å†²åŒºä¼šåœ¨å­è¿›ç¨‹åˆ›å»ºæ–° AOF æ–‡ä»¶æœŸé—´ï¼Œè®°å½•æœåŠ¡å™¨æ‰§è¡Œçš„æ‰€æœ‰å†™å‘½ä»¤ã€‚å½“å­è¿›ç¨‹å®Œæˆåˆ›å»ºæ–° AOF æ–‡ä»¶çš„å·¥ä½œä¹‹åï¼ŒæœåŠ¡å™¨ä¼šå°†é‡å†™ç¼“å†²åŒºä¸­çš„æ‰€æœ‰å†…å®¹è¿½åŠ åˆ°æ–° AOF æ–‡ä»¶çš„æœ«å°¾ï¼Œä½¿å¾—æ–°çš„ AOF æ–‡ä»¶ä¿å­˜çš„æ•°æ®åº“çŠ¶æ€ä¸ç°æœ‰çš„æ•°æ®åº“çŠ¶æ€ä¸€è‡´</u>ã€‚æœ€åï¼ŒæœåŠ¡å™¨ç”¨æ–°çš„ AOF æ–‡ä»¶æ›¿æ¢æ—§çš„ AOF æ–‡ä»¶ï¼Œä»¥æ­¤æ¥å®Œæˆ AOF æ–‡ä»¶é‡å†™æ“ä½œã€‚

å¼€å¯ AOF é‡å†™åŠŸèƒ½ï¼Œå¯ä»¥è°ƒç”¨ `BGREWRITEAOF` å‘½ä»¤æ‰‹åŠ¨æ‰§è¡Œï¼Œä¹Ÿå¯ä»¥è®¾ç½®ä¸‹é¢ä¸¤ä¸ªé…ç½®é¡¹ï¼Œè®©ç¨‹åºè‡ªåŠ¨å†³å®šè§¦å‘æ—¶æœºï¼š

- `auto-aof-rewrite-min-size`ï¼šå¦‚æœ AOF æ–‡ä»¶å¤§å°å°äºè¯¥å€¼ï¼Œåˆ™ä¸ä¼šè§¦å‘ AOF é‡å†™ã€‚é»˜è®¤å€¼ä¸º 64 MB;
- `auto-aof-rewrite-percentage`ï¼šæ‰§è¡Œ AOF é‡å†™æ—¶ï¼Œå½“å‰ AOF å¤§å°ï¼ˆaof_current_sizeï¼‰å’Œä¸Šä¸€æ¬¡é‡å†™æ—¶ AOF å¤§å°ï¼ˆaof_base_sizeï¼‰çš„æ¯”å€¼ã€‚å¦‚æœå½“å‰ AOF æ–‡ä»¶å¤§å°å¢åŠ äº†è¿™ä¸ªç™¾åˆ†æ¯”å€¼ï¼Œå°†è§¦å‘ AOF é‡å†™ã€‚å°†æ­¤å€¼è®¾ç½®ä¸º 0 å°†ç¦ç”¨è‡ªåŠ¨ AOF é‡å†™ã€‚é»˜è®¤å€¼ä¸º 100ã€‚

Redis 7.0 ç‰ˆæœ¬ä¹‹å‰ï¼Œå¦‚æœåœ¨é‡å†™æœŸé—´æœ‰å†™å…¥å‘½ä»¤ï¼ŒAOF å¯èƒ½ä¼šä½¿ç”¨å¤§é‡å†…å­˜ï¼Œé‡å†™æœŸé—´åˆ°è¾¾çš„æ‰€æœ‰å†™å…¥å‘½ä»¤éƒ½ä¼šå†™å…¥ç£ç›˜ä¸¤æ¬¡ã€‚

Redis 7.0 ç‰ˆæœ¬ä¹‹åï¼ŒAOF é‡å†™æœºåˆ¶å¾—åˆ°äº†ä¼˜åŒ–æ”¹è¿›ã€‚ä¸‹é¢è¿™æ®µå†…å®¹æ‘˜è‡ªé˜¿é‡Œå¼€å‘è€…çš„[ä» Redis7.0 å‘å¸ƒçœ‹ Redis çš„è¿‡å»ä¸æœªæ¥](https://mp.weixin.qq.com/s/RnoPPL7jiFSKkx3G4p57Pg) è¿™ç¯‡æ–‡ç« ã€‚

> AOF é‡å†™æœŸé—´çš„å¢é‡æ•°æ®å¦‚ä½•å¤„ç†ä¸€ç›´æ˜¯ä¸ªé—®é¢˜ï¼Œåœ¨è¿‡å»å†™æœŸé—´çš„å¢é‡æ•°æ®éœ€è¦åœ¨å†…å­˜ä¸­ä¿ç•™ï¼Œå†™ç»“æŸåå†æŠŠè¿™éƒ¨åˆ†å¢é‡æ•°æ®å†™å…¥æ–°çš„ AOF æ–‡ä»¶ä¸­ä»¥ä¿è¯æ•°æ®å®Œæ•´æ€§ã€‚å¯ä»¥çœ‹å‡ºæ¥ AOF å†™ä¼šé¢å¤–æ¶ˆè€—å†…å­˜å’Œç£ç›˜ IOï¼Œè¿™ä¹Ÿæ˜¯ Redis AOF å†™çš„ç—›ç‚¹ï¼Œè™½ç„¶ä¹‹å‰ä¹Ÿè¿›è¡Œè¿‡å¤šæ¬¡æ”¹è¿›ä½†æ˜¯èµ„æºæ¶ˆè€—çš„æœ¬è´¨é—®é¢˜ä¸€ç›´æ²¡æœ‰è§£å†³ã€‚
>
> é˜¿é‡Œäº‘çš„ Redis ä¼ä¸šç‰ˆåœ¨æœ€åˆä¹Ÿé‡åˆ°äº†è¿™ä¸ªé—®é¢˜ï¼Œåœ¨å†…éƒ¨ç»è¿‡å¤šæ¬¡è¿­ä»£å¼€å‘ï¼Œå®ç°äº† Multi-part AOF æœºåˆ¶æ¥è§£å†³ï¼ŒåŒæ—¶ä¹Ÿè´¡çŒ®ç»™äº†ç¤¾åŒºå¹¶éšæ­¤æ¬¡ 7.0 å‘å¸ƒã€‚å…·ä½“æ–¹æ³•æ˜¯é‡‡ç”¨ baseï¼ˆå…¨é‡æ•°æ®ï¼‰+incï¼ˆå¢é‡æ•°æ®ï¼‰ç‹¬ç«‹æ–‡ä»¶å­˜å‚¨çš„æ–¹å¼ï¼Œå½»åº•è§£å†³å†…å­˜å’Œ IO èµ„æºçš„æµªè´¹ï¼ŒåŒæ—¶ä¹Ÿæ”¯æŒå¯¹å†å² AOF æ–‡ä»¶çš„ä¿å­˜ç®¡ç†ï¼Œç»“åˆ AOF æ–‡ä»¶ä¸­çš„æ—¶é—´ä¿¡æ¯è¿˜å¯ä»¥å®ç° PITR æŒ‰æ—¶é—´ç‚¹æ¢å¤ï¼ˆé˜¿é‡Œäº‘ä¼ä¸šç‰ˆ Tair å·²æ”¯æŒï¼‰ï¼Œè¿™è¿›ä¸€æ­¥å¢å¼ºäº† Redis çš„æ•°æ®å¯é æ€§ï¼Œæ»¡è¶³ç”¨æˆ·æ•°æ®å›æ¡£ç­‰éœ€æ±‚ã€‚

**ç›¸å…³ issue**ï¼š[Redis AOF é‡å†™æè¿°ä¸å‡†ç¡® #1439](https://github.com/Snailclimb/JavaGuide/issues/1439)ã€‚

### AOF æ ¡éªŒæœºåˆ¶äº†è§£å—ï¼Ÿ

==**AOF æ ¡éªŒæœºåˆ¶**==æ˜¯ **Redis åœ¨å¯åŠ¨æ—¶å¯¹ AOF æ–‡ä»¶è¿›è¡Œæ£€æŸ¥ï¼Œä»¥åˆ¤æ–­æ–‡ä»¶æ˜¯å¦å®Œæ•´ï¼Œæ˜¯å¦æœ‰æŸåæˆ–è€…ä¸¢å¤±çš„æ•°æ®**ã€‚è¿™ä¸ªæœºåˆ¶çš„åŸç†å…¶å®éå¸¸ç®€å•ï¼Œå°±æ˜¯é€šè¿‡ä½¿ç”¨ä¸€ç§å«åš **æ ¡éªŒå’Œï¼ˆchecksumï¼‰** çš„æ•°å­—æ¥éªŒè¯ AOF æ–‡ä»¶ã€‚è¿™ä¸ªæ ¡éªŒå’Œæ˜¯é€šè¿‡å¯¹æ•´ä¸ª AOF æ–‡ä»¶å†…å®¹è¿›è¡Œ **CRC64 ç®—æ³•** è®¡ç®—å¾—å‡ºçš„æ•°å­—ã€‚å¦‚æœæ–‡ä»¶å†…å®¹å‘ç”Ÿäº†å˜åŒ–ï¼Œé‚£ä¹ˆæ ¡éªŒå’Œä¹Ÿä¼šéšä¹‹æ”¹å˜ã€‚å› æ­¤ï¼ŒRedis åœ¨å¯åŠ¨æ—¶ä¼šæ¯”è¾ƒè®¡ç®—å‡ºçš„æ ¡éªŒå’Œä¸æ–‡ä»¶æœ«å°¾ä¿å­˜çš„æ ¡éªŒå’Œï¼ˆè®¡ç®—çš„æ—¶å€™ä¼šæŠŠæœ€åä¸€è¡Œä¿å­˜æ ¡éªŒå’Œçš„å†…å®¹ç»™å¿½ç•¥ç‚¹ï¼‰ï¼Œä»è€Œåˆ¤æ–­ AOF æ–‡ä»¶æ˜¯å¦å®Œæ•´ã€‚å¦‚æœå‘ç°æ–‡ä»¶æœ‰é—®é¢˜ï¼ŒRedis å°±ä¼šæ‹’ç»å¯åŠ¨å¹¶æä¾›ç›¸åº”çš„é”™è¯¯ä¿¡æ¯ã€‚AOF æ ¡éªŒæœºåˆ¶ååˆ†ç®€å•æœ‰æ•ˆï¼Œå¯ä»¥æé«˜ Redis æ•°æ®çš„å¯é æ€§ã€‚

ç±»ä¼¼åœ°ï¼Œ**RDB æ–‡ä»¶ä¹Ÿæœ‰ç±»ä¼¼çš„æ ¡éªŒæœºåˆ¶æ¥ä¿è¯ RDB æ–‡ä»¶çš„æ­£ç¡®æ€§**ï¼Œè¿™é‡Œå°±ä¸é‡å¤è¿›è¡Œä»‹ç»äº†ã€‚

## Redis 4.0 å¯¹äºæŒä¹…åŒ–æœºåˆ¶åšäº†ä»€ä¹ˆä¼˜åŒ–ï¼Ÿ

ç”±äº RDB å’Œ AOF å„æœ‰ä¼˜åŠ¿ï¼Œäºæ˜¯ï¼ŒRedis 4.0 å¼€å§‹æ”¯æŒ ==RDB å’Œ AOF çš„æ··åˆæŒä¹…åŒ–==ï¼ˆé»˜è®¤å…³é—­ï¼Œå¯ä»¥é€šè¿‡é…ç½®é¡¹ `aof-use-rdb-preamble` å¼€å¯ï¼‰ã€‚

**å¦‚æœæŠŠæ··åˆæŒä¹…åŒ–æ‰“å¼€ï¼ŒAOF é‡å†™çš„æ—¶å€™å°±ç›´æ¥æŠŠ RDB çš„å†…å®¹å†™åˆ° AOF æ–‡ä»¶å¼€å¤´**ã€‚è¿™æ ·åšçš„å¥½å¤„æ˜¯å¯ä»¥ç»“åˆ RDB å’Œ AOF çš„ä¼˜ç‚¹, å¿«é€ŸåŠ è½½åŒæ—¶é¿å…ä¸¢å¤±è¿‡å¤šçš„æ•°æ®ã€‚å½“ç„¶ç¼ºç‚¹ä¹Ÿæ˜¯æœ‰çš„ï¼Œ AOF é‡Œé¢çš„ RDB éƒ¨åˆ†æ˜¯å‹ç¼©æ ¼å¼ä¸å†æ˜¯ AOF æ ¼å¼ï¼Œå¯è¯»æ€§è¾ƒå·®ã€‚

å®˜æ–¹æ–‡æ¡£åœ°å€ï¼šhttps://redis.io/topics/persistence

![](images\redis4.0-persitence (1).png)

## å¦‚ä½•é€‰æ‹© RDB å’Œ AOFï¼Ÿ

å…³äº RDB å’Œ AOF çš„ä¼˜ç¼ºç‚¹ï¼Œå®˜ç½‘ä¸Šé¢ä¹Ÿç»™äº†æ¯”è¾ƒè¯¦ç»†çš„è¯´æ˜[Redis persistence](https://redis.io/docs/manual/persistence/)ï¼Œè¿™é‡Œç»“åˆè‡ªå·±çš„ç†è§£ç®€å•æ€»ç»“ä¸€ä¸‹ã€‚

**RDB æ¯” AOF ä¼˜ç§€çš„åœ°æ–¹**ï¼š

- RDB æ–‡ä»¶å­˜å‚¨çš„å†…å®¹æ˜¯ç»è¿‡**å‹ç¼©çš„äºŒè¿›åˆ¶æ•°æ®**ï¼Œ ä¿å­˜ç€**æŸä¸ªæ—¶é—´ç‚¹**çš„æ•°æ®é›†ï¼Œ**æ–‡ä»¶å¾ˆå°**ï¼Œé€‚åˆåšæ•°æ®çš„å¤‡ä»½ï¼Œç¾éš¾æ¢å¤ã€‚AOF æ–‡ä»¶å­˜å‚¨çš„æ˜¯æ¯ä¸€æ¬¡å†™å‘½ä»¤ï¼Œç±»ä¼¼äº MySQL çš„ binlog æ—¥å¿—ï¼Œé€šå¸¸<u>ä¼šæ¯” RDB æ–‡ä»¶å¤§å¾ˆå¤š</u>ã€‚å½“ AOF å˜å¾—å¤ªå¤§æ—¶ï¼ŒRedis èƒ½å¤Ÿåœ¨åå°è‡ªåŠ¨é‡å†™ AOFã€‚æ–°çš„ AOF æ–‡ä»¶å’ŒåŸæœ‰çš„ AOF æ–‡ä»¶æ‰€ä¿å­˜çš„æ•°æ®åº“çŠ¶æ€ä¸€æ ·ï¼Œä½†ä½“ç§¯æ›´å°ã€‚ä¸è¿‡ï¼Œ Redis 7.0 ç‰ˆæœ¬ä¹‹å‰ï¼Œå¦‚æœåœ¨é‡å†™æœŸé—´æœ‰å†™å…¥å‘½ä»¤ï¼ŒAOF å¯èƒ½ä¼šä½¿ç”¨å¤§é‡å†…å­˜ï¼Œé‡å†™æœŸé—´åˆ°è¾¾çš„æ‰€æœ‰å†™å…¥å‘½ä»¤éƒ½ä¼šå†™å…¥ç£ç›˜ä¸¤æ¬¡ã€‚
- ä½¿ç”¨ RDB æ–‡ä»¶æ¢å¤æ•°æ®ï¼Œç›´æ¥è§£æè¿˜åŸæ•°æ®å³å¯ï¼Œä¸éœ€è¦ä¸€æ¡ä¸€æ¡åœ°æ‰§è¡Œå‘½ä»¤ï¼Œé€Ÿåº¦éå¸¸å¿«ã€‚è€Œ AOF åˆ™éœ€è¦ä¾æ¬¡æ‰§è¡Œæ¯ä¸ªå†™å‘½ä»¤ï¼Œé€Ÿåº¦éå¸¸æ…¢ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œ**ä¸ AOF ç›¸æ¯”ï¼Œæ¢å¤å¤§æ•°æ®é›†çš„æ—¶å€™ï¼ŒRDB é€Ÿåº¦æ›´å¿«**ã€‚

**AOF æ¯” RDB ä¼˜ç§€çš„åœ°æ–¹**ï¼š

- RDB çš„æ•°æ®å®‰å…¨æ€§ä¸å¦‚ AOFï¼Œæ²¡æœ‰åŠæ³•å®æ—¶æˆ–è€…ç§’çº§æŒä¹…åŒ–æ•°æ®å³ **AOFå®æ—¶æ€§æ›´å¥½**ã€‚ç”Ÿæˆ RDB æ–‡ä»¶çš„è¿‡ç¨‹æ˜¯æ¯”è¾ƒç¹é‡çš„ï¼Œ è™½ç„¶ BGSAVE å­è¿›ç¨‹å†™å…¥ RDB æ–‡ä»¶çš„å·¥ä½œä¸ä¼šé˜»å¡ä¸»çº¿ç¨‹ï¼Œä½†ä¼šå¯¹æœºå™¨çš„ CPU èµ„æºå’Œå†…å­˜èµ„æºäº§ç”Ÿå½±å“ï¼Œä¸¥é‡çš„æƒ…å†µä¸‹ç”šè‡³ä¼šç›´æ¥æŠŠ Redis æœåŠ¡å¹²å®•æœºã€‚**AOF æ”¯æŒç§’çº§æ•°æ®ä¸¢å¤±**ï¼ˆå–å†³ fsync ç­–ç•¥ï¼Œå¦‚æœæ˜¯ everysecï¼Œæœ€å¤šä¸¢å¤± 1 ç§’çš„æ•°æ®ï¼‰ï¼Œä»…ä»…æ˜¯è¿½åŠ å‘½ä»¤åˆ° AOF æ–‡ä»¶ï¼Œ**æ“ä½œè½»é‡**ã€‚
- RDB æ–‡ä»¶æ˜¯ä»¥ç‰¹å®šçš„äºŒè¿›åˆ¶æ ¼å¼ä¿å­˜çš„ï¼Œå¹¶ä¸”åœ¨ Redis ç‰ˆæœ¬æ¼”è¿›ä¸­æœ‰å¤šä¸ªç‰ˆæœ¬çš„ RDBï¼Œæ‰€ä»¥å­˜åœ¨è€ç‰ˆæœ¬çš„ Redis æœåŠ¡ä¸å…¼å®¹æ–°ç‰ˆæœ¬çš„ RDB æ ¼å¼çš„é—®é¢˜ã€‚
- AOF ä»¥ä¸€ç§**æ˜“äºç†è§£å’Œè§£æçš„æ ¼å¼**åŒ…å«æ‰€æœ‰æ“ä½œçš„æ—¥å¿—ã€‚ä½ å¯ä»¥è½»æ¾åœ°å¯¼å‡º AOF æ–‡ä»¶è¿›è¡Œåˆ†æï¼Œä½ ä¹Ÿå¯ä»¥ç›´æ¥æ“ä½œ AOF æ–‡ä»¶æ¥è§£å†³ä¸€äº›é—®é¢˜ã€‚æ¯”å¦‚ï¼Œå¦‚æœæ‰§è¡Œ`FLUSHALL`å‘½ä»¤æ„å¤–åœ°åˆ·æ–°äº†æ‰€æœ‰å†…å®¹åï¼Œåªè¦ AOF æ–‡ä»¶æ²¡æœ‰è¢«é‡å†™ï¼Œåˆ é™¤æœ€æ–°å‘½ä»¤å¹¶é‡å¯å³å¯æ¢å¤ä¹‹å‰çš„çŠ¶æ€ã€‚

**ç»¼ä¸Š**ï¼š

- Redis ä¿å­˜çš„æ•°æ®ä¸¢å¤±ä¸€äº›ä¹Ÿæ²¡ä»€ä¹ˆå½±å“çš„è¯ï¼Œå¯ä»¥é€‰æ‹©ä½¿ç”¨ RDBã€‚
- ä¸å»ºè®®å•ç‹¬ä½¿ç”¨ AOFï¼Œå› ä¸ºæ—¶ä¸æ—¶åœ°åˆ›å»ºä¸€ä¸ª RDB å¿«ç…§å¯ä»¥è¿›è¡Œæ•°æ®åº“å¤‡ä»½ã€æ›´å¿«çš„é‡å¯ä»¥åŠè§£å†³ AOF å¼•æ“é”™è¯¯ã€‚
- å¦‚æœä¿å­˜çš„æ•°æ®è¦æ±‚å®‰å…¨æ€§æ¯”è¾ƒé«˜çš„è¯ï¼Œå»ºè®®åŒæ—¶å¼€å¯ RDB å’Œ AOF æŒä¹…åŒ–æˆ–è€…å¼€å¯ RDB å’Œ AOF æ··åˆæŒä¹…åŒ–ã€‚

## å‚è€ƒ

- ã€ŠRedis è®¾è®¡ä¸å®ç°ã€‹
- Redis persistence - Redis å®˜æ–¹æ–‡æ¡£ï¼š[https://redis.io/docs/management/persistence/](https://redis.io/docs/management/persistence/)
- The difference between AOF and RDB persistenceï¼š[https://www.sobyte.net/post/2022-04/redis-rdb-and-aof/](https://www.sobyte.net/post/2022-04/redis-rdb-and-aof/)
- Redis AOF æŒä¹…åŒ–è¯¦è§£ - ç¨‹åºå‘˜å†å°å†°ï¼š[http://remcarpediem.net/article/376c55d8/](http://remcarpediem.net/article/376c55d8/)
- Redis RDB ä¸ AOF æŒä¹…åŒ– Â· Analyzeï¼š[https://wingsxdu.com/posts/database/redis/rdb-and-aof/](https://wingsxdu.com/posts/database/redis/rdb-and-aof/)



# Rediså†…å­˜ç¢ç‰‡è¯¦è§£ï¼ˆæ›´æ–°ä¸­ï¼‰

## ä»€ä¹ˆæ˜¯å†…å­˜ç¢ç‰‡?

ä½ å¯ä»¥å°†å†…å­˜ç¢ç‰‡ç®€å•åœ°ç†è§£ä¸ºé‚£äº›**ä¸å¯ç”¨çš„ç©ºé—²å†…å­˜**ã€‚

ä¸¾ä¸ªä¾‹å­ï¼šæ“ä½œç³»ç»Ÿä¸ºä½ åˆ†é…äº† 32 å­—èŠ‚çš„è¿ç»­å†…å­˜ç©ºé—´ï¼Œè€Œä½ å­˜å‚¨æ•°æ®å®é™…åªéœ€è¦ä½¿ç”¨ 24 å­—èŠ‚å†…å­˜ç©ºé—´ï¼Œé‚£è¿™å¤šä½™å‡ºæ¥çš„ 8 å­—èŠ‚å†…å­˜ç©ºé—´å¦‚æœåç»­æ²¡åŠæ³•å†è¢«åˆ†é…å­˜å‚¨å…¶ä»–æ•°æ®çš„è¯ï¼Œå°±å¯ä»¥è¢«ç§°ä¸º==å†…å­˜ç¢ç‰‡==ã€‚

![](images\memory-fragmentation.png)

Redis å†…å­˜ç¢ç‰‡è™½ç„¶ä¸ä¼šå½±å“ Redis æ€§èƒ½ï¼Œä½†æ˜¯ä¼š**å¢åŠ å†…å­˜æ¶ˆè€—**ã€‚

## ä¸ºä»€ä¹ˆä¼šæœ‰ Redis å†…å­˜ç¢ç‰‡?

Redis å†…å­˜ç¢ç‰‡äº§ç”Ÿæ¯”è¾ƒå¸¸è§çš„ 2 ä¸ªåŸå› ï¼š

**1ã€Redis å­˜å‚¨æ•°æ®çš„æ—¶å€™å‘æ“ä½œç³»ç»Ÿç”³è¯·çš„å†…å­˜ç©ºé—´å¯èƒ½ä¼šå¤§äºæ•°æ®å®é™…éœ€è¦çš„å­˜å‚¨ç©ºé—´ã€‚**

ä»¥ä¸‹æ˜¯è¿™æ®µ Redis å®˜æ–¹çš„åŸè¯ï¼š

> To store user keys, Redis allocates at most as much memory as the `maxmemory` setting enables (however there are small extra allocations possible).

Redis ä½¿ç”¨ `zmalloc` æ–¹æ³•(Redis è‡ªå·±å®ç°çš„å†…å­˜åˆ†é…æ–¹æ³•)è¿›è¡Œå†…å­˜åˆ†é…çš„æ—¶å€™ï¼Œé™¤äº†è¦åˆ†é… `size` å¤§å°çš„å†…å­˜ä¹‹å¤–ï¼Œè¿˜ä¼šå¤šåˆ†é… `PREFIX_SIZE` å¤§å°çš„å†…å­˜ã€‚

`zmalloc` æ–¹æ³•æºç å¦‚ä¸‹ï¼ˆæºç åœ°å€ï¼šhttps://github.com/antirez/redis-tools/blob/master/zmalloc.cï¼‰ï¼š

```java
void *zmalloc(size_t size) {
   // åˆ†é…æŒ‡å®šå¤§å°çš„å†…å­˜
   void *ptr = malloc(size+PREFIX_SIZE);
   if (!ptr) zmalloc_oom_handler(size);
#ifdef HAVE_MALLOC_SIZE
   update_zmalloc_stat_alloc(zmalloc_size(ptr));
   return ptr;
#else
   *((size_t*)ptr) = size;
   update_zmalloc_stat_alloc(size+PREFIX_SIZE);
   return (char*)ptr+PREFIX_SIZE;
#endif
}
```

å¦å¤–ï¼ŒRedis å¯ä»¥ä½¿ç”¨å¤šç§å†…å­˜åˆ†é…å™¨æ¥åˆ†é…å†…å­˜ï¼ˆ libcã€jemallocã€tcmallocï¼‰ï¼Œé»˜è®¤ä½¿ç”¨ [jemalloc](https://github.com/jemalloc/jemalloc)ï¼Œè€Œ jemalloc æŒ‰ç…§ä¸€ç³»åˆ—å›ºå®šçš„å¤§å°ï¼ˆ8 å­—èŠ‚ã€16 å­—èŠ‚ã€32 å­—èŠ‚â€¦â€¦ï¼‰æ¥åˆ†é…å†…å­˜çš„ã€‚jemalloc åˆ’åˆ†çš„å†…å­˜å•å…ƒå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![](images\6803d3929e3e46c1b1c9d0bb9ee8e717.png)

å½“ç¨‹åºç”³è¯·çš„å†…å­˜æœ€æ¥è¿‘æŸä¸ªå›ºå®šå€¼æ—¶ï¼Œjemalloc ä¼šç»™å®ƒåˆ†é…ç›¸åº”å¤§å°çš„ç©ºé—´ï¼Œå°±æ¯”å¦‚è¯´ç¨‹åºéœ€è¦ç”³è¯· 17 å­—èŠ‚çš„å†…å­˜ï¼Œjemalloc ä¼šç›´æ¥ç»™å®ƒåˆ†é… 32 å­—èŠ‚çš„å†…å­˜ï¼Œè¿™æ ·ä¼šå¯¼è‡´æœ‰ 15 å­—èŠ‚å†…å­˜çš„æµªè´¹ã€‚ä¸è¿‡ï¼Œjemalloc ä¸“é—¨é’ˆå¯¹å†…å­˜ç¢ç‰‡é—®é¢˜åšäº†ä¼˜åŒ–ï¼Œä¸€èˆ¬ä¸ä¼šå­˜åœ¨è¿‡åº¦ç¢ç‰‡åŒ–çš„é—®é¢˜ã€‚

**2ã€é¢‘ç¹ä¿®æ”¹ Redis ä¸­çš„æ•°æ®ä¹Ÿä¼šäº§ç”Ÿå†…å­˜ç¢ç‰‡ã€‚**

å½“ Redis ä¸­çš„æŸä¸ªæ•°æ®åˆ é™¤æ—¶ï¼ŒRedis é€šå¸¸ä¸ä¼šè½»æ˜“é‡Šæ”¾å†…å­˜ç»™æ“ä½œç³»ç»Ÿã€‚

è¿™ä¸ªåœ¨ Redis å®˜æ–¹æ–‡æ¡£ä¸­ä¹Ÿæœ‰å¯¹åº”çš„åŸè¯ï¼š

![](images\redis-docs-memory-optimization.png)

æ–‡æ¡£åœ°å€ï¼š[https://redis.io/topics/memory-optimization](https://redis.io/topics/memory-optimization) ã€‚

## å¦‚ä½•æŸ¥çœ‹ Redis å†…å­˜ç¢ç‰‡çš„ä¿¡æ¯ï¼Ÿ

ä½¿ç”¨ **`info memory`** å‘½ä»¤å³å¯æŸ¥çœ‹ Redis å†…å­˜ç›¸å…³çš„ä¿¡æ¯ã€‚ä¸‹å›¾ä¸­æ¯ä¸ªå‚æ•°å…·ä½“çš„å«ä¹‰ï¼ŒRedis å®˜æ–¹æ–‡æ¡£æœ‰è¯¦ç»†çš„ä»‹ç»ï¼š[https://redis.io/commands/INFO](https://redis.io/commands/INFO) ã€‚

![](images\redis-info-memory.png)

Redis ==å†…å­˜ç¢ç‰‡ç‡==çš„è®¡ç®—å…¬å¼ï¼š**`mem_fragmentation_ratio` ï¼ˆå†…å­˜ç¢ç‰‡ç‡ï¼‰= `used_memory_rss` (æ“ä½œç³»ç»Ÿå®é™…åˆ†é…ç»™ Redis çš„ç‰©ç†å†…å­˜ç©ºé—´å¤§å°)/ `used_memory`(Redis å†…å­˜åˆ†é…å™¨ä¸ºäº†å­˜å‚¨æ•°æ®å®é™…ç”³è¯·ä½¿ç”¨çš„å†…å­˜ç©ºé—´å¤§å°)**ã€‚

ä¹Ÿå°±æ˜¯è¯´ï¼Œ`mem_fragmentation_ratio` ï¼ˆå†…å­˜ç¢ç‰‡ç‡ï¼‰çš„å€¼è¶Šå¤§ä»£è¡¨å†…å­˜ç¢ç‰‡ç‡è¶Šä¸¥é‡ã€‚

**ä¸€å®šä¸è¦è¯¯è®¤ä¸º`used_memory_rss` å‡å» `used_memory`å€¼å°±æ˜¯å†…å­˜ç¢ç‰‡çš„å¤§å°ï¼ï¼ï¼**è¿™ä¸ä»…åŒ…æ‹¬å†…å­˜ç¢ç‰‡ï¼Œè¿˜åŒ…æ‹¬å…¶ä»–è¿›ç¨‹å¼€é”€ï¼Œä»¥åŠå…±äº«åº“ã€å †æ ˆç­‰çš„å¼€é”€ã€‚

å¾ˆå¤šå°ä¼™ä¼´å¯èƒ½è¦é—®äº†ï¼šâ€œå¤šå¤§çš„å†…å­˜ç¢ç‰‡ç‡æ‰æ˜¯éœ€è¦æ¸…ç†å‘¢ï¼Ÿâ€ã€‚

é€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬è®¤ä¸º `mem_fragmentation_ratio > 1.5` çš„è¯æ‰éœ€è¦æ¸…ç†å†…å­˜ç¢ç‰‡ã€‚ `mem_fragmentation_ratio > 1.5` æ„å‘³ç€ä½ ä½¿ç”¨ Redis å­˜å‚¨å®é™…å¤§å° 2G çš„æ•°æ®éœ€è¦ä½¿ç”¨å¤§äº 3G çš„å†…å­˜ã€‚

å¦‚æœæƒ³è¦å¿«é€ŸæŸ¥çœ‹å†…å­˜ç¢ç‰‡ç‡çš„è¯ï¼Œä½ è¿˜å¯ä»¥é€šè¿‡ä¸‹é¢è¿™ä¸ªå‘½ä»¤ï¼š

```bash
> redis-cli -p 6379 info | grep mem_fragmentation_ratio
```

å¦å¤–ï¼Œå†…å­˜ç¢ç‰‡ç‡å¯èƒ½å­˜åœ¨å°äº 1 çš„æƒ…å†µã€‚è¿™ç§æƒ…å†µæˆ‘åœ¨æ—¥å¸¸ä½¿ç”¨ä¸­è¿˜æ²¡æœ‰é‡åˆ°è¿‡ï¼Œæ„Ÿå…´è¶£çš„å°ä¼™ä¼´å¯ä»¥çœ‹çœ‹è¿™ç¯‡æ–‡ç«  [æ•…éšœåˆ†æ | Redis å†…å­˜ç¢ç‰‡ç‡å¤ªä½è¯¥æ€ä¹ˆåŠï¼Ÿ- çˆ±å¯ç”Ÿå¼€æºç¤¾åŒº](https://mp.weixin.qq.com/s/drlDvp7bfq5jt2M5pTqJCw) ã€‚

## å¦‚ä½•æ¸…ç† Redis å†…å­˜ç¢ç‰‡ï¼Ÿ

**Redis4.0-RC3 ç‰ˆæœ¬ä»¥åè‡ªå¸¦äº†å†…å­˜æ•´ç†ï¼Œå¯ä»¥é¿å…å†…å­˜ç¢ç‰‡ç‡è¿‡å¤§çš„é—®é¢˜**ã€‚

ç›´æ¥é€šè¿‡ `config set` å‘½ä»¤å°† `activedefrag` é…ç½®é¡¹è®¾ç½®ä¸º `yes` å³å¯ã€‚

```bash
config set activedefrag yes
```

å…·ä½“ä»€ä¹ˆæ—¶å€™æ¸…ç†éœ€è¦é€šè¿‡ä¸‹é¢ä¸¤ä¸ªå‚æ•°æ§åˆ¶ï¼š

```bash
# å†…å­˜ç¢ç‰‡å ç”¨ç©ºé—´è¾¾åˆ° 500mb çš„æ—¶å€™å¼€å§‹æ¸…ç†
config set active-defrag-ignore-bytes 500mb
# å†…å­˜ç¢ç‰‡ç‡å¤§äº 1.5 çš„æ—¶å€™å¼€å§‹æ¸…ç†
config set active-defrag-threshold-lower 50
```

é€šè¿‡ Redis è‡ªåŠ¨å†…å­˜ç¢ç‰‡æ¸…ç†æœºåˆ¶å¯èƒ½ä¼šå¯¹ Redis çš„æ€§èƒ½äº§ç”Ÿå½±å“ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸‹é¢ä¸¤ä¸ªå‚æ•°æ¥å‡å°‘å¯¹ Redis æ€§èƒ½çš„å½±å“ï¼š

```bash
# å†…å­˜ç¢ç‰‡æ¸…ç†æ‰€å ç”¨ CPU æ—¶é—´çš„æ¯”ä¾‹ä¸ä½äº 20%
config set active-defrag-cycle-min 20
# å†…å­˜ç¢ç‰‡æ¸…ç†æ‰€å ç”¨ CPU æ—¶é—´çš„æ¯”ä¾‹ä¸é«˜äº 50%
config set active-defrag-cycle-max 50
```

å¦å¤–ï¼Œé‡å¯èŠ‚ç‚¹å¯ä»¥åšåˆ°å†…å­˜ç¢ç‰‡é‡æ–°æ•´ç†ã€‚å¦‚æœä½ é‡‡ç”¨çš„æ˜¯é«˜å¯ç”¨æ¶æ„çš„ Redis é›†ç¾¤çš„è¯ï¼Œä½ å¯ä»¥å°†ç¢ç‰‡ç‡è¿‡é«˜çš„ä¸»èŠ‚ç‚¹è½¬æ¢ä¸ºä»èŠ‚ç‚¹ï¼Œä»¥ä¾¿è¿›è¡Œå®‰å…¨é‡å¯ã€‚

## å‚è€ƒ

- Redis å®˜æ–¹æ–‡æ¡£ï¼š[https://redis.io/topics/memory-optimization](https://redis.io/topics/memory-optimization)

- Redis æ ¸å¿ƒæŠ€æœ¯ä¸å®æˆ˜ - æå®¢æ—¶é—´ - åˆ é™¤æ•°æ®åï¼Œä¸ºä»€ä¹ˆå†…å­˜å ç”¨ç‡è¿˜æ˜¯å¾ˆé«˜ï¼Ÿï¼š[https://time.geekbang.org/column/article/289140](https://time.geekbang.org/column/article/289140)

- Redis æºç è§£æâ€”â€”å†…å­˜åˆ†é…ï¼š<[https://shinerio.cc/2020/05/17/redis/Redis](https://shinerio.cc/2020/05/17/redis/Redis) æºç è§£æâ€”â€”å†…å­˜ç®¡ç†>



# Rediså¸¸è§é˜»å¡åŸå› æ€»ç»“ï¼ˆæ›´æ–°ä¸­ï¼‰

> æœ¬æ–‡æ•´ç†å®Œå–„è‡ªï¼š[https://mp.weixin.qq.com/s/0Nqfq_eQrUb12QH6eBbHXA](https://mp.weixin.qq.com/s/0Nqfq_eQrUb12QH6eBbHXA) ï¼Œä½œè€…ï¼šé˜¿ Q è¯´ä»£ç 

è¿™ç¯‡æ–‡ç« ä¼šè¯¦ç»†æ€»ç»“ä¸€ä¸‹å¯èƒ½å¯¼è‡´ Redis é˜»å¡çš„æƒ…å†µï¼Œè¿™äº›æƒ…å†µä¹Ÿæ˜¯å½±å“ Redis æ€§èƒ½çš„å…³é”®å› ç´ ï¼Œä½¿ç”¨ Redis çš„æ—¶å€™åº”è¯¥æ ¼å¤–æ³¨æ„ï¼

## O(n) å‘½ä»¤

Redis ä¸­çš„å¤§éƒ¨åˆ†å‘½ä»¤éƒ½æ˜¯ O(1)æ—¶é—´å¤æ‚åº¦ï¼Œä½†ä¹Ÿæœ‰å°‘éƒ¨åˆ† O(n) æ—¶é—´å¤æ‚åº¦çš„å‘½ä»¤ï¼Œä¾‹å¦‚ï¼š

- `KEYS *`ï¼šä¼šè¿”å›æ‰€æœ‰ç¬¦åˆè§„åˆ™çš„ keyã€‚
- `HGETALL`ï¼šä¼šè¿”å›ä¸€ä¸ª Hash ä¸­æ‰€æœ‰çš„é”®å€¼å¯¹ã€‚
- `LRANGE`ï¼šä¼šè¿”å› List ä¸­æŒ‡å®šèŒƒå›´å†…çš„å…ƒç´ ã€‚
- `SMEMBERS`ï¼šè¿”å› Set ä¸­çš„æ‰€æœ‰å…ƒç´ ã€‚
- `SINTER`/`SUNION`/`SDIFF`ï¼šè®¡ç®—å¤šä¸ª Set çš„äº¤é›†/å¹¶é›†/å·®é›†ã€‚
- â€¦â€¦

ç”±äºè¿™äº›å‘½ä»¤æ—¶é—´å¤æ‚åº¦æ˜¯ O(n)ï¼Œæœ‰æ—¶å€™ä¹Ÿä¼šå…¨è¡¨æ‰«æï¼Œéšç€ n çš„å¢å¤§ï¼Œæ‰§è¡Œè€—æ—¶ä¹Ÿä¼šè¶Šé•¿ï¼Œä»è€Œå¯¼è‡´å®¢æˆ·ç«¯é˜»å¡ã€‚ä¸è¿‡ï¼Œ è¿™äº›å‘½ä»¤å¹¶ä¸æ˜¯ä¸€å®šä¸èƒ½ä½¿ç”¨ï¼Œä½†æ˜¯éœ€è¦æ˜ç¡® N çš„å€¼ã€‚å¦å¤–ï¼Œæœ‰éå†çš„éœ€æ±‚å¯ä»¥ä½¿ç”¨ `HSCAN`ã€`SSCAN`ã€`ZSCAN` ä»£æ›¿ã€‚

é™¤äº†è¿™äº› **O(n)æ—¶é—´å¤æ‚åº¦çš„å‘½ä»¤å¯èƒ½ä¼šå¯¼è‡´é˜»å¡**ä¹‹å¤–ï¼Œ è¿˜æœ‰ä¸€äº›æ—¶é—´å¤æ‚åº¦å¯èƒ½åœ¨ O(N) ä»¥ä¸Šçš„å‘½ä»¤ï¼Œä¾‹å¦‚ï¼š

- `ZRANGE`/`ZREVRANGE`ï¼šè¿”å›æŒ‡å®š Sorted Set ä¸­æŒ‡å®šæ’åèŒƒå›´å†…çš„æ‰€æœ‰å…ƒç´ ã€‚æ—¶é—´å¤æ‚åº¦ä¸º O(log(n)+m)ï¼Œn ä¸ºæ‰€æœ‰å…ƒç´ çš„æ•°é‡ï¼Œ m ä¸ºè¿”å›çš„å…ƒç´ æ•°é‡ï¼Œå½“ m å’Œ n ç›¸å½“å¤§æ—¶ï¼ŒO(n) çš„æ—¶é—´å¤æ‚åº¦æ›´å°ã€‚
- `ZREMRANGEBYRANK`/`ZREMRANGEBYSCORE`ï¼šç§»é™¤ Sorted Set ä¸­æŒ‡å®šæ’åèŒƒå›´/æŒ‡å®š score èŒƒå›´å†…çš„æ‰€æœ‰å…ƒç´ ã€‚æ—¶é—´å¤æ‚åº¦ä¸º O(log(n)+m)ï¼Œn ä¸ºæ‰€æœ‰å…ƒç´ çš„æ•°é‡ï¼Œ m è¢«åˆ é™¤å…ƒç´ çš„æ•°é‡ï¼Œå½“ m å’Œ n ç›¸å½“å¤§æ—¶ï¼ŒO(n) çš„æ—¶é—´å¤æ‚åº¦æ›´å°ã€‚
- â€¦â€¦

## SAVE åˆ›å»º RDB å¿«ç…§

Redis æä¾›äº†ä¸¤ä¸ªå‘½ä»¤æ¥ç”Ÿæˆ RDB å¿«ç…§æ–‡ä»¶ï¼š

- `save` : åŒæ­¥ä¿å­˜æ“ä½œï¼Œä¼š**é˜»å¡** Redis ä¸»çº¿ç¨‹ï¼›
- `bgsave` : fork å‡ºä¸€ä¸ªå­è¿›ç¨‹ï¼Œ**å­è¿›ç¨‹**æ‰§è¡Œï¼Œä¸ä¼šé˜»å¡ Redis ä¸»çº¿ç¨‹ï¼Œé»˜è®¤é€‰é¡¹ã€‚

é»˜è®¤æƒ…å†µä¸‹ï¼ŒRedis é»˜è®¤é…ç½®ä¼šä½¿ç”¨ `bgsave` å‘½ä»¤ã€‚å¦‚æœæ‰‹åŠ¨ä½¿ç”¨ `save` å‘½ä»¤ç”Ÿæˆ RDB å¿«ç…§æ–‡ä»¶çš„è¯ï¼Œå°±ä¼šé˜»å¡ä¸»çº¿ç¨‹ã€‚

## AOF

### AOF æ—¥å¿—è®°å½•é˜»å¡

**Redis AOF æŒä¹…åŒ–æœºåˆ¶æ˜¯åœ¨æ‰§è¡Œå®Œå‘½ä»¤ä¹‹åå†è®°å½•æ—¥å¿—ï¼Œè¿™å’Œå…³ç³»å‹æ•°æ®åº“ï¼ˆå¦‚ MySQLï¼‰é€šå¸¸éƒ½æ˜¯æ‰§è¡Œå‘½ä»¤ä¹‹å‰è®°å½•æ—¥å¿—ï¼ˆæ–¹ä¾¿æ•…éšœæ¢å¤ï¼‰ä¸åŒ**ã€‚

![](images\redis-aof-write-log-disc (1).png)

**ä¸ºä»€ä¹ˆæ˜¯åœ¨æ‰§è¡Œå®Œå‘½ä»¤ä¹‹åè®°å½•æ—¥å¿—å‘¢ï¼Ÿ**

- é¿å…é¢å¤–çš„æ£€æŸ¥å¼€é”€ï¼ŒAOF è®°å½•æ—¥å¿—ä¸ä¼šå¯¹å‘½ä»¤è¿›è¡Œè¯­æ³•æ£€æŸ¥ï¼›
- åœ¨å‘½ä»¤æ‰§è¡Œå®Œä¹‹åå†è®°å½•ï¼Œä¸ä¼šé˜»å¡å½“å‰çš„å‘½ä»¤æ‰§è¡Œã€‚

è¿™æ ·ä¹Ÿå¸¦æ¥äº†é£é™©ï¼ˆæˆ‘åœ¨å‰é¢ä»‹ç» AOF æŒä¹…åŒ–çš„æ—¶å€™ä¹Ÿæåˆ°è¿‡ï¼‰ï¼š

- å¦‚æœåˆšæ‰§è¡Œå®Œå‘½ä»¤ Redis å°±å®•æœºä¼šå¯¼è‡´å¯¹åº”çš„ä¿®æ”¹ä¸¢å¤±ï¼›
- **å¯èƒ½ä¼šé˜»å¡åç»­å…¶ä»–å‘½ä»¤çš„æ‰§è¡Œï¼ˆAOF è®°å½•æ—¥å¿—æ˜¯åœ¨ Redis ä¸»çº¿ç¨‹ä¸­è¿›è¡Œçš„ï¼‰**ã€‚

### AOF åˆ·ç›˜é˜»å¡

**å¼€å¯ AOF æŒä¹…åŒ–åæ¯æ‰§è¡Œä¸€æ¡ä¼šæ›´æ”¹ Redis ä¸­çš„æ•°æ®çš„å‘½ä»¤ï¼ŒRedis å°±ä¼šå°†è¯¥å‘½ä»¤å†™å…¥åˆ° AOF ç¼“å†²åŒº `server.aof_buf` ä¸­ï¼Œç„¶åå†æ ¹æ® `appendfsync` é…ç½®æ¥å†³å®šä½•æ—¶å°†å…¶åŒæ­¥åˆ°ç¡¬ç›˜ä¸­çš„ AOF æ–‡ä»¶**ã€‚

åœ¨ Redis çš„é…ç½®æ–‡ä»¶ä¸­å­˜åœ¨ä¸‰ç§ä¸åŒçš„ AOF æŒä¹…åŒ–æ–¹å¼ï¼ˆ `fsync`ç­–ç•¥ï¼‰ï¼Œå®ƒä»¬åˆ†åˆ«æ˜¯ï¼š

1. `appendfsync always`ï¼šä¸»çº¿ç¨‹è°ƒç”¨ `write` æ‰§è¡Œå†™æ“ä½œåï¼Œåå°çº¿ç¨‹ï¼ˆ `aof_fsync` çº¿ç¨‹ï¼‰ç«‹å³ä¼šè°ƒç”¨ `fsync` å‡½æ•°åŒæ­¥ AOF æ–‡ä»¶ï¼ˆåˆ·ç›˜ï¼‰ï¼Œ`fsync` å®Œæˆåçº¿ç¨‹è¿”å›ï¼Œè¿™æ ·ä¼šä¸¥é‡é™ä½ Redis çš„æ€§èƒ½ï¼ˆ`write` + `fsync`ï¼‰ã€‚
2. `appendfsync everysec`ï¼šä¸»çº¿ç¨‹è°ƒç”¨ `write` æ‰§è¡Œå†™æ“ä½œåç«‹å³è¿”å›ï¼Œç”±åå°çº¿ç¨‹ï¼ˆ `aof_fsync` çº¿ç¨‹ï¼‰æ¯ç§’é’Ÿè°ƒç”¨ `fsync` å‡½æ•°ï¼ˆç³»ç»Ÿè°ƒç”¨ï¼‰åŒæ­¥ä¸€æ¬¡ AOF æ–‡ä»¶ï¼ˆ`write`+`fsync`ï¼Œ`fsync`é—´éš”ä¸º 1 ç§’ï¼‰
3. `appendfsync no`ï¼šä¸»çº¿ç¨‹è°ƒç”¨ `write` æ‰§è¡Œå†™æ“ä½œåç«‹å³è¿”å›ï¼Œè®©æ“ä½œç³»ç»Ÿå†³å®šä½•æ—¶è¿›è¡ŒåŒæ­¥ï¼ŒLinux ä¸‹ä¸€èˆ¬ä¸º 30 ç§’ä¸€æ¬¡ï¼ˆ`write`ä½†ä¸`fsync`ï¼Œ`fsync` çš„æ—¶æœºç”±æ“ä½œç³»ç»Ÿå†³å®šï¼‰ã€‚

**å½“åå°çº¿ç¨‹ï¼ˆ `aof_fsync` çº¿ç¨‹ï¼‰è°ƒç”¨ `fsync` å‡½æ•°åŒæ­¥ AOF æ–‡ä»¶æ—¶ï¼Œéœ€è¦ç­‰å¾…ï¼Œç›´åˆ°å†™å…¥å®Œæˆã€‚å½“ç£ç›˜å‹åŠ›å¤ªå¤§çš„æ—¶å€™ï¼Œä¼šå¯¼è‡´ `fsync` æ“ä½œå‘ç”Ÿé˜»å¡ï¼Œä¸»çº¿ç¨‹è°ƒç”¨ `write` å‡½æ•°æ—¶ä¹Ÿä¼šè¢«é˜»å¡ã€‚`fsync` å®Œæˆåï¼Œä¸»çº¿ç¨‹æ‰§è¡Œ `write` æ‰èƒ½æˆåŠŸè¿”å›**ã€‚

å…³äº AOF å·¥ä½œæµç¨‹çš„è¯¦ç»†ä»‹ç»å¯ä»¥æŸ¥çœ‹ï¼š[Redis æŒä¹…åŒ–æœºåˆ¶è¯¦è§£]()ï¼Œæœ‰åŠ©äºç†è§£ AOF åˆ·ç›˜é˜»å¡ã€‚

### AOF é‡å†™é˜»å¡

1. fork å‡ºä¸€æ¡å­çº¿ç¨‹æ¥å°†æ–‡ä»¶é‡å†™ï¼Œåœ¨æ‰§è¡Œ `BGREWRITEAOF` å‘½ä»¤æ—¶ï¼ŒRedis æœåŠ¡å™¨ä¼šç»´æŠ¤ä¸€ä¸ª **AOF é‡å†™ç¼“å†²åŒº**ï¼Œè¯¥ç¼“å†²åŒºä¼šåœ¨å­çº¿ç¨‹åˆ›å»ºæ–° AOF æ–‡ä»¶æœŸé—´ï¼Œè®°å½•æœåŠ¡å™¨æ‰§è¡Œçš„æ‰€æœ‰å†™å‘½ä»¤ã€‚
2. å½“å­çº¿ç¨‹å®Œæˆåˆ›å»ºæ–° AOF æ–‡ä»¶çš„å·¥ä½œä¹‹åï¼ŒæœåŠ¡å™¨ä¼š**å°†é‡å†™ç¼“å†²åŒºä¸­çš„æ‰€æœ‰å†…å®¹è¿½åŠ åˆ°æ–° AOF æ–‡ä»¶çš„æœ«å°¾**ï¼Œä½¿å¾—æ–°çš„ AOF æ–‡ä»¶ä¿å­˜çš„æ•°æ®åº“çŠ¶æ€ä¸ç°æœ‰çš„æ•°æ®åº“çŠ¶æ€ä¸€è‡´ã€‚
3. æœ€åï¼ŒæœåŠ¡å™¨ç”¨æ–°çš„ AOF æ–‡ä»¶æ›¿æ¢æ—§çš„ AOF æ–‡ä»¶ï¼Œä»¥æ­¤æ¥å®Œæˆ AOF æ–‡ä»¶é‡å†™æ“ä½œã€‚

é˜»å¡å°±æ˜¯å‡ºç°åœ¨ç¬¬ 2 æ­¥çš„è¿‡ç¨‹ä¸­ï¼Œå°†ç¼“å†²åŒºä¸­æ–°æ•°æ®å†™åˆ°æ–°æ–‡ä»¶çš„è¿‡ç¨‹ä¸­ä¼šäº§ç”Ÿ**é˜»å¡**ã€‚

ç›¸å…³é˜…è¯»ï¼š[Redis AOF é‡å†™é˜»å¡é—®é¢˜åˆ†æ](https://cloud.tencent.com/developer/article/1633077)ã€‚

## å¤§ Key

å¦‚æœä¸€ä¸ª key å¯¹åº”çš„ value æ‰€å ç”¨çš„å†…å­˜æ¯”è¾ƒå¤§ï¼Œé‚£è¿™ä¸ª key å°±å¯ä»¥çœ‹ä½œæ˜¯ bigkeyã€‚å…·ä½“å¤šå¤§æ‰ç®—å¤§å‘¢ï¼Ÿæœ‰ä¸€ä¸ªä¸æ˜¯ç‰¹åˆ«ç²¾ç¡®çš„å‚è€ƒæ ‡å‡†ï¼š

- string ç±»å‹çš„ value è¶…è¿‡ 1MB
- å¤åˆç±»å‹ï¼ˆåˆ—è¡¨ã€å“ˆå¸Œã€é›†åˆã€æœ‰åºé›†åˆç­‰ï¼‰çš„ value åŒ…å«çš„å…ƒç´ è¶…è¿‡ 5000 ä¸ªï¼ˆå¯¹äºå¤åˆç±»å‹çš„ value æ¥è¯´ï¼Œä¸ä¸€å®šåŒ…å«çš„å…ƒç´ è¶Šå¤šï¼Œå ç”¨çš„å†…å­˜å°±è¶Šå¤šï¼‰ã€‚

å¤§ key é€ æˆçš„é˜»å¡é—®é¢˜å¦‚ä¸‹ï¼š

- **å®¢æˆ·ç«¯è¶…æ—¶é˜»å¡**ï¼šç”±äº Redis æ‰§è¡Œå‘½ä»¤æ˜¯å•çº¿ç¨‹å¤„ç†ï¼Œç„¶ååœ¨æ“ä½œå¤§ key æ—¶ä¼šæ¯”è¾ƒè€—æ—¶ï¼Œé‚£ä¹ˆå°±ä¼šé˜»å¡ Redisï¼Œä»å®¢æˆ·ç«¯è¿™ä¸€è§†è§’çœ‹ï¼Œå°±æ˜¯å¾ˆä¹…å¾ˆä¹…éƒ½æ²¡æœ‰å“åº”ã€‚
- **å¼•å‘ç½‘ç»œé˜»å¡**ï¼šæ¯æ¬¡è·å–å¤§ key äº§ç”Ÿçš„ç½‘ç»œæµé‡è¾ƒå¤§ï¼Œå¦‚æœä¸€ä¸ª key çš„å¤§å°æ˜¯ 1 MBï¼Œæ¯ç§’è®¿é—®é‡ä¸º 1000ï¼Œé‚£ä¹ˆæ¯ç§’ä¼šäº§ç”Ÿ 1000MB çš„æµé‡ï¼Œè¿™å¯¹äºæ™®é€šåƒå…†ç½‘å¡çš„æœåŠ¡å™¨æ¥è¯´æ˜¯ç¾éš¾æ€§çš„ã€‚
- **é˜»å¡å·¥ä½œçº¿ç¨‹**ï¼šå¦‚æœä½¿ç”¨ del åˆ é™¤å¤§ key æ—¶ï¼Œä¼šé˜»å¡å·¥ä½œçº¿ç¨‹ï¼Œè¿™æ ·å°±æ²¡åŠæ³•å¤„ç†åç»­çš„å‘½ä»¤ã€‚

### æŸ¥æ‰¾å¤§ key

å½“æˆ‘ä»¬åœ¨ä½¿ç”¨ Redis è‡ªå¸¦çš„ `--bigkeys` å‚æ•°æŸ¥æ‰¾å¤§ key æ—¶ï¼Œæœ€å¥½é€‰æ‹©åœ¨**ä»èŠ‚ç‚¹**ä¸Šæ‰§è¡Œè¯¥å‘½ä»¤ï¼Œå› ä¸ºä¸»èŠ‚ç‚¹ä¸Šæ‰§è¡Œæ—¶ï¼Œä¼š**é˜»å¡ä¸»èŠ‚ç‚¹**ã€‚

- æˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨ `SCAN` å‘½ä»¤æ¥æŸ¥æ‰¾å¤§ keyï¼›
- é€šè¿‡åˆ†æ RDB æ–‡ä»¶æ¥æ‰¾å‡º big keyï¼Œè¿™ç§æ–¹æ¡ˆçš„å‰ææ˜¯ Redis é‡‡ç”¨çš„æ˜¯ RDB æŒä¹…åŒ–ã€‚ç½‘ä¸Šæœ‰ç°æˆçš„å·¥å…·ï¼š
- - redis-rdb-toolsï¼šPython è¯­è¨€å†™çš„ç”¨æ¥åˆ†æ Redis çš„ RDB å¿«ç…§æ–‡ä»¶ç”¨çš„å·¥å…·
  - rdb_bigkeysï¼šGo è¯­è¨€å†™çš„ç”¨æ¥åˆ†æ Redis çš„ RDB å¿«ç…§æ–‡ä»¶ç”¨çš„å·¥å…·ï¼Œæ€§èƒ½æ›´å¥½ã€‚

### åˆ é™¤å¤§ key

åˆ é™¤æ“ä½œçš„æœ¬è´¨æ˜¯è¦é‡Šæ”¾é”®å€¼å¯¹å ç”¨çš„å†…å­˜ç©ºé—´ã€‚

é‡Šæ”¾å†…å­˜åªæ˜¯ç¬¬ä¸€æ­¥ï¼Œä¸ºäº†æ›´åŠ é«˜æ•ˆåœ°ç®¡ç†å†…å­˜ç©ºé—´ï¼Œåœ¨åº”ç”¨ç¨‹åºé‡Šæ”¾å†…å­˜æ—¶ï¼Œ**æ“ä½œç³»ç»Ÿéœ€è¦æŠŠé‡Šæ”¾æ‰çš„å†…å­˜å—æ’å…¥ä¸€ä¸ªç©ºé—²å†…å­˜å—çš„é“¾è¡¨**ï¼Œä»¥ä¾¿åç»­è¿›è¡Œç®¡ç†å’Œå†åˆ†é…ã€‚è¿™ä¸ªè¿‡ç¨‹æœ¬èº«éœ€è¦ä¸€å®šæ—¶é—´ï¼Œè€Œä¸”ä¼š**é˜»å¡**å½“å‰é‡Šæ”¾å†…å­˜çš„åº”ç”¨ç¨‹åºã€‚

æ‰€ä»¥ï¼Œ**å¦‚æœä¸€ä¸‹å­é‡Šæ”¾äº†å¤§é‡å†…å­˜ï¼Œç©ºé—²å†…å­˜å—é“¾è¡¨æ“ä½œæ—¶é—´å°±ä¼šå¢åŠ ï¼Œç›¸åº”åœ°å°±ä¼šé€ æˆ Redis ä¸»çº¿ç¨‹çš„é˜»å¡**ï¼Œå¦‚æœä¸»çº¿ç¨‹å‘ç”Ÿäº†é˜»å¡ï¼Œå…¶ä»–æ‰€æœ‰è¯·æ±‚å¯èƒ½éƒ½ä¼šè¶…æ—¶ï¼Œè¶…æ—¶è¶Šæ¥è¶Šå¤šï¼Œä¼šé€ æˆ Redis è¿æ¥è€—å°½ï¼Œäº§ç”Ÿå„ç§å¼‚å¸¸ã€‚

åˆ é™¤å¤§ key æ—¶å»ºè®®é‡‡ç”¨**åˆ†æ‰¹æ¬¡åˆ é™¤**å’Œ**å¼‚æ­¥åˆ é™¤**çš„æ–¹å¼è¿›è¡Œã€‚

## æ¸…ç©ºæ•°æ®åº“

æ¸…ç©ºæ•°æ®åº“å’Œä¸Šé¢ bigkey åˆ é™¤ä¹Ÿæ˜¯åŒæ ·é“ç†ï¼Œ`flushdb`ã€`flushall` ä¹Ÿæ¶‰åŠåˆ°åˆ é™¤å’Œé‡Šæ”¾æ‰€æœ‰çš„é”®å€¼å¯¹ï¼Œä¹Ÿæ˜¯ Redis çš„é˜»å¡ç‚¹ã€‚

## é›†ç¾¤æ‰©å®¹

Redis é›†ç¾¤å¯ä»¥è¿›è¡Œ**èŠ‚ç‚¹çš„åŠ¨æ€æ‰©å®¹ç¼©å®¹**ï¼Œè¿™ä¸€è¿‡ç¨‹ç›®å‰è¿˜å¤„äºåŠè‡ªåŠ¨çŠ¶æ€ï¼Œéœ€è¦äººå·¥ä»‹å…¥ã€‚

åœ¨æ‰©ç¼©å®¹çš„æ—¶å€™ï¼Œéœ€è¦è¿›è¡Œæ•°æ®è¿ç§»ã€‚è€Œ Redis ä¸ºäº†ä¿è¯è¿ç§»çš„ä¸€è‡´æ€§ï¼Œè¿ç§»æ‰€æœ‰æ“ä½œéƒ½æ˜¯**åŒæ­¥æ“ä½œ**ã€‚

æ‰§è¡Œè¿ç§»æ—¶ï¼Œ**ä¸¤ç«¯çš„ Redis å‡ä¼šè¿›å…¥æ—¶é•¿ä¸ç­‰çš„é˜»å¡çŠ¶æ€**ï¼Œå¯¹äºå° Keyï¼Œè¯¥æ—¶é—´å¯ä»¥å¿½ç•¥ä¸è®¡ï¼Œä½†**å¦‚æœä¸€æ—¦ Key çš„å†…å­˜ä½¿ç”¨è¿‡å¤§ï¼Œä¸¥é‡çš„æ—¶å€™ä¼šè§¦å‘é›†ç¾¤å†…çš„æ•…éšœè½¬ç§»ï¼Œé€ æˆä¸å¿…è¦çš„åˆ‡æ¢**ã€‚

## Swapï¼ˆå†…å­˜äº¤æ¢ï¼‰

**ä»€ä¹ˆæ˜¯ Swapï¼Ÿ** Swap ç›´è¯‘è¿‡æ¥æ˜¯äº¤æ¢çš„æ„æ€ï¼ŒLinux ä¸­çš„ Swap å¸¸è¢«ç§°ä¸º**å†…å­˜äº¤æ¢æˆ–è€…äº¤æ¢åˆ†åŒº**ã€‚ç±»ä¼¼äº Windows ä¸­çš„è™šæ‹Ÿå†…å­˜ï¼Œå°±æ˜¯å½“å†…å­˜ä¸è¶³çš„æ—¶å€™ï¼ŒæŠŠä¸€éƒ¨åˆ†ç¡¬ç›˜ç©ºé—´è™šæ‹Ÿæˆå†…å­˜ä½¿ç”¨ï¼Œä»è€Œè§£å†³å†…å­˜å®¹é‡ä¸è¶³çš„æƒ…å†µã€‚å› æ­¤ï¼Œ**Swap åˆ†åŒºçš„ä½œç”¨å°±æ˜¯ç‰ºç‰²ç¡¬ç›˜ï¼Œå¢åŠ å†…å­˜ï¼Œè§£å†³ VPS å†…å­˜ä¸å¤Ÿç”¨æˆ–è€…çˆ†æ»¡çš„é—®é¢˜**ã€‚

Swap å¯¹äº Redis æ¥è¯´æ˜¯éå¸¸è‡´å‘½çš„ï¼ŒRedis ä¿è¯é«˜æ€§èƒ½çš„ä¸€ä¸ªé‡è¦å‰ææ˜¯æ‰€æœ‰çš„æ•°æ®åœ¨å†…å­˜ä¸­ã€‚å¦‚æœæ“ä½œç³»ç»ŸæŠŠ Redis ä½¿ç”¨çš„éƒ¨åˆ†å†…å­˜æ¢å‡ºç¡¬ç›˜ï¼Œç”±äºå†…å­˜ä¸ç¡¬ç›˜çš„è¯»å†™é€Ÿåº¦å·®å‡ ä¸ªæ•°é‡çº§ï¼Œä¼šå¯¼è‡´å‘ç”Ÿäº¤æ¢åçš„ Redis æ€§èƒ½æ€¥å‰§ä¸‹é™ã€‚

è¯†åˆ« Redis å‘ç”Ÿ Swap çš„æ£€æŸ¥æ–¹æ³•å¦‚ä¸‹ï¼š

1ã€æŸ¥è¯¢ Redis è¿›ç¨‹å·

```bash
redis-cli -p 6383 info server | grep process_id
process_id: 4476
```

2ã€æ ¹æ®è¿›ç¨‹å·æŸ¥è¯¢å†…å­˜äº¤æ¢ä¿¡æ¯

```bash
cat /proc/4476/smaps | grep Swap
Swap: 0kB
Swap: 0kB
Swap: 4kB
Swap: 0kB
Swap: 0kB
.....
```

å¦‚æœäº¤æ¢é‡éƒ½æ˜¯ 0KB æˆ–è€…ä¸ªåˆ«çš„æ˜¯ 4KBï¼Œåˆ™æ­£å¸¸ã€‚

é¢„é˜²å†…å­˜äº¤æ¢çš„æ–¹æ³•ï¼š

- ä¿è¯æœºå™¨å……è¶³çš„å¯ç”¨å†…å­˜
- ç¡®ä¿æ‰€æœ‰ Redis å®ä¾‹è®¾ç½®æœ€å¤§å¯ç”¨å†…å­˜(maxmemory)ï¼Œé˜²æ­¢æç«¯æƒ…å†µ Redis å†…å­˜ä¸å¯æ§çš„å¢é•¿
- é™ä½ç³»ç»Ÿä½¿ç”¨ swap ä¼˜å…ˆçº§ï¼Œå¦‚`echo 10 > /proc/sys/vm/swappiness`

## CPU ç«äº‰

**Redis æ˜¯å…¸å‹çš„ CPU å¯†é›†å‹åº”ç”¨**ï¼Œä¸å»ºè®®å’Œå…¶ä»–å¤šæ ¸ CPU å¯†é›†å‹æœåŠ¡éƒ¨ç½²åœ¨ä¸€èµ·ã€‚å½“å…¶ä»–è¿›ç¨‹è¿‡åº¦æ¶ˆè€— CPU æ—¶ï¼Œå°†ä¸¥é‡å½±å“ Redis çš„ååé‡ã€‚

å¯ä»¥é€šè¿‡`redis-cli --stat`è·å–å½“å‰ Redis ä½¿ç”¨æƒ…å†µã€‚é€šè¿‡`top`å‘½ä»¤è·å–è¿›ç¨‹å¯¹ CPU çš„åˆ©ç”¨ç‡ç­‰ä¿¡æ¯ é€šè¿‡`info commandstats`ç»Ÿè®¡ä¿¡æ¯åˆ†æå‡ºå‘½ä»¤ä¸åˆç†å¼€é”€æ—¶é—´ï¼ŒæŸ¥çœ‹æ˜¯å¦æ˜¯å› ä¸ºé«˜ç®—æ³•å¤æ‚åº¦æˆ–è€…è¿‡åº¦çš„å†…å­˜ä¼˜åŒ–é—®é¢˜ã€‚

## ç½‘ç»œé—®é¢˜

è¿æ¥æ‹’ç»ã€ç½‘ç»œå»¶è¿Ÿï¼Œç½‘å¡è½¯ä¸­æ–­ç­‰ç½‘ç»œé—®é¢˜ä¹Ÿå¯èƒ½ä¼šå¯¼è‡´ Redis é˜»å¡ã€‚

## å‚è€ƒ

- Redis é˜»å¡çš„ 6 å¤§ç±»åœºæ™¯åˆ†æä¸æ€»ç»“ï¼š[https://mp.weixin.qq.com/s/eaZCEtTjTuEmXfUubVHjew](https://mp.weixin.qq.com/s/eaZCEtTjTuEmXfUubVHjew)
- Redis å¼€å‘ä¸è¿ç»´ç¬”è®°-Redis çš„å™©æ¢¦-é˜»å¡ï¼š[https://mp.weixin.qq.com/s/TDbpz9oLH6ifVv6ewqgSgA](https://mp.weixin.qq.com/s/TDbpz9oLH6ifVv6ewqgSgA)

# Redisé›†ç¾¤è¯¦è§£(ä»˜è´¹)

æš‚æ— 

